<!DOCTYPE html>
<html lang="en">

  <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Handling User Authentication with the MEAN Stack</title>
  <meta name="description" content="Here we look at how to handle user authentication with the MEAN stack.">
  
    
    <meta name="keywords" content="mean, web development, mongo, mongodb, express, expressjs, node, nodejs, angular, angularjs, authentication, login, mean stack">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://mherman.org/blog/handling-user-authentication-with-the-mean-stack/">
  
  
  <link rel="alternate" type="application/rss+xml" title="Michael Herman" href="https://mherman.org/feed.xml">

  <link rel="icon" type="image/png" href="/favicon.png">


  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Handling User Authentication with the MEAN Stack">
  <meta name="twitter:description" content="Here we look at how to handle user authentication with the MEAN stack.">
  
  

  <script type="text/javascript">
  WebFontConfig = {
    google: { families: [ 'Bitter:400,700,400italic:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  
    
  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-37074204-1', 'auto');
    ga('send', 'pageview');
  </script>


  
</head>


  <link rel="stylesheet" href="/assets/hello.css">

  <body>

    <header class="site-header">

  <div class="color-bar">
    <div class="bar bar1"></div>
    <div class="bar bar2"></div>
    <div class="bar bar3"></div>
    <div class="bar bar4"></div>
    <div class="bar bar5"></div>
    <div class="bar bar6"></div>
  </div>

  <div class="wrapper">

    <a class="site-title" href="/">Michael Herman</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/">Blog</a>
      
        
        <a class="page-link" href="/about">About</a>
      
        
        <a class="page-link" href="/talks">Talks</a>
      
        
        <a class="page-link" href="/feed.xml">RSS</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Handling User Authentication with the MEAN Stack</h1>
    
    <p class="post-meta">
      Last update: <time datetime="2015-07-02T00:00:00-06:00" itemprop="datePublished">Jul 2, 2015</time>
       • 
  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/angular/">angular</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/node/">node</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/auth/">auth</a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <div style="text-align:center;">
  <img src="/assets/img/blog/mean-auth.png" style="max-width: 100%; border:0;" alt="mean stack authentication" />
</div>

<p><br /></p>

<p>This post provides a solution to the question, “How do I handle user authentication with the MEAN Stack - MongoDB, ExpressJS, AngularJS, and NodeJS?”.</p>

<blockquote>
  <p>Much of this post is ported from <a href="https://realpython.com/blog/python/handling-user-authentication-with-angular-and-flask/">Handling User Authentication with Angular and Flask</a> from <a href="https://realpython.com">Real Python</a>.</p>
</blockquote>

<p><em>Updates:</em></p>

<ul>
  <li>02/28/2016: Updated to the latest versions of NodeJS, ExpressJS, MongoDB, and AngularJS; added a section on persistent logins.</li>
</ul>

<p>Keep in mind that this solution posed in this tutorial is not the <em>only</em> solution to the question at hand, and it may not even be the <em>right</em> solution for your situation. Regardless of the solution you implement, it is important to note that since end users have full control of the browser as well as access to the front-end code, sensitive data living in your server-side API must be secure. <em>In other words, make certain that you implement an authentication strategy on the server-side to protect sensitive API endpoints.</em></p>

<p>That said, we need to enable the following workflow:</p>

<ol>
  <li>When the client accesses the main route, an index page is served, at which point Angular takes over.</li>
  <li>The Angular app immediately “asks” the server if a user is logged in.</li>
  <li>Assuming the server indicates that a user is not logged in, the client is immediately asked to log in.</li>
  <li>Once logged in, the Angular app then tracks the user’s login status.</li>
</ol>

<blockquote>
  <p>This tutorial uses <a href="https://nodejs.org/">NodeJS</a> v4.3.1, <a href="http://expressjs.com/4x/api.html">ExpressJS</a> v4.13.4, <a href="https://docs.mongodb.org/v3.2/">MongoDB</a> v3.2.3, and <a href="https://code.angularjs.org/1.4.9/docs/guide">AngularJS</a> v1.4.9. For a full list of dependencies, please view the <em><a href="https://github.com/mjhea0/mean-auth/blob/master/package.json">package.json</a></em> file.</p>
</blockquote>

<h2 class="no_toc" id="contents">Contents</h2>

<ul id="markdown-toc">
  <li><a href="#getting-started" id="markdown-toc-getting-started">Getting Started</a></li>
  <li><a href="#login-api" id="markdown-toc-login-api">Login API</a></li>
  <li><a href="#angular-app" id="markdown-toc-angular-app">Angular App</a></li>
  <li><a href="#route-restriction" id="markdown-toc-route-restriction">Route Restriction</a></li>
  <li><a href="#persistent-login" id="markdown-toc-persistent-login">Persistent Login</a></li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ul>

<h2 id="getting-started">Getting Started</h2>

<p>First, grab the boilerplate code from the <a href="https://github.com/mjhea0/mean-auth/releases/tag/v1">project repo</a>, install the requirements, and then test out the app:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm start
</code></pre></div></div>

<p>Navigate to <a href="http://localhost:3000/">http://localhost:3000/</a> and you should see a simple welcome message - “Yo!”. Once you’re finished admiring the page, kill the server, and glance over the code within the project folder:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>├── client
│   ├── index.html
│   ├── main.js
│   └── partials
│       └── home.html
├── package.json
└── server
    ├── app.js
    ├── models
    │   └── user.js
    ├── routes
    │   └── api.js
    └── server.js
</code></pre></div></div>

<p>Nothing too spectacular. You can see that the back-end code resides in the “server” folder, while the front-end code lives in the “client” folder. Explore the files and folders within each.</p>

<h2 id="login-api">Login API</h2>

<p>Let’s start with the back-end API. This is already built out, for your convenience. Why? The focus of this tutorial is mainly on the client-side. If you’re looking for a back-end tutorial for setting up Passport with NodeJS, ExpressJS, and MongoDB take a look at this <a href="http://mherman.org/blog/2015/01/31/local-authentication-with-passport-and-express-4/#.VZCK9xNViko">tutorial</a>.</p>

<h3 id="user-registration">User Registration</h3>

<p>Open the “routes” folder and locate the following code:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/register'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">User</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="k">new</span> <span class="nx">User</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span> <span class="p">}),</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">account</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
        <span class="na">err</span><span class="p">:</span> <span class="nx">err</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s1">'local'</span><span class="p">)(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
        <span class="na">status</span><span class="p">:</span> <span class="s1">'Registration successful!'</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Here, we grab the values from the payload sent with the POST request (from the client-side), create a new <code class="highlighter-rouge">User</code> instance, and then attempt to add the instance to the database. If this succeeds a user is added, of course, and then we return a JSON response with a <code class="highlighter-rouge">status</code> of “success”. If it fails, an “error” response is sent.</p>

<p>Let’s test this via curl. Fire up the server, and then run the following command:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-H</span> <span class="s2">"Accept: application/json"</span> <span class="nt">-H</span> <span class="se">\</span>
<span class="s2">"Content-type: application/json"</span> <span class="nt">-X</span> POST <span class="se">\</span>
<span class="nt">-d</span> <span class="s1">'{"username": "test@test.com", "password": "test"}'</span> <span class="se">\</span>
http://localhost:3000/user/register
</code></pre></div></div>

<p>You should see a success message:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
  <span class="s2">"status"</span>: <span class="s2">"Registration successful!"</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Try it again, with the exact same username and password, and you should see an error:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
  <span class="s2">"err"</span>: <span class="o">{</span>
    <span class="s2">"name"</span>: <span class="s2">"UserExistsError"</span>,
    <span class="s2">"message"</span>: <span class="s2">"A user with the given username is already registered"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>On to the login…</p>

<h3 id="user-login">User Login</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s1">'local'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
        <span class="na">err</span><span class="p">:</span> <span class="nx">info</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">logIn</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
          <span class="na">err</span><span class="p">:</span> <span class="s1">'Could not log in user'</span>
        <span class="p">});</span>
      <span class="p">}</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
        <span class="na">status</span><span class="p">:</span> <span class="s1">'Login successful!'</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">})(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>This utilizes Passport’s <a href="https://github.com/jaredhanson/passport-local">local strategy</a> to verify the username/email as well as the password. The appropriate response is then returned.</p>

<p>With the server running, test again with curl-</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-H</span> <span class="s2">"Accept: application/json"</span> <span class="nt">-H</span> <span class="se">\</span>
<span class="s2">"Content-type: application/json"</span> <span class="nt">-X</span> POST <span class="se">\</span>
<span class="nt">-d</span> <span class="s1">'{"username": "test@test.com", "password": "test"}'</span> <span class="se">\</span>
http://localhost:3000/user/login
</code></pre></div></div>

<p>-and you should see:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
  <span class="s2">"message"</span>: <span class="s2">"Login successful!"</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Test again with curl, sending the wrong password, and you should see:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
  <span class="s2">"err"</span>: <span class="o">{</span>
    <span class="s2">"name"</span>: <span class="s2">"IncorrectPasswordError"</span>,
    <span class="s2">"message"</span>: <span class="s2">"Password or username are incorrect"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Perfect!</p>

<h3 id="user-logout">User Logout</h3>

<p>Finally, take a look at the logout:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/logout'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">logout</span><span class="p">();</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
    <span class="na">status</span><span class="p">:</span> <span class="s1">'Bye!'</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>This should be straightforward, and you can probably guess what the response will look like - but let’s test it again to be sure:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-H</span> <span class="s2">"Accept: application/json"</span> <span class="nt">-H</span> <span class="se">\</span>
<span class="s2">"Content-type: application/json"</span> <span class="nt">-X</span> GET <span class="se">\</span>
http://localhost:3000/user/logout
</code></pre></div></div>

<p>You should see:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
  <span class="s2">"status"</span>: <span class="s2">"Bye!"</span>
<span class="o">}</span>
</code></pre></div></div>

<p>On to the client-side!</p>

<h2 id="angular-app">Angular App</h2>

<p>Before diving in, remember that since end users have full access to the power of the browser as well as <a href="https://developer.chrome.com/devtools">DevTools</a> and the client-side code, it’s vital that you not only restrict access to sensitive endpoints on the server-side - but that you also do not store sensitive data on the client-side. Keep this in mind as you add auth functionality to your own MEAN application stack.</p>

<h3 id="client-side-routing">Client-side Routing</h3>

<p>Let’s add the remainder of the client-side routes to the <em>main.js</em> file:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">myApp</span><span class="p">.</span><span class="nx">config</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">$routeProvider</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$routeProvider</span>
    <span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'partials/home.html'</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'partials/login.html'</span><span class="p">,</span>
      <span class="na">controller</span><span class="p">:</span> <span class="s1">'loginController'</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/logout'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">controller</span><span class="p">:</span> <span class="s1">'logoutController'</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/register'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'partials/register.html'</span><span class="p">,</span>
      <span class="na">controller</span><span class="p">:</span> <span class="s1">'registerController'</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/one'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">template</span><span class="p">:</span> <span class="s1">'&lt;h1&gt;This is page one!&lt;/h1&gt;'</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/two'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">template</span><span class="p">:</span> <span class="s1">'&lt;h1&gt;This is page two!&lt;/h1&gt;'</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">otherwise</span><span class="p">({</span>
      <span class="na">redirectTo</span><span class="p">:</span> <span class="s1">'/'</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Here, we created five new routes. Before we add the subsequent templates and controllers, let’s create a <a href="https://code.angularjs.org/1.4.9/docs/guide/services">service</a> to handle authentication.</p>

<h3 id="authentication-service">Authentication Service</h3>

<p>Start by adding the basic structure of the service to a new file called <em>services.js</em> in the “client” directory:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'myApp'</span><span class="p">).</span><span class="nx">factory</span><span class="p">(</span><span class="s1">'AuthService'</span><span class="p">,</span>
  <span class="p">[</span><span class="s1">'$q'</span><span class="p">,</span> <span class="s1">'$timeout'</span><span class="p">,</span> <span class="s1">'$http'</span><span class="p">,</span>
  <span class="kd">function</span> <span class="p">(</span><span class="nx">$q</span><span class="p">,</span> <span class="nx">$timeout</span><span class="p">,</span> <span class="nx">$http</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// create user variable</span>
    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="c1">// return available functions for use in the controllers</span>
    <span class="k">return</span> <span class="p">({</span>
      <span class="na">isLoggedIn</span><span class="p">:</span> <span class="nx">isLoggedIn</span><span class="p">,</span>
      <span class="na">getUserStatus</span><span class="p">:</span> <span class="nx">getUserStatus</span><span class="p">,</span>
      <span class="na">login</span><span class="p">:</span> <span class="nx">login</span><span class="p">,</span>
      <span class="na">logout</span><span class="p">:</span> <span class="nx">logout</span><span class="p">,</span>
      <span class="na">register</span><span class="p">:</span> <span class="nx">register</span>
    <span class="p">});</span>

<span class="p">}]);</span>
</code></pre></div></div>

<p>Here, we simply defined the service name, <code class="highlighter-rouge">AuthService</code>, and then injected the dependencies that we will be using - <code class="highlighter-rouge">$q</code>, <code class="highlighter-rouge">$timeout</code>, <code class="highlighter-rouge">$http</code> - and then returned the functions, which we still need to write, for use outside the service.</p>

<p>Make sure to add the script to the <em>index.html</em> file:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"./services.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div>

<p>Let’s create each function…</p>

<p><strong><code class="highlighter-rouge">isLoggedIn()</code></strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">isLoggedIn</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This function returns <code class="highlighter-rouge">true</code> if <code class="highlighter-rouge">user</code> evaluates to <code class="highlighter-rouge">true</code> - a user is logged in - otherwise it returns false.</p>

<p><strong><code class="highlighter-rouge">getUserStatus()</code></strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">getUserStatus</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">user</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong><code class="highlighter-rouge">login()</code></strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">login</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// create a new instance of deferred</span>
  <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

  <span class="c1">// send a post request to the server</span>
  <span class="nx">$http</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/user/login'</span><span class="p">,</span>
    <span class="p">{</span><span class="na">username</span><span class="p">:</span> <span class="nx">username</span><span class="p">,</span> <span class="na">password</span><span class="p">:</span> <span class="nx">password</span><span class="p">})</span>
    <span class="c1">// handle success</span>
    <span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">status</span><span class="p">){</span>
        <span class="nx">user</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">user</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">})</span>
    <span class="c1">// handle error</span>
    <span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">user</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">();</span>
    <span class="p">});</span>

  <span class="c1">// return promise object</span>
  <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div></div>

<p>Here, we used the <a href="https://code.angularjs.org/1.4.9/docs/api/ng/service/$q">$q</a> service to set up a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">promise</a>, which we’ll access in a future controller. We also utilized the <a href="https://code.angularjs.org/1.4.9/docs/api/ng/service/$http">$http</a> service to send an AJAX request to the <code class="highlighter-rouge">/user/login</code> endpoint that we already set up in our back-end Node/Express app.</p>

<p>Based on the returned response, we either <a href="https://code.angularjs.org/1.4.9/docs/api/ng/service/$q#usage">resolve</a> or <a href="https://code.angularjs.org/1.4.9/docs/api/ng/service/$q#usage">reject</a> and set the value of <code class="highlighter-rouge">user</code> to <code class="highlighter-rouge">true</code> or <code class="highlighter-rouge">false</code>, respectively.</p>

<p><strong><code class="highlighter-rouge">logout()</code></strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">logout</span><span class="p">()</span> <span class="p">{</span>

  <span class="c1">// create a new instance of deferred</span>
  <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

  <span class="c1">// send a get request to the server</span>
  <span class="nx">$http</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/user/logout'</span><span class="p">)</span>
    <span class="c1">// handle success</span>
    <span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">user</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
    <span class="p">})</span>
    <span class="c1">// handle error</span>
    <span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">user</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">();</span>
    <span class="p">});</span>

  <span class="c1">// return promise object</span>
  <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div></div>

<p>Here, we followed the same formula as the <code class="highlighter-rouge">login()</code> function, except we sent a GET request rather than a POST and to be safe we just went ahead and handled the error the same as the success.</p>

<p><strong><code class="highlighter-rouge">register()</code></strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">register</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// create a new instance of deferred</span>
  <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

  <span class="c1">// send a post request to the server</span>
  <span class="nx">$http</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/user/register'</span><span class="p">,</span>
    <span class="p">{</span><span class="na">username</span><span class="p">:</span> <span class="nx">username</span><span class="p">,</span> <span class="na">password</span><span class="p">:</span> <span class="nx">password</span><span class="p">})</span>
    <span class="c1">// handle success</span>
    <span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">status</span><span class="p">){</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">})</span>
    <span class="c1">// handle error</span>
    <span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">();</span>
    <span class="p">});</span>

  <span class="c1">// return promise object</span>
  <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div></div>

<p>Again, we followed a similar formula to the <code class="highlighter-rouge">logout()</code> function. Can you tell what’s happening?</p>

<p>That’s it for the service. Keep in mind that we still have not “used” this service. In order to do that we just need to inject it into the necessary components in the Angular app. In our case, that will be the controllers, which we’ll build next.</p>

<h3 id="templates-and-controllers">Templates and Controllers</h3>

<p>Looking back at our routes, we need to setup two partials/templates and three controllers:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'partials/login.html'</span><span class="p">,</span>
  <span class="na">controller</span><span class="p">:</span> <span class="s1">'loginController'</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/logout'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">controller</span><span class="p">:</span> <span class="s1">'logoutController'</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/register'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'partials/register.html'</span><span class="p">,</span>
  <span class="na">controller</span><span class="p">:</span> <span class="s1">'registerController'</span>
<span class="p">})</span>
</code></pre></div></div>

<p><strong>Login</strong></p>

<p>First, add the following HTML to a new file called <em>login.html</em>:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-4"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Login<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">ng-show=</span><span class="s">"error"</span> <span class="na">class=</span><span class="s">"alert alert-danger"</span><span class="nt">&gt;</span>{{errorMessage}}<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"form"</span> <span class="na">ng-submit=</span><span class="s">"login()"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label&gt;</span>Username<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">ng-model=</span><span class="s">"loginForm.username"</span> <span class="na">required</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">ng-model=</span><span class="s">"loginForm.password"</span> <span class="na">required</span><span class="nt">&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"btn btn-default"</span> <span class="na">ng-disabled=</span><span class="s">"disabled"</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>Add this file to the “partials” directory.</p>

<p>Take note of the form. We used the <a href="https://code.angularjs.org/1.4.9/docs/api/ng/directive/ngModel">ng-model</a> directive on each of the inputs so that we can capture those values in the controller. Also, when the form is submitted, the <a href="https://code.angularjs.org/1.4.9/docs/api/ng/directive/ngSubmit">ng-submit</a> directive handles the event by firing the <code class="highlighter-rouge">login()</code> function.</p>

<p>Next, within the “client” folder, add a new file called <em>controllers.js</em>. Yes, this will hold all of our Angular app’s controllers. Don’t forget to add the script to the <em>index.html</em> file:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"./controllers.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div>

<p>Now, let’s add the first controller:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'myApp'</span><span class="p">).</span><span class="nx">controller</span><span class="p">(</span><span class="s1">'loginController'</span><span class="p">,</span>
  <span class="p">[</span><span class="s1">'$scope'</span><span class="p">,</span> <span class="s1">'$location'</span><span class="p">,</span> <span class="s1">'AuthService'</span><span class="p">,</span>
  <span class="kd">function</span> <span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$location</span><span class="p">,</span> <span class="nx">AuthService</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">$scope</span><span class="p">.</span><span class="nx">login</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

      <span class="c1">// initial values</span>
      <span class="nx">$scope</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">$scope</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

      <span class="c1">// call login from service</span>
      <span class="nx">AuthService</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">loginForm</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">loginForm</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span>
        <span class="c1">// handle success</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
          <span class="nx">$scope</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="nx">$scope</span><span class="p">.</span><span class="nx">loginForm</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">})</span>
        <span class="c1">// handle error</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="nx">$scope</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="nx">$scope</span><span class="p">.</span><span class="nx">errorMessage</span> <span class="o">=</span> <span class="s2">"Invalid username and/or password"</span><span class="p">;</span>
          <span class="nx">$scope</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="nx">$scope</span><span class="p">.</span><span class="nx">loginForm</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">});</span>

    <span class="p">};</span>

<span class="p">}]);</span>
</code></pre></div></div>

<p>So, when the <code class="highlighter-rouge">login()</code> function is fired, we set some initial values and then call <code class="highlighter-rouge">login()</code> from the <code class="highlighter-rouge">AuthService</code>, passing the user supplied email and password as arguments. The subsequent success or error is then handled and the DOM/view/template is updated appropriately.</p>

<p>Ready to test the first round-trip - <strong>client =&gt; server =&gt; client</strong>?</p>

<p>Fire up the server and navigate to <a href="http://localhost:3000/#/login">http://localhost:3000/#/login</a> in your browser. First, try logging in with the user credentials used to register earlier - e.g, <code class="highlighter-rouge">test@test.com</code> and <code class="highlighter-rouge">test</code>, respectively. If all went well, you should be redirected to the main URL. Next, try to log in using invalid credentials. You should see the error message flash, “Invalid username and/or password”.</p>

<p><strong>Logout</strong></p>

<p>Add the controller:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'myApp'</span><span class="p">).</span><span class="nx">controller</span><span class="p">(</span><span class="s1">'logoutController'</span><span class="p">,</span>
  <span class="p">[</span><span class="s1">'$scope'</span><span class="p">,</span> <span class="s1">'$location'</span><span class="p">,</span> <span class="s1">'AuthService'</span><span class="p">,</span>
  <span class="kd">function</span> <span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$location</span><span class="p">,</span> <span class="nx">AuthService</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">$scope</span><span class="p">.</span><span class="nx">logout</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

      <span class="c1">// call logout from service</span>
      <span class="nx">AuthService</span><span class="p">.</span><span class="nx">logout</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">);</span>
        <span class="p">});</span>

    <span class="p">};</span>

<span class="p">}]);</span>
</code></pre></div></div>

<p>Here, we called <code class="highlighter-rouge">AuthService.logout()</code> and then redirected the user to the <code class="highlighter-rouge">/login</code> route after the promise is resolved.</p>

<p>Add a button to <em>home.html</em>:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">ng-controller=</span><span class="s">"logoutController"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">ng-click=</span><span class="s">'logout()'</span> <span class="na">class=</span><span class="s">"btn btn-default"</span><span class="nt">&gt;</span>Logout<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>And then test it out again.</p>

<p><strong>Register</strong></p>

<p>Add a new new file called <em>register.html</em> to the “partials” folder and add the following HTML:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-4"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Register<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">ng-show=</span><span class="s">"error"</span> <span class="na">class=</span><span class="s">"alert alert-danger"</span><span class="nt">&gt;</span>{{errorMessage}}<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"form"</span> <span class="na">ng-submit=</span><span class="s">"register()"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label&gt;</span>Username<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">ng-model=</span><span class="s">"registerForm.username"</span> <span class="na">required</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">ng-model=</span><span class="s">"registerForm.password"</span> <span class="na">required</span><span class="nt">&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"btn btn-default"</span> <span class="na">ng-disabled=</span><span class="s">"disabled"</span><span class="nt">&gt;</span>Register<span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>Next, add the controller:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'myApp'</span><span class="p">).</span><span class="nx">controller</span><span class="p">(</span><span class="s1">'registerController'</span><span class="p">,</span>
  <span class="p">[</span><span class="s1">'$scope'</span><span class="p">,</span> <span class="s1">'$location'</span><span class="p">,</span> <span class="s1">'AuthService'</span><span class="p">,</span>
  <span class="kd">function</span> <span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$location</span><span class="p">,</span> <span class="nx">AuthService</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">$scope</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

      <span class="c1">// initial values</span>
      <span class="nx">$scope</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">$scope</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

      <span class="c1">// call register from service</span>
      <span class="nx">AuthService</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">registerForm</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">registerForm</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span>
        <span class="c1">// handle success</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">);</span>
          <span class="nx">$scope</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="nx">$scope</span><span class="p">.</span><span class="nx">registerForm</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">})</span>
        <span class="c1">// handle error</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="nx">$scope</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="nx">$scope</span><span class="p">.</span><span class="nx">errorMessage</span> <span class="o">=</span> <span class="s2">"Something went wrong!"</span><span class="p">;</span>
          <span class="nx">$scope</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
          <span class="nx">$scope</span><span class="p">.</span><span class="nx">registerForm</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">});</span>

    <span class="p">};</span>

<span class="p">}]);</span>
</code></pre></div></div>

<p>You’ve seen this before, so let’s move right on to testing.</p>

<p>Fire up the server and register a new user at <a href="http://localhost:3000/#/register">http://localhost:3000/#/register</a>. Make sure to test logging in with that new user as well.</p>

<p>Well, that’s it for the templates and controllers. We now need to add in functionality to check if a user is logged in on each and every change of route.</p>

<h3 id="route-changes">Route Changes</h3>

<p>Start by adding the following code to <em>main.js</em>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">myApp</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">$rootScope</span><span class="p">,</span> <span class="nx">$location</span><span class="p">,</span> <span class="nx">$route</span><span class="p">,</span> <span class="nx">AuthService</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$on</span><span class="p">(</span><span class="s1">'$routeChangeStart'</span><span class="p">,</span>
    <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">current</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">AuthService</span><span class="p">.</span><span class="nx">isLoggedIn</span><span class="p">()</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>The <a href="https://code.angularjs.org/1.4.9/docs/api/ngRoute/service/$route">$routeChangeStart</a> event fires before the actual route change occurs. So, whenever a route is accessed, before the view is served, we ensure that the user is logged in. Test this out!</p>

<h2 id="route-restriction">Route Restriction</h2>

<p>Right now all client-side routes require a user to be logged in. What if you want certain routes restricted and other routes open?</p>

<p>You can add the following code to each route handler, replacing <code class="highlighter-rouge">true</code> with <code class="highlighter-rouge">false</code> for routes that you do not want to restrict:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">access</span><span class="p">:</span> <span class="p">{</span><span class="nl">restricted</span><span class="p">:</span> <span class="kc">true</span><span class="p">}</span>
</code></pre></div></div>

<p>For example:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">myApp</span><span class="p">.</span><span class="nx">config</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">$routeProvider</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$routeProvider</span>
    <span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'partials/home.html'</span><span class="p">,</span>
      <span class="na">access</span><span class="p">:</span> <span class="p">{</span><span class="na">restricted</span><span class="p">:</span> <span class="kc">true</span><span class="p">}</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'partials/login.html'</span><span class="p">,</span>
      <span class="na">controller</span><span class="p">:</span> <span class="s1">'loginController'</span><span class="p">,</span>
      <span class="na">access</span><span class="p">:</span> <span class="p">{</span><span class="na">restricted</span><span class="p">:</span> <span class="kc">false</span><span class="p">}</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/logout'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">controller</span><span class="p">:</span> <span class="s1">'logoutController'</span><span class="p">,</span>
      <span class="na">access</span><span class="p">:</span> <span class="p">{</span><span class="na">restricted</span><span class="p">:</span> <span class="kc">true</span><span class="p">}</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/register'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'partials/register.html'</span><span class="p">,</span>
      <span class="na">controller</span><span class="p">:</span> <span class="s1">'registerController'</span><span class="p">,</span>
      <span class="na">access</span><span class="p">:</span> <span class="p">{</span><span class="na">restricted</span><span class="p">:</span> <span class="kc">false</span><span class="p">}</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/one'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">template</span><span class="p">:</span> <span class="s1">'&lt;h1&gt;This is page one!&lt;/h1&gt;'</span><span class="p">,</span>
      <span class="na">access</span><span class="p">:</span> <span class="p">{</span><span class="na">restricted</span><span class="p">:</span> <span class="kc">true</span><span class="p">}</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/two'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">template</span><span class="p">:</span> <span class="s1">'&lt;h1&gt;This is page two!&lt;/h1&gt;'</span><span class="p">,</span>
      <span class="na">access</span><span class="p">:</span> <span class="p">{</span><span class="na">restricted</span><span class="p">:</span> <span class="kc">false</span><span class="p">}</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">otherwise</span><span class="p">({</span>
      <span class="na">redirectTo</span><span class="p">:</span> <span class="s1">'/'</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Now just update the <code class="highlighter-rouge">$routeChangeStart</code> code in <em>main.js</em>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">myApp</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">$rootScope</span><span class="p">,</span> <span class="nx">$location</span><span class="p">,</span> <span class="nx">$route</span><span class="p">,</span> <span class="nx">AuthService</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$on</span><span class="p">(</span><span class="s1">'$routeChangeStart'</span><span class="p">,</span>
  <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">current</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">next</span><span class="p">.</span><span class="nx">access</span><span class="p">.</span><span class="nx">restricted</span> <span class="o">&amp;&amp;</span> <span class="nx">AuthService</span><span class="p">.</span><span class="nx">isLoggedIn</span><span class="p">()</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">);</span>
      <span class="nx">$route</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Test it out!</p>

<h2 id="persistent-login">Persistent Login</h2>

<p>Finally, what happens on a page refresh? Try it.</p>

<p>The user is logged out, right? Why? Because the controller and services are called again, setting the <code class="highlighter-rouge">user</code> variable to <code class="highlighter-rouge">null</code>. This is a problem since the user is still logged in on the server side.</p>

<p>Fortunately, the fix is simple: Within the <code class="highlighter-rouge">$routeChangeStart</code> we need to ALWAYS check if a user is logged in. Right now, it’s checking whether <code class="highlighter-rouge">isLoggedIn()</code> is <code class="highlighter-rouge">false</code>. Let’s update <code class="highlighter-rouge">getUserStatus()</code> so that it checks the user status on the back-end:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">getUserStatus</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">$http</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/user/status'</span><span class="p">)</span>
  <span class="c1">// handle success</span>
  <span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">status</span><span class="p">){</span>
      <span class="nx">user</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">user</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="c1">// handle error</span>
  <span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then add the route handler:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/status'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
      <span class="na">status</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
    <span class="na">status</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Finally, update the <code class="highlighter-rouge">$routeChangeStart</code>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">myApp</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">$rootScope</span><span class="p">,</span> <span class="nx">$location</span><span class="p">,</span> <span class="nx">$route</span><span class="p">,</span> <span class="nx">AuthService</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$on</span><span class="p">(</span><span class="s1">'$routeChangeStart'</span><span class="p">,</span>
    <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">current</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">AuthService</span><span class="p">.</span><span class="nx">getUserStatus</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">next</span><span class="p">.</span><span class="nx">access</span><span class="p">.</span><span class="nx">restricted</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">AuthService</span><span class="p">.</span><span class="nx">isLoggedIn</span><span class="p">()){</span>
          <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">);</span>
          <span class="nx">$route</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Try it out!</p>

<h2 id="conclusion">Conclusion</h2>

<p>That’s it. One thing you should note is that the Angular app can be used with various frameworks as long as the endpoints are set up correctly in the AJAX requests. So, you can easily take the Angular portion and add it to your Django or Pyramid or NodeJS app. Try it!</p>

<blockquote>
  <p>Check out a Python/Flask app with Angular Auth <a href="https://realpython.com/blog/python/handling-user-authentication-with-angular-and-flask/">here</a></p>
</blockquote>

<p>Grab the final code from the <a href="https://github.com/mjhea0/mean-auth">repo</a>. Cheers!</p>

  </div>

  <!-- addthis -->
  
    <div class="sharing">
  <br>
  <!-- AddThis Button BEGIN -->
  <div class="addthis_toolbox addthis_default_style addthis_32x32_style">
    <a class="addthis_button_preferred_1"></a>
    <a class="addthis_button_preferred_2"></a>
    <a class="addthis_button_preferred_3"></a>
    <a class="addthis_button_preferred_4"></a>
    <a class="addthis_button_compact"></a>
    <a class="addthis_counter addthis_bubble_style"></a>
  </div>
  <script type="text/javascript">var addthis_config = {"data_track_addressbar":false};</script>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-50e5f1cc35ad077d"></script>
  <!-- AddThis Button END -->
  <br>
</div>

  

  <!-- disqus -->
  
    <div id="disqus_thread"></div>

<script>
  var disqus_config = function () {
    this.page.url = 'https://mherman.org/blog/handling-user-authentication-with-the-mean-stack/';
    this.page.identifier = 'https://mherman.org/blog/handling-user-authentication-with-the-mean-stack/';
  };

  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//' + 'michaelherman' + '.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  


</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      




<div>
  <hr>
  <p>
    <span>Copyright &copy; 2019 - Michael Herman</span>
    <br>
    <small>Questions? michael at mherman dot org</small><br>
    <small><a href="#">Back to top</a></small>
    <br>
    <span>
      <a href="https://github.com/mjhea0"><i class="fa fa-github-square" style="font-size:2em" aria-hidden="true"></i></a>
      <a href="https://twitter.com/mikeherman"><i class="fa fa-twitter-square" style="font-size:2em" aria-hidden="true"></i></a>
      <a href="https://www.linkedin.com/in/mjhea0/"><i class="fa fa-linkedin-square" style="font-size:2em" aria-hidden="true"></i></a>
      <a href="https://www.youtube.com/hermanmu"><i class="fa fa-youtube-square" style="font-size:2em" aria-hidden="true"></i></a>
    </span>
  </p>
</div>

    </p>

  </div>

</footer>


  </body>

  <script type="text/javascript" src="/assets/hello.js"></script>

</html>
