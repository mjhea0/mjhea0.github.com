<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Meteor.js in Action: Create an App, Test with Laika</title>
  <meta name="description" content="">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/blog/2014/01/29/meteor-dot-js-in-action-create-an-app-test-with-laika/">
  
  
  <link rel="alternate" type="application/rss+xml" title="Michael Herman" href="http://localhost:4000/feed.xml">

  <link rel="icon" type="image/png" href="/favicon.png">


  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Meteor.js in Action: Create an App, Test with Laika">
  <meta name="twitter:description" content="">
  
  

  <script type="text/javascript">
  WebFontConfig = {
    google: { families: [ 'Bitter:400,700,400italic:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  
</head>


  <link rel="stylesheet" href="/assets/hello.css">

  <body>

    <header class="site-header">

  <div class="color-bar">
    <div class="bar bar1"></div>
    <div class="bar bar2"></div>
    <div class="bar bar3"></div>
    <div class="bar bar4"></div>
    <div class="bar bar5"></div>
    <div class="bar bar6"></div>
  </div>

  <div class="wrapper">

    <a class="site-title" href="/">Michael Herman</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/">Blog</a>
      
        
        <a class="page-link" href="/about">About</a>
      
        
        <a class="page-link" href="/talks">Talks</a>
      
        
        <a class="page-link" href="/feed.xml">RSS</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Meteor.js in Action: Create an App, Test with Laika</h1>
    
    <p class="post-meta"><time datetime="2014-01-29T10:51:00-07:00" itemprop="datePublished">Jan 29, 2014</time> • 
  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/meteor/">meteor</a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <div style="text-align:center;">
  <img src="/assets/img/blog/meteor.jpeg" style="max-width: 100%; border:0; box-shadow: none;" alt="meteor" />
</div>

<p><br /></p>

<p>Meteor is a next generation framework used for rapidly developing web apps, which seamlessly combines popular packages like MongoDB, Node.js, and jQuery, to name a few.</p>

<p>Check out the excellent Meteor <a href="http://docs.meteor.com/">documentation</a> for more information. Grab the code from the repo <a href="https://github.com/mjhea0/meteor-in-action">here</a>.</p>

<p><strong>Please note: Before you can follow this tutorial, please install <a href="http://nodejs.org/download/">Node and npm</a>.</strong></p>

<p>With that, let’s start building …</p>

<blockquote>
  <p>This tutorial uses Meteor version <code class="highlighter-rouge">0.7.0.1</code> - which, as of writing, is the latest version</p>
</blockquote>

<h2 class="no_toc" id="contents">Contents</h2>

<ul id="markdown-toc">
  <li><a href="#setup-a-project" id="markdown-toc-setup-a-project">Setup a Project</a></li>
  <li><a href="#create-a-basic-app" id="markdown-toc-create-a-basic-app">Create a Basic App</a></li>
  <li><a href="#restructure" id="markdown-toc-restructure">Restructure</a></li>
  <li><a href="#testing-framework" id="markdown-toc-testing-framework">Testing Framework</a></li>
  <li><a href="#users-can-submit-answers" id="markdown-toc-users-can-submit-answers">Users can submit answers</a></li>
  <li><a href="#users-can-see-all-submitted-answers" id="markdown-toc-users-can-see-all-submitted-answers">Users can see all submitted answers</a></li>
  <li><a href="#users-can-up-or-down-vote-answers" id="markdown-toc-users-can-up-or-down-vote-answers">Users can up or down vote answers</a></li>
  <li><a href="#users-can-login-via-twitter" id="markdown-toc-users-can-login-via-twitter">Users can login via Twitter</a></li>
  <li><a href="#users-can-only-answer-or-vote-if-they-are-logged-in" id="markdown-toc-users-can-only-answer-or-vote-if-they-are-logged-in">Users can only answer or vote if they are logged in</a></li>
  <li><a href="#remove-insecure-packages" id="markdown-toc-remove-insecure-packages">Remove insecure packages</a></li>
  <li><a href="#deployment" id="markdown-toc-deployment">Deployment</a></li>
  <li><a href="#whats-next" id="markdown-toc-whats-next">What’s next?</a></li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ul>

<p><a id="setup"></a></p>

<h2 id="setup-a-project">Setup a Project</h2>

<h4 id="1-install-meteor-and-the-meteor-package-manager-meteorite">1. Install Meteor and the Meteor Package Manager, <a href="https://github.com/oortcloud/meteorite">Meteorite</a>:</h4>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl https://install.meteor.com/ | sh
<span class="nv">$ </span>meteor update
<span class="nv">$ </span>npm install <span class="nt">-g</span> meteorite
</code></pre></div></div>

<blockquote>
  <p>Alternatively, you can install meteor with npm, <code class="highlighter-rouge">npm install -g meteor</code>), however the npm package is not uploaded or maintained by Meteor Development Group</p>
</blockquote>

<h4 id="2-create-a-meteor-project">2. Create a Meteor project:</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>meteor create mymeteor
</code></pre></div></div>

<p>Look! It tells you exactly what to do:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>To run your new app:
   <span class="nb">cd </span>mymeteor
   meteor
</code></pre></div></div>

<p>Go ahead and run it:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd </span>mymeteor
<span class="nv">$ </span>meteor
<span class="o">[[[[[</span> ~/Desktop/mymeteor <span class="o">]]]]]</span>

<span class="o">=&gt;</span> Meteor server running on: http://localhost:3000/
</code></pre></div></div>

<p>We just initialized the Meteor server. Navigate to [http://localhost:3000/]
(http://localhost:3000/), and you should see:</p>

<p><img src="https://raw.githubusercontent.com/mjhea0/meteor-in-action/master/images/helloworld.png" alt="helloworld" /></p>

<p>If port 3000 is unavailable, you can use <code class="highlighter-rouge">–port</code> as an option:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>meteor <span class="nt">--port</span> 1337
</code></pre></div></div>

<p>Leave the app running. The browser will automatically update as you save changes to your code.</p>

<h5 id="whats-going-on-here">What’s going on here?</h5>

<p>Look at your basic project structure:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
├── mymeteor.css
├── mymeteor.html
└── mymeteor.js
</code></pre></div></div>

<p>Your JS file contains both client and server code:</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// client!</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">isClient</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Template</span><span class="p">.</span><span class="nx">hello</span><span class="p">.</span><span class="nx">greeting</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">"Welcome to mymeteor."</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="nx">Template</span><span class="p">.</span><span class="nx">hello</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
      <span class="s1">'click input'</span> <span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="c1">// template data, if any, is available in 'this'</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">console</span> <span class="o">!==</span> <span class="s1">'undefined'</span><span class="p">)</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"You pressed the button"</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// server!</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">isServer</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">startup</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="c1">// code to run on server at startup</span>
    <span class="p">});</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>The behavior of <code class="highlighter-rouge">{{greeting}}</code> in the HTML file is controlled by <code class="highlighter-rouge">Template</code> within the client-side code in the JS file, as well as the handling of events.</p>

<p><a id="create"></a></p>

<h2 id="create-a-basic-app">Create a Basic App</h2>

<p>In this example, we’ll be creating an app, which displays a question with a list of answers. Users can -</p>

<ol>
  <li>Submit answers</li>
  <li>See all submitted answers</li>
  <li>Up or down vote answers</li>
  <li>Login via Twitter</li>
  <li>Only answer or vote if they are logged in</li>
  <li>View question but not submitted answers without logging in</li>
</ol>

<p>Before we start adding this functionality, let’s first restructure the project.</p>

<p><a id="restructure"></a></p>

<h2 id="restructure">Restructure</h2>

<h4 id="1-add-packages-err-smart-packages">1. Add Packages (err Smart Packages!)</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mrt add accounts-ui
accounts-ui: Simple templates to add login widgets to an app
<span class="nv">$ </span>mrt add accounts-twitter
accounts-twitter: Login service <span class="k">for </span>Twitter accounts
<span class="nv">$ </span>mrt add bootstrap-3
bootstrap-3: Provides bootstrap 3.
</code></pre></div></div>

<p>Watch your browser as you add these. You should see the styles update almost immediately.</p>

<p>You can read more about these packages <a href="http://docs.meteor.com/#accountsui">here</a>, <a href="http://docs.meteor.com/#accounts_api">here</a>, <a href="https://github.com/mangasocial/meteor-bootstrap-3">here</a>. It’s pretty awesome that you can add these web components in just a matter of minutes! Awesome for prototyping!</p>

<blockquote>
  <p>You can view the available packages from the terminal by running the command - <code class="highlighter-rouge">meteor list</code></p>
</blockquote>

<h4 id="2-add-client-and-server-folders">2. Add client and server folders</h4>

<p>Add two new folders - “client” and “server”. Essentially, if Meteor detects a client folder, all the JavaScript within the folder will be run on the client-side, while JavaScript code found within the server folder will run only on the server-side.</p>

<p>Within the client folder, create a file called “mainClient.js” and add the following code:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">isClient</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Template</span><span class="p">.</span><span class="nx">hello</span><span class="p">.</span><span class="nx">greeting</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">"Welcome to mymeteor."</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">Template</span><span class="p">.</span><span class="nx">hello</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
    <span class="s1">'click input'</span> <span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="c1">// template data, if any, is available in 'this'</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">console</span> <span class="o">!==</span> <span class="s1">'undefined'</span><span class="p">)</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"You pressed the button"</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then within the server folder, and a file called “mainServer.js” and add the following code:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">isServer</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Meteor</span><span class="p">.</span><span class="nx">startup</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// code to run on server at startup</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Delete the “mymeteor.js” file. If you look at your browser, everything should look the same. Add one more folder called “tests”, which as you probably guessed will include our unit tests along with a file called “index.js”.</p>

<p>Your project structure should now look like this:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
├── client
│   └── mainClient.js
├── mymeteor.css
├── mymeteor.html
├── server
│   └── mainServer.js
└── tests
    └── index.js

</code></pre></div></div>

<h4 id="3-update-html">3. Update HTML</h4>

<p>Update “mymeteor.html”:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"description"</span> <span class="na">content=</span><span class="s">""</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"author"</span> <span class="na">content=</span><span class="s">""</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>One Question. Several Answers.<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">href=</span><span class="s">"http://netdna.bootstrapcdn.com/bootswatch/3.0.3/yeti/bootstrap.min.css"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    {{&gt; hello}}
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"hello"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Hello World!<span class="nt">&lt;/h1&gt;</span>
  {{greeting}}
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">value=</span><span class="s">"Click"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/template&gt;</span>
</code></pre></div></div>

<p>Your app should now look like this:</p>

<p><img src="https://raw.githubusercontent.com/mjhea0/meteor-in-action/master/images/helloworld-redux.png" alt="helloworld-redux" /></p>

<p><a id="test"></a></p>

<h2 id="testing-framework">Testing Framework</h2>

<p>Since both client and server code are interconnected, we want to be able to write test cases that target both the client and server. <a href="http://arunoda.github.io/laika/">Laika</a> is by far the best framework for this.</p>

<p>For this reason, your tests will run bit slower.</p>

<p>Before installing Laika, make sure you have <a href="http://nodejs.org/">Node.js</a>, <a href="http://phantomjs.org/download.html">PhantomJS</a>, and <a href="http://docs.mongodb.org/manual/installation/">MongoDB</a> installed. Also, run <a href="http://docs.mongodb.org/v2.2/reference/mongod/"><code class="highlighter-rouge">mongod</code></a> in a separate terminal window.</p>

<p>Install Laika:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>npm install <span class="nt">-g</span> laika
</code></pre></div></div>
<p>All of our tests will reside in the “index.js” file within the “tests” folder.</p>

<p>Now let’s start building.</p>

<p><a id="submit"></a></p>

<h2 id="users-can-submit-answers">Users can submit answers</h2>

<h4 id="1-client-js">1. Client JS</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Answers</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s2">"answers"</span><span class="p">);</span>

<span class="nx">Template</span><span class="p">.</span><span class="nx">addAnswer</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
  <span class="s1">'click input.add-answer'</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">answerText</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"answerText"</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">"addAnswer"</span><span class="p">,</span><span class="nx">answerText</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span> <span class="p">,</span> <span class="nx">answerId</span><span class="p">){</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Added answer with ID: '</span><span class="o">+</span><span class="nx">answerId</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"answerText"</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>
<h5 id="whats-going-on">What’s going on?</h5>

<p>First, we have a click event, which grabs the value from the input box. This value is then passed to the server side via the <a href="http://docs.meteor.com/#meteor_call"><code class="highlighter-rouge">.call()</code></a> - which is used to invoke a method. <code class="highlighter-rouge">answerId</code> is then the call back, which is then assigned to the console.log.</p>

<h4 id="1-server-js">1. Server JS</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Answers</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s2">"answers"</span><span class="p">);</span>

<span class="nx">Meteor</span><span class="p">.</span><span class="nx">methods</span><span class="p">({</span>
  <span class="na">addAnswer</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">answerText</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Adding Answer ...'</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">answerId</span> <span class="o">=</span> <span class="nx">Answers</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
      <span class="s1">'answerText'</span> <span class="p">:</span> <span class="nx">answerText</span><span class="p">,</span>
      <span class="s1">'submittedOn'</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="p">});</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">answerId</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">answerId</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h5 id="whats-going-on-1">What’s going on?</h5>

<p>On the client side we passed the <code class="highlighter-rouge">answerText</code> - inputted value - to the server side. This answer is the added to the MongoDB collection, then we return the answerID, which is handled on the client side.</p>

<p>Notice how we established the Mongo collection on both the client and server.</p>

<h4 id="3-html">3. HTML</h4>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"description"</span> <span class="na">content=</span><span class="s">""</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"author"</span> <span class="na">content=</span><span class="s">""</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>One Question. Several Answers.<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">href=</span><span class="s">"http://netdna.bootstrapcdn.com/bootswatch/3.0.3/yeti/bootstrap.min.css"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Add an answer. Or vote.<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;h3&gt;&lt;em&gt;</span>Question<span class="nt">&lt;/em&gt;</span>: Is the world getting warmer?<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;div&gt;</span>
      <span class="c">&lt;!-- if there is an answer, append it to the DOM --&gt;</span>
      {{&gt; addAnswer}}
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"addAnswer"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;textarea</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">rows=</span><span class="s">"3"</span> <span class="na">name=</span><span class="s">"answerText"</span> <span class="na">id=</span><span class="s">"answerText"</span> <span class="na">placeholder=</span><span class="s">"Add Your Answer .."</span><span class="nt">&gt;&lt;/textarea&gt;</span>
  <span class="nt">&lt;br&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"btn-primary add-answer btn-md"</span> <span class="na">value=</span><span class="s">"Add Answer"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/template&gt;</span>
</code></pre></div></div>

<h4 id="4-manually-test">4. Manually Test</h4>

<p>First, your browser view should now look like this:</p>

<p><img src="https://raw.githubusercontent.com/mjhea0/meteor-in-action/master/images/part1.png" alt="part1" /></p>

<p>Next, arrange your screen so that you can view both your terminal as well as your browser. Also, open up the JS debug console:</p>

<p><img src="https://raw.githubusercontent.com/mjhea0/meteor-in-action/master/images/part1-2.png" alt="part1-2" /></p>

<p>Then, just like in the screenshot above, add an answer. On the client side, you should see the MongoDB ID - i.e., <code class="highlighter-rouge">Added answer with ID: ECrTqRQha7vpXu78q</code>, which should match the ID on the server side:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>I20140114-07:38:27.061<span class="o">(</span><span class="nt">-7</span><span class="o">)</span>? Adding Answer ...
I20140114-07:38:27.340<span class="o">(</span><span class="nt">-7</span><span class="o">)</span>? ECrTqRQha7vpXu78q
</code></pre></div></div>

<p><strong>Want to see something cool?</strong> Of course you do.</p>

<p>Open up your browser’s console. Let’s add an answer:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> Answers.insert<span class="o">({</span>answerText: <span class="s1">'Client Side Console Test!'</span><span class="o">})</span><span class="p">;</span>
<span class="s2">"3D9nQYn87gXQX66ha"</span>
</code></pre></div></div>
<p>You should see the answer appear on the page instantly!!</p>

<h4 id="5-automated-test">5. Automated Test</h4>

<p>Now, add a Laika test by adding the following code to “index.js”:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'use strict'</span>

<span class="kd">var</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'assert'</span><span class="p">);</span>

<span class="nx">suite</span><span class="p">(</span><span class="s1">'submitAnswers'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="c1">// ensure that -</span>
  <span class="c1">// (1) the "Answers" collection exists</span>
  <span class="c1">// (2) we can connect to the collection</span>
  <span class="c1">// (3) the collection is empty</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">'server initialization'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">,</span> <span class="nx">server</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">server</span><span class="p">.</span><span class="kr">eval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">Answers</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">fetch</span><span class="p">();</span>
      <span class="nx">emit</span><span class="p">(</span><span class="s1">'collection'</span><span class="p">,</span> <span class="nx">collection</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">once</span><span class="p">(</span><span class="s1">'collection'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="c1">// ensure that -</span>
  <span class="c1">// (1) we can add data to the collection</span>
  <span class="c1">// (2) after data is added, we can retrieve it</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">'server insert : OK'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">,</span> <span class="nx">server</span><span class="p">,</span> <span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">server</span><span class="p">.</span><span class="kr">eval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">Answers</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">answerText</span><span class="p">:</span> <span class="s2">"whee!"</span>  <span class="p">});</span>
      <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">Answers</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">fetch</span><span class="p">();</span>
      <span class="nx">emit</span><span class="p">(</span><span class="s1">'collection'</span><span class="p">,</span> <span class="nx">collection</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">once</span><span class="p">(</span><span class="s1">'collection'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">'collection'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">Answers</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">fetch</span><span class="p">().</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>

<span class="p">});</span>
</code></pre></div></div>

<h5 id="whats-going-on-here-1">What’s going on here?</h5>

<p>Basically, we are just testing that the Answers collection exists and is accessible. See the inline comments for more info.</p>

<p>You may have noticed that Laika runs a bit slow. Well, that’s normal - because Laika creates a new, isolated app and database for each test, and each test is also isolated for the other, so you don’t have to worry about dumping the database after each test.</p>

<h5 id="run-the-test">Run the test</h5>

<p>If all goes well, you should see this:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>laika

  injecting laika...
  loading phantomjs...
  loading initial app pool...


  submitAnswers
    ✓ server initialization <span class="o">(</span>1517ms<span class="o">)</span>
    ✓ server insert : OK


  2 passing <span class="o">(</span>2s<span class="o">)</span>

  cleaning up injected code
</code></pre></div></div>

<p>Congrats! You just wrote your first test!</p>

<blockquote>
  <p>If you have not initialized a Git repo yet, go ahead and do this now. Then commit the code.</p>
</blockquote>

<p><a id="submitted"></a></p>

<h2 id="users-can-see-all-submitted-answers">Users can see all submitted answers</h2>

<h4 id="1-client-js-1">1. Client JS</h4>

<p>Add the following template to pull out the data from the collection and sort in descending order.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="nx">Answers</span><span class="p">.</span><span class="nx">find</span><span class="p">({},{</span><span class="na">sort</span><span class="p">:{</span><span class="s1">'submittedOn'</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">}});</span>
</code></pre></div></div>
<h4 id="2-html">2. HTML</h4>

<p>Add the templates to the HTML file:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"description"</span> <span class="na">content=</span><span class="s">""</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"author"</span> <span class="na">content=</span><span class="s">""</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>One Question. Several Answers.<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">href=</span><span class="s">"http://netdna.bootstrapcdn.com/bootswatch/3.0.3/yeti/bootstrap.min.css"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Add an answer. Or vote.<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;h3&gt;&lt;em&gt;</span>Question<span class="nt">&lt;/em&gt;</span>: Is the world getting warmer?<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;div&gt;</span>
      <span class="c">&lt;!-- if there is an answer, append it to the DOM --&gt;</span>
      {{&gt; addAnswer}}
      {{&gt; answers}}
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"addAnswer"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;textarea</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">rows=</span><span class="s">"3"</span> <span class="na">name=</span><span class="s">"answerText"</span> <span class="na">id=</span><span class="s">"answerText"</span> <span class="na">placeholder=</span><span class="s">"Add Your Answer .."</span><span class="nt">&gt;&lt;/textarea&gt;</span>
  <span class="nt">&lt;br&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"btn-primary add-answer btn-md"</span> <span class="na">value=</span><span class="s">"Add Answer"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/template&gt;</span>

<span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"answers"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;br&gt;</span>
  <span class="nt">&lt;br&gt;</span>
  <span class="nt">&lt;h2&gt;</span>All Questions<span class="nt">&lt;/h2&gt;</span>
  {{#each items}}
    {{&gt; answer}}
  {{/each}}
<span class="nt">&lt;/template&gt;</span>

<span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"answer"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"lead"</span><span class="nt">&gt;</span>
      {{answerText}}
      <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span>
</code></pre></div></div>

<h4 id="3-manually-test">3. Manually Test</h4>

<p>You should see all of the submitted answers:</p>

<p><img src="https://raw.githubusercontent.com/mjhea0/meteor-in-action/master/images/part2.png" alt="part2" /></p>

<p>Go ahead and add new answers. They should immediately appear.</p>

<p>As far as automated testing goes, we are already testing this with this code:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">client</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">'collection'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">Answers</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">fetch</span><span class="p">().</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="nx">done</span><span class="p">();</span>
</code></pre></div></div>

<p>Commit your code.</p>

<p><a id="vote"></a></p>

<h2 id="users-can-up-or-down-vote-answers">Users can up or down vote answers</h2>

<p>Let’s add some voting capabilities. Think about what we need to add for this.</p>

<ol>
  <li>Update collection to store votes</li>
  <li>Update HTML to add vote buttons</li>
  <li>Event handler for when the user clicks a button so that the collection is updated</li>
</ol>

<h4 id="1-server-js-1">1. Server JS</h4>

<p>Add the following code:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">incrementYesVotes</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">answerID</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">answerID</span><span class="p">);</span>
  <span class="nx">Answers</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">answerID</span><span class="p">,{</span><span class="na">$inc</span> <span class="p">:</span> <span class="p">{</span><span class="s1">'yes'</span><span class="p">:</span><span class="mi">1</span><span class="p">}});</span>
<span class="p">},</span>
<span class="na">incrementNoVotes</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">answerID</span><span class="p">){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">answerID</span><span class="p">);</span>
  <span class="nx">Answers</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">answerID</span><span class="p">,{</span><span class="na">$inc</span> <span class="p">:</span> <span class="p">{</span><span class="s1">'no'</span><span class="p">:</span><span class="mi">1</span><span class="p">}});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This utilizes Meteor’s collection update to increment the counter.</p>

<h4 id="2-client-js">2. Client JS</h4>

<p>Add the event handler:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Template</span><span class="p">.</span><span class="nx">answer</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
  <span class="s1">'click'</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">Session</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="s2">"selected_answer"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="s1">'click a.yes'</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">answerId</span> <span class="o">=</span> <span class="nx">Session</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'selected_answer'</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'updating yes count for answerId '</span><span class="o">+</span><span class="nx">answerId</span><span class="p">);</span>
    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">"incrementYesVotes"</span><span class="p">,</span><span class="nx">answerId</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="s1">'click a.no'</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">answerId</span> <span class="o">=</span> <span class="nx">Session</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'selected_answer'</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'updating no count for answerId '</span><span class="o">+</span><span class="nx">answerId</span><span class="p">);</span>
    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">"incrementNoVotes"</span><span class="p">,</span><span class="nx">answerId</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h4 id="3-html-1">3. HTML</h4>

<p>Update the <code class="highlighter-rouge">answer</code> template:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"answer"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"lead"</span><span class="nt">&gt;</span>
      {{answerText}}
      <span class="nt">&lt;br&gt;</span>
      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"btn btn-xs btn-success yes"</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;&lt;i</span> <span class="na">class=</span><span class="s">"icon-thumbs-up"</span><span class="nt">&gt;&lt;/i&gt;</span> Yes {{yes}}<span class="nt">&lt;/a&gt;</span>
      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"btn btn-xs btn-primary no"</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;&lt;i</span> <span class="na">class=</span><span class="s">"icon-thumbs-down"</span><span class="nt">&gt;&lt;/i&gt;</span> No {{no}}<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span>
</code></pre></div></div>

<h4 id="3-manually-test-1">3. Manually Test</h4>

<p>You should see Yes and No buttons below the answers:</p>

<p><img src="https://raw.githubusercontent.com/mjhea0/meteor-in-action/master/images/part3.png" alt="part3" /></p>

<p>Test it out:</p>

<p><img src="https://raw.githubusercontent.com/mjhea0/meteor-in-action/master/images/part3-2.png" alt="part3-2" /></p>

<h4 id="4-automated-test">4. Automated Test</h4>

<p>Add the following code to “index.js”:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">suite</span><span class="p">(</span><span class="s1">'addVotes'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="c1">// ensure that -</span>
  <span class="c1">// (1) we can add data to the collection</span>
  <span class="c1">// (2) after data is added, we can retrieve it</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">'server insert votes : OK'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">,</span> <span class="nx">server</span><span class="p">,</span> <span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">server</span><span class="p">.</span><span class="kr">eval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">Answers</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">answerText</span><span class="p">:</span> <span class="s2">"wheeeeeeeeeee!"</span><span class="p">});</span>
      <span class="nx">Answers</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="na">answerText</span><span class="p">:</span> <span class="s2">"wheeeeeeeeeee!"</span><span class="p">},{</span><span class="na">$inc</span> <span class="p">:</span> <span class="p">{</span><span class="s1">'yes'</span><span class="p">:</span><span class="mi">1</span><span class="p">}});</span>
      <span class="kd">var</span> <span class="nx">voteCollection</span> <span class="o">=</span> <span class="nx">Answers</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">fetch</span><span class="p">();</span>
      <span class="nx">emit</span><span class="p">(</span><span class="s1">'collection'</span><span class="p">,</span> <span class="nx">voteCollection</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">once</span><span class="p">(</span><span class="s1">'collection'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">voteCollection</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// console.log(collection[0].yes)</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">voteCollection</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">yes</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>

<span class="p">});</span>
</code></pre></div></div>

<h5 id="whats-going-on-here-2">What’s going on here?</h5>

<p>Similar to the last test, we are just testing that the collection exists and that it returns certain data. This time, though, we are not just testing that the collection exists, but that the <code class="highlighter-rouge">yes</code> key contains a value of 1.</p>

<h5 id="run-the-test-1">Run the test</h5>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>laika

  injecting laika...
  loading phantomjs...
  loading initial app pool...


  submitAnswers
    ✓ server initialization <span class="o">(</span>1882ms<span class="o">)</span>
    ✓ server insert : OK <span class="o">(</span>2957ms<span class="o">)</span>

  addVotes
    ✓ server insert votes : OK <span class="o">(</span>3105ms<span class="o">)</span>


  3 passing <span class="o">(</span>8s<span class="o">)</span>

  cleaning up injected code
</code></pre></div></div>

<p>Commit your code!</p>

<p><a id="twitter"></a></p>

<h2 id="users-can-login-via-twitter">Users can login via Twitter</h2>

<p>Remember when we added these two packages-</p>

<ol>
  <li><code class="highlighter-rouge">accounts-ui</code></li>
  <li><code class="highlighter-rouge">accounts-twitter</code></li>
</ol>

<p>-well, let’s go ahead and use them.</p>

<h4 id="1-update-html">1. Update HTML</h4>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Add an answer. Or vote.<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;div&gt;</span>
      {{loginButtons}}
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;h3&gt;&lt;em&gt;</span>Question<span class="nt">&lt;/em&gt;</span>: Is the world getting warmer?<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;div&gt;</span>
      <span class="c">&lt;!-- if there is an answer, append it to the DOM --&gt;</span>
      {{&gt; addAnswer}}
      {{&gt; answers}}
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</code></pre></div></div>

<p>Check your browser. You should see the “Configure Twitter Login” button. Go ahead and click it:</p>

<p><img src="https://raw.githubusercontent.com/mjhea0/meteor-in-action/master/images/oauth.png" alt="oauth" /></p>

<p>Wow. This tells you <em>exactly</em> how to setup your app on Twitter for logging via Oauth. Follow the instructions to create the app, then copy and paste the consumer key and consumer secret into the window on the Meteor app.</p>

<p>Next, test logging in. If all went well you should see:</p>

<p><img src="https://raw.githubusercontent.com/mjhea0/meteor-in-action/master/images/oauth2.png" alt="oauth2" /></p>

<blockquote>
  <p>If you need to add a different Twitter app to authenticate with you must drop the <code class="highlighter-rouge">meteor_accounts_loginServiceConfiguration</code> collection from MongoDB - <code class="highlighter-rouge">db.meteor_accounts_loginServiceConfiguration.drop()</code></p>
</blockquote>

<h4 id="4-automated-test-1">4. Automated Test</h4>

<p>Since the Twitter login is part of a pre-written package, we do not need to do any unit tests. In general, unit tests should be reserved to code that you have written. Other people’s code should be tested within the scope of a functional test, which I cannot figure out how to do with Laika. You could use Selenium or PhantomJS here, but I think just the manual testing is fine for now. The Meteor team really needs to develop an internal testing solution.</p>

<p>Commit your code. Take a breath. Move on.</p>

<p><a id="loggedin"></a></p>

<h2 id="users-can-only-answer-or-vote-if-they-are-logged-in">Users can only answer or vote if they are logged in</h2>

<p>Finally, let’s add some restrictions so that a user must be logged in before adding answers or voting.</p>

<h4 id="1-client-js-2">1. Client JS</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Template</span><span class="p">.</span><span class="nx">answer</span><span class="p">.</span><span class="nx">events</span><span class="p">({</span>
  <span class="s1">'click'</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">Session</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="s2">"selected_answer"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="s1">'click a.yes'</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">()){</span>
      <span class="kd">var</span> <span class="nx">answerId</span> <span class="o">=</span> <span class="nx">Session</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'selected_answer'</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'updating yes count for answerId '</span><span class="o">+</span><span class="nx">answerId</span><span class="p">);</span>
      <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">"incrementYesVotes"</span><span class="p">,</span><span class="nx">answerId</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s1">'click a.no'</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">()){</span>
      <span class="kd">var</span> <span class="nx">answerId</span> <span class="o">=</span> <span class="nx">Session</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'selected_answer'</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'updating no count for answerId '</span><span class="o">+</span><span class="nx">answerId</span><span class="p">);</span>
      <span class="nx">Meteor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">"incrementNoVotes"</span><span class="p">,</span><span class="nx">answerId</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h4 id="2-server-js">2. Server JS</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">answerId</span> <span class="o">=</span> <span class="nx">Answers</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
  <span class="s1">'answerText'</span> <span class="p">:</span> <span class="nx">answerText</span><span class="p">,</span>
  <span class="s1">'submittedOn'</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
  <span class="s1">'submittedBy'</span> <span class="p">:</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">()</span>
<span class="p">});</span>
</code></pre></div></div>

<h4 id="3-html-2">3. HTML</h4>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"description"</span> <span class="na">content=</span><span class="s">""</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"author"</span> <span class="na">content=</span><span class="s">""</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>One Question. Several Answers.<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">href=</span><span class="s">"http://netdna.bootstrapcdn.com/bootswatch/3.0.3/yeti/bootstrap.min.css"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Add an answer. Or vote.<span class="nt">&lt;/h1&gt;</span>
    {{#if currentUser}}
      {{loginButtons}}
    {{/if}}
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;h3&gt;&lt;em&gt;</span>Question<span class="nt">&lt;/em&gt;</span>: Is the world getting warmer?<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;br&gt;</span>
      <span class="nt">&lt;div&gt;</span>
        {{#if currentUser}}
          {{&gt; addAnswer}}
          {{&gt; answers}}
        {{/if}}
        {{#unless currentUser}}
          {{&gt; login}}
          {{loginButtons}}
        {{/unless}}
      <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"addAnswer"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;textarea</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">rows=</span><span class="s">"3"</span> <span class="na">name=</span><span class="s">"answerText"</span> <span class="na">id=</span><span class="s">"answerText"</span> <span class="na">placeholder=</span><span class="s">"Add Your Answer .."</span><span class="nt">&gt;&lt;/textarea&gt;</span>
  <span class="nt">&lt;br&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"btn-primary add-answer btn-md"</span> <span class="na">value=</span><span class="s">"Add Answer"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/template&gt;</span>

<span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"answers"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;br&gt;</span>
  <span class="nt">&lt;br&gt;</span>
  <span class="nt">&lt;h2&gt;</span>All Questions<span class="nt">&lt;/h2&gt;</span>
  {{#each items}}
    {{&gt; answer}}
  {{/each}}
<span class="nt">&lt;/template&gt;</span>

<span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"answer"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"lead"</span><span class="nt">&gt;</span>
      {{answerText}}
      <span class="nt">&lt;br&gt;</span>
      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"btn btn-xs btn-success yes {{#unless currentUser}}disabled{{/unless}}"</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;&lt;i</span> <span class="na">class=</span><span class="s">"icon-thumbs-up"</span><span class="nt">&gt;&lt;/i&gt;</span> Yes {{yes}}<span class="nt">&lt;/a&gt;</span>
      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"btn btn-xs btn-primary no {{#unless currentUser}}disabled{{/unless}}"</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;&lt;i</span> <span class="na">class=</span><span class="s">"icon-thumbs-down"</span><span class="nt">&gt;&lt;/i&gt;</span> No {{no}}<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/template&gt;</span>

<span class="nt">&lt;template</span> <span class="na">name=</span><span class="s">"login"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h4&gt;</span>Sign in using Twitter to submit new questions or to vote on existing questions.<span class="nt">&lt;/h4&gt;</span>
<span class="nt">&lt;/template&gt;</span>
</code></pre></div></div>

<h5 id="whats-going-on-here-3">What’s going on here?</h5>

<ol>
  <li><code class="highlighter-rouge">if(Meteor.userId()){}</code> prevents a user from voting if they are not logged in, but only on the JS side. In other words, the user can still click the button; it’s just nothing will happen if they do.</li>
  <li><code class="highlighter-rouge">'submittedBy' : Meteor.userId()</code> adds the logged in user to the collection</li>
  <li><code class="highlighter-rouge">{{#unless currentUser}}disabled{{/unless}}</code> disables the yes or no button. Now the it can’t even be clicked unless the user is logged in.</li>
  <li><code class="highlighter-rouge">{{#if currentUser}} ... {{/if}}</code> and <code class="highlighter-rouge">{{#unless currentUser}} ... {{/unless}}</code> are used to display certain templates if the user is logged in or not.</li>
</ol>

<h4 id="4-manual-test">4. Manual Test</h4>

<p>Open your browser. If you’re logged in, go ahead and log out. You should see this:</p>

<p><img src="https://raw.githubusercontent.com/mjhea0/meteor-in-action/master/images/loggedout.png" alt="loggedout" /></p>

<p>Now, before logging in to test. Let’s dump the answers collection so that each record in the collection has a user associated with it. To do this, make sure your meteor app is running, then open a new terminal window and navigate to your app’s project root.</p>

<p>Follow these commands to dump the collection:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>meteor mongo
MongoDB shell version: 2.4.8
connecting to: 127.0.0.1:3002/meteor
meteor:PRIMARY&gt; show dbs<span class="p">;</span>
<span class="nb">local </span>0.0625GB
meteor  0.0625GB
meteor:PRIMARY&gt; use meteor<span class="p">;</span>
switched to db meteor
meteor:PRIMARY&gt; show collections<span class="p">;</span>
answers
meteor_accounts_loginServiceConfiguration
questions
system.indexes
users
meteor:PRIMARY&gt; db.answers.drop<span class="o">()</span>
<span class="nb">true</span>
</code></pre></div></div>
<p>Back on your browser, go ahead and log back in. Add an answer.</p>

<p>Finally, jump back to the mongo shell:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meteor:PRIMARY&gt; show collections<span class="p">;</span>
answers
meteor_accounts_loginServiceConfiguration
questions
system.indexes
users
meteor:PRIMARY&gt; db.answers.find<span class="o">()</span>
<span class="o">{</span> <span class="s2">"_id"</span> : <span class="s2">"cbWebazW8eehJkaXL"</span>, <span class="s2">"answerText"</span> : <span class="s2">"This is my first test while logged in."</span>, <span class="s2">"no"</span> : 2, <span class="s2">"submittedBy"</span> : <span class="s2">"Ex2bHmCgkygNbByEc"</span>, <span class="s2">"submittedOn"</span> : ISODate<span class="o">(</span><span class="s2">"2014-01-14T20:07:53.080Z"</span><span class="o">)</span>, <span class="s2">"yes"</span> : 2 <span class="o">}</span>
</code></pre></div></div>

<p>Success! There is a key/value pair for the user - <code class="highlighter-rouge">"submittedBy" : "Ex2bHmCgkygNbByEc"</code>.</p>

<p><a id="insecure"></a></p>

<h2 id="remove-insecure-packages">Remove insecure packages</h2>

<p>All Meteor applications have a package called Insecure pre-installed. This handy little package gives the client the ability to interact with the database, as you saw before. While this may be handy for prototyping you always want to remove it for production applications.</p>

<p>To remove, just run:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>meteor remove insecure
</code></pre></div></div>

<h4 id="1-manually-test">1. Manually Test</h4>

<p>Manually test this on your end. With the Meteor server running and your browser open, try to insert an answer in the console. Make sure that the user is logged in.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> Answers.insert<span class="o">({</span>answerText: <span class="s1">'Client Console Test!'</span><span class="o">})</span>
<span class="s2">"oeYhZMmXyBjivJ5uM"</span>
insert failed: Access denied
</code></pre></div></div>
<p>You should the see above insertion error. Also, you know that it’s not working if the answer did not get immediately added to the page.</p>

<p>Finally, you can look in Mongo, just to be sure. Open a new window in your terminal, navigate to your “mymeteor” directory, then type the following commands:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>meteor mongo
MongoDB shell version: 2.4.8
connecting to: 127.0.0.1:3002/meteor
meteor:PRIMARY&gt; show dbs<span class="p">;</span>
<span class="nb">local </span>0.0625GB
meteor  0.0625GB
meteor:PRIMARY&gt; use meteor<span class="p">;</span>
switched to db meteor
meteor:PRIMARY&gt; show collections<span class="p">;</span>
answers
meteor_accounts_loginServiceConfiguration
questions
system.indexes
users
</code></pre></div></div>

<p>Now search the collection:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meteor:PRIMARY&gt; db.answers.find<span class="o">({</span>answerText: <span class="s1">'Client Console Test!'</span><span class="o">})</span>
meteor:PRIMARY&gt;
</code></pre></div></div>

<p>This shouldn’t find anything.</p>

<p><a id="deployment"></a></p>

<h2 id="deployment">Deployment</h2>

<p>Although there are a number of deployment options, pushing your new app to the Meteor test servers is by far the easiest. Simply run the command: <code class="highlighter-rouge">meteor deploy &lt;YOUR-APP-NAME-HERE&gt;</code>.</p>

<p>So -</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meteor deploy answers
</code></pre></div></div>

<p>Check it out at <a href="http://answers.meteor.com/">http://answers.meteor.com/</a>.</p>

<blockquote>
  <p>The Meteor servers are for <strong>testing</strong> only; they are not meant for apps in production.</p>
</blockquote>

<p>Don’t forget to commit!</p>

<p><a id="next"></a></p>

<h2 id="whats-next">What’s next?</h2>

<ol>
  <li>Deploy to Heroku</li>
  <li>Setup Selenium Tests</li>
  <li>Add additional functionality</li>
</ol>

<p><a id="conclusion"></a></p>

<h2 id="conclusion">Conclusion</h2>

<p>That’s it. Give me some feedback. In the coming weeks, I’ll be deploying an app into production. Stay tuned.</p>

<p>Grab the code from the repo <a href="https://github.com/mjhea0/meteor-in-action">here</a></p>

  </div>

  <!-- addthis -->
  
    <div class="sharing">
  <br>
  <!-- AddThis Button BEGIN -->
  <div class="addthis_toolbox addthis_default_style addthis_32x32_style">
    <a class="addthis_button_preferred_1"></a>
    <a class="addthis_button_preferred_2"></a>
    <a class="addthis_button_preferred_3"></a>
    <a class="addthis_button_preferred_4"></a>
    <a class="addthis_button_compact"></a>
    <a class="addthis_counter addthis_bubble_style"></a>
  </div>
  <script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-50e5f1cc35ad077d"></script>
  <!-- AddThis Button END -->
  <br>
</div>

  

  <!-- disqus -->
  
    <div id="disqus_thread"></div>

<script>
  var disqus_config = function () {
    this.page.url = 'http://localhost:4000/blog/2014/01/29/meteor-dot-js-in-action-create-an-app-test-with-laika/';
    this.page.identifier = 'http://localhost:4000/blog/2014/01/29/meteor-dot-js-in-action-create-an-app-test-with-laika/';
  };

  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//' + 'michaelherman' + '.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  


</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      




<div>
  <hr>
  <p>
    <span>Copyright &copy; 2018 - Michael Herman</span>
    <br>
    <small>Questions? michael at mherman dot org</small><br>
    <small><a href="#">Back to top</a></small>
    <br>
    <span>
      <a href="https://github.com/mjhea0"><i class="fa fa-github-square" style="font-size:2em" aria-hidden="true"></i></a>
      <a href="https://twitter.com/mikeherman"><i class="fa fa-twitter-square" style="font-size:2em" aria-hidden="true"></i></a>
      <a href="http://www.linkedin.com/pub/michael-herman/3b/a94/4"><i class="fa fa-linkedin-square" style="font-size:2em" aria-hidden="true"></i></a>
      <a href="http://www.youtube.com/hermanmu"><i class="fa fa-youtube-square" style="font-size:2em" aria-hidden="true"></i></a>
    </span>
  </p>
</div>

    </p>

  </div>

</footer>


  </body>

  <script type="text/javascript" src="/assets/hello.js"></script>

</html>
