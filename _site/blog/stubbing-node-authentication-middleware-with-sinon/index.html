<!DOCTYPE html>
<html lang="en">

  <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Stubbing Node Authentication Middleware with Sinon</title>
  <meta name="description" content="This post looks at how to stub Passport authentication middleware with Sinon.js during test runs.">
  
    
    <meta name="keywords" content="node, node.js, koa, testing, sinon, sinon.js, stub, mock, passport, authentication, koa 2 javascript, unit tests, unit testing, mocha, chai">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://mherman.org/blog/stubbing-node-authentication-middleware-with-sinon/">
  
  
  <link rel="alternate" type="application/rss+xml" title="Michael Herman" href="https://mherman.org/feed.xml">

  <link rel="icon" type="image/png" href="/favicon.png">


  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Stubbing Node Authentication Middleware with Sinon">
  <meta name="twitter:description" content="This post looks at how to stub Passport authentication middleware with Sinon.js during test runs.">
  
  

  <script type="text/javascript">
  WebFontConfig = {
    google: { families: [ 'Bitter:400,700,400italic:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  
    
  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-37074204-1', 'auto');
    ga('send', 'pageview');
  </script>


  
</head>


  <link rel="stylesheet" href="/assets/hello.css">

  <body>

    <header class="site-header">

  <div class="color-bar">
    <div class="bar bar1"></div>
    <div class="bar bar2"></div>
    <div class="bar bar3"></div>
    <div class="bar bar4"></div>
    <div class="bar bar5"></div>
    <div class="bar bar6"></div>
  </div>

  <div class="wrapper">

    <a class="site-title" href="/">Michael Herman</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/">Blog</a>
      
        
        <a class="page-link" href="/about">About</a>
      
        
        <a class="page-link" href="/talks">Talks</a>
      
        
        <a class="page-link" href="/feed.xml">RSS</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Stubbing Node Authentication Middleware with Sinon</h1>
    
    <p class="post-meta">
      
        <time datetime="2018-01-22T00:00:00-07:00" itemprop="datePublished">Jan 22, 2018</time>
      
       • 
  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/node/">node</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/koa/">koa</a>,
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/auth/">auth</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/mocha/">mocha</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/testing/">testing</a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><a href="http://mherman.org/blog/2018/01/02/user-authentication-with-passport-and-koa/">Last time</a> we looked at how to set up <a href="http://www.passportjs.org/">Passport</a> local authentication with Node and Koa. We took a test-first approach and wrote the majority of tests first. That said, there were a two routes that we could not test (<code class="highlighter-rouge">/auth/status</code> and <code class="highlighter-rouge">/auth/logout</code>) since they required us to to bypass the <code class="highlighter-rouge">isAuthenticated()</code> method and manually set a cookie.</p>

<p>In this post, we’ll look at how to stub Passport authentication middleware and calls to both Postgres and Redis with <a href="http://sinonjs.org/">Sinon.js</a>.</p>

<div style="text-align:center;">
  <img src="/assets/img/blog/koa/sinon-passport.png" style="max-width: 90%; border:0; box-shadow: none;" alt="sinon.js and passport.js" />
</div>

<h3 id="parts">Parts</h3>

<p>This article is part of a 4-part Koa and Sinon series…</p>

<ol>
  <li><a href="http://mherman.org/blog/2017/08/23/building-a-restful-api-with-koa-and-postgres">Building a RESTful API with Koa and Postgres</a></li>
  <li><a href="http://mherman.org/blog/2017/11/06/stubbing-http-requests-with-sinon">Stubbing HTTP Requests with Sinon</a></li>
  <li><a href="http://mherman.org/blog/2018/01/02/user-authentication-with-passport-and-koa">User Authentication with Passport and Koa</a></li>
  <li><a href="http://mherman.org/blog/2018/01/22/stubbing-node-authentication-middleware-with-sinon">Stubbing Node Authentication Middleware with Sinon</a> (this article)</li>
</ol>

<h2 class="no_toc" id="contents">Contents</h2>

<ul id="markdown-toc">
  <li><a href="#objectives" id="markdown-toc-objectives">Objectives</a></li>
  <li><a href="#project-setup" id="markdown-toc-project-setup">Project Setup</a></li>
  <li><a href="#test-structure" id="markdown-toc-test-structure">Test Structure</a></li>
  <li><a href="#why-stub" id="markdown-toc-why-stub">Why Stub?</a></li>
  <li><a href="#postgres-stub" id="markdown-toc-postgres-stub">Postgres Stub</a></li>
  <li><a href="#passport-stub" id="markdown-toc-passport-stub">Passport Stub</a></li>
  <li><a href="#redis-stub" id="markdown-toc-redis-stub">Redis Stub</a></li>
  <li><a href="#ensure-authenticated-stub" id="markdown-toc-ensure-authenticated-stub">Ensure Authenticated Stub</a></li>
  <li><a href="#ensure-admin-stub" id="markdown-toc-ensure-admin-stub">Ensure Admin Stub</a></li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ul>

<h2 id="objectives">Objectives</h2>

<p>By the end of this tutorial, you will be able to…</p>

<ol>
  <li>Discuss the overall client/server authentication workflow</li>
  <li>Describe what a stub is and why you would want to use them in your test suites</li>
  <li>Add Sinon to an existing Mocha test structure</li>
  <li>Refactor each of the auth integration tests, stubbing Passport-related authentication middleware and calls to Postgres and Redis</li>
</ol>

<h2 id="project-setup">Project Setup</h2>

<p>Clone the <a href="https://github.com/mjhea0/node-koa-api">node-koa-api</a> repo (if you haven’t already), and then check out the <a href="https://github.com/mjhea0/node-koa-api/releases/tag/v3">v3</a> tag to the master branch and install the dependencies:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/mjhea0/node-koa-api <span class="se">\</span>
  <span class="nt">--branch</span> v3 <span class="nt">--single-branch</span>
<span class="nv">$ </span><span class="nb">cd </span>node-koa-api
<span class="nv">$ </span>git checkout tags/v3 <span class="nt">-b</span> master
<span class="nv">$ </span>npm install
</code></pre></div></div>

<p>Review the project structure:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>├── knexfile.js
├── package.json
├── src
│   └── server
│       ├── auth.js
│       ├── db
│       │   ├── connection.js
│       │   ├── migrations
│       │   │   ├── 20170817152841_movies.js
│       │   │   └── 20171231115201_users.js
│       │   ├── queries
│       │   │   ├── movies.js
│       │   │   └── users.js
│       │   └── seeds
│       │       ├── movies_seed.js
│       │       └── users.js
│       ├── index.js
│       ├── routes
│       │   ├── auth.js
│       │   ├── index.js
│       │   └── movies.js
│       └── views
│           ├── login.html
│           ├── register.html
│           └── status.html
└── <span class="nb">test</span>
    ├── routes.auth.test.js
    ├── routes.index.test.js
    ├── routes.movies.test.js
    └── sample.test.js
</code></pre></div></div>

<p>Take note of the routes as well:</p>

<table>
  <thead>
    <tr>
      <th>URL</th>
      <th>HTTP Verb</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>/</td>
      <td>GET</td>
      <td>Sanity Check</td>
    </tr>
    <tr>
      <td>/api/v1/movies</td>
      <td>GET</td>
      <td>Return ALL movies</td>
    </tr>
    <tr>
      <td>/api/v1/movies/:id</td>
      <td>GET</td>
      <td>Return a SINGLE movie</td>
    </tr>
    <tr>
      <td>/api/v1/movies</td>
      <td>POST</td>
      <td>Add a movie</td>
    </tr>
    <tr>
      <td>/api/v1/movies/:id</td>
      <td>PUT</td>
      <td>Update a movie</td>
    </tr>
    <tr>
      <td>/api/v1/movies/:id</td>
      <td>DELETE</td>
      <td>Delete a movie</td>
    </tr>
    <tr>
      <td>/auth/register</td>
      <td>GET</td>
      <td>Render the register view</td>
    </tr>
    <tr>
      <td>/auth/register</td>
      <td>POST</td>
      <td>Register a new user</td>
    </tr>
    <tr>
      <td>/auth/login</td>
      <td>GET</td>
      <td>Render the login view</td>
    </tr>
    <tr>
      <td>/auth/login</td>
      <td>POST</td>
      <td>Log a user in</td>
    </tr>
    <tr>
      <td>/auth/status</td>
      <td>GET</td>
      <td>Render the status page</td>
    </tr>
    <tr>
      <td>/auth/logout</td>
      <td>GET</td>
      <td>Log a user out</td>
    </tr>
  </tbody>
</table>

<p>In short, this is a basic RESTful API with local authentication, powered by Koa and Passport.</p>

<blockquote>
  <p>Want to learn how to build this project? Review the <a href="http://mherman.org/blog/2017/08/23/building-a-restful-api-with-koa-and-postgres">Building a RESTful API With Koa and Postgres</a> and <a href="http://mherman.org/blog/2018/01/02/user-authentication-with-passport-and-koa">User Authentication with Passport and Koa</a> blog posts.</p>
</blockquote>

<p>Moving on, <a href="https://www.postgresql.org/download/">download</a> and install Postgres (if necessary). Then, spin up the server on port 5432. Open psql, in your terminal and create two new databases:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>psql

<span class="c"># CREATE DATABASE koa_api;</span>
CREATE DATABASE
<span class="c"># CREATE DATABASE koa_api_test;</span>
CREATE DATABASE
<span class="c"># \q</span>
</code></pre></div></div>

<p>Spin up Redis in a new terminal tab:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>redis-server
</code></pre></div></div>

<p>Ensure the tests pass:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ npm test

Server listening on port: 1337
  routes : auth
    GET /auth/register
      ✓ should render the register view
    POST /auth/register
      ✓ should register a new user (241ms)
    GET /auth/login
      ✓ should render the login view
    POST /auth/login
      ✓ should login a user (100ms)

  routes : index
    GET /
      ✓ should return json

  routes : movies
    GET /api/v1/movies
      ✓ should return all movies
    GET /api/v1/movies/:id
      ✓ should respond with a single movie
      ✓ should throw an error if the movie does not exist
    POST /api/v1/movies
      ✓ should return the movie that was added
      ✓ should throw an error if the payload is malformed
    PUT /api/v1/movies
      ✓ should return the movie that was updated
      ✓ should throw an error if the movie does not exist
    DELETE /api/v1/movies/:id
      ✓ should return the movie that was deleted
      ✓ should throw an error if the movie does not exist

  Sample Test
    ✓ should pass


  15 passing (3s)
</code></pre></div></div>

<p>Apply the migrations, and seed the database:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>knex migrate:latest <span class="nt">--env</span> development
<span class="nv">$ </span>knex seed:run <span class="nt">--env</span> development
</code></pre></div></div>

<p>Run the Koa server, via <code class="highlighter-rouge">npm start</code>, and test out the following routes to get a feel for the app’s current functionality:</p>

<ol>
  <li>http://localhost:1337/</li>
  <li>http://localhost:1337/api/v1/movies</li>
  <li>http://localhost:1337/auth/register</li>
  <li>http://localhost:1337/auth/login</li>
  <li>http://localhost:1337/auth/status</li>
  <li>http://localhost:1337/auth/logout</li>
</ol>

<p>Install Sinon:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm install sinon@4.1.5 <span class="nt">--save-dev</span>
</code></pre></div></div>

<h2 id="test-structure">Test Structure</h2>

<p>Let’s quickly update the test structure to differentiate between unit and integration tests and add a new file for the stubbed tests.</p>

<p>Add two new folders to the “test” directory:</p>

<ol>
  <li>“unit”</li>
  <li>“integration”</li>
</ol>

<p>Then, move the <em>sample.test.js</em> to the “unit” folder and the remaining test files to the “integration” folder.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>└── <span class="nb">test</span>
    ├── integration
    │   ├── routes.auth.test.js
    │   ├── routes.index.test.js
    │   └── routes.movies.test.js
    └── unit
        └── sample.test.js
</code></pre></div></div>

<p>Update the <code class="highlighter-rouge">test</code> command in <em>package.json</em> so that the tests are discovered in the newly created folders:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"test": "./node_modules/mocha/bin/_mocha ./test/**/*.test.js"
</code></pre></div></div>

<p>You’ll need to update the paths in each of the test files as well:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../../src/server/index'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">knex</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../../src/server/db/connection'</span><span class="p">);</span>
</code></pre></div></div>

<p>Ensure the tests still pass before moving on.</p>

<p>Next, create a duplicate of <em>test/integration/routes.auth.test.js</em> called <em>test/integration/routes.auth.stub.test.js</em>.</p>

<p>Then, update the first <code class="highlighter-rouge">describe</code> block along with the <code class="highlighter-rouge">beforeEach</code> and <code class="highlighter-rouge">afterEach</code>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">.</span><span class="nx">only</span><span class="p">(</span><span class="s1">'routes : auth - stubbed'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{});</span>

  <span class="nx">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{});</span>

<span class="p">...</span>

<span class="p">});</span>
</code></pre></div></div>

<p>So, we’re no longer applying the migrations and only (via <code class="highlighter-rouge">.only</code>) running the tests in this <code class="highlighter-rouge">describe</code> block during test runs.</p>

<p>Run the tests:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">test</span>
</code></pre></div></div>

<p>As expected, you should see an error since the database tables do not exist:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>error: relation <span class="s2">"users"</span> does not exist
</code></pre></div></div>

<h2 id="why-stub">Why Stub?</h2>

<p>Before beginning, review the following two sections from the <a href="http://mherman.org/blog/2017/11/06/stubbing-http-requests-with-sinon">Stubbing HTTP Requests with Sinon</a> blog post to get an overview of stubbing:</p>

<ol>
  <li><a href="http://mherman.org/blog/2017/11/06/stubbing-http-requests-with-sinon/#what-is-a-stub">What is a Stub?</a></li>
  <li><a href="http://mherman.org/blog/2017/11/06/stubbing-http-requests-with-sinon/#why-stub">Why Stub?</a></li>
</ol>

<p>The end goal of this post is to be able to test routes that require authentication <em>without</em> actually going through either of the following authentication flows…</p>

<blockquote>
  <p>Be sure to review the actual code as you’re reading through each flow.</p>
</blockquote>

<p><em>First flow:</em></p>

<ol>
  <li>User submits auth credentials (username and password), which are then sent to the server via a POST request to <code class="highlighter-rouge">/auth/login</code>.</li>
  <li><code class="highlighter-rouge">passport.authenticate()</code> is called and the credentials are checked against the user info stored in the database.</li>
  <li>If the credentials are correct, <code class="highlighter-rouge">passport.serializeUser()</code> is fired and the user <code class="highlighter-rouge">id</code> is serialized to the Redis session store via the <code class="highlighter-rouge">ctx.login()</code> method.</li>
  <li>Finally, a cookie is generated, which is sent back with the response to the client and that cookie is then set.</li>
</ol>

<p><em>Second flow:</em></p>

<ol>
  <li>An authenticated user hits a route requiring a user to be authenticated (like <code class="highlighter-rouge">/auth/status</code>).</li>
  <li><code class="highlighter-rouge">isAuthenticated()</code> is called, which then verifies that (a) a user is in session and (b) that user is found within the database (via <code class="highlighter-rouge">passport.deserializeUser()</code>).</li>
  <li>If correct, the end user is allowed to view the route and the appropriate response is sent.</li>
</ol>

<div style="text-align:left;padding-top:10px;padding-left:10px;">
  <img src="/assets/img/blog/koa/client-server-auth-flow.png" style="max-width: 90%;border:0;box-shadow:none;" alt="client/server auth flow" />
</div>

<p><br /></p>

<p>Let’s get to it!</p>

<h2 id="postgres-stub">Postgres Stub</h2>

<p>We’ll start by stubbing the Postgres <code class="highlighter-rouge">addUser</code> query (which is a promise) called in the POST <code class="highlighter-rouge">/auth/register</code> route handler in <em>src/server/routes/auth.js</em>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">queries</span><span class="p">.</span><span class="nx">addUser</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
</code></pre></div></div>

<p>Think about how this should normally resolve. Something like this, right?</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[
  {
    id: 1,
    username: 'michael',
    password: 'something'
  }
];
</code></pre></div></div>

<p>Update the test like so:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">.</span><span class="nx">only</span><span class="p">(</span><span class="s1">'POST /auth/register'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="na">username</span><span class="p">:</span> <span class="s1">'michael'</span><span class="p">,</span>
        <span class="na">password</span><span class="p">:</span> <span class="s1">'something'</span>
      <span class="p">}</span>
    <span class="p">];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">queries</span><span class="p">,</span> <span class="s1">'addUser'</span><span class="p">).</span><span class="nx">resolves</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
  <span class="p">});</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">'should register a new user'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">chai</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/auth/register'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">send</span><span class="p">({</span>
      <span class="na">username</span><span class="p">:</span> <span class="s1">'michael'</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="s1">'herman'</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">redirects</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">should</span><span class="p">.</span><span class="nx">contain</span><span class="p">(</span><span class="s1">'/auth/status'</span><span class="p">);</span>
      <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Here, we stubbed the <code class="highlighter-rouge">addUser</code> query in the <code class="highlighter-rouge">beforeEach()</code>, passing in the expected <code class="highlighter-rouge">user</code> info for when the query is resolved, and then restored the functionality in the <code class="highlighter-rouge">afterEach()</code>.</p>

<p>Add the imports to the top:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">sinon</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'sinon'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">queries</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../../src/server/db/queries/users'</span><span class="p">);</span>
</code></pre></div></div>

<p>The test should fail since we’re still accessing the database in the Passport <code class="highlighter-rouge">authenticate</code> method.</p>

<h2 id="passport-stub">Passport Stub</h2>

<p>We can use a similar pattern for stubbing the <code class="highlighter-rouge">authenticate</code> method:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">authenticate</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">passport</span><span class="p">,</span> <span class="s1">'authenticate'</span><span class="p">).</span><span class="nx">returns</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{});</span>
<span class="p">});</span>

<span class="nx">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Add this to the outer <code class="highlighter-rouge">describe</code> block so it’s applied to all tests. Then, to simulate the calling of the callback, update the <code class="highlighter-rouge">beforeEach</code> in the nested <code class="highlighter-rouge">describe</code>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="na">username</span><span class="p">:</span> <span class="s1">'michael'</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="s1">'something'</span>
    <span class="p">}</span>
  <span class="p">];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">queries</span><span class="p">,</span> <span class="s1">'addUser'</span><span class="p">).</span><span class="nx">resolves</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">.</span><span class="nx">yields</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="mi">1</span> <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>You should have something similar to:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">.</span><span class="nx">only</span><span class="p">(</span><span class="s1">'routes : auth - stubbed'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">authenticate</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">passport</span><span class="p">,</span> <span class="s1">'authenticate'</span><span class="p">).</span><span class="nx">returns</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{});</span>
  <span class="p">});</span>

  <span class="nx">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="p">...</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">'POST /auth/register'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="na">username</span><span class="p">:</span> <span class="s1">'michael'</span><span class="p">,</span>
          <span class="na">password</span><span class="p">:</span> <span class="s1">'something'</span>
        <span class="p">}</span>
      <span class="p">];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">queries</span><span class="p">,</span> <span class="s1">'addUser'</span><span class="p">).</span><span class="nx">resolves</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">.</span><span class="nx">yields</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="mi">1</span> <span class="p">});</span>
    <span class="p">});</span>
    <span class="nx">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
    <span class="p">});</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">'should register a new user'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">chai</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/auth/register'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">send</span><span class="p">({</span>
        <span class="na">username</span><span class="p">:</span> <span class="s1">'michael'</span><span class="p">,</span>
        <span class="na">password</span><span class="p">:</span> <span class="s1">'herman'</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">redirects</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">should</span><span class="p">.</span><span class="nx">contain</span><span class="p">(</span><span class="s1">'/auth/status'</span><span class="p">);</span>
        <span class="nx">done</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>

<span class="p">...</span>

<span class="p">});</span>
</code></pre></div></div>

<p>Add the <code class="highlighter-rouge">beforeEach</code> to the POST <code class="highlighter-rouge">/auth/login</code> test as well:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'POST /auth/login'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">.</span><span class="nx">yields</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="mi">1</span> <span class="p">});</span>
  <span class="p">});</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">'should login a user'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">chai</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/auth/login'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">send</span><span class="p">({</span>
      <span class="na">username</span><span class="p">:</span> <span class="s1">'jeremy'</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="s1">'johnson'</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">redirects</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">should</span><span class="p">.</span><span class="nx">contain</span><span class="p">(</span><span class="s1">'/auth/status'</span><span class="p">);</span>
      <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Run the tests:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ npm test

Server listening on port: 1337
  routes : auth - stubbed
    GET /auth/register
      ✓ should render the register view
    POST /auth/register
      ✓ should register a new user
    GET /auth/login
      ✓ should render the login view
    POST /auth/login
      ✓ should login a user
</code></pre></div></div>

<p>They should all pass!</p>

<p>Notice how we passed in some dummy data to the callback, <code class="highlighter-rouge">null, { id: 1 }</code>. What if we passed <code class="highlighter-rouge">false</code> in for the second parameter instead of <code class="highlighter-rouge">{ id: 1 }</code>? Review the following code in <em>src/server/routes/auth.js</em> for more info:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">new</span> <span class="nx">LocalStrategy</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">knex</span><span class="p">(</span><span class="s1">'users'</span><span class="p">).</span><span class="nx">where</span><span class="p">({</span> <span class="nx">username</span> <span class="p">}).</span><span class="nx">first</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">comparePass</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">});</span>
<span class="p">}));</span>
</code></pre></div></div>

<p>How would you write a test, and stub it properly, for a situation where the user is found but the password is incorrect?</p>

<p>Add a new test:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'POST /auth/login'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">.</span><span class="nx">yields</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">'should not login a user if the password is incorrect'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">chai</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/auth/login'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">send</span><span class="p">({</span>
      <span class="na">username</span><span class="p">:</span> <span class="s1">'jeremy'</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="s1">'notcorrect'</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">should</span><span class="p">.</span><span class="nx">exist</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">redirects</span><span class="p">.</span><span class="nx">length</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="s1">'application/json'</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="s1">'error'</span><span class="p">);</span>
      <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Update the <code class="highlighter-rouge">serializeUser</code> and <code class="highlighter-rouge">deserializeUser</code> methods too:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">authenticate</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">passport</span><span class="p">,</span> <span class="s1">'authenticate'</span><span class="p">).</span><span class="nx">returns</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">serialize</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">passport</span><span class="p">,</span> <span class="s1">'serializeUser'</span><span class="p">).</span><span class="nx">returns</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">deserialize</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">passport</span><span class="p">,</span> <span class="s1">'deserializeUser'</span><span class="p">).</span><span class="nx">returns</span><span class="p">(</span>
    <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{});</span>
<span class="p">});</span>

<span class="nx">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">serialize</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">deserialize</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Add the appropriate yields:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">serialize</span><span class="p">.</span><span class="nx">yields</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="mi">1</span> <span class="p">});</span>
<span class="k">this</span><span class="p">.</span><span class="nx">deserialize</span><span class="p">.</span><span class="nx">yields</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="mi">1</span> <span class="p">});</span>
</code></pre></div></div>

<p>Ensure the tests still pass. Then, bring down the Postgres server and run them again. Again, they should pass.</p>

<p>It’s worth noting that these tests will run faster than the full integration flavor in <em>test/integration/routes.auth.test.js</em> since we’re no longer hitting Postgres - 82ms vs 1s. This may not be significant now, but think if the test suite had hundreds of tests all hitting the database - stubbing becomes super important for developer productivity.</p>

<h2 id="redis-stub">Redis Stub</h2>

<p>Kill the Redis server. Try running the tests. You should see a few failures since <code class="highlighter-rouge">ctx.login();</code> adds the session to Redis:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1) routes : auth - stubbed POST /auth/register should register a new user:
   Error: Timeout of 2000ms exceeded.
   For async tests and hooks, ensure "done()" is called;
   if returning a Promise, ensure it resolves.


2) routes : auth - stubbed POST /auth/login should login a user:
   Error: Timeout of 2000ms exceeded.
   For async tests and hooks, ensure "done()" is called;
   if returning a Promise, ensure it resolves.
</code></pre></div></div>

<p>To stub, let’s refactor out the initialization of the session store in <em>src/server/index.js</em>.</p>

<p>Add a new file to “src/server” called <em>session.js</em>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">RedisStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa-redis'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RedisStore</span><span class="p">();</span>
</code></pre></div></div>

<p>Then, within <em>src/server/index.js</em>, replace:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">RedisStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa-redis'</span><span class="p">);</span>
</code></pre></div></div>

<p>With:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./session'</span><span class="p">);</span>
</code></pre></div></div>

<p>Update the mounting of the session to the middleware:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// sessions</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'super-secret-key'</span><span class="p">];</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">session</span><span class="p">({</span> <span class="nx">store</span> <span class="p">},</span> <span class="nx">app</span><span class="p">));</span>
</code></pre></div></div>

<p>Fire the Redis server back up and run the tests to ensure that we didn’t break the existing functionality. Once done, kill the Redis server again and update the <code class="highlighter-rouge">beforeEach</code> and <code class="highlighter-rouge">afterEach</code> blocks:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">store</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">store</span><span class="p">,</span> <span class="s1">'set'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">authenticate</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">passport</span><span class="p">,</span> <span class="s1">'authenticate'</span><span class="p">).</span><span class="nx">returns</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">serialize</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">passport</span><span class="p">,</span> <span class="s1">'serializeUser'</span><span class="p">).</span><span class="nx">returns</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">deserialize</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">passport</span><span class="p">,</span> <span class="s1">'deserializeUser'</span><span class="p">).</span><span class="nx">returns</span><span class="p">(</span>
    <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{});</span>
<span class="p">});</span>

<span class="nx">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">serialize</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">deserialize</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Import:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../../src/server/session'</span><span class="p">);</span>
</code></pre></div></div>

<p>The tests should now pass:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ npm test

Server listening on port: 1337
  routes : auth - stubbed
    GET /auth/register
      ✓ should render the register view
    POST /auth/register
      ✓ should register a new user
    GET /auth/login
      ✓ should render the login view
    POST /auth/login
      ✓ should login a user
    POST /auth/login
      ✓ should not login a user if the password is incorrect
</code></pre></div></div>

<p>We can also stub the <code class="highlighter-rouge">get</code> and <code class="highlighter-rouge">destroy</code> <a href="https://github.com/koajs/session#external-session-stores">methods</a> from <a href="https://github.com/koajs/session">koa-session</a>.</p>

<h2 id="ensure-authenticated-stub">Ensure Authenticated Stub</h2>

<p>Moving right along, let’s stub out the <code class="highlighter-rouge">ctx.isAuthenticated()</code> method. Again, we’ll need to do a quick refactor first.</p>

<p>First, add a new file to “src/server/routes/” called <em>_helpers.js</em>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">ensureAuthenticated</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">ensureAuthenticated</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Import the function into <em>src/server/routes/auth.js</em>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">helpers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./_helpers'</span><span class="p">);</span>
</code></pre></div></div>

<p>Refactor the GET <code class="highlighter-rouge">/auth/status</code>, GET <code class="highlighter-rouge">/auth/logout</code>, and GET <code class="highlighter-rouge">/auth/login</code> routes to use the new helper:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/auth/login'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">ensureAuthenticated</span><span class="p">())</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'html'</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="s1">'./src/server/views/login.html'</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/auth/status'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/auth/logout'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">ensureAuthenticated</span><span class="p">(</span><span class="nx">ctx</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">logout</span><span class="p">();</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/auth/login'</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="p">{</span> <span class="na">success</span><span class="p">:</span> <span class="kc">false</span> <span class="p">};</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="mi">401</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/auth/status'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">ensureAuthenticated</span><span class="p">(</span><span class="nx">ctx</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'html'</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="s1">'./src/server/views/status.html'</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/auth/login'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Import the function again into the tests:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">helpers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../../src/server/routes/_helpers'</span><span class="p">);</span>
</code></pre></div></div>

<p>Create the stub:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ensureAuthenticated</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span>
    <span class="nx">helpers</span><span class="p">,</span> <span class="s1">'ensureAuthenticated'</span>
  <span class="p">).</span><span class="nx">returns</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">store</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">store</span><span class="p">,</span> <span class="s1">'set'</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">authenticate</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">passport</span><span class="p">,</span> <span class="s1">'authenticate'</span><span class="p">).</span><span class="nx">returns</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">serialize</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">passport</span><span class="p">,</span> <span class="s1">'serializeUser'</span><span class="p">).</span><span class="nx">returns</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">deserialize</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">passport</span><span class="p">,</span> <span class="s1">'deserializeUser'</span><span class="p">).</span><span class="nx">returns</span><span class="p">(</span>
    <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{});</span>
<span class="p">});</span>

<span class="nx">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">serialize</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">deserialize</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ensureAuthenticated</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Add the tests:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'GET /auth/status'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ensureAuthenticated</span><span class="p">.</span><span class="nx">returns</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">'should render the status view'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">chai</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/auth/status'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">should</span><span class="p">.</span><span class="nx">not</span><span class="p">.</span><span class="nx">exist</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">redirects</span><span class="p">.</span><span class="nx">length</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="s1">'text/html'</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">contain</span><span class="p">(</span><span class="s1">'&lt;p&gt;You are authenticated.&lt;/p&gt;'</span><span class="p">);</span>
      <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'GET /auth/login'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ensureAuthenticated</span><span class="p">.</span><span class="nx">returns</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">'should render the status view if the user is logged in'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">chai</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/auth/login'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">should</span><span class="p">.</span><span class="nx">not</span><span class="p">.</span><span class="nx">exist</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">redirects</span><span class="p">.</span><span class="nx">length</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">redirects</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">should</span><span class="p">.</span><span class="nx">contain</span><span class="p">(</span><span class="s1">'/auth/status'</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="s1">'text/html'</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">contain</span><span class="p">(</span><span class="s1">'&lt;p&gt;You are authenticated.&lt;/p&gt;'</span><span class="p">);</span>
      <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Update the other GET <code class="highlighter-rouge">/auth/login</code> test:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'GET /auth/login'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ensureAuthenticated</span><span class="p">.</span><span class="nx">returns</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">'should render the login view if a user is not logged in'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">chai</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/auth/login'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">end</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">should</span><span class="p">.</span><span class="nx">not</span><span class="p">.</span><span class="nx">exist</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">redirects</span><span class="p">.</span><span class="nx">length</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="s1">'text/html'</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">contain</span><span class="p">(</span><span class="s1">'&lt;h1&gt;Login&lt;/h1&gt;'</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">contain</span><span class="p">(</span>
        <span class="s1">'&lt;p&gt;&lt;button type="submit"&gt;Log In&lt;/button&gt;&lt;/p&gt;'</span><span class="p">);</span>
      <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>All tests should pass!</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ npm test

Server listening on port: 1337
  routes : auth - stubbed
    GET /auth/register
      ✓ should render the register view
    POST /auth/register
      ✓ should register a new user
    GET /auth/login
      ✓ should render the login view if a user is not logged in
    POST /auth/login
      ✓ should login a user
    POST /auth/login
      ✓ should not login a user if the password is incorrect
    GET /auth/status
      ✓ should render the status view
    GET /auth/login
      ✓ should render the status view if the user is logged in
</code></pre></div></div>

<p>Spin the Postgres and Redis servers back up, remove the <code class="highlighter-rouge">.only</code> from the describe, and run <em>all</em> the tests:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ npm test

Server listening on port: 1337
  routes : auth - stubbed
    GET /auth/register
      ✓ should render the register view
    POST /auth/register
      ✓ should register a new user
    GET /auth/login
      ✓ should render the login view if a user is not logged in
    POST /auth/login
      ✓ should login a user
    POST /auth/login
      ✓ should not login a user if the password is incorrect
    GET /auth/status
      ✓ should render the status view
    GET /auth/login
      ✓ should render the status view if the user is logged in

  routes : auth
    GET /auth/register
      ✓ should render the register view
    POST /auth/register
      ✓ should register a new user (200ms)
    GET /auth/login
      ✓ should render the login view
    POST /auth/login
      ✓ should login a user (99ms)

  routes : index
    GET /
      ✓ should return json

  routes : movies
    GET /api/v1/movies
      ✓ should return all movies
    GET /api/v1/movies/:id
      ✓ should respond with a single movie
      ✓ should throw an error if the movie does not exist
    POST /api/v1/movies
      ✓ should return the movie that was added
      ✓ should throw an error if the payload is malformed
    PUT /api/v1/movies
      ✓ should return the movie that was updated
      ✓ should throw an error if the movie does not exist
    DELETE /api/v1/movies/:id
      ✓ should return the movie that was deleted
      ✓ should throw an error if the movie does not exist

  Sample Test
    ✓ should pass


  22 passing (3s)
</code></pre></div></div>

<h2 id="ensure-admin-stub">Ensure Admin Stub</h2>

<p>Check your understanding by adding an <code class="highlighter-rouge">ensureAdmin</code> method to prevent access to a route if a user is not an admin. Add a route handler as well.</p>

<p><strong>Steps:</strong></p>

<ol>
  <li>Write a test</li>
  <li>Ensure the test fails</li>
  <li>Update the <code class="highlighter-rouge">users</code> model in the migration file, <em>src/server/db/migrations/20170817152841_movies.js</em></li>
  <li>Update the users seed</li>
  <li>Apply the migration and seed</li>
  <li>Add a route handler</li>
  <li>Add the HTML view</li>
  <li>Add the <code class="highlighter-rouge">ensureAdmin</code> helper</li>
  <li>Manually test the route in the browser</li>
  <li>Ensure the test still fails</li>
  <li>Add the stub to the test</li>
  <li>Ensure the test passes</li>
</ol>

<p>Compare your solution with the code in the <a href="https://github.com/mjhea0/node-koa-api">repo</a>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>This article took a look at how to stub authentication middleware and database calls with Sinon.</p>

<p>The full code can be found in the <a href="https://github.com/mjhea0/node-koa-api/releases/tag/v4">v4</a> tag of the <a href="https://github.com/mjhea0/node-koa-api">node-koa-api</a> repository. Please share your comments, questions, and/or tips below.</p>

  </div>

  <!-- addthis -->
  
    <div class="sharing">
  <br>
  <!-- AddThis Button BEGIN -->
  <div class="addthis_toolbox addthis_default_style addthis_32x32_style">
    <a class="addthis_button_preferred_1"></a>
    <a class="addthis_button_preferred_2"></a>
    <a class="addthis_button_preferred_3"></a>
    <a class="addthis_button_preferred_4"></a>
    <a class="addthis_button_compact"></a>
    <a class="addthis_counter addthis_bubble_style"></a>
  </div>
  <script type="text/javascript">var addthis_config = {"data_track_addressbar":false};</script>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-50e5f1cc35ad077d"></script>
  <!-- AddThis Button END -->
  <br>
</div>

  

  <!-- disqus -->
  
    <div id="disqus_thread"></div>

<script>
  var disqus_config = function () {
    this.page.url = 'https://mherman.org/blog/stubbing-node-authentication-middleware-with-sinon/';
    this.page.identifier = 'https://mherman.org/blog/stubbing-node-authentication-middleware-with-sinon/';
  };

  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//' + 'michaelherman' + '.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  


</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      




<div>
  <hr>
  <p>
    <span>Copyright &copy; 2019 - Michael Herman</span>
    <br>
    <small>Questions? michael at mherman dot org</small><br>
    <small><a href="#">Back to top</a></small>
    <br>
    <span>
      <a href="https://github.com/mjhea0"><i class="fa fa-github-square" style="font-size:2em" aria-hidden="true"></i></a>
      <a href="https://twitter.com/mikeherman"><i class="fa fa-twitter-square" style="font-size:2em" aria-hidden="true"></i></a>
      <a href="https://www.linkedin.com/in/mjhea0/"><i class="fa fa-linkedin-square" style="font-size:2em" aria-hidden="true"></i></a>
      <a href="https://www.youtube.com/hermanmu"><i class="fa fa-youtube-square" style="font-size:2em" aria-hidden="true"></i></a>
    </span>
  </p>
</div>

    </p>

  </div>

</footer>


  </body>

  <script type="text/javascript" src="/assets/hello.js"></script>

</html>
