
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>
    
      On-Demand Environments with Docker and AWS ECS
     
   </title>
  <meta name="author" content="Michael Herman">

  
  <meta name="description" content="This tutorial details how to spin up reproducible, on-demand test environments with Docker, Amazon EC2 Container Service (ECS), and Circle CI.">
  <meta name="keywords" content="aws, aws ecs, amazon ecs, docker, amazon ec2 container service, microservice, microservices, node, react, reactjs, javascript">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mherman.org/blog/2017/09/18/on-demand-test-environments-with-docker-and-aws-ecs">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Michael Herman" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>


  <!-- hello bar -->
  <link rel="stylesheet" href="/stylesheets/hellobar.css">
  <!-- hello bar -->
  <script type="text/javascript" src="/javascripts/hellobar.js"></script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Fjalla+One" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
<!--- MathJax Configuration -->
<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-37074204-1', 'auto');
    ga('send', 'pageview');

  </script>



</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Michael Herman</a></h1>
  
    <h2>Software Developer</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscribe" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 13.310204,73.332654 C 5.967347,73.332654 0,79.322448 0,86.621428 c 0,7.338776 5.967347,13.262246 13.310204,13.262246 7.370408,0 13.328572,-5.92245 13.328572,-13.262246 0,-7.29898 -5.958164,-13.288774 -13.328572,-13.288774 z M 0.01530612,33.978572 V 53.143878 C 12.493878,53.143878 24.229592,58.02347 33.068368,66.865306 41.894898,75.685714 46.767346,87.47449 46.767346,100 h 19.25 C 66.017346,63.592858 36.4,33.979592 0.01530612,33.978572 l 0,0 z M 0.03877552,0 V 19.17449 C 44.54796,19.17551 80.77551,55.437756 80.77551,100 H 100 C 100,44.87653 55.15102,0 0.03877552,0 z"></path></svg></a></li>
  
</ul>
  
  
  
  
  
  
  
  
  
  
    
      <form action="http://google.com/search" method="get">
        <fieldset role="search">
          <input type="hidden" name="sitesearch" value="mherman.org" />
    
          <input class="search" type="text" name="q" results="0" placeholder="Search"/>
        </fieldset>
      </form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/talks">Talks</a></li>
</ul>

</nav>
      <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=mhermanorg" id="_carbonads_js" media="(min-width: 768px)"></script>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">On-Demand Environments With Docker and AWS ECS</h1>
      
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-09-18T08:08:43-06:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>8:08 am</span></time>
        
        
      </p>
    
  </header>


<div class="entry-content"><p>In this tutorial, we&rsquo;ll look at how to spin up reproducible (and easily-destructible), on-demand test environments with <a href="http://docker.com/">Docker</a>, <a href="https://aws.amazon.com/ecs/">Amazon EC2 Container Service</a> (ECS), and <a href="https://circleci.com/">Circle CI</a> (for continuous integration and delivery).</p>

<div style="text-align:center;">
  <img src="/images/blog/on-demand-environments/on-demand-envs.png" style="max-width: 90%; border:0; box-shadow: none;" alt="on demand test environments">
</div>


<p>We&rsquo;ll be using the following tools&hellip;</p>

<table>
<thead>
<tr>
<th> Tool    </th>
<th> Use Cases              </th>
<th> Version                                                                </th>
</tr>
</thead>
<tbody>
<tr>
<td> Docker  </td>
<td> Containerization and distribution      </td>
<td> <a href="https://github.com/moby/moby/releases/tag/v17.03.2-ce">17.03.2-ce</a>    </td>
</tr>
<tr>
<td> AWS ECS </td>
<td> Container orchestration and management  </td>
<td> <a href="https://github.com/aws/amazon-ecs-agent/releases/tag/v1.14.4">1.14.4</a> (service agent) </td>
</tr>
<tr>
<td> Circle CI </td>
<td> Continuous integration </td>
<td> <a href="https://circleci.com/docs/2.0/">2.0</a> </td>
</tr>
<tr>
<td> AWS JavaScript SDK </td>
<td> Interacting with AWS </td>
<td> <a href="https://github.com/aws/aws-sdk-js/releases/tag/v2.114.0">2.114.0</a> </td>
</tr>
</tbody>
</table>


<p>For a demo, check out the following <a href="https://www.youtube.com/watch?v=O4jlWN3IVhE">video</a>.</p>

<h2>Contents</h2>

<ol>
<li>Prerequisites</li>
<li>Objectives</li>
<li>Introduction</li>
<li>Development Workflow</li>
<li>Project Setup</li>
<li>Manual AWS Setup</li>
<li>Circle CI Setup</li>
<li>AWS SDK Setup</li>
<li>Deployment Script</li>
<li>Testing</li>
<li>Teardown Script</li>
<li>Conclusion and Next Steps</li>
</ol>


<h2>Prerequisites</h2>

<p>This post assumes prior knowledge of Docker and Docker Compose along with microservice architecture in general.</p>

<p>If you haven&rsquo;t already, review the <a href="http://mherman.org/blog/2017/05/11/developing-microservices-node-react-docker">Developing Microservices - Node, React, and Docker</a> blog post. This tutorial utilizes a <em>slightly</em> modified version of the finished project from that post, so be sure to review the code from the <a href="https://github.com/mjhea0/microservice-movies/releases/tag/v3">v3</a> tag of the <a href="https://github.com/mjhea0/microservice-movies">microservice-movies</a> repository, taking note of each service:</p>

<table>
<thead>
<tr>
<th> Name             </th>
<th> Service </th>
<th> Container </th>
<th> Tech                 </th>
</tr>
</thead>
<tbody>
<tr>
<td> Web              </td>
<td> Web     </td>
<td> web       </td>
<td> React, React-Router  </td>
</tr>
<tr>
<td> Movies API       </td>
<td> Movies  </td>
<td> movies    </td>
<td> Node, Express        </td>
</tr>
<tr>
<td> Movies DB        </td>
<td> Movies  </td>
<td> movies-db </td>
<td> Postgres             </td>
</tr>
<tr>
<td> Swagger          </td>
<td> Movies  </td>
<td> swagger   </td>
<td> Swagger UI           </td>
</tr>
<tr>
<td> Users API        </td>
<td> Users   </td>
<td> users     </td>
<td> Node, Express        </td>
</tr>
<tr>
<td> Users DB         </td>
<td> Users   </td>
<td> users-db  </td>
<td> Postgres             </td>
</tr>
<tr>
<td> Functional Tests </td>
<td> Test    </td>
<td> n/a       </td>
<td> TestCafe             </td>
</tr>
</tbody>
</table>


<p>You should also be familiar with AWS in general along with the following AWS services - <a href="https://aws.amazon.com/vpc/">VPC</a>, <a href="https://aws.amazon.com/elasticloadbalancing/">ELB</a>, <a href="https://aws.amazon.com/ec2/">EC2</a>, and <a href="https://aws.amazon.com/iam/">IAM</a>.</p>

<h2>Objectives</h2>

<p>By the end of this tutorial, you will be able to&hellip;</p>

<ol>
<li>Explain what on-demand environments are, why you would want to use them, and the overall development workflow</li>
<li>Discuss the benefits of using on-demand environments</li>
<li>Automate the building, configuring, deploying, and maintaining of on-demand environments on AWS</li>
<li>Configure an Application Load Balancer and ECS to run a set of microservices</li>
<li>Set up continuous integration and deployment to ECS via Circle CI</li>
<li>Integrate Amazon EC2 Container Registry, an image registry, into the continuous integration process</li>
<li>Create a teardown script to remove the environment once testing is complete</li>
</ol>


<h2>Introduction</h2>

<p>The end goal of on-demand test environments is to allow developers to quickly and easily spin up multiple, independent testing environments.</p>

<p>In other words, testing environments are spun up as needed during the development process - when code is checked-in, for example - and, then, when no longer needed, spun down just as quickly to free up resources and keep costs down.</p>

<p>With microservices, testing a single service can be difficult, time consuming, and expensive since you often have to spin up a plethora of services, especially if you have resource and/or config-heavy services. On-demand environments simplify this, making testing and trial easy, decreasing the feedback cycle between review and development.</p>

<p>Such environments can used for running integration and end-to-end tests, QA, UAT, troubleshooting, and basic trial.</p>

<blockquote><p><strong>NOTE:</strong> For more on the benefits of using reproducible, on-demand test environments, review the <a href="https://www.cognizant.com/whitepapers/the-business-case-for-on-demand-test-services-codex1342.pdf">The Business Case for On-Demand Test Services</a> whitepaper.</p></blockquote>

<h2>Development Workflow</h2>

<p>With on-demand environments, the development workflow looks like&hellip;</p>

<h3>(1) Local development</h3>

<ol>
<li>Create a new feature branch from the master branch</li>
<li>Make code changes</li>
<li>Commit and push code to GitHub</li>
</ol>


<h3>(2) Continuous integration</h3>

<ol>
<li>Open a new PR against the development branch</li>
<li>A new build is then triggered on Circle CI</li>
<li>If the build passes, manually merge the PR</li>
<li>A new build is triggered again on Circle CI</li>
<li>If the build passes, deployment occurs&hellip;</li>
</ol>


<h3>(3) Deployment on AWS via deployment scripts</h3>

<ol>
<li>Images are created, tagged, and pushed to ECR</li>
<li>Task Definitions are registered on ECS</li>
<li>Target Groups are created</li>
<li>A Listener is added to the load balancer and Rules are added</li>
<li>ECS Services are created</li>
</ol>


<h3>(4) Testing</h3>

<ol>
<li>End-to-end tests</li>
<li>Acceptance tests</li>
<li>UAT</li>
</ol>


<h3>(5) Teardown</h3>

<ol>
<li>All AWS Resources are torn down</li>
</ol>


<h2>Project Setup</h2>

<p>Fork the <a href="https://github.com/mjhea0/microservice-movies">microservice-movies</a> repo, clone it down, and then check out the <a href="https://github.com/mjhea0/microservice-movies/releases/tag/v3">v3</a> tag to a new branch called <code>aws-docker-on-demand</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git clone https://github.com/YOUR_GITHUB_NAME/microservice-movies
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>microservice-movies
</span><span class='line'><span class="nv">$ </span>git checkout tags/v3 -b aws-docker-on-demand
</span></code></pre></td></tr></table></div></figure>


<p>Set the environment variables:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">NODE_ENV</span><span class="o">=</span><span class="nb">test</span>
</span><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">REACT_APP_USERS_SERVICE_URL</span><span class="o">=</span>http://localhost:3000
</span><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">REACT_APP_MOVIES_SERVICE_URL</span><span class="o">=</span>http://localhost:3001
</span></code></pre></td></tr></table></div></figure>


<p>Build the images and fire up the containers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker-compose -f docker-compose-review.yml build
</span><span class='line'><span class="nv">$ </span>docker-compose -f docker-compose-review.yml up -d
</span></code></pre></td></tr></table></div></figure>


<p>Run the tests:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker-compose -f docker-compose-review.yml <span class="se">\</span>
</span><span class='line'>    run users-service-review npm <span class="nb">test</span> <span class="se">\ </span><span class="o">&amp;&amp;</span>
</span><span class='line'>  docker-compose -f docker-compose-review.yml <span class="se">\</span>
</span><span class='line'>    run movies-service-review npm <span class="nb">test</span> <span class="se">\ </span><span class="o">&amp;&amp;</span>
</span><span class='line'>  testcafe firefox tests/**/*.js
</span></code></pre></td></tr></table></div></figure>


<p>Finally, ensure you can view the app in your browser at <a href="http://localhost:3007">http://localhost:3007</a>, and then try logging in with username <code>michael</code> and password <code>herman</code>.</p>

<h2>Manual AWS Setup</h2>

<p>Before deploying, we need to configure the the following AWS resources:</p>

<ol>
<li><a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html">EC2 Key Pair</a></li>
<li><a href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/ECS_clusters.html">ECS Cluster</a></li>
<li><a href="https://aws.amazon.com/ecr/">EC2 Container Registry</a> (ECR)</li>
<li><a href="https://aws.amazon.com/elasticloadbalancing/applicationloadbalancer/">Application Load Balancer</a> (ALB)</li>
<li><a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-network-security.html">Security Group</a></li>
</ol>


<p>Keep in mind that you <em>could</em> create each of these resources dynamically as well. Clusters can take a bit of time to fire up since EC2 instances need to be spun up though. By setting up the Cluster beforehand, EC2 instances are up and running, ready for Tasks to be added.</p>

<h3>EC2 Key Pair</h3>

<p>Within the <a href="https://console.aws.amazon.com/ec2/">EC2 Dashboard</a>, click &ldquo;Key Pairs&rdquo; on the navigation pane, and then click the &ldquo;Create Key Pair&rdquo; button. Name the key <code>microservicemovies-review</code>. Save the file in a safe place - i.e., &ldquo;~/.ssh&rdquo;.</p>

<h3>ECS Cluster</h3>

<p>An <a href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/ECS_clusters.html">ECS Cluster</a> is just a group of EC2 container instances managed by ECS. To set up, navigate to the <a href="https://console.aws.amazon.com/ecs">ECS Console</a>, and then <a href="http://docs.aws.amazon.com/awsconsolehelpdocs/latest/gsg/getting-started.html#select-region">select</a> the region for the Cluster on the right-side of the nav bar.</p>

<blockquote><p><strong>NOTE</strong>: This tutorial uses the <code>US West (Oregon)</code> / <code>us-west-2</code> region. Feel free to use the region of your choice. For more info, review the <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html">Regions and Availability Zones</a> guide.</p></blockquote>

<p>Next, click the &ldquo;Create Cluster&rdquo; button:</p>

<ol>
<li>&ldquo;Cluster name&rdquo;: <code>microservicemovies-review</code></li>
<li>&ldquo;EC2 instance type&rdquo;: <code>t2.medium</code></li>
<li>&ldquo;Number of instances&rdquo;: <code>3</code></li>
<li>&ldquo;Key pair&rdquo;: <code>microservicemovies-review</code></li>
<li>Create a new <a href="https://aws.amazon.com/vpc/">VPC</a> and <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_SecurityGroups.html">Security Group</a></li>
</ol>


<p>Create the Cluster.</p>

<p>Navigate to the Cluster once it&rsquo;s created, and then click the &ldquo;ECS Instances&rdquo; tab. From there, click the &ldquo;Actions&rdquo; dropdown and select &ldquo;View Cluster Resources&rdquo;. Take note of the VPC and Security Group:</p>

<p><a href="/images/blog/on-demand-environments/aws-ecs-cluster-resources.png"><img src="/images/blog/on-demand-environments/aws-ecs-cluster-resources.png" alt="aws ecs cluster resources" /></a></p>

<h3>ECR</h3>

<p>Within the <a href="https://console.aws.amazon.com/ecs">ECS Console</a>, click &ldquo;Repositories&rdquo; on the navigation pane, and then click the &ldquo;Create repository&rdquo; button. Add the following repositories:</p>

<ol>
<li><code>microservicemovies/users-db-review</code></li>
<li><code>microservicemovies/movies-db-review</code></li>
<li><code>microservicemovies/users-service-review</code></li>
<li><code>microservicemovies/movies-service-review</code></li>
<li><code>microservicemovies/web-service-review</code></li>
<li><code>microservicemovies/swagger-review</code></li>
</ol>


<p><a href="/images/blog/on-demand-environments/aws-ecr-repos.png"><img src="/images/blog/on-demand-environments/aws-ecr-repos.png" alt="aws ecr repos" /></a></p>

<h3>Application Load Balancer</h3>

<p><a href="https://aws.amazon.com/elasticloadbalancing/">Elastic Load Balancing</a>, as of writing, supports two types of load balancers - <em>Classic</em> and <em>Application</em>. Either will work with ECS, but the Application Load Balancer (ALB) is the better of the two since it:</p>

<ol>
<li>Dynamically maps container services to ports</li>
<li>Distributes traffic evenly across the entire ECS Service</li>
<li>Runs status health checks against each service</li>
<li>Allows for zero-downtime deploys</li>
</ol>


<p>To set up, navigate to the <a href="https://console.aws.amazon.com/ec2/">EC2 Dashboard</a>, update the region (if necessary), and then click &ldquo;Load Balancers&rdquo; in the navigation pane. Click the &ldquo;Create Load Balancer&rdquo; button. Select &ldquo;Application Load Balancer&rdquo;, and then go through each of the steps to configure the load balancer&hellip;</p>

<ol>
<li><em>Configure Load Balancer</em>:

<ul>
<li>&ldquo;Name&rdquo;: <code>microservicemovies-review</code></li>
<li>&ldquo;VPC&rdquo;: Select the VPC that was just created</li>
<li>&ldquo;Availability Zones&rdquo;: Select at least two available subnets</li>
</ul>
</li>
<li><em>Configure Security Settings</em>: Skip this for now</li>
<li><em>Configure Security Groups</em>: Select the Security Group that was just created</li>
<li><em>Configure Routing</em>:

<ul>
<li>&ldquo;Name&rdquo;: <code>review-default</code></li>
<li>&ldquo;Port&rdquo;: <code>80</code></li>
<li>&ldquo;Path&rdquo;: <code>/</code></li>
</ul>
</li>
<li><em>Register Targets</em>: Do not assign any instances manually since this will be managed by ECS</li>
</ol>


<p><a href="/images/blog/on-demand-environments/aws-load-balancer.png"><img src="/images/blog/on-demand-environments/aws-load-balancer.png" alt="aws load balancer" /></a></p>

<p>Along with the Application Load Balancer, this will also create a default Target Group called <code>review-default</code>:</p>

<p><a href="/images/blog/on-demand-environments/aws-default-target-group.png"><img src="/images/blog/on-demand-environments/aws-default-target-group.png" alt="aws default target group" /></a></p>

<h3>Security Group</h3>

<p>Finally, let&rsquo;s add some ports to work with to the Security Group. Within the <a href="https://console.aws.amazon.com/ec2/">EC2 Dashboard</a>, click &ldquo;Security Groups&rdquo; in the navigation pane, and then select the Security Group that was just created. On the &ldquo;Inbound Rules&rdquo; pane, click the &ldquo;Edit&rdquo; button and the &ldquo;Add another rule button&rdquo;:</p>

<ol>
<li>&ldquo;Type&rdquo;: &ldquo;Custom TCP Rule&rdquo;</li>
<li>&ldquo;Protocol&rdquo;: &ldquo;TCP (6)&rdquo;</li>
<li>&ldquo;Port Range&rdquo;: <code>30000-50000</code></li>
<li>&ldquo;Source&rdquo;: <code>0.0.0.0/0</code></li>
</ol>


<p>Click the &ldquo;Save&rdquo; button.</p>

<p><a href="/images/blog/on-demand-environments/aws-security-groups.png"><img src="/images/blog/on-demand-environments/aws-security-groups.png" alt="aws security groups" /></a></p>

<p>That&rsquo;s it for the basic AWS resources.</p>

<h2>Circle CI Setup</h2>

<p>Next, <a href="https://circleci.com/signup/">sign up</a> for Circle CI (if necessary) and follow the basic <a href="https://circleci.com/docs/2.0/first-steps/">steps</a> to configure Circle 2.0, making sure to enable access to your GitHub repos. Then, create a new folder called &ldquo;.circleci&rdquo; in the project root of &ldquo;microservice-movies&rdquo; and add a <em>config.yml</em> file to that directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">jobs</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">build</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">docker</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker:17.03.2-ce-git</span>
</span><span class='line'>    <span class="l-Scalar-Plain">working_directory</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~/microservice-movies</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">NODE_ENV</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">REACT_APP_USERS_SERVICE_URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://localhost:3000</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">REACT_APP_MOVIES_SERVICE_URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://localhost:3001</span>
</span><span class='line'>    <span class="l-Scalar-Plain">parallelism</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>    <span class="l-Scalar-Plain">steps</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">checkout</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">setup_remote_docker</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">reusable</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>          <span class="l-Scalar-Plain">exclusive</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Install dependencies</span>
</span><span class='line'>          <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>            <span class="no">apk add --no-cache \</span>
</span><span class='line'>              <span class="no">py-pip=9.0.0-r1 \</span>
</span><span class='line'>              <span class="no">bash \</span>
</span><span class='line'>              <span class="no">jq \</span>
</span><span class='line'>              <span class="no">curl \</span>
</span><span class='line'>              <span class="no">nodejs</span>
</span><span class='line'>            <span class="no">pip install \</span>
</span><span class='line'>              <span class="no">docker-compose==1.12.0 \</span>
</span><span class='line'>              <span class="no">awscli==1.11.76</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Build Docker images</span>
</span><span class='line'>          <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-compose -f docker-compose-review.yml build</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Spin up Docker containers</span>
</span><span class='line'>          <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-compose -f docker-compose-review.yml up -d</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Test the user service</span>
</span><span class='line'>          <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-compose -f docker-compose-review.yml run users-service-review npm test</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Test the movies service</span>
</span><span class='line'>          <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-compose -f docker-compose-review.yml run movies-service-review npm test</span>
</span></code></pre></td></tr></table></div></figure>


<p>Review this file. Refer to the Circle <a href="https://circleci.com/docs/2.0/">documentation</a> as needed. Commit and push your code to GitHub once done. On Circle, navigate to the <a href="https://circleci.com/add-projects">Add Projects</a> page and click the &ldquo;Build Project&rdquo; button next to your project. This will trigger a new build, which should pass.</p>

<h2>AWS SDK Setup</h2>

<p>Since the microservice stack is built with Node, we&rsquo;ll develop the deployment script in JavaScript with the <a href="https://www.npmjs.com/package/aws-sdk">AWS JavaScript SDK</a>.</p>

<p>Add a <em>package.json</em> to the project root:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;microservice-movies&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;aws-sdk&quot;</span><span class="p">:</span> <span class="s2">&quot;2.114.0&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Install the dependency:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>npm install
</span></code></pre></td></tr></table></div></figure>


<p>Add a new folder to the project root called &ldquo;ecs&rdquo;, and then create a new folder called &ldquo;scripts&rdquo; within that folder. Finally, add a new file called <em>setup.js</em> to &ldquo;scripts&rdquo;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;aws-sdk&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// globals</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_ACCOUNT_ID</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_ACCOUNT_ID</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_ACCESS_KEY_ID</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_SECRET_ACCESS_KEY</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_USERNAME</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_USERNAME</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_CONFIG_REGION</span> <span class="o">=</span> <span class="s1">&#39;us-west-2&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">clusterName</span> <span class="o">=</span> <span class="s1">&#39;microservicemovies-review&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// config</span>
</span><span class='line'>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">Config</span><span class="p">();</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">accessKeyId</span> <span class="o">=</span> <span class="nx">AWS_ACCESS_KEY_ID</span><span class="p">;</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">secretAccessKey</span> <span class="o">=</span> <span class="nx">AWS_SECRET_ACCESS_KEY</span><span class="p">;</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">region</span> <span class="o">=</span> <span class="nx">AWS_CONFIG_REGION</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// init aws services</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">ecs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">ECS</span><span class="p">();</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">iam</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">IAM</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// methods</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">ensureAuthenticated</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">UserName</span><span class="o">:</span> <span class="nx">AWS_USERNAME</span> <span class="p">};</span>
</span><span class='line'>    <span class="nx">iam</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">confirmRegion</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">region</span> <span class="o">!==</span> <span class="nx">AWS_CONFIG_REGION</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">reject</span><span class="p">(</span><span class="s1">&#39;Something went wrong!&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">resolve</span><span class="p">(</span><span class="nx">AWS_CONFIG_REGION</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">getCluster</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">clusters</span><span class="o">:</span> <span class="p">[</span> <span class="nx">clusterName</span> <span class="p">]</span> <span class="p">};</span>
</span><span class='line'>    <span class="nx">ecs</span><span class="p">.</span><span class="nx">describeClusters</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// main</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nx">ensureAuthenticated</span><span class="p">()</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Welcome</span> <span class="nx">$</span><span class="p">{</span><span class="nx">data</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">UserName</span><span class="p">}</span><span class="o">!</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">confirmRegion</span><span class="p">();</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">region</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">AWS</span> <span class="nx">Region</span> <span class="o">-&gt;</span> <span class="nx">$</span><span class="p">{</span><span class="nx">region</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">getCluster</span><span class="p">();</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">cluster</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">clusters</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Cluster does not exist!&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">ECS</span> <span class="nx">Cluster</span> <span class="o">-&gt;</span> <span class="nx">$</span><span class="p">{</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">clusterName</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>In essence, this confirms that the AWS user credentials are correct and that the AWS Region and ECS Cluster are configured properly.</p>

<p>Set the following environment variables locally:</p>

<ol>
<li><code>AWS_ACCOUNT_ID</code></li>
<li><code>AWS_ACCESS_KEY_ID</code></li>
<li><code>AWS_SECRET_ACCESS_KEY</code></li>
<li><code>AWS_USERNAME</code></li>
</ol>


<p>Run the script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>node ecs/scripts/setup.js
</span></code></pre></td></tr></table></div></figure>


<p>You should see:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>Welcome AWS_USERNAME!
</span><span class='line'>AWS Region -&gt; us-west-2
</span><span class='line'>ECS Cluster -&gt; microservicemovies-review
</span></code></pre></td></tr></table></div></figure>


<p>Add another step to the bottom of <em>.circleci/config.yml</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Deploy</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>      <span class="no">npm install</span>
</span><span class='line'>      <span class="no">node ecs/scripts/setup.js</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add the following <a href="https://circleci.com/docs/2.0/env-vars/#adding-environment-variables-in-the-app">environment variables</a> to Circle so that we can properly configure the AWS SDK:</p>

<ol>
<li><code>AWS_ACCOUNT_ID</code></li>
<li><code>AWS_ACCESS_KEY_ID</code></li>
<li><code>AWS_SECRET_ACCESS_KEY</code></li>
<li><code>AWS_USERNAME</code></li>
</ol>


<p>Commit your changes, and then push to GitHub to trigger a new build. Make sure it passes before moving on.</p>

<h2>Deployment Script</h2>

<p>Moving right along, let&rsquo;s start building the deployment scripts to set up the AWS resources and deploy the app.</p>

<p>Main Steps:</p>

<ol>
<li>Tag and push images to ECR</li>
<li>Get open port for the Listener</li>
<li>Register Task Definitions</li>
<li>Create Target Groups</li>
<li>Add the Listener and Rules</li>
<li>Create new Services</li>
</ol>


<h3>(1) Tag and push images to ECR</h3>

<p>Create a new file in &ldquo;ecs/scripts&rdquo; called <em>ecr.sh</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/usr/bin/env bash</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># config</span>
</span><span class='line'>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'>
</span><span class='line'><span class="nv">ECS_REGION</span><span class="o">=</span><span class="s2">&quot;us-west-2&quot;</span>
</span><span class='line'><span class="nv">NAMESPACE</span><span class="o">=</span><span class="s2">&quot;microservicemovies&quot;</span>
</span><span class='line'><span class="nv">IMAGE_BASE</span><span class="o">=</span><span class="s2">&quot;microservicemovies&quot;</span>
</span><span class='line'><span class="nv">ECR_URI</span><span class="o">=</span><span class="s2">&quot;${AWS_ACCOUNT_ID}.dkr.ecr.${ECS_REGION}.amazonaws.com&quot;</span>
</span><span class='line'><span class="nv">SHORT_GIT_HASH</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$CIRCLE_SHA1</span> <span class="p">|</span> cut -c -7<span class="k">)</span>
</span><span class='line'><span class="nv">TAG</span><span class="o">=</span><span class="nv">$SHORT_GIT_HASH</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># helpers</span>
</span><span class='line'>
</span><span class='line'>configure_aws_cli<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;Configuring AWS...&quot;</span>
</span><span class='line'>  aws --version
</span><span class='line'>  aws configure <span class="nb">set </span>default.region <span class="nv">$ECS_REGION</span>
</span><span class='line'>  aws configure <span class="nb">set </span>default.output json
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;AWS configured!&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>tag_and_push_images<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;Tagging and pushing images...&quot;</span>
</span><span class='line'>  <span class="k">$(</span>aws ecr get-login --region <span class="s2">&quot;${ECS_REGION}&quot;</span><span class="k">)</span>
</span><span class='line'>  <span class="c"># tag</span>
</span><span class='line'>  docker tag <span class="k">${</span><span class="nv">IMAGE_BASE</span><span class="k">}</span>_users-db-review <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/users-db-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
</span><span class='line'>  docker tag <span class="k">${</span><span class="nv">IMAGE_BASE</span><span class="k">}</span>_movies-db-review <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/movies-db-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
</span><span class='line'>  docker tag <span class="k">${</span><span class="nv">IMAGE_BASE</span><span class="k">}</span>_users-service-review <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/users-service-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
</span><span class='line'>  docker tag <span class="k">${</span><span class="nv">IMAGE_BASE</span><span class="k">}</span>_movies-service-review <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/movies-service-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
</span><span class='line'>  docker tag <span class="k">${</span><span class="nv">IMAGE_BASE</span><span class="k">}</span>_web-service-review <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/web-service-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
</span><span class='line'>  docker tag <span class="k">${</span><span class="nv">IMAGE_BASE</span><span class="k">}</span>_swagger-review <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/swagger-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
</span><span class='line'>  <span class="c"># push</span>
</span><span class='line'>  docker push <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/users-db-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
</span><span class='line'>  docker push <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/movies-db-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
</span><span class='line'>  docker push <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/users-service-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
</span><span class='line'>  docker push <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/movies-service-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
</span><span class='line'>  docker push <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/web-service-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
</span><span class='line'>  docker push <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/swagger-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;Images tagged and pushed!&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># main</span>
</span><span class='line'>
</span><span class='line'>configure_aws_cli
</span><span class='line'>tag_and_push_images
</span></code></pre></td></tr></table></div></figure>


<p>Each deploy is associated with a different commit and, thus, a different version of the code. To link the commit back to a specific image, we just used part of the Git commit SHA as the image tag:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">SHORT_GIT_HASH</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$CIRCLE_SHA1</span> <span class="p">|</span> cut -c -7<span class="k">)</span>
</span><span class='line'><span class="nv">TAG</span><span class="o">=</span><span class="nv">$SHORT_GIT_HASH</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>NOTE:</strong> Instead of using the associated Git commit SHA, you could get a bit creative and build a Heroku-like random name generator.</p></blockquote>

<p>Update the <code>Deploy</code> command in <em>.circle/config.yml</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Deploy</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>      <span class="no">npm install</span>
</span><span class='line'>      <span class="no">node ecs/scripts/setup.js</span>
</span><span class='line'>      <span class="no">sh ecs/scripts/ecr.sh</span>
</span></code></pre></td></tr></table></div></figure>


<p>Commit and push your code to GitHub to trigger a new Circle build. Once done, ensure the images are up on ECS with the appropriate tag:</p>

<p><a href="/images/blog/on-demand-environments/aws-ecr-users-db-review-image.png"><img src="/images/blog/on-demand-environments/aws-ecr-users-db-review-image.png" alt="aws ecr users db review image" /></a></p>

<h3>(2) Get open port for the Listener</h3>

<p>Remember how we set a range of open ports, <code>30000</code> - <code>50000</code>, when we set up the Security Group? Well, each new environment will be assigned to a port within this range.</p>

<p>Add a new file called <em>listener.js</em> to &ldquo;ecs/scripts&rdquo;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;aws-sdk&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// globals</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_ACCOUNT_ID</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_ACCOUNT_ID</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_ACCESS_KEY_ID</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_SECRET_ACCESS_KEY</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_USERNAME</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_USERNAME</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_CONFIG_REGION</span> <span class="o">=</span> <span class="s1">&#39;us-west-2&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">LOAD_BALANCER_ARN</span> <span class="o">=</span> <span class="s1">&#39;UPDATE_ME&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// config</span>
</span><span class='line'>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">Config</span><span class="p">();</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">accessKeyId</span> <span class="o">=</span> <span class="nx">AWS_ACCESS_KEY_ID</span><span class="p">;</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">secretAccessKey</span> <span class="o">=</span> <span class="nx">AWS_SECRET_ACCESS_KEY</span><span class="p">;</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">region</span> <span class="o">=</span> <span class="nx">AWS_CONFIG_REGION</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// init aws services</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">elbv2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">ELBv2</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// methods</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">getPort</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">LoadBalancerArn</span><span class="o">:</span> <span class="nx">LOAD_BALANCER_ARN</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">elbv2</span><span class="p">.</span><span class="nx">describeListeners</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="kr">const</span> <span class="nx">max</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">Listeners</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">prev</span><span class="p">,</span> <span class="nx">current</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="nx">prev</span><span class="p">.</span><span class="nx">Port</span> <span class="o">&gt;</span> <span class="nx">current</span><span class="p">.</span><span class="nx">Port</span><span class="p">)</span> <span class="o">?</span> <span class="nx">prev</span> <span class="o">:</span> <span class="nx">current</span><span class="p">;</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">max</span><span class="p">.</span><span class="nx">Port</span><span class="p">)</span> <span class="o">===</span> <span class="mi">80</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">resolve</span><span class="p">(</span><span class="mi">30000</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="kr">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">max</span><span class="p">.</span><span class="nx">Port</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">resolve</span><span class="p">(</span><span class="nx">port</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">getPort</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add then update the following variable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">LOAD_BALANCER_ARN</span> <span class="o">=</span> <span class="s1">&#39;UPDATE_ME&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, take note of the following <code>if</code> statement:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">max</span><span class="p">.</span><span class="nx">Port</span><span class="p">)</span> <span class="o">===</span> <span class="mi">80</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">resolve</span><span class="p">(</span><span class="mi">30000</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">max</span><span class="p">.</span><span class="nx">Port</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">resolve</span><span class="p">(</span><span class="nx">port</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Why do we need this?</p>

<p>Since the default Target Group, <code>review-default</code>, was configured to listen on port 80, we need to account for it if it&rsquo;s the only Listener set up since we&rsquo;re bumping the port by 1 each time.</p>

<p>We&rsquo;ll test this out in the next section&hellip;</p>

<h3>(3) Register Task Definitions</h3>

<p>A <a href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definitions.html">Task Definition</a> is used to create an application from one or more containers. It&rsquo;s similar to a Docker Compose file.</p>

<p>Steps:</p>

<ol>
<li>Create Task Definition files</li>
<li>Create script to register Task Definitions</li>
</ol>


<h4>Create Task Definition files</h4>

<p>Create a new directory called &ldquo;tasks&rdquo; within &ldquo;ecs&rdquo;, and then add the following files:</p>

<ol>
<li><em>users-review_task.js</em></li>
<li><em>movies-review_task.js</em></li>
<li><em>web-review_task.js</em></li>
</ol>


<h5>Users - <em>users-review_task.js</em></h5>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">createUsersTaskDefinition</span><span class="p">(</span><span class="nx">accountID</span><span class="p">,</span> <span class="nx">region</span><span class="p">,</span> <span class="nx">tag</span><span class="p">,</span> <span class="nx">family</span><span class="p">,</span> <span class="nx">revision</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">taskDefinition</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">containerDefinitions</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;users-service-review&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">image</span><span class="o">:</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">accountID</span><span class="p">}.</span><span class="nx">dkr</span><span class="p">.</span><span class="nx">ecr</span><span class="p">.</span><span class="nx">$</span><span class="p">{</span><span class="nx">region</span><span class="p">}.</span><span class="nx">amazonaws</span><span class="p">.</span><span class="nx">com</span><span class="err">\</span><span class="o">/</span><span class="nx">microservicemovies</span><span class="err">\</span><span class="o">/</span><span class="nx">users</span><span class="o">-</span><span class="nx">service</span><span class="o">-</span><span class="nx">review</span><span class="o">:</span><span class="nx">$</span><span class="p">{</span><span class="nx">tag</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">essential</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">memoryReservation</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">cpu</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">portMappings</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">containerPort</span><span class="o">:</span> <span class="mi">3000</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">hostPort</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">protocol</span><span class="o">:</span> <span class="s1">&#39;tcp&#39;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nx">environment</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;DATABASE_URL&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;postgres://postgres:postgres@users-db-review:5432/users_dev&#39;</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;DATABASE_TEST_URL&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;postgres://postgres:postgres@users-db-review:5432/users_test&#39;</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;NODE_ENV&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;test&#39;</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;TOKEN_SECRET&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;changeme&#39;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nx">links</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="s1">&#39;users-db-review&#39;</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nx">logConfiguration</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">logDriver</span><span class="o">:</span> <span class="s1">&#39;awslogs&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s1">&#39;awslogs-group&#39;</span><span class="o">:</span> <span class="s1">&#39;microservicemovies&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;awslogs-region&#39;</span><span class="o">:</span> <span class="nx">region</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;users-db-review&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">image</span><span class="o">:</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">accountID</span><span class="p">}.</span><span class="nx">dkr</span><span class="p">.</span><span class="nx">ecr</span><span class="p">.</span><span class="nx">$</span><span class="p">{</span><span class="nx">region</span><span class="p">}.</span><span class="nx">amazonaws</span><span class="p">.</span><span class="nx">com</span><span class="err">\</span><span class="o">/</span><span class="nx">microservicemovies</span><span class="err">\</span><span class="o">/</span><span class="nx">users</span><span class="o">-</span><span class="nx">db</span><span class="o">-</span><span class="nx">review</span><span class="o">:</span><span class="nx">$</span><span class="p">{</span><span class="nx">tag</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">essential</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">memoryReservation</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">cpu</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">portMappings</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">containerPort</span><span class="o">:</span> <span class="mi">5432</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nx">environment</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;POSTGRES_USER&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;postgres&#39;</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;POSTGRES_PASSWORD&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;postgres&#39;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nx">logConfiguration</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">logDriver</span><span class="o">:</span> <span class="s1">&#39;awslogs&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s1">&#39;awslogs-group&#39;</span><span class="o">:</span> <span class="s1">&#39;microservicemovies&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;awslogs-region&#39;</span><span class="o">:</span> <span class="nx">region</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nx">family</span><span class="o">:</span> <span class="s1">&#39;microservicemovies-review-users-td&#39;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">taskDefinition</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">createUsersTaskDefinition</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Most of this should be fairly straightforward since the container definition relates back to the Docker Compose file. Review the <a href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definition_parameters.html">Task Definition Parameters</a> guide for more info.</p>

<p>Two things to note:</p>

<ol>
<li>We set the host port for the users service to <code>0</code> so that a port is dynamically assigned when the Task is fired up.</li>
<li>We also configured logs, via  <a href="http://docs.aws.amazon.com/AmazonECS/latest/APIReference/API_LogConfiguration.html">LogConfiguration</a>, to pipe logs to <a href="https://console.aws.amazon.com/cloudwatch">CloudWatch</a>. To set up, we need to create a new <a href="http://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CloudWatchLogsConcepts.html">Log Group</a>. Simply navigate to <a href="https://console.aws.amazon.com/cloudwatch">CloudWatch</a>, click &ldquo;Logs&rdquo; on the navigation pane, click the &ldquo;Actions&rdquo; drop-down button, and then select &ldquo;Create log group&rdquo;. Name the group <code>microservicemovies-review</code>.</li>
</ol>


<h5>Movies - <em>movies-review_task.js</em></h5>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">createMoviesTaskDefinition</span><span class="p">(</span><span class="nx">accountID</span><span class="p">,</span> <span class="nx">region</span><span class="p">,</span> <span class="nx">tag</span><span class="p">,</span> <span class="nx">family</span><span class="p">,</span> <span class="nx">revision</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">taskDefinition</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">containerDefinitions</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;movies-service-review&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">image</span><span class="o">:</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">accountID</span><span class="p">}.</span><span class="nx">dkr</span><span class="p">.</span><span class="nx">ecr</span><span class="p">.</span><span class="nx">$</span><span class="p">{</span><span class="nx">region</span><span class="p">}.</span><span class="nx">amazonaws</span><span class="p">.</span><span class="nx">com</span><span class="err">\</span><span class="o">/</span><span class="nx">microservicemovies</span><span class="err">\</span><span class="o">/</span><span class="nx">movies</span><span class="o">-</span><span class="nx">service</span><span class="o">-</span><span class="nx">review</span><span class="o">:</span><span class="nx">$</span><span class="p">{</span><span class="nx">tag</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">essential</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">memoryReservation</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">cpu</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">portMappings</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">containerPort</span><span class="o">:</span> <span class="mi">3000</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">hostPort</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">protocol</span><span class="o">:</span> <span class="s1">&#39;tcp&#39;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nx">environment</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;DATABASE_URL&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;postgres://postgres:postgres@movies-db-review:5432/movies_dev&#39;</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;DATABASE_TEST_URL&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;postgres://postgres:postgres@movies-db-review:5432/movies_test&#39;</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;NODE_ENV&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;test&#39;</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;TOKEN_SECRET&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;changeme&#39;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nx">links</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="s1">&#39;movies-db-review&#39;</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nx">logConfiguration</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">logDriver</span><span class="o">:</span> <span class="s1">&#39;awslogs&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s1">&#39;awslogs-group&#39;</span><span class="o">:</span> <span class="s1">&#39;microservicemovies&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;awslogs-region&#39;</span><span class="o">:</span> <span class="nx">region</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;movies-db-review&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">image</span><span class="o">:</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">accountID</span><span class="p">}.</span><span class="nx">dkr</span><span class="p">.</span><span class="nx">ecr</span><span class="p">.</span><span class="nx">$</span><span class="p">{</span><span class="nx">region</span><span class="p">}.</span><span class="nx">amazonaws</span><span class="p">.</span><span class="nx">com</span><span class="err">\</span><span class="o">/</span><span class="nx">microservicemovies</span><span class="err">\</span><span class="o">/</span><span class="nx">movies</span><span class="o">-</span><span class="nx">db</span><span class="o">-</span><span class="nx">review</span><span class="o">:</span><span class="nx">$</span><span class="p">{</span><span class="nx">tag</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">essential</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">memoryReservation</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">cpu</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">portMappings</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">containerPort</span><span class="o">:</span> <span class="mi">5432</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nx">environment</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;POSTGRES_USER&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;postgres&#39;</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;POSTGRES_PASSWORD&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;postgres&#39;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nx">logConfiguration</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">logDriver</span><span class="o">:</span> <span class="s1">&#39;awslogs&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s1">&#39;awslogs-group&#39;</span><span class="o">:</span> <span class="s1">&#39;microservicemovies&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;awslogs-region&#39;</span><span class="o">:</span> <span class="nx">region</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;swagger-review&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">image</span><span class="o">:</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">accountID</span><span class="p">}.</span><span class="nx">dkr</span><span class="p">.</span><span class="nx">ecr</span><span class="p">.</span><span class="nx">$</span><span class="p">{</span><span class="nx">region</span><span class="p">}.</span><span class="nx">amazonaws</span><span class="p">.</span><span class="nx">com</span><span class="err">\</span><span class="o">/</span><span class="nx">microservicemovies</span><span class="err">\</span><span class="o">/</span><span class="nx">swagger</span><span class="o">-</span><span class="nx">review</span><span class="o">:</span><span class="nx">$</span><span class="p">{</span><span class="nx">tag</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">essential</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">memoryReservation</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">cpu</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">portMappings</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">containerPort</span><span class="o">:</span> <span class="mi">3001</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">hostPort</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">protocol</span><span class="o">:</span> <span class="s1">&#39;tcp&#39;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nx">environment</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;NODE_ENV&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;test&#39;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nx">logConfiguration</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">logDriver</span><span class="o">:</span> <span class="s1">&#39;awslogs&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s1">&#39;awslogs-group&#39;</span><span class="o">:</span> <span class="s1">&#39;microservicemovies&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;awslogs-region&#39;</span><span class="o">:</span> <span class="nx">region</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nx">family</span><span class="o">:</span> <span class="s1">&#39;microservicemovies-review-movies-td&#39;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">taskDefinition</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">createMoviesTaskDefinition</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first two containers should be almost identical to the containers in the previous Task Definition. Review the Swagger container definition.</p>

<h5>Web - <em>web-review_task.js</em></h5>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">createWebTaskDefinition</span><span class="p">(</span><span class="nx">accountID</span><span class="p">,</span> <span class="nx">region</span><span class="p">,</span> <span class="nx">tag</span><span class="p">,</span> <span class="nx">usersURL</span><span class="p">,</span> <span class="nx">moviesURL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">taskDefinition</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">containerDefinitions</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;web-service-review&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">image</span><span class="o">:</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">accountID</span><span class="p">}.</span><span class="nx">dkr</span><span class="p">.</span><span class="nx">ecr</span><span class="p">.</span><span class="nx">$</span><span class="p">{</span><span class="nx">region</span><span class="p">}.</span><span class="nx">amazonaws</span><span class="p">.</span><span class="nx">com</span><span class="err">\</span><span class="o">/</span><span class="nx">microservicemovies</span><span class="err">\</span><span class="o">/</span><span class="nx">web</span><span class="o">-</span><span class="nx">service</span><span class="o">-</span><span class="nx">review</span><span class="o">:</span><span class="nx">$</span><span class="p">{</span><span class="nx">tag</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">essential</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">memoryReservation</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">cpu</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">portMappings</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">containerPort</span><span class="o">:</span> <span class="mi">9000</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">hostPort</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">protocol</span><span class="o">:</span> <span class="s1">&#39;tcp&#39;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nx">environment</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;NODE_ENV&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;test&#39;</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;REACT_APP_USERS_SERVICE_URL&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">value</span><span class="o">:</span> <span class="nx">usersURL</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;REACT_APP_MOVIES_SERVICE_URL&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">value</span><span class="o">:</span> <span class="nx">moviesURL</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nx">logConfiguration</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">logDriver</span><span class="o">:</span> <span class="s1">&#39;awslogs&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s1">&#39;awslogs-group&#39;</span><span class="o">:</span> <span class="s1">&#39;microservicemovies&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;awslogs-region&#39;</span><span class="o">:</span> <span class="nx">region</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nx">family</span><span class="o">:</span> <span class="s1">&#39;microservicemovies-review-web-td&#39;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">taskDefinition</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">createWebTaskDefinition</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice how we&rsquo;re passing in values for the environment variables. You could also use HashiCorp&rsquo;s <a href="https://www.vaultproject.io/">Vault</a> project to better manage secrets and variables.</p>

<h4>Create script to register Task Definitions</h4>

<p>Next, add a new file called <em>tasks.js</em> to &ldquo;ecs/scripts&rdquo;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;aws-sdk&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">createUsersTaskDefinition</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../tasks/users-review_task&#39;</span><span class="p">).</span><span class="nx">createUsersTaskDefinition</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">createMoviesTaskDefinition</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../tasks/movies-review_task&#39;</span><span class="p">).</span><span class="nx">createMoviesTaskDefinition</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">createWebTaskDefinition</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../tasks/web-review_task&#39;</span><span class="p">).</span><span class="nx">createWebTaskDefinition</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./listener&#39;</span><span class="p">).</span><span class="nx">getPort</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// globals</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_ACCOUNT_ID</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_ACCOUNT_ID</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_ACCESS_KEY_ID</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_SECRET_ACCESS_KEY</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_USERNAME</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_USERNAME</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_CONFIG_REGION</span> <span class="o">=</span> <span class="s1">&#39;us-west-2&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">SHORT_GIT_HASH</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CIRCLE_SHA1</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">LOAD_BALANCER_DNS</span> <span class="o">=</span> <span class="s1">&#39;http://microservicemovies-review-476947634.us-west-2.elb.amazonaws.com&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// config</span>
</span><span class='line'>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">Config</span><span class="p">();</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">accessKeyId</span> <span class="o">=</span> <span class="nx">AWS_ACCESS_KEY_ID</span><span class="p">;</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">secretAccessKey</span> <span class="o">=</span> <span class="nx">AWS_SECRET_ACCESS_KEY</span><span class="p">;</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">region</span> <span class="o">=</span> <span class="nx">AWS_CONFIG_REGION</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// init aws services</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">ecs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">ECS</span><span class="p">();</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">iam</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">IAM</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// methods</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">ensureAuthenticated</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">UserName</span><span class="o">:</span> <span class="nx">AWS_USERNAME</span> <span class="p">};</span>
</span><span class='line'>    <span class="nx">iam</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">registerTaskDef</span><span class="p">(</span><span class="nx">task</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">task</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">ecs</span><span class="p">.</span><span class="nx">registerTaskDefinition</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">registerUsersTD</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">task</span> <span class="o">=</span> <span class="nx">createUsersTaskDefinition</span><span class="p">(</span><span class="nx">AWS_ACCOUNT_ID</span><span class="p">,</span> <span class="nx">AWS_CONFIG_REGION</span><span class="p">,</span> <span class="nx">SHORT_GIT_HASH</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">registerTaskDef</span><span class="p">(</span><span class="nx">task</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Task Registered!&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">taskDefinition</span><span class="p">.</span><span class="nx">taskDefinitionArn</span><span class="p">);</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">registerMoviesTD</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">task</span> <span class="o">=</span> <span class="nx">createMoviesTaskDefinition</span><span class="p">(</span><span class="nx">AWS_ACCOUNT_ID</span><span class="p">,</span> <span class="nx">AWS_CONFIG_REGION</span><span class="p">,</span> <span class="nx">SHORT_GIT_HASH</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">registerTaskDef</span><span class="p">(</span><span class="nx">task</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Task Registered!&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">taskDefinition</span><span class="p">.</span><span class="nx">taskDefinitionArn</span><span class="p">);</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">registerWebTD</span><span class="p">(</span><span class="nx">usersURL</span><span class="p">,</span> <span class="nx">moviesURL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">task</span> <span class="o">=</span> <span class="nx">createWebTaskDefinition</span><span class="p">(</span><span class="nx">AWS_ACCOUNT_ID</span><span class="p">,</span> <span class="nx">AWS_CONFIG_REGION</span><span class="p">,</span> <span class="nx">SHORT_GIT_HASH</span><span class="p">,</span> <span class="nx">usersURL</span><span class="p">,</span> <span class="nx">moviesURL</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">registerTaskDef</span><span class="p">(</span><span class="nx">task</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Task Registered!&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">taskDefinition</span><span class="p">.</span><span class="nx">taskDefinitionArn</span><span class="p">);</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'>  <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// main</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nx">ensureAuthenticated</span><span class="p">()</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Welcome</span> <span class="nx">$</span><span class="p">{</span><span class="nx">data</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">UserName</span><span class="p">}</span><span class="o">!</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">port</span><span class="p">();</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">port</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">usersURL</span> <span class="o">=</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">LOAD_BALANCER_DNS</span><span class="p">}</span><span class="o">:</span><span class="nx">$</span><span class="p">{</span><span class="nx">port</span><span class="p">}</span><span class="o">/</span><span class="nx">users</span><span class="err">`</span><span class="p">;</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">moviesURL</span> <span class="o">=</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">LOAD_BALANCER_DNS</span><span class="p">}</span><span class="o">:</span><span class="nx">$</span><span class="p">{</span><span class="nx">port</span><span class="p">}</span><span class="o">/</span><span class="nx">movies</span><span class="err">`</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">registerUsersTD</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">registerMoviesTD</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">registerWebTD</span><span class="p">(</span><span class="nx">usersURL</span><span class="p">,</span> <span class="nx">moviesURL</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, we pulled in the <code>getPort</code> function from the <em>listener.js</em> file, created the individual Task Definitions, and then passed the definitions to the <code>registerTaskDefinition</code> function to register them on AWS. Review the official AWS SDK <a href="http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/ECS.html#registerTaskDefinition-property">documentation</a> for more info.</p>

<p>Update the <code>Deploy</code> command in <em>.circle/config.yml</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Deploy</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>      <span class="no">npm install</span>
</span><span class='line'>      <span class="no">node ecs/scripts/setup.js</span>
</span><span class='line'>      <span class="no">sh ecs/scripts/ecr.sh</span>
</span><span class='line'>      <span class="no">node ecs/scripts/tasks.js</span>
</span></code></pre></td></tr></table></div></figure>


<p>Commit and push your code to GitHub. Once the Circle build passes, make sure the Task Definitions were created:</p>

<p><a href="/images/blog/on-demand-environments/aws-ecs-task-definitions.png"><img src="/images/blog/on-demand-environments/aws-ecs-task-definitions.png" alt="aws ecs task definitions" /></a></p>

<p>Also, make sure the <code>REACT_APP_USERS_SERVICE_URL</code> and <code>REACT_APP_MOVIES_SERVICE_URL</code> environment variables were added correctly to the <code>microservicemovies-review-web-td</code> Task Definition by clicking the Task Definition name, selecting the latest revision, and then expanding the <code>web-service-review</code> container:</p>

<p><a href="/images/blog/on-demand-environments/aws-ecs-web-task-definition.png"><img src="/images/blog/on-demand-environments/aws-ecs-web-task-definition.png" alt="aws ecs web task definition" /></a></p>

<h3>(4) Create Target Groups</h3>

<p><a href="http://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-target-groups.html">Target Group</a>s are used to link the Application Load Balancer (ALB) to the container instances, which we just defined.</p>

<p>Create a new script in &ldquo;scripts&rdquo; called <em>alb.js</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;aws-sdk&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// globals</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_ACCOUNT_ID</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_ACCOUNT_ID</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_ACCESS_KEY_ID</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_SECRET_ACCESS_KEY</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_USERNAME</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_USERNAME</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_CONFIG_REGION</span> <span class="o">=</span> <span class="s1">&#39;us-west-2&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">SHORT_GIT_HASH</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CIRCLE_SHA1</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">VPC_ID</span><span class="o">=</span><span class="s1">&#39;UPDATE_ME&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">USERS_TARGET_GROUP_ARN</span><span class="p">;</span>
</span><span class='line'><span class="kd">let</span> <span class="nx">MOVIES_TARGET_GROUP_ARN</span><span class="p">;</span>
</span><span class='line'><span class="kd">let</span> <span class="nx">WEB_TARGET_GROUP_ARN</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// config</span>
</span><span class='line'>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">Config</span><span class="p">();</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">accessKeyId</span> <span class="o">=</span> <span class="nx">AWS_ACCESS_KEY_ID</span><span class="p">;</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">secretAccessKey</span> <span class="o">=</span> <span class="nx">AWS_SECRET_ACCESS_KEY</span><span class="p">;</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">region</span> <span class="o">=</span> <span class="nx">AWS_CONFIG_REGION</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// init aws services</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">elbv2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">ELBv2</span><span class="p">();</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">iam</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">IAM</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// methods</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">ensureAuthenticated</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">UserName</span><span class="o">:</span> <span class="nx">AWS_USERNAME</span> <span class="p">};</span>
</span><span class='line'>    <span class="nx">iam</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">addTargetGroup</span><span class="p">(</span><span class="nx">service</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">Name</span><span class="o">:</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">SHORT_GIT_HASH</span><span class="p">}</span><span class="o">-</span><span class="nx">$</span><span class="p">{</span><span class="nx">service</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Port</span><span class="o">:</span> <span class="nx">port</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Protocol</span><span class="o">:</span> <span class="s1">&#39;HTTP&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">VpcId</span><span class="o">:</span> <span class="nx">VPC_ID</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">HealthCheckPath</span><span class="o">:</span> <span class="nx">path</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">elbv2</span><span class="p">.</span><span class="nx">createTargetGroup</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// main</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nx">ensureAuthenticated</span><span class="p">()</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Welcome</span> <span class="nx">$</span><span class="p">{</span><span class="nx">data</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">UserName</span><span class="p">}</span><span class="o">!</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">addTargetGroup</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;3000&#39;</span><span class="p">,</span> <span class="s1">&#39;/users/ping&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">USERS_TARGET_GROUP_ARN</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">TargetGroups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">TargetGroupArn</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Target Group Added!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">addTargetGroup</span><span class="p">(</span><span class="s1">&#39;movies&#39;</span><span class="p">,</span> <span class="s1">&#39;3000&#39;</span><span class="p">,</span> <span class="s1">&#39;/movies/ping&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">MOVIES_TARGET_GROUP_ARN</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">TargetGroups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">TargetGroupArn</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Target Group Added!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">addTargetGroup</span><span class="p">(</span><span class="s1">&#39;web&#39;</span><span class="p">,</span> <span class="s1">&#39;9000&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">WEB_TARGET_GROUP_ARN</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">TargetGroups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">TargetGroupArn</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Target Group Added!&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make sure to add the correct VPC ID in the script, and then take note of the <code>addTargetGroup</code> function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">addTargetGroup</span><span class="p">(</span><span class="nx">service</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">Name</span><span class="o">:</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">SHORT_GIT_HASH</span><span class="p">}</span><span class="o">-</span><span class="nx">$</span><span class="p">{</span><span class="nx">service</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Port</span><span class="o">:</span> <span class="nx">port</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Protocol</span><span class="o">:</span> <span class="s1">&#39;HTTP&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">VpcId</span><span class="o">:</span> <span class="nx">VPC</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">HealthCheckPath</span><span class="o">:</span> <span class="nx">path</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">elbv2</span><span class="p">.</span><span class="nx">createTargetGroup</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, the <code>name</code> should be unique, so we used a portion of the Git commit SHA in it. The <code>port</code> refers back to the container port, and the <code>HealthCheckPath</code> is used by the load balancer to ensure the container is running.</p>

<table>
<thead>
<tr>
<th> Task Name             </th>
<th> Port </th>
<th> Path         </th>
</tr>
</thead>
<tbody>
<tr>
<td> users-service-review  </td>
<td> 3000 </td>
<td> /users/ping  </td>
</tr>
<tr>
<td> movies-service-review </td>
<td> 3000 </td>
<td> /movies/ping </td>
</tr>
<tr>
<td> web-review            </td>
<td> 9000 </td>
<td> /            </td>
</tr>
</tbody>
</table>


<p>After the Target Groups are created, we grabbed the returned <a href="http://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html">Amazon Resource Name</a> (ARN) and assigned it to a variable, which we&rsquo;ll end up using shortly when we set up the Listeners. For more on registering Target Groups, review the official <a href="http://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-target-groups.html">documentation</a>.</p>

<p>Update the <code>Deploy</code> command in <em>.circle/config.yml</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Deploy</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>      <span class="no">npm install</span>
</span><span class='line'>      <span class="no">node ecs/scripts/setup.js</span>
</span><span class='line'>      <span class="no">sh ecs/scripts/ecr.sh</span>
</span><span class='line'>      <span class="no">node ecs/scripts/tasks.js</span>
</span><span class='line'>      <span class="no">node ecs/scripts/alb.js</span>
</span></code></pre></td></tr></table></div></figure>


<p>Commit and push your changes to GitHub. Make sure the Circle build passes. Within the <a href="https://console.aws.amazon.com/ec2/">EC2 Dashboard</a>, click &ldquo;Target Groups&rdquo; on the navigation pane, and you should see three new Target Groups:</p>

<p><a href="/images/blog/on-demand-environments/aws-target-groups.png"><img src="/images/blog/on-demand-environments/aws-target-groups.png" alt="aws target groups" /></a></p>

<h3>(5) Add the Listener and Rules</h3>

<p>A <a href="http://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-listeners.html">Listener</a> forwards traffic from the load balancer to a specific Target Group.</p>

<h4>Add Listener</h4>

<p>Add the following function to <em>alb.js</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">addListener</span><span class="p">(</span><span class="nx">port</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">DefaultActions</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="nx">TargetGroupArn</span><span class="o">:</span> <span class="nx">DEFAULT_TARGET_GROUP_ARN</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">Type</span><span class="o">:</span> <span class="s1">&#39;forward&#39;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nx">LoadBalancerArn</span><span class="o">:</span> <span class="nx">LOAD_BALANCER_ARN</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Port</span><span class="o">:</span> <span class="nx">port</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">Protocol</span><span class="o">:</span> <span class="s1">&#39;HTTP&#39;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">elbv2</span><span class="p">.</span><span class="nx">createListener</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And add then update the following variable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">DEFAULT_TARGET_GROUP_ARN</span> <span class="o">=</span> <span class="s1">&#39;UPDATE_ME&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">LOAD_BALANCER_ARN</span> <span class="o">=</span> <span class="s1">&#39;UPDATE_ME&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Get open port</h4>

<p>Before we can create a new Listener, we need to find an open port on the Application Load Balancer to add it to. So, import the <code>getPort</code> function that we created before:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./listener&#39;</span><span class="p">).</span><span class="nx">getPort</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Update the promise chain:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// main</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nx">ensureAuthenticated</span><span class="p">()</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Welcome</span> <span class="nx">$</span><span class="p">{</span><span class="nx">data</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">UserName</span><span class="p">}</span><span class="o">!</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">addTargetGroup</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;3000&#39;</span><span class="p">,</span> <span class="s1">&#39;/users/ping&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">USERS_TARGET_GROUP_ARN</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">TargetGroups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">TargetGroupArn</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Target Group Added!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">addTargetGroup</span><span class="p">(</span><span class="s1">&#39;movies&#39;</span><span class="p">,</span> <span class="s1">&#39;3000&#39;</span><span class="p">,</span> <span class="s1">&#39;/movies/ping&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">MOVIES_TARGET_GROUP_ARN</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">TargetGroups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">TargetGroupArn</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Target Group Added!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">addTargetGroup</span><span class="p">(</span><span class="s1">&#39;web&#39;</span><span class="p">,</span> <span class="s1">&#39;9000&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">WEB_TARGET_GROUP_ARN</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">TargetGroups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">TargetGroupArn</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Target Group Added!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">addListener</span><span class="p">(</span><span class="nx">MAX_PORT</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">LISTENER_ARN</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Listeners</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">ListenerArn</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Listener</span> <span class="nx">added</span> <span class="nx">on</span> <span class="nx">port</span> <span class="nx">$</span><span class="p">{</span><span class="nx">res</span><span class="p">.</span><span class="nx">Listeners</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Port</span><span class="p">}</span><span class="o">!</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Be sure to add <code>let LISTENER_ARN;</code> to the top as well.</p>

<h4>Add rules</h4>

<p>Finally, add some rules to the Listener:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">addRule</span><span class="p">(</span><span class="nx">targetGroup</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">,</span> <span class="nx">listener</span><span class="p">,</span> <span class="nx">priority</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">Actions</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="nx">TargetGroupArn</span><span class="o">:</span> <span class="nx">targetGroup</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">Type</span><span class="o">:</span> <span class="s1">&#39;forward&#39;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>     <span class="p">],</span>
</span><span class='line'>     <span class="nx">Conditions</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="nx">Field</span><span class="o">:</span> <span class="s1">&#39;path-pattern&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">Values</span><span class="o">:</span> <span class="p">[</span><span class="nx">pattern</span><span class="p">]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>     <span class="p">],</span>
</span><span class='line'>     <span class="nx">ListenerArn</span><span class="o">:</span> <span class="nx">listener</span><span class="p">,</span>
</span><span class='line'>     <span class="nx">Priority</span><span class="o">:</span> <span class="nx">priority</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">elbv2</span><span class="p">.</span><span class="nx">createRule</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Update the promise chain again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// main</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nx">ensureAuthenticated</span><span class="p">()</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Welcome</span> <span class="nx">$</span><span class="p">{</span><span class="nx">data</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">UserName</span><span class="p">}</span><span class="o">!</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">addTargetGroup</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;3000&#39;</span><span class="p">,</span> <span class="s1">&#39;/users/ping&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">USERS_TARGET_GROUP_ARN</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">TargetGroups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">TargetGroupArn</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Target Group Added!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">addTargetGroup</span><span class="p">(</span><span class="s1">&#39;movies&#39;</span><span class="p">,</span> <span class="s1">&#39;3000&#39;</span><span class="p">,</span> <span class="s1">&#39;/movies/ping&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">MOVIES_TARGET_GROUP_ARN</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">TargetGroups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">TargetGroupArn</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Target Group Added!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">addTargetGroup</span><span class="p">(</span><span class="s1">&#39;web&#39;</span><span class="p">,</span> <span class="s1">&#39;9000&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">WEB_TARGET_GROUP_ARN</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">TargetGroups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">TargetGroupArn</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Target Group Added!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">port</span><span class="p">();</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">port</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">addListener</span><span class="p">(</span><span class="nx">port</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">LISTENER_ARN</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Listeners</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">ListenerArn</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Listener</span> <span class="nx">added</span> <span class="nx">on</span> <span class="nx">port</span> <span class="nx">$</span><span class="p">{</span><span class="nx">res</span><span class="p">.</span><span class="nx">Listeners</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Port</span><span class="p">}</span><span class="o">!</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">addRule</span><span class="p">(</span><span class="nx">USERS_TARGET_GROUP_ARN</span><span class="p">,</span> <span class="s1">&#39;/users*&#39;</span><span class="p">,</span> <span class="nx">LISTENER_ARN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Rule Added!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">addRule</span><span class="p">(</span><span class="nx">MOVIES_TARGET_GROUP_ARN</span><span class="p">,</span> <span class="s1">&#39;/movies*&#39;</span><span class="p">,</span> <span class="nx">LISTENER_ARN</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Rule Added!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">addRule</span><span class="p">(</span><span class="nx">MOVIES_TARGET_GROUP_ARN</span><span class="p">,</span> <span class="s1">&#39;/docs*&#39;</span><span class="p">,</span> <span class="nx">LISTENER_ARN</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Rule Added!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">addRule</span><span class="p">(</span><span class="nx">WEB_TARGET_GROUP_ARN</span><span class="p">,</span> <span class="s1">&#39;/*&#39;</span><span class="p">,</span> <span class="nx">LISTENER_ARN</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Rule Added!&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Commit and push your changes. After the build passes, make sure the Listener was added to the Application Load Balancer:</p>

<p><a href="/images/blog/on-demand-environments/aws-load-balancer-listeners.png"><img src="/images/blog/on-demand-environments/aws-load-balancer-listeners.png" alt="aws load balancer listeners" /></a></p>

<p>Also, make sure the Listener has four Rules:</p>

<p><a href="/images/blog/on-demand-environments/aws-listeners-rules.png"><img src="/images/blog/on-demand-environments/aws-listeners-rules.png" alt="aws listeners rules" /></a></p>

<h3>(6) Create a new Service</h3>

<p>A <a href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs_services.html">Service</a> is used to spin up and run a number of Tasks within the ECS Cluster. Since we&rsquo;ve already pre-configured the Cluster and assigned EC2 instances to it, we can simply create a new Service that uses the Cluster resources.</p>

<p>Start by adding a new file called <em>services.js</em> to &ldquo;ecs/scripts&rdquo;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;aws-sdk&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// globals</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_ACCOUNT_ID</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_ACCOUNT_ID</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_ACCESS_KEY_ID</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_SECRET_ACCESS_KEY</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_USERNAME</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_USERNAME</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_CONFIG_REGION</span> <span class="o">=</span> <span class="s1">&#39;us-west-2&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">SHORT_GIT_HASH</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CIRCLE_SHA1</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// config</span>
</span><span class='line'>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">Config</span><span class="p">();</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">accessKeyId</span> <span class="o">=</span> <span class="nx">AWS_ACCESS_KEY_ID</span><span class="p">;</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">secretAccessKey</span> <span class="o">=</span> <span class="nx">AWS_SECRET_ACCESS_KEY</span><span class="p">;</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">region</span> <span class="o">=</span> <span class="nx">AWS_CONFIG_REGION</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// init aws services</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">ecs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">ECS</span><span class="p">();</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">iam</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">IAM</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// methods</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">ensureAuthenticated</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">UserName</span><span class="o">:</span> <span class="nx">AWS_USERNAME</span> <span class="p">};</span>
</span><span class='line'>    <span class="nx">iam</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">addService</span><span class="p">(</span><span class="nx">service</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">service</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">ecs</span><span class="p">.</span><span class="nx">createService</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// main</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nx">ensureAuthenticated</span><span class="p">()</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Welcome</span> <span class="nx">$</span><span class="p">{</span><span class="nx">data</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">UserName</span><span class="p">}</span><span class="o">!</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, add a new directory to &ldquo;ecs&rdquo; called &ldquo;services&rdquo;, and then add the following files:</p>

<ol>
<li><em>users-review_service.js</em></li>
<li><em>movies-review_service.js</em></li>
<li><em>web-review_service.js</em></li>
</ol>


<h5>Users - <em>users-review_service.js</em></h5>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">createUsersService</span><span class="p">(</span><span class="nx">cluster</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">targetGroup</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">cluster</span><span class="o">:</span> <span class="nx">cluster</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">serviceName</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">taskDefinition</span><span class="o">:</span> <span class="s1">&#39;microservicemovies-review-users-td&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">loadBalancers</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="nx">targetGroupArn</span><span class="o">:</span> <span class="nx">targetGroup</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">containerName</span><span class="o">:</span> <span class="s2">&quot;users-service-review&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">containerPort</span><span class="o">:</span> <span class="mi">3000</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nx">desiredCount</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">role</span><span class="o">:</span> <span class="s2">&quot;ecsServiceRole&quot;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">params</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">createUsersService</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h5>Movies - <em>movies-review_service.js</em></h5>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">createMoviesService</span><span class="p">(</span><span class="nx">cluster</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">targetGroup</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">cluster</span><span class="o">:</span> <span class="nx">cluster</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">serviceName</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">taskDefinition</span><span class="o">:</span> <span class="s1">&#39;microservicemovies-review-movies-td&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">loadBalancers</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="nx">targetGroupArn</span><span class="o">:</span> <span class="nx">targetGroup</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">containerName</span><span class="o">:</span> <span class="s2">&quot;movies-service-review&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">containerPort</span><span class="o">:</span> <span class="mi">3000</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nx">desiredCount</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">role</span><span class="o">:</span> <span class="s2">&quot;ecsServiceRole&quot;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">params</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">createMoviesService</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h5>Web - <em>web-review_service.js</em></h5>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">createWebService</span><span class="p">(</span><span class="nx">cluster</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">targetGroup</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">cluster</span><span class="o">:</span> <span class="nx">cluster</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">serviceName</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">taskDefinition</span><span class="o">:</span> <span class="s1">&#39;microservicemovies-review-web-td&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">loadBalancers</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="nx">targetGroupArn</span><span class="o">:</span> <span class="nx">targetGroup</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">containerName</span><span class="o">:</span> <span class="s2">&quot;web-service-review&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">containerPort</span><span class="o">:</span> <span class="mi">9000</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nx">desiredCount</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">role</span><span class="o">:</span> <span class="s2">&quot;ecsServiceRole&quot;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">params</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">createWebService</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Update <em>services.js</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;aws-sdk&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">createUsersService</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../services/users-review_service&#39;</span><span class="p">).</span><span class="nx">createUsersService</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">createMoviesService</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../services/movies-review_service&#39;</span><span class="p">).</span><span class="nx">createMoviesService</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">createWebService</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../services/web-review_service&#39;</span><span class="p">).</span><span class="nx">createWebService</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// globals</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_ACCOUNT_ID</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_ACCOUNT_ID</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_ACCESS_KEY_ID</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_SECRET_ACCESS_KEY</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_USERNAME</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_USERNAME</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_CONFIG_REGION</span> <span class="o">=</span> <span class="s1">&#39;us-west-2&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">SHORT_GIT_HASH</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CIRCLE_SHA1</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">LOAD_BALANCER_ARN</span> <span class="o">=</span> <span class="s1">&#39;arn:aws:elasticloadbalancing:us-west-2:046505967931:loadbalancer/app/microservicemovies-review/493be740ee6aea54&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">CLUSTER_NAME</span> <span class="o">=</span> <span class="s1">&#39;microservicemovies-review&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="nx">USERS_TARGET_GROUP_ARN</span><span class="p">;</span>
</span><span class='line'><span class="kd">let</span> <span class="nx">MOVIES_TARGET_GROUP_ARN</span><span class="p">;</span>
</span><span class='line'><span class="kd">let</span> <span class="nx">WEB_TARGET_GROUP_ARN</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// config</span>
</span><span class='line'>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">Config</span><span class="p">();</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">accessKeyId</span> <span class="o">=</span> <span class="nx">AWS_ACCESS_KEY_ID</span><span class="p">;</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">secretAccessKey</span> <span class="o">=</span> <span class="nx">AWS_SECRET_ACCESS_KEY</span><span class="p">;</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">region</span> <span class="o">=</span> <span class="nx">AWS_CONFIG_REGION</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// init aws services</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">ecs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">ECS</span><span class="p">();</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">iam</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">IAM</span><span class="p">();</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">elbv2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">ELBv2</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// methods</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">ensureAuthenticated</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">UserName</span><span class="o">:</span> <span class="nx">AWS_USERNAME</span> <span class="p">};</span>
</span><span class='line'>    <span class="nx">iam</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">addService</span><span class="p">(</span><span class="nx">service</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">service</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">ecs</span><span class="p">.</span><span class="nx">createService</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">getTargetGroups</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">LoadBalancerArn</span><span class="o">:</span> <span class="nx">LOAD_BALANCER_ARN</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">elbv2</span><span class="p">.</span><span class="nx">describeTargetGroups</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// main</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nx">ensureAuthenticated</span><span class="p">()</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Welcome</span> <span class="nx">$</span><span class="p">{</span><span class="nx">data</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">UserName</span><span class="p">}</span><span class="o">!</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">getTargetGroups</span><span class="p">();</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">groups</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">TargetGroups</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">group</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">group</span><span class="p">.</span><span class="nx">TargetGroupName</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">SHORT_GIT_HASH</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">group</span> <span class="nx">of</span> <span class="nx">groups</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">group</span><span class="p">.</span><span class="nx">TargetGroupName</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">USERS_TARGET_GROUP_ARN</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">TargetGroupArn</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">group</span><span class="p">.</span><span class="nx">TargetGroupName</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;movies&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">MOVIES_TARGET_GROUP_ARN</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">TargetGroupArn</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">group</span><span class="p">.</span><span class="nx">TargetGroupName</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;web&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">WEB_TARGET_GROUP_ARN</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">TargetGroupArn</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">userServiceParams</span> <span class="o">=</span> <span class="nx">createUsersService</span><span class="p">(</span>
</span><span class='line'>    <span class="nx">CLUSTER_NAME</span><span class="p">,</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">SHORT_GIT_HASH</span><span class="p">}</span><span class="o">-</span><span class="nx">users</span><span class="err">`</span><span class="p">,</span> <span class="nx">USERS_TARGET_GROUP_ARN</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">addService</span><span class="p">(</span><span class="nx">userServiceParams</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Service Added!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">moviesServiceParams</span> <span class="o">=</span> <span class="nx">createMoviesService</span><span class="p">(</span>
</span><span class='line'>    <span class="nx">CLUSTER_NAME</span><span class="p">,</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">SHORT_GIT_HASH</span><span class="p">}</span><span class="o">-</span><span class="nx">movies</span><span class="err">`</span><span class="p">,</span> <span class="nx">MOVIES_TARGET_GROUP_ARN</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">addService</span><span class="p">(</span><span class="nx">moviesServiceParams</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Service Added!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">webServiceParams</span> <span class="o">=</span> <span class="nx">createWebService</span><span class="p">(</span>
</span><span class='line'>    <span class="nx">CLUSTER_NAME</span><span class="p">,</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">SHORT_GIT_HASH</span><span class="p">}</span><span class="o">-</span><span class="nx">web</span><span class="err">`</span><span class="p">,</span> <span class="nx">WEB_TARGET_GROUP_ARN</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">addService</span><span class="p">(</span><span class="nx">webServiceParams</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Service Added!&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Update the <code>Deploy</code> command in <em>.circle/config.yml</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Deploy</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>      <span class="no">npm install</span>
</span><span class='line'>      <span class="no">node ecs/scripts/setup.js</span>
</span><span class='line'>      <span class="no">sh ecs/scripts/ecr.sh</span>
</span><span class='line'>      <span class="no">node ecs/scripts/tasks.js</span>
</span><span class='line'>      <span class="no">node ecs/scripts/alb.js</span>
</span><span class='line'>      <span class="no">node ecs/scripts/services.js</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, commit and push to GitHub, and then ensure:</p>

<ol>
<li>The Circle build passes</li>
<li>The Services were created on the <code>microservicemovies-review</code> Cluster</li>
<li>Each Service has a running Task associated with it</li>
<li>Three Target Groups were created, each with health targets</li>
<li>A Listener was added to the Application Load Balancer with four Rules</li>
<li>Logs were added to <a href="https://console.aws.amazon.com/cloudwatch">CloudWatch</a></li>
<li>The following endpoints work-

<ul>
<li><a href="http://LOAD_BALANCER_DNS:LISTENER_PORT">http://LOAD_BALANCER_DNS:LISTENER_PORT</a></li>
<li><a href="http://LOAD_BALANCER_DNS:LISTENER_PORT/users/ping">http://LOAD_BALANCER_DNS:LISTENER_PORT/users/ping</a></li>
<li><a href="http://LOAD_BALANCER_DNS:LISTENER_PORT/movies/ping">http://LOAD_BALANCER_DNS:LISTENER_PORT/movies/ping</a></li>
</ul>
</li>
</ol>


<p><a href="/images/blog/on-demand-environments/aws-ecs-services.png"><img src="/images/blog/on-demand-environments/aws-ecs-services.png" alt="aws ecs services" /></a></p>

<h2>Testing</h2>

<p>To run the end-to-end tests, first change each of the URLs in <em>tests/sample.test.js</em> from <code>http://localhost:3007</code> to <code>http://LOAD_BALANCER_DNS:LISTENER_PORT</code>, and then run the tests locally:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>testcafe firefox tests/**/*.js
</span></code></pre></td></tr></table></div></figure>


<p>They should pass.</p>

<h2>Teardown</h2>

<p>Next, let&rsquo;s add a script to handle the tearing down of the AWS resources after testing is complete.</p>

<p>Main Steps:</p>

<ol>
<li>Remove Listener</li>
<li>Remove Target Groups</li>
<li>Remove Services</li>
</ol>


<p>Start by adding a new script called <em>teardown.js</em> to &ldquo;ecs/scripts&rdquo;.</p>

<h3>(1) Remove Listener</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;aws-sdk&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// globals</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_ACCOUNT_ID</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_ACCOUNT_ID</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_ACCESS_KEY_ID</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_SECRET_ACCESS_KEY</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_USERNAME</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AWS_USERNAME</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">AWS_CONFIG_REGION</span> <span class="o">=</span> <span class="s1">&#39;us-west-2&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">LOAD_BALANCER_ARN</span> <span class="o">=</span> <span class="s1">&#39;UPDATE_ME&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">ARGS</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">USAGE_MESSAGE</span> <span class="o">=</span> <span class="s1">&#39;\nusage:\n  teardown.js LISTENER_PORT COMMIT_SHA\n&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ARGS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="nx">ARGS</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">USAGE_MESSAGE</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">SHORT_GIT_HASH</span> <span class="o">=</span> <span class="nx">ARGS</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// config</span>
</span><span class='line'>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">Config</span><span class="p">();</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">accessKeyId</span> <span class="o">=</span> <span class="nx">AWS_ACCESS_KEY_ID</span><span class="p">;</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">secretAccessKey</span> <span class="o">=</span> <span class="nx">AWS_SECRET_ACCESS_KEY</span><span class="p">;</span>
</span><span class='line'><span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">region</span> <span class="o">=</span> <span class="nx">AWS_CONFIG_REGION</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// init aws services</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">iam</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">IAM</span><span class="p">();</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">elbv2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">ELBv2</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// methods</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">ensureAuthenticated</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">UserName</span><span class="o">:</span> <span class="nx">AWS_USERNAME</span> <span class="p">};</span>
</span><span class='line'>    <span class="nx">iam</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">getListeners</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">LoadBalancerArn</span><span class="o">:</span> <span class="nx">LOAD_BALANCER_ARN</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">elbv2</span><span class="p">.</span><span class="nx">describeListeners</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">removeListener</span><span class="p">(</span><span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">ListenerArn</span><span class="o">:</span> <span class="nx">listener</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">elbv2</span><span class="p">.</span><span class="nx">deleteListener</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// main</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nx">ensureAuthenticated</span><span class="p">()</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Welcome</span> <span class="nx">$</span><span class="p">{</span><span class="nx">data</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">UserName</span><span class="p">}</span><span class="o">!</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">getListeners</span><span class="p">();</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">listener</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Listeners</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">listener</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">listener</span><span class="p">.</span><span class="nx">Port</span><span class="p">)</span> <span class="o">===</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">ARGS</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>  <span class="p">})[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Listener does not exist.&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">removeListener</span><span class="p">(</span><span class="nx">listener</span><span class="p">.</span><span class="nx">ListenerArn</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Listener Removed!&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, we grabbed all Listeners in <code>getListeners</code> and then filtered them by the provided listener port. From there, we deleted the listener. Be sure to update <code>LOAD_BALANCER_ARN</code> before continuing.</p>

<p>Test this out:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>node ecs/scripts/teardown.js LISTENER_PORT COMMIT_SHA
</span></code></pre></td></tr></table></div></figure>


<h3>(2) Remove Target Groups</h3>

<p>Add the following two functions to <em>teardown.js</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">getTargetGroups</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>    <span class="nx">elbv2</span><span class="p">.</span><span class="nx">describeTargetGroups</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">removeTargetGroup</span><span class="p">(</span><span class="nx">targetgroup</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">TargetGroupArn</span><span class="o">:</span> <span class="nx">targetgroup</span> <span class="p">};</span>
</span><span class='line'>    <span class="nx">elbv2</span><span class="p">.</span><span class="nx">deleteTargetGroup</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then update the promise chain:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// main</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nx">ensureAuthenticated</span><span class="p">()</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Welcome</span> <span class="nx">$</span><span class="p">{</span><span class="nx">data</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">UserName</span><span class="p">}</span><span class="o">!</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">getListeners</span><span class="p">();</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">listener</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Listeners</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">listener</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">listener</span><span class="p">.</span><span class="nx">Port</span><span class="p">)</span> <span class="o">===</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">ARGS</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>  <span class="p">})[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Listener does not exist.&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">removeListener</span><span class="p">(</span><span class="nx">listener</span><span class="p">.</span><span class="nx">ListenerArn</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Listener Removed!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">getTargetGroups</span><span class="p">();</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">targets</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">TargetGroups</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">group</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">group</span><span class="p">.</span><span class="nx">TargetGroupName</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">SHORT_GIT_HASH</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">targets</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Targets do not exist.&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">promises</span> <span class="o">=</span> <span class="nx">targets</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">target</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">removeTargetGroup</span><span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">TargetGroupArn</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Target Groups Removed!&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>(3) Remove Services</h3>

<p>Finally, add the following functions to remove the Services:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">updateServiceCount</span><span class="p">(</span><span class="nx">serviceName</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">service</span><span class="o">:</span> <span class="nx">serviceName</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">desiredCount</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">cluster</span><span class="o">:</span> <span class="nx">CLUSTER_NAME</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">ecs</span><span class="p">.</span><span class="nx">updateService</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">removeService</span><span class="p">(</span><span class="nx">serviceName</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">service</span><span class="o">:</span> <span class="nx">serviceName</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">cluster</span><span class="o">:</span> <span class="nx">CLUSTER_NAME</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="nx">ecs</span><span class="p">.</span><span class="nx">deleteService</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add the variables to the top:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">const</span> <span class="nx">CLUSTER_NAME</span> <span class="o">=</span> <span class="s1">&#39;microservicemovies-review&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">ecs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">ECS</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, update the promise chain:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// main</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nx">ensureAuthenticated</span><span class="p">()</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Welcome</span> <span class="nx">$</span><span class="p">{</span><span class="nx">data</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">UserName</span><span class="p">}</span><span class="o">!</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">getListeners</span><span class="p">();</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">listener</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Listeners</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">listener</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">listener</span><span class="p">.</span><span class="nx">Port</span><span class="p">)</span> <span class="o">===</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">ARGS</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>  <span class="p">})[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Listener does not exist.&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">removeListener</span><span class="p">(</span><span class="nx">listener</span><span class="p">.</span><span class="nx">ListenerArn</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Listener Removed!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">getTargetGroups</span><span class="p">();</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">targets</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">TargetGroups</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">group</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">group</span><span class="p">.</span><span class="nx">TargetGroupName</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">SHORT_GIT_HASH</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">targets</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Targets do not exist.&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">promises</span> <span class="o">=</span> <span class="nx">targets</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">target</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">removeTargetGroup</span><span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">TargetGroupArn</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Target Groups Removed!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">updateServiceCount</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">SHORT_GIT_HASH</span><span class="p">}</span><span class="o">-</span><span class="nx">users</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Service Updated!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">removeService</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">SHORT_GIT_HASH</span><span class="p">}</span><span class="o">-</span><span class="nx">users</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Service Removed!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">updateServiceCount</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">SHORT_GIT_HASH</span><span class="p">}</span><span class="o">-</span><span class="nx">movies</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Service Updated!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">removeService</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">SHORT_GIT_HASH</span><span class="p">}</span><span class="o">-</span><span class="nx">movies</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Service Removed!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">updateServiceCount</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">SHORT_GIT_HASH</span><span class="p">}</span><span class="o">-</span><span class="nx">web</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Service Updated!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">removeService</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">SHORT_GIT_HASH</span><span class="p">}</span><span class="o">-</span><span class="nx">web</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Service removed!&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Test it out again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>node ecs/scripts/teardown.js LISTENER_PORT COMMIT_SHA
</span></code></pre></td></tr></table></div></figure>


<p>You should see:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>Welcome AWS_USERNAME!
</span><span class='line'>Listener Removed!
</span><span class='line'>Target Groups Removed!
</span><span class='line'>Service Updated!
</span><span class='line'>Service Removed!
</span><span class='line'>Service Updated!
</span><span class='line'>Service Removed!
</span><span class='line'>Service Updated!
</span><span class='line'>Service removed!
</span></code></pre></td></tr></table></div></figure>


<p>Make sure all associated AWS Resources were removed as well.</p>

<h2>Conclusion and Next Steps</h2>

<p>That&rsquo;s it!</p>

<h3>Development Workflow</h3>

<p>Let&rsquo;s quickly review the development workflow&hellip;</p>

<ol>
<li>Local development

<ul>
<li>Create a new feature branch from the master branch</li>
<li>Make code changes</li>
<li>Commit and push code to GitHub</li>
</ul>
</li>
<li>Continuous integration

<ul>
<li>Open a new PR against the development branch</li>
<li>A new build is then triggered on Circle CI</li>
<li>If the build passes, manually merge the PR</li>
<li>A new build is triggered again on Circle CI</li>
<li>If the build passes, deployment occurs&hellip;</li>
</ul>
</li>
<li>Deployment on AWS via deployment scripts</li>
<li>Testing

<ul>
<li>Update then run the end-to-end tests</li>
</ul>
</li>
<li>Teardown

<ul>
<li>Run the teardown script</li>
</ul>
</li>
</ol>


<h3>What&rsquo;s next?</h3>

<p>Did you test out the Swagger docs? They don&rsquo;t work. What&rsquo;s happening? Fix this on your own.</p>

<p>Developers will inevitably forget to run the teardown script. Configure an <a href="AWS%20Lambda">AWS Lambda</a> function to run nightly to tear down all AWS resources associated with the on-demand test environments.</p>

<p>Add <a href="https://www.vaultproject.io/">Vault</a> and <a href="https://www.consul.io/">Consul</a> into the mix to handle secrets and environment variables.</p>

<p>Grab the final code from the <a href="https://github.com/mjhea0/microservice-movies/releases/tag/v4">v4</a> tag of the <a href="https://github.com/mjhea0/microservice-movies">microservice-movies</a> repo. Please add questions and/or comments below. Cheers!</p>
</div>


  <footer>
    <p class="meta">
      
  



  <span class="byline author vcard">Authored by <span class="fn">
  
    Michael Herman
  
  </span></span>


      




<time class='entry-date' datetime='2017-09-18T08:08:43-06:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>8:08 am</span></time>
      
      

<span class="categories">
  
    <a class='category' href='/blog/categories/aws/'>aws</a>
  
</span>


    </p>
    
      <div class="sharing">
<!--   
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://mherman.org/blog/2017/09/18/on-demand-test-environments-with-docker-and-aws-ecs/" data-via="" data-counturl="http://mherman.org/blog/2017/09/18/on-demand-test-environments-with-docker-and-aws-ecs/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
   -->
  <br>
  <!-- AddThis Button BEGIN -->
  <div class="addthis_toolbox addthis_default_style addthis_32x32_style">
  <a class="addthis_button_preferred_1"></a>
  <a class="addthis_button_preferred_2"></a>
  <a class="addthis_button_preferred_3"></a>
  <a class="addthis_button_preferred_4"></a>
  <a class="addthis_button_compact"></a>
  <a class="addthis_counter addthis_bubble_style"></a>
  </div>
  <script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-50e5f1cc35ad077d"></script>
  <!-- AddThis Button END -->
  <br>
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2017/08/23/building-a-restful-api-with-koa-and-postgres/" title="Previous Post: Building a RESTful API with Koa and Postgres">&laquo; Building a RESTful API with Koa and Postgres</a>
      
      
        <a class="basic-alignment right" href="/blog/2017/11/06/stubbing-http-requests-with-sinon/" title="Next Post: Stubbing HTTP Requests with Sinon">Stubbing HTTP Requests with Sinon &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>


</div>

    </div>
  </div>
  <footer role="contentinfo"><div>
  <span>Copyright &copy; 2017 - Michael Herman</span><br>
  <a href="https://github.com/mjhea0"><i class="fa fa-github-square" style="font-size:2em" aria-hidden="true"></i></a>
  <a href="https://twitter.com/mikeherman"><i class="fa fa-twitter-square" style="font-size:2em" aria-hidden="true"></i></a>
  <a href="http://www.linkedin.com/pub/michael-herman/3b/a94/4"><i class="fa fa-linkedin-square" style="font-size:2em" aria-hidden="true"></i></a>
  <a href="http://www.youtube.com/hermanmu"><i class="fa fa-youtube-square" style="font-size:2em" aria-hidden="true"></i></a>
</div>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'michaelherman';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://mherman.org/blog/2017/09/18/on-demand-test-environments-with-docker-and-aws-ecs/';
        var disqus_url = 'http://mherman.org/blog/2017/09/18/on-demand-test-environments-with-docker-and-aws-ecs/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>






<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
