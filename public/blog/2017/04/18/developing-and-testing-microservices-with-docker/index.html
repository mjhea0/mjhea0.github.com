
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>
    
      Developing and Testing Microservices with Docker
     
   </title>
  <meta name="author" content="Michael Herman">

  
  <meta name="description" content="Let's build and test a number of services with Docker.">
  <meta name="keywords" content="docker, microservice, microservices, node, javascript">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mherman.org/blog/2017/04/18/developing-and-testing-microservices-with-docker">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Michael Herman" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>


  <!-- hello bar -->
  <link rel="stylesheet" href="/stylesheets/hellobar.css">
  <!-- hello bar -->
  <script type="text/javascript" src="/javascripts/hellobar.js"></script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Fjalla+One" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
<!--- MathJax Configuration -->
<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-37074204-1', 'auto');
    ga('send', 'pageview');

  </script>



</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Michael Herman</a></h1>
  
    <h2>Software Developer</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscribe" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 13.310204,73.332654 C 5.967347,73.332654 0,79.322448 0,86.621428 c 0,7.338776 5.967347,13.262246 13.310204,13.262246 7.370408,0 13.328572,-5.92245 13.328572,-13.262246 0,-7.29898 -5.958164,-13.288774 -13.328572,-13.288774 z M 0.01530612,33.978572 V 53.143878 C 12.493878,53.143878 24.229592,58.02347 33.068368,66.865306 41.894898,75.685714 46.767346,87.47449 46.767346,100 h 19.25 C 66.017346,63.592858 36.4,33.979592 0.01530612,33.978572 l 0,0 z M 0.03877552,0 V 19.17449 C 44.54796,19.17551 80.77551,55.437756 80.77551,100 H 100 C 100,44.87653 55.15102,0 0.03877552,0 z"></path></svg></a></li>
  
</ul>
  
  
  
  
  
  
  
  
  
  
    
      <form action="http://google.com/search" method="get">
        <fieldset role="search">
          <input type="hidden" name="sitesearch" value="mherman.org" />
    
          <input class="search" type="text" name="q" results="0" placeholder="Search"/>
        </fieldset>
      </form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/talks">Talks</a></li>
</ul>

</nav>
      <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=mhermanorg" id="_carbonads_js" media="(min-width: 768px)"></script>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Developing and Testing Microservices With Docker</h1>
      
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-04-18T08:16:46-06:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>8:16 am</span></time>
        
        
      </p>
    
  </header>


<div class="entry-content"><p>Often, when developing applications with a microservice architecture, you cannot fully test out all services until you deploy to a staging server. This takes much too long to get feedback. Docker helps to speed up this process by making it easier to link together small, independent services locally.</p>

<p><strong>In this article we&rsquo;ll look at how to configure and test a number of services locally with <a href="https://docs.docker.com/">Docker</a> and <a href="https://docs.docker.com/compose/">Docker Compose</a>. We&rsquo;ll also look at workflow and how to interact with and debug containers.</strong></p>

<div style="text-align:center;">
  <img src="/images/blog/node-docker-api.png" style="max-width: 100%; border:0; box-shadow: none;" alt="microservice architecture">
</div>


<p><br></p>

<p>This post assumes prior knowledge of the following topics. Refer to the resources for more info:</p>

<table>
<thead>
<tr>
<th> Topic            </th>
<th> Resource </th>
</tr>
</thead>
<tbody>
<tr>
<td> Docker           </td>
<td> <a href="https://docs.docker.com/engine/getstarted/">Get started with Docker</a> </td>
</tr>
<tr>
<td> Docker Compose   </td>
<td> <a href="https://docs.docker.com/compose/gettingstarted/">Get started with Docker Compose</a> </td>
</tr>
<tr>
<td> Node/Express API </td>
<td> <a href="http://mherman.org/blog/2016/09/12/testing-node-and-express">Testing Node and Express</a> </td>
</tr>
</tbody>
</table>


<blockquote><p><strong>NOTE</strong>: Looking for a more advanced implementation with React? Check out my other post - <a href="http://mherman.org/blog/2017/05/11/developing-microservices-node-react-docker">Developing Microservices - Node, React, and Docker</a>.</p></blockquote>

<h2>Contents</h2>

<ol>
<li>Objectives</li>
<li>Project Setup</li>
<li>Docker Config</li>
<li>Postgres Setup</li>
<li>Users Service Setup</li>
<li>Locations Service Setup</li>
<li>Web Setup</li>
<li>Workflow</li>
<li>Testing</li>
<li>Test Setup</li>
<li>Next Steps</li>
</ol>


<h2>Objectives</h2>

<p>By the end of this tutorial, you should be able to&hellip;</p>

<ol>
<li>Configure and run a set of microservices locally with Docker and Docker Compose</li>
<li>Utilize <a href="https://docs.docker.com/engine/tutorials/dockervolumes/">volumes</a> to mount your code into a container</li>
<li>Run unit and integration tests inside a Docker container</li>
<li>Set up a separate container for functional tests</li>
<li>Debug a running Docker container</li>
<li>Utilize <a href="https://docs.docker.com/compose/compose-file/#links">links</a> for inter-container communication (AJAX)</li>
<li>Secure your services via JWT-based authentication</li>
</ol>


<h2>Project Setup</h2>

<p>Start by cloning the base project and then checking out the first tag:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git clone https://github.com/mjhea0/node-docker-api
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>node-docker-api
</span><span class='line'><span class="nv">$ </span>git checkout tags/v1
</span></code></pre></td></tr></table></div></figure>


<p>Take a quick look at the structure, broken down by service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>├── services
</span><span class='line'>│   ├── locations
</span><span class='line'>│   │   ├── gulpfile.js
</span><span class='line'>│   │   ├── knexfile.js
</span><span class='line'>│   │   ├── package.json
</span><span class='line'>│   │   ├── src
</span><span class='line'>│   │   │   ├── app.js
</span><span class='line'>│   │   │   ├── db
</span><span class='line'>│   │   │   │   ├── connection.js
</span><span class='line'>│   │   │   │   ├── create.sql
</span><span class='line'>│   │   │   │   ├── migrations
</span><span class='line'>│   │   │   │   │   └── 20170405114746_locations.js
</span><span class='line'>│   │   │   │   ├── queries.js
</span><span class='line'>│   │   │   │   └── seeds
</span><span class='line'>│   │   │   │       └── locations.js
</span><span class='line'>│   │   │   ├── routes
</span><span class='line'>│   │   │   │   ├── _helpers.js
</span><span class='line'>│   │   │   │   └── locations.js
</span><span class='line'>│   │   │   └── server.js
</span><span class='line'>│   │   └── tests
</span><span class='line'>│   │       └── integration
</span><span class='line'>│   │           ├── routes.index.test.js
</span><span class='line'>│   │           └── routes.locations.test.js
</span><span class='line'>│   └── users
</span><span class='line'>│       ├── gulpfile.js
</span><span class='line'>│       ├── knexfile.js
</span><span class='line'>│       ├── npm-debug.log
</span><span class='line'>│       ├── package.json
</span><span class='line'>│       ├── src
</span><span class='line'>│       │   ├── app.js
</span><span class='line'>│       │   ├── auth
</span><span class='line'>│       │   │   ├── _helpers.js
</span><span class='line'>│       │   │   └── local.js
</span><span class='line'>│       │   ├── db
</span><span class='line'>│       │   │   ├── connection.js
</span><span class='line'>│       │   │   ├── create.sql
</span><span class='line'>│       │   │   ├── migrations
</span><span class='line'>│       │   │   │   └── 20170403223908_users.js
</span><span class='line'>│       │   │   └── seeds
</span><span class='line'>│       │   │       └── users.js
</span><span class='line'>│       │   ├── routes
</span><span class='line'>│       │   │   └── users.js
</span><span class='line'>│       │   └── server.js
</span><span class='line'>│       └── tests
</span><span class='line'>│           ├── integration
</span><span class='line'>│           │   ├── routes.index.test.js
</span><span class='line'>│           │   └── routes.users.test.js
</span><span class='line'>│           └── unit
</span><span class='line'>│               ├── auth.helpers.test.js
</span><span class='line'>│               └── auth.local.test.js
</span><span class='line'>├── tests
</span><span class='line'>│   ├── main.test.js
</span><span class='line'>│   └── package.json
</span><span class='line'>└── web
</span><span class='line'>    ├── gulpfile.js
</span><span class='line'>    ├── package.json
</span><span class='line'>    └── src
</span><span class='line'>        ├── app.js
</span><span class='line'>        ├── public
</span><span class='line'>        │   ├── main.css
</span><span class='line'>        │   └── main.js
</span><span class='line'>        ├── routes
</span><span class='line'>        │   ├── _helpers.js
</span><span class='line'>        │   └── index.js
</span><span class='line'>        ├── server.js
</span><span class='line'>        └── views
</span><span class='line'>            ├── _base.html
</span><span class='line'>            ├── error.html
</span><span class='line'>            ├── login.html
</span><span class='line'>            ├── main.html
</span><span class='line'>            ├── nav.html
</span><span class='line'>            ├── register.html
</span><span class='line'>            └── user.html
</span></code></pre></td></tr></table></div></figure>


<p>Before we Dockerize the services, feel free to test the locations and/or users services&hellip;</p>

<p>Users:</p>

<ol>
<li>Navigate to &ldquo;services/users&rdquo;</li>
<li><code>npm install</code></li>
<li><code>node src/server.js</code></li>
<li>Open <a href="http://localhost:3000/users/ping">http://localhost:3000/users/ping</a> in your browser</li>
</ol>


<p>Locations:</p>

<ol>
<li>Navigate to &ldquo;services/locations&rdquo;</li>
<li><code>npm install</code></li>
<li><code>node src/server.js</code></li>
<li>Open <a href="http://localhost:3001/locations/ping">http://localhost:3001/locations/ping</a> in your browser</li>
</ol>


<p>Kill the servers once done.</p>

<h2>Docker Config</h2>

<p>Add a <em>docker-compose.yml</em> file to the project root, which is a config file used by Docker Compose to link multiple services together:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>version: <span class="s1">&#39;2.1&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>NOTE:</strong> Why 2.1? <a href="https://docs.docker.com/compose/compose-file/compose-file-v2/#version-21">Answer</a>.</p></blockquote>

<p>Then add a <em>.dockerignore</em> to the &ldquo;services/locations&rdquo;, &ldquo;services/locations/src/db&rdquo;, &ldquo;services/users&rdquo;, &ldquo;services/users/src/db&rdquo;, &ldquo;tests&rdquo;, and &ldquo;web&rdquo; directories:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>.git
</span><span class='line'>.gitignore
</span><span class='line'>README.md
</span><span class='line'>docker-compose.yml
</span><span class='line'>node_modules
</span></code></pre></td></tr></table></div></figure>


<p>With that, let&rsquo;s set up each service individually, testing as we go&hellip;</p>

<h2>Postgres Setup</h2>

<p>Add a <em>Dockerfile</em> to &ldquo;services/locations/src/db&rdquo; and &ldquo;services/users/src/db&rdquo;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>FROM postgres
</span><span class='line'>
</span><span class='line'><span class="c"># run create.sql on init</span>
</span><span class='line'>ADD create.sql /docker-entrypoint-initdb.d
</span></code></pre></td></tr></table></div></figure>


<p>Then update <em>docker-compose.yml</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>version: <span class="s1">&#39;2.1&#39;</span>
</span><span class='line'>
</span><span class='line'>services:
</span><span class='line'>
</span><span class='line'>  users-db:
</span><span class='line'>    container_name: users-db
</span><span class='line'>    build: ./services/users/src/db
</span><span class='line'>    ports:
</span><span class='line'>      - <span class="s1">&#39;5433:5432&#39;</span>
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">POSTGRES_USER</span><span class="o">=</span>admin
</span><span class='line'>      - <span class="nv">POSTGRES_PASSWORD</span><span class="o">=</span>admin
</span><span class='line'>    healthcheck:
</span><span class='line'>      <span class="nb">test</span>: <span class="nb">exit </span>0
</span><span class='line'>
</span><span class='line'>  locations-db:
</span><span class='line'>    container_name: locations-db
</span><span class='line'>    build: ./services/locations/src/db
</span><span class='line'>    ports:
</span><span class='line'>      - <span class="s1">&#39;5434:5432&#39;</span>
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">POSTGRES_USER</span><span class="o">=</span>admin
</span><span class='line'>      - <span class="nv">POSTGRES_PASSWORD</span><span class="o">=</span>admin
</span><span class='line'>    healthcheck:
</span><span class='line'>      <span class="nb">test</span>: <span class="nb">exit </span>0
</span></code></pre></td></tr></table></div></figure>


<p>Here, we create two new containers called <code>users-db</code> and <code>locations-db</code>, from the <em>Dockerfiles</em> found in &ldquo;services/users/src/db&rdquo; and &ldquo;services/locations/src/db&rdquo;, respectively. We also add environment variables, expose ports, and send an exit code <code>0</code> once they are successfully up and running - which will be used by other services.</p>

<p>To fire up the containers, run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker-compose up --build -d
</span></code></pre></td></tr></table></div></figure>


<p>Once up, you can get a quick sanity check, by entering the shell:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker-compose run users-db bash
</span><span class='line'><span class="c"># exit</span>
</span><span class='line'><span class="nv">$ </span>docker-compose run locations-db bash
</span><span class='line'><span class="c"># exit</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Users Service Setup</h2>

<p>Again, add a <em>Dockerfile</em> to &ldquo;services/users&rdquo;, making sure to review the comments:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>FROM node:latest
</span><span class='line'>
</span><span class='line'><span class="c"># set working directory</span>
</span><span class='line'>RUN mkdir /src
</span><span class='line'>WORKDIR /src
</span><span class='line'>
</span><span class='line'><span class="c"># install app dependencies</span>
</span><span class='line'>ENV PATH /src/node_modules/.bin:<span class="nv">$PATH</span>
</span><span class='line'>ADD package.json /src/package.json
</span><span class='line'>RUN npm install
</span><span class='line'>
</span><span class='line'><span class="c"># start app</span>
</span><span class='line'>CMD <span class="o">[</span><span class="s2">&quot;npm&quot;</span>, <span class="s2">&quot;start&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add the <code>users-service</code> to the <em>docker-compose.yml</em> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>users-service:
</span><span class='line'>  container_name: users-service
</span><span class='line'>  build: ./services/users/
</span><span class='line'>  volumes:
</span><span class='line'>    - <span class="s1">&#39;./services/users:/src/app&#39;</span>
</span><span class='line'>    - <span class="s1">&#39;./services/users/package.json:/src/package.json&#39;</span>
</span><span class='line'>  ports:
</span><span class='line'>    - <span class="s1">&#39;3000:3000&#39;</span>
</span><span class='line'>  environment:
</span><span class='line'>    - <span class="nv">DATABASE_URL</span><span class="o">=</span>postgres://admin:admin@users-db:5432/node_docker_api_users_dev
</span><span class='line'>    - <span class="nv">DATABASE_TEST_URL</span><span class="o">=</span>postgres://admin:admin@users-db:5432/node_docker_api_users_test
</span><span class='line'>    - <span class="nv">NODE_ENV</span><span class="o">=</span><span class="k">${</span><span class="nv">NODE_ENV</span><span class="k">}</span>
</span><span class='line'>    - <span class="nv">TOKEN_SECRET</span><span class="o">=</span>changeme
</span><span class='line'>  depends_on:
</span><span class='line'>    users-db:
</span><span class='line'>      condition: service_healthy
</span><span class='line'>  links:
</span><span class='line'>    - users-db
</span></code></pre></td></tr></table></div></figure>


<p>What&rsquo;s new here?</p>

<ol>
<li><code>volumes</code>: <a href="https://docs.docker.com/engine/tutorials/dockervolumes/">volumes</a> are used to mount a directory into a container so that you can make changes to the code without having to build a new image. This should be a default in your local development environment so you can get quick feedback on code changes.</li>
<li><code>depends_on</code>: <a href="https://docs.docker.com/compose/compose-file/#dependson">depends_on</a> is used to start services in a specific order. So, the <code>users-service</code> will wait for the <code>users-db</code> to fire up successfully (with an exit code of <code>0</code>) before it starts.</li>
<li><code>links</code>: With <a href="https://docs.docker.com/compose/compose-file/#links">links</a>, code inside the <code>users-service</code> can access the database via <code>users-db:5432</code>.</li>
</ol>


<p>Set the <code>NODE_ENV</code> environment variable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">NODE_ENV</span><span class="o">=</span>development
</span></code></pre></td></tr></table></div></figure>


<p>Spin up the container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker-compose up --build -d users-service
</span></code></pre></td></tr></table></div></figure>


<p>Once up, create a new file in the project root called <em>migrate.sh</em> and add the Knex migrate and seed commands:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'>docker-compose run users-service knex migrate:latest --env development --knexfile app/knexfile.js
</span><span class='line'>docker-compose run users-service knex seed:run --env development --knexfile app/knexfile.js
</span></code></pre></td></tr></table></div></figure>


<p>Then run it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sh migrate.sh
</span></code></pre></td></tr></table></div></figure>


<p>Test:</p>

<table>
<thead>
<tr>
<th> Endpoint        </th>
<th> HTTP Method </th>
<th> CRUD Method </th>
<th> Result        </th>
</tr>
</thead>
<tbody>
<tr>
<td> /users/ping     </td>
<td> GET         </td>
<td> READ        </td>
<td> <code>pong</code>        </td>
</tr>
<tr>
<td> /users/register </td>
<td> POST        </td>
<td> CREATE      </td>
<td> add a user    </td>
</tr>
<tr>
<td> /users/login    </td>
<td> POST        </td>
<td> CREATE      </td>
<td> log in a user </td>
</tr>
<tr>
<td> /users/user     </td>
<td> GET         </td>
<td> READ        </td>
<td> get user info </td>
</tr>
</tbody>
</table>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>http POST http://localhost:3000/users/register <span class="nv">username</span><span class="o">=</span>michael <span class="nv">password</span><span class="o">=</span>herman
</span><span class='line'><span class="nv">$ </span>http POST http://localhost:3000/users/login <span class="nv">username</span><span class="o">=</span>michael <span class="nv">password</span><span class="o">=</span>herman
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>NOTE:</strong> <code>http</code> in the above commands is part of the <a href="https://httpie.org/">HTTPie</a> library, which is a wrapper on top of cURL.</p></blockquote>

<h2>Locations Service Setup</h2>

<p>Add the <em>Dockerfile</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>FROM node:latest
</span><span class='line'>
</span><span class='line'><span class="c"># set working directory</span>
</span><span class='line'>RUN mkdir /src
</span><span class='line'>WORKDIR /src
</span><span class='line'>
</span><span class='line'><span class="c"># install app dependencies</span>
</span><span class='line'>ENV PATH /src/node_modules/.bin:<span class="nv">$PATH</span>
</span><span class='line'>ADD package.json /src/package.json
</span><span class='line'>RUN npm install
</span><span class='line'>
</span><span class='line'><span class="c"># start app</span>
</span><span class='line'>CMD <span class="o">[</span><span class="s2">&quot;npm&quot;</span>, <span class="s2">&quot;start&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add the service to <em>docker-compose</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>locations-service:
</span><span class='line'>  container_name: locations-service
</span><span class='line'>  build: ./services/locations/
</span><span class='line'>  volumes:
</span><span class='line'>    - <span class="s1">&#39;./services/locations:/src/app&#39;</span>
</span><span class='line'>    - <span class="s1">&#39;./services/locations/package.json:/src/package.json&#39;</span>
</span><span class='line'>  ports:
</span><span class='line'>    - <span class="s1">&#39;3001:3001&#39;</span>
</span><span class='line'>  environment:
</span><span class='line'>    - <span class="nv">DATABASE_URL</span><span class="o">=</span>postgres://admin:admin@locations-db:5432/node_docker_api_locations_dev
</span><span class='line'>    - <span class="nv">DATABASE_TEST_URL</span><span class="o">=</span>postgres://admin:admin@locations-db:5432/node_docker_api_locations_test
</span><span class='line'>    - <span class="nv">NODE_ENV</span><span class="o">=</span><span class="k">${</span><span class="nv">NODE_ENV</span><span class="k">}</span>
</span><span class='line'>    - <span class="nv">TOKEN_SECRET</span><span class="o">=</span>changeme
</span><span class='line'>    - <span class="nv">OPENWEATHERMAP_API_KEY</span><span class="o">=</span><span class="k">${</span><span class="nv">OPENWEATHERMAP_API_KEY</span><span class="k">}</span>
</span><span class='line'>  depends_on:
</span><span class='line'>    locations-db:
</span><span class='line'>      condition: service_healthy
</span><span class='line'>    users-service:
</span><span class='line'>      condition: service_started
</span><span class='line'>  links:
</span><span class='line'>    - locations-db
</span><span class='line'>    - users-service
</span></code></pre></td></tr></table></div></figure>


<p>Register with the <a href="https://openweathermap.org/api">OpenWeatherMap API</a>, and add the key as an environment variable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">OPENWEATHERMAP_API_KEY</span><span class="o">=</span>YOUR_KEY_HERE
</span></code></pre></td></tr></table></div></figure>


<p>Spin up the container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker-compose up --build -d locations-service
</span></code></pre></td></tr></table></div></figure>


<p>Add the migrate and seed commands to <em>migrate.sh</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>docker-compose run locations-service knex migrate:latest --env development --knexfile app/knexfile.js
</span><span class='line'>docker-compose run locations-service knex seed:run --env development --knexfile app/knexfile.js
</span></code></pre></td></tr></table></div></figure>


<p>Run it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sh migrate.sh
</span></code></pre></td></tr></table></div></figure>


<p>Test:</p>

<table>
<thead>
<tr>
<th> Endpoint         </th>
<th> HTTP Method </th>
<th> CRUD Method </th>
<th> Result                    </th>
</tr>
</thead>
<tbody>
<tr>
<td> /locations/ping  </td>
<td> GET         </td>
<td> READ        </td>
<td> <code>pong</code>                    </td>
</tr>
<tr>
<td> /locations       </td>
<td> GET         </td>
<td> READ        </td>
<td> get all locations         </td>
</tr>
<tr>
<td> /locations/user  </td>
<td> GET         </td>
<td> READ        </td>
<td> get all locations by user </td>
</tr>
<tr>
<td> /locations/:id   </td>
<td> GET         </td>
<td> READ        </td>
<td> get a single location     </td>
</tr>
<tr>
<td> /locations       </td>
<td> POST        </td>
<td> CREATE      </td>
<td> add a single location     </td>
</tr>
<tr>
<td> /locations/:id   </td>
<td> PUT         </td>
<td> UPDATE      </td>
<td> update a single location  </td>
</tr>
<tr>
<td> /locations/:id   </td>
<td> DELETE      </td>
<td> DELETE      </td>
<td> delete a single location  </td>
</tr>
</tbody>
</table>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>http GET http://localhost:3001/locations/ping
</span></code></pre></td></tr></table></div></figure>


<h2>Web Services Setup</h2>

<p>Moving right along&hellip;</p>

<p>Add the <em>Dockerfile</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>FROM node:latest
</span><span class='line'>
</span><span class='line'><span class="c"># set working directory</span>
</span><span class='line'>RUN mkdir /src
</span><span class='line'>WORKDIR /src
</span><span class='line'>
</span><span class='line'><span class="c"># install app dependencies</span>
</span><span class='line'>ENV PATH /src/node_modules/.bin:<span class="nv">$PATH</span>
</span><span class='line'>ADD package.json /src/package.json
</span><span class='line'>RUN npm install
</span><span class='line'>
</span><span class='line'><span class="c"># start app</span>
</span><span class='line'>CMD <span class="o">[</span><span class="s2">&quot;npm&quot;</span>, <span class="s2">&quot;start&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add the service to <em>docker-compose</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>web:
</span><span class='line'>  container_name: web
</span><span class='line'>  build: ./web/
</span><span class='line'>  volumes:
</span><span class='line'>    - <span class="s1">&#39;./web:/src/app&#39;</span>
</span><span class='line'>    - <span class="s1">&#39;./web/package.json:/src/package.json&#39;</span>
</span><span class='line'>  ports:
</span><span class='line'>    - <span class="s1">&#39;3003:3003&#39;</span>
</span><span class='line'>  environment:
</span><span class='line'>    - <span class="nv">NODE_ENV</span><span class="o">=</span><span class="k">${</span><span class="nv">NODE_ENV</span><span class="k">}</span>
</span><span class='line'>    - <span class="nv">SECRET_KEY</span><span class="o">=</span>changeme
</span><span class='line'>  depends_on:
</span><span class='line'>    users-service:
</span><span class='line'>      condition: service_started
</span><span class='line'>    locations-service:
</span><span class='line'>      condition: service_started
</span><span class='line'>  links:
</span><span class='line'>    - users-service
</span><span class='line'>    - locations-service
</span></code></pre></td></tr></table></div></figure>


<p>Spin up the container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker-compose up --build -d web
</span></code></pre></td></tr></table></div></figure>


<p>Navigate to <a href="http://localhost:3003">http://localhost:3003</a> in your browser and you should see the login page. Register a new user. Once redirected, you should see:</p>

<div style="text-align:center;">
  <img src="/images/blog/node-docker-api-browser.png" style="max-width: 100%; border:0; box-shadow: none;" alt="node docker browser view">
</div>


<p><br></p>

<p>Take a look at the AJAX request in the GET <code>/</code> route in <em>web/src/routes/index.js</em>. Why does the <code>uri</code> point to <code>locations-service</code> and not <code>localhost</code>? Well, <code>localhost</code> refers back to the container itself, so you need to set up a <a href="https://docs.docker.com/compose/compose-file/#links">link</a> in the Docker compose - which we&rsquo;ve already done.</p>

<h2>Testing</h2>

<p>Did you notice the unit and integration tests in the &ldquo;services/users/tests&rdquo; and &ldquo;services/locations/tests&rdquo; folders? Well, to run the tests properly, we need to update the <code>NODE_ENV</code> environment variable, since it is currently configured for the development environment.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">NODE_ENV</span><span class="o">=</span><span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>Update the containers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker-compose up -d
</span></code></pre></td></tr></table></div></figure>


<p>Then run the tests:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker-compose run users-service npm <span class="nb">test</span>
</span><span class='line'><span class="nv">$ </span>docker-compose run locations-service npm <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ready to develop again?</p>

<ol>
<li>Update the env variable - <code>export NODE_ENV=development</code></li>
<li>Update the containers - <code>docker-compose up -d</code></li>
</ol>


<h2>Workflow</h2>

<p>Let&rsquo;s quickly look at how to work with code inside the containers&hellip;</p>

<ol>
<li>Live Reloading - Since the code is mounted in the container via a volume, you can make changes to the local code base which will be applied to the code in the container. <a href="https://github.com/remy/nodemon">Nodemon</a> is used (along with Gulp) to restart the app when changes occur.</li>
<li>Debugging - <code>console.log</code> can be used for testing and debugging. Simply add one to your code base and then open the logs&hellip;</li>
<li>Logs - run <code>docker-compose logs -f</code> to view the logs.</li>
</ol>


<blockquote><p><strong>NOTE:</strong> Check out the <a href="https://github.com/mjhea0/node-docker-api">repo</a> to view more commands.</p></blockquote>

<p>Try it out:</p>

<ol>
<li>Run <code>docker-compose logs -f</code> in the terminal</li>
<li>Add <code>console.log('here');</code> to the top of <em>web/src/routes/index.js</em></li>
<li><p>As soon as you save, you should see the following in the terminal:</p>

<pre><code class="`sh"> web  | [18:35:37] [nodemon] restarting due to changes...
 web  | [18:35:37] [nodemon] running tasks...
 web  | [18:35:39] Using gulpfile /src/app/gulpfile.js
 web  | [18:35:39] Starting 'lint'...
 web  | [18:35:40]
 web  | /src/app/src/routes/index.js
 web  |   1:1  warning  Unexpected console statement  no-console
 web  |
 web  | ✖ 1 problem (0 errors, 1 warning)
 web  |
 web  | [18:35:40] Finished 'lint' after 1.69 s
 web  | [18:35:40] [nodemon] starting `node ./src/server`
 web  | here
</code></pre>

<p> Essentially, Nodemon detected changes and restarted the app, which fired the linter and then the server fired back up.</p></li>
</ol>


<h2>Test Setup</h2>

<p>Finally, to set up the last service, add the <em>Dockerfile</em> to the &ldquo;tests&rdquo; folder:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>FROM node:latest
</span><span class='line'>
</span><span class='line'><span class="c"># set working directory</span>
</span><span class='line'>RUN mkdir /src
</span><span class='line'>WORKDIR /src
</span><span class='line'>
</span><span class='line'><span class="c"># install app dependencies</span>
</span><span class='line'>ENV PATH /src/node_modules/.bin:<span class="nv">$PATH</span>
</span><span class='line'>ADD package.json /src/package.json
</span><span class='line'>RUN npm install
</span></code></pre></td></tr></table></div></figure>


<p>Then update the <em>docker-compose.yml</em> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>tests:
</span><span class='line'>  container_name: tests
</span><span class='line'>  build: ./tests/
</span><span class='line'>  volumes:
</span><span class='line'>    - <span class="s1">&#39;./tests:/src/app&#39;</span>
</span><span class='line'>    - <span class="s1">&#39;./tests/package.json:/src/package.json&#39;</span>
</span><span class='line'>  depends_on:
</span><span class='line'>    users-service:
</span><span class='line'>      condition: service_started
</span><span class='line'>    locations-service:
</span><span class='line'>      condition: service_started
</span><span class='line'>  links:
</span><span class='line'>    - users-service
</span><span class='line'>    - locations-service
</span><span class='line'>    - web
</span></code></pre></td></tr></table></div></figure>


<p>Fire up the container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker-compose up --build -d tests
</span></code></pre></td></tr></table></div></figure>


<p>Update the environment variable, update the containers, and then run the tests:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">NODE_ENV</span><span class="o">=</span><span class="nb">test</span>
</span><span class='line'><span class="nv">$ </span>docker-compose up -d
</span><span class='line'><span class="nv">$ </span>docker-compose run tests npm <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Next Steps</h2>

<p>What&rsquo;s next?</p>

<ol>
<li><strong>Dependency management</strong>: Right now we&rsquo;re installing many of the same dependencies over and over again, in multiple containers. How can we manage this better to spin up new containers faster and save disc space? How about a data-only container that just houses dependencies?</li>
<li><strong>Deployment prep</strong>: Set up Docker Machine for spinning up Docker environments, nginx for load balancing, and Consul for service discovery. Update the environment variables for the base URL since these will be different in production. Add an image registry solution and a data-only container for piping logs to&hellip;</li>
<li><strong>Error handling</strong>: Right now errors are being thrown, but there really isn&rsquo;t much info in the response as to why, which makes debugging difficult. Be a good citizen and handle your errors properly since you may not always have access to the code base from a different service.</li>
<li><strong>DRY</strong>: The code could be refactored in places, especially the tests.</li>
</ol>


<p>Grab the final code from the <a href="https://github.com/mjhea0/node-docker-api">node-docker-api</a> repo. Comment below. Cheers!</p>
</div>


  <footer>
    <p class="meta">
      
  



  <span class="byline author vcard">Authored by <span class="fn">
  
    Michael Herman
  
  </span></span>


      




<time class='entry-date' datetime='2017-04-18T08:16:46-06:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>8:16 am</span></time>
      
      

<span class="categories">
  
    <a class='category' href='/blog/categories/node/'>node</a>
  
</span>


    </p>
    
      <div class="sharing">
<!--   
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://mherman.org/blog/2017/04/18/developing-and-testing-microservices-with-docker/" data-via="" data-counturl="http://mherman.org/blog/2017/04/18/developing-and-testing-microservices-with-docker/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
   -->
  <br>
  <!-- AddThis Button BEGIN -->
  <div class="addthis_toolbox addthis_default_style addthis_32x32_style">
  <a class="addthis_button_preferred_1"></a>
  <a class="addthis_button_preferred_2"></a>
  <a class="addthis_button_preferred_3"></a>
  <a class="addthis_button_preferred_4"></a>
  <a class="addthis_button_compact"></a>
  <a class="addthis_counter addthis_bubble_style"></a>
  </div>
  <script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-50e5f1cc35ad077d"></script>
  <!-- AddThis Button END -->
  <br>
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2017/03/19/functional-testing-with-testcafe/" title="Previous Post: Functional Testing with TestCafe">&laquo; Functional Testing with TestCafe</a>
      
      
        <a class="basic-alignment right" href="/blog/2017/04/26/flask-for-node-developers/" title="Next Post: Flask for Node Developers">Flask for Node Developers &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>


</div>

    </div>
  </div>
  <footer role="contentinfo"><div>
  <span>Copyright &copy; 2017 - Michael Herman</span><br>
  <a href="https://github.com/mjhea0"><i class="fa fa-github-square" style="font-size:2em" aria-hidden="true"></i></a>
  <a href="https://twitter.com/mikeherman"><i class="fa fa-twitter-square" style="font-size:2em" aria-hidden="true"></i></a>
  <a href="http://www.linkedin.com/pub/michael-herman/3b/a94/4"><i class="fa fa-linkedin-square" style="font-size:2em" aria-hidden="true"></i></a>
  <a href="http://www.youtube.com/hermanmu"><i class="fa fa-youtube-square" style="font-size:2em" aria-hidden="true"></i></a>
</div>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'michaelherman';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://mherman.org/blog/2017/04/18/developing-and-testing-microservices-with-docker/';
        var disqus_url = 'http://mherman.org/blog/2017/04/18/developing-and-testing-microservices-with-docker/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>






<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
