<div class="highlight"><pre><span class="s1">&#39;use strict&#39;</span>

<span class="kd">var</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">);</span>

<span class="nx">suite</span><span class="p">(</span><span class="s1">&#39;submitAnswers&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="c1">// ensure that -</span>
  <span class="c1">// (1) the &quot;Answers&quot; collection exists</span>
  <span class="c1">// (2) we can connect to the collection</span>
  <span class="c1">// (3) the collection is empty</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;server initialization&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">,</span> <span class="nx">server</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">server</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">Answers</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">fetch</span><span class="p">();</span>
      <span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;collection&#39;</span><span class="p">,</span> <span class="nx">collection</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;collection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="c1">// ensure that -</span>
  <span class="c1">// (1) we can add data to the collection</span>
  <span class="c1">// (2) after data is added, we can retrieve it</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;server insert : OK&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">,</span> <span class="nx">server</span><span class="p">,</span> <span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">server</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">Answers</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">answerText</span><span class="o">:</span> <span class="s2">&quot;whee!&quot;</span>  <span class="p">});</span>
      <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">Answers</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">fetch</span><span class="p">();</span>
      <span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;collection&#39;</span><span class="p">,</span> <span class="nx">collection</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;collection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">collection</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;collection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">Answers</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">fetch</span><span class="p">().</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="nx">done</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>

<span class="p">});</span>
</pre>
</div>
