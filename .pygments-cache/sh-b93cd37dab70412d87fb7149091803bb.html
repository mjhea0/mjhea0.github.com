<div class="highlight"><pre>get_target_group_arn<span class="o">()</span> <span class="o">{</span>
	<span class="nb">echo</span> <span class="s2">&quot;Getting target group arn...&quot;</span>
  <span class="k">if</span> <span class="nv">target_group_arn</span><span class="o">=</span><span class="k">$(</span>aws elbv2 describe-target-groups --name <span class="nv">$TARGET_GROUP</span> <span class="p">|</span> <span class="nv">$JQ</span> <span class="s2">&quot;.TargetGroups[0].TargetGroupArn&quot;</span><span class="k">)</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Target group arn: $target_group_arn&quot;</span>
  <span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;Failed to get target group arn.&quot;</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>
<span class="o">}</span>

get_listener_priority<span class="o">()</span> <span class="o">{</span>
	<span class="nb">echo</span> <span class="s2">&quot;Getting listener priority...&quot;</span>
  <span class="k">if</span> <span class="nv">length</span><span class="o">=</span><span class="k">$(</span>aws elbv2 describe-rules --listener-arn <span class="nv">$LOAD_BALANCER_LISTENER_ARN</span> <span class="p">|</span> <span class="nv">$JQ</span>  <span class="s2">&quot;.Rules | length&quot;</span><span class="k">)</span><span class="p">;</span> <span class="k">then</span>
		<span class="nv">length</span><span class="o">=</span><span class="k">$((</span><span class="nv">$length</span><span class="o">+</span><span class="m">1</span><span class="k">))</span>
    <span class="nb">echo</span> <span class="s2">&quot;Listener priority: $length&quot;</span>
  <span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;Failed to get target group arn.&quot;</span>
    <span class="k">return</span> 1
  <span class="k">fi</span>
<span class="o">}</span>

create_listener<span class="o">()</span> <span class="o">{</span>
	<span class="nb">echo</span> <span class="s2">&quot;Creating listener...&quot;</span>
	<span class="k">if</span> <span class="o">[[</span> <span class="k">$(</span>aws elbv2 create-rule --listener-arn <span class="nv">$LOAD_BALANCER_LISTENER_ARN</span> --priority <span class="nv">$length</span> --conditions <span class="nv">Field</span><span class="o">=</span>path-pattern,Values<span class="o">=</span><span class="s2">&quot;/${SHORT_GIT_HASH}&quot;</span> --actions <span class="nv">Type</span><span class="o">=</span>forward,TargetGroupArn<span class="o">=</span><span class="nv">$target_group_arn</span> <span class="p">|</span> <span class="nv">$JQ</span> <span class="s2">&quot;.Rules[0].Actions[0].TargetGroupArn&quot;</span><span class="k">)</span> <span class="o">==</span> <span class="nv">$target_group_arn</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
		<span class="nb">echo</span> <span class="s2">&quot;Listener created!&quot;</span>
	<span class="k">else</span>
		<span class="nb">echo</span> <span class="s2">&quot;Error creating listener.&quot;</span>
		<span class="k">return</span> 1
  <span class="k">fi</span>
<span class="o">}</span>
</pre></div>