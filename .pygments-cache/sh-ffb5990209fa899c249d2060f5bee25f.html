<div class="highlight"><pre><span class="c">#!/usr/bin/env bash</span>


<span class="c"># config</span>

<span class="nb">set</span> -e

<span class="nv">ECS_REGION</span><span class="o">=</span><span class="s2">&quot;us-west-2&quot;</span>
<span class="nv">NAMESPACE</span><span class="o">=</span><span class="s2">&quot;microservicemovies&quot;</span>
<span class="nv">IMAGE_BASE</span><span class="o">=</span><span class="s2">&quot;microservicemovies&quot;</span>
<span class="nv">ECR_URI</span><span class="o">=</span><span class="s2">&quot;${AWS_ACCOUNT_ID}.dkr.ecr.${ECS_REGION}.amazonaws.com&quot;</span>
<span class="nv">SHORT_GIT_HASH</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$CIRCLE_SHA1</span> <span class="p">|</span> cut -c -7<span class="k">)</span>
<span class="nv">TAG</span><span class="o">=</span><span class="nv">$SHORT_GIT_HASH</span>


<span class="c"># helpers</span>

configure_aws_cli<span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;Configuring AWS...&quot;</span>
  aws --version
  aws configure <span class="nb">set </span>default.region <span class="nv">$ECS_REGION</span>
  aws configure <span class="nb">set </span>default.output json
  <span class="nb">echo</span> <span class="s2">&quot;AWS configured!&quot;</span>
<span class="o">}</span>

tag_and_push_images<span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;Tagging and pushing images...&quot;</span>
  <span class="k">$(</span>aws ecr get-login --region <span class="s2">&quot;${ECS_REGION}&quot;</span><span class="k">)</span>
  <span class="c"># tag</span>
  docker tag <span class="k">${</span><span class="nv">IMAGE_BASE</span><span class="k">}</span>_users-db-review <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/users-db-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
  docker tag <span class="k">${</span><span class="nv">IMAGE_BASE</span><span class="k">}</span>_movies-db-review <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/movies-db-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
  docker tag <span class="k">${</span><span class="nv">IMAGE_BASE</span><span class="k">}</span>_users-service-review <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/users-service-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
  docker tag <span class="k">${</span><span class="nv">IMAGE_BASE</span><span class="k">}</span>_movies-service-review <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/movies-service-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
  docker tag <span class="k">${</span><span class="nv">IMAGE_BASE</span><span class="k">}</span>_web-service-review <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/web-service-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
  docker tag <span class="k">${</span><span class="nv">IMAGE_BASE</span><span class="k">}</span>_swagger-review <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/swagger-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
  <span class="c"># push</span>
  docker push <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/users-db-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
  docker push <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/movies-db-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
  docker push <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/users-service-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
  docker push <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/movies-service-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
  docker push <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/web-service-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
  docker push <span class="k">${</span><span class="nv">ECR_URI</span><span class="k">}</span>/<span class="k">${</span><span class="nv">NAMESPACE</span><span class="k">}</span>/swagger-review:<span class="k">${</span><span class="nv">TAG</span><span class="k">}</span>
  <span class="nb">echo</span> <span class="s2">&quot;Images tagged and pushed!&quot;</span>
<span class="o">}</span>

<span class="c"># main</span>

configure_aws_cli
tag_and_push_images
</pre></div>