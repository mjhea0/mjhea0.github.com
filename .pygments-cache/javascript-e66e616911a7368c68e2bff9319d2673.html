<div class="highlight"><pre><span class="nx">Add</span> <span class="nx">the</span> <span class="nx">following</span> <span class="p">[</span><span class="nx">environment</span> <span class="nx">variables</span><span class="p">](</span><span class="nx">https</span><span class="o">:</span><span class="c1">//circleci.com/docs/2.0/env-vars/#adding-environment-variables-in-the-app) to Circle so that we can properly configure the AWS CLI:</span>

<span class="mi">1</span><span class="p">.</span> <span class="err">`</span><span class="nx">AWS_ACCOUNT_ID</span><span class="err">`</span>
<span class="mi">1</span><span class="p">.</span> <span class="err">`</span><span class="nx">AWS_ACCESS_KEY_ID</span><span class="err">`</span>
<span class="mi">1</span><span class="p">.</span> <span class="err">`</span><span class="nx">AWS_SECRET_ACCESS_KEY</span><span class="err">`</span>

<span class="nx">Commit</span> <span class="nx">your</span> <span class="nx">changes</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">then</span> <span class="nx">push</span> <span class="nx">to</span> <span class="nx">GitHub</span> <span class="nx">to</span> <span class="nx">trigger</span> <span class="nx">a</span> <span class="k">new</span> <span class="nx">build</span><span class="p">.</span> <span class="nx">Make</span> <span class="nx">sure</span> <span class="nx">it</span> <span class="nx">passes</span> <span class="nx">before</span> <span class="nx">moving</span> <span class="nx">on</span><span class="p">.</span>

<span class="p">[</span><span class="o">!</span><span class="p">[</span><span class="nx">circle</span> <span class="nx">aws</span> <span class="nx">config</span><span class="p">](</span><span class="err">/images/blog/on-demand-environments/circle-ci-aws-config.png)](/images/blog/on-demand-environments/circle-ci-aws-config.png)</span>

<span class="err">##</span> <span class="nx">Deployment</span>

<span class="nx">The</span> <span class="nx">remainder</span> <span class="nx">of</span> <span class="k">this</span> <span class="nx">tutorial</span> <span class="nx">will</span> <span class="nx">focus</span> <span class="nx">on</span> <span class="nx">deployment</span><span class="o">:</span>

<span class="mi">1</span><span class="p">.</span> <span class="o">*</span><span class="nx">Setup</span><span class="o">*</span> <span class="o">-</span> <span class="nx">configuring</span> <span class="nx">the</span> <span class="nx">necessary</span> <span class="nx">AWS</span> <span class="nx">resources</span> <span class="nx">and</span> <span class="nx">deploying</span>
<span class="mi">1</span><span class="p">.</span> <span class="o">*</span><span class="nx">Test</span><span class="o">*</span> <span class="o">-</span> <span class="nx">running</span> <span class="nx">the</span> <span class="nx">end</span><span class="o">-</span><span class="nx">to</span><span class="o">-</span><span class="nx">end</span> <span class="nx">tests</span> <span class="nx">against</span> <span class="nx">the</span> <span class="nx">running</span> <span class="nx">app</span>
<span class="mi">1</span><span class="p">.</span> <span class="o">*</span><span class="nx">Teardown</span><span class="o">*</span> <span class="o">-</span> <span class="nx">bringing</span> <span class="nx">down</span> <span class="nx">the</span> <span class="nx">AWS</span> <span class="nx">resources</span>

<span class="err">###</span> <span class="nx">Image</span> <span class="nx">Registry</span>

<span class="nx">Moving</span> <span class="nx">right</span> <span class="nx">along</span><span class="p">,</span> <span class="kd">let</span><span class="err">&#39;</span><span class="nx">s</span> <span class="nx">set</span> <span class="nx">up</span> <span class="p">[</span><span class="nx">Amazon</span> <span class="nx">EC2</span> <span class="nx">Container</span> <span class="nx">Registry</span><span class="p">](</span><span class="nx">https</span><span class="o">:</span><span class="c1">//aws.amazon.com/ecr/) (ECR), an image registry tied to ECS.</span>

<span class="nx">Steps</span><span class="o">:</span>

<span class="mi">1</span><span class="p">.</span> <span class="nx">Manually</span> <span class="nx">add</span> <span class="nx">images</span> <span class="nx">to</span> <span class="nx">ECR</span>
<span class="mi">1</span><span class="p">.</span> <span class="nx">Update</span> <span class="nx">script</span> <span class="nx">to</span> <span class="nx">tag</span> <span class="nx">and</span> <span class="nx">push</span> <span class="nx">images</span> <span class="nx">on</span> <span class="nx">a</span> <span class="nx">successful</span> <span class="nx">build</span>

<span class="err">####</span> <span class="nx">Manually</span> <span class="nx">add</span> <span class="nx">images</span> <span class="nx">to</span> <span class="nx">ECR</span>

<span class="nx">Within</span> <span class="nx">the</span> <span class="p">[</span><span class="nx">ECS</span> <span class="nx">Console</span><span class="p">](</span><span class="nx">https</span><span class="o">:</span><span class="c1">//console.aws.amazon.com/ecs), click &quot;Repositories&quot; on the navigation pane, and then click the &quot;Create repository&quot; button. Add the following repositories:</span>

<span class="mi">1</span><span class="p">.</span> <span class="err">`</span><span class="nx">sample</span><span class="o">/</span><span class="nx">users</span><span class="o">-</span><span class="nx">db</span><span class="o">-</span><span class="nx">review</span><span class="err">`</span>
<span class="mi">1</span><span class="p">.</span> <span class="err">`</span><span class="nx">sample</span><span class="o">/</span><span class="nx">movies</span><span class="o">-</span><span class="nx">db</span><span class="o">-</span><span class="nx">review</span><span class="err">`</span>
<span class="mi">1</span><span class="p">.</span> <span class="err">`</span><span class="nx">sample</span><span class="o">/</span><span class="nx">users</span><span class="o">-</span><span class="nx">service</span><span class="o">-</span><span class="nx">review</span><span class="err">`</span>
<span class="mi">1</span><span class="p">.</span> <span class="err">`</span><span class="nx">sample</span><span class="o">/</span><span class="nx">movies</span><span class="o">-</span><span class="nx">service</span><span class="o">-</span><span class="nx">review</span><span class="err">`</span>
<span class="mi">1</span><span class="p">.</span> <span class="err">`</span><span class="nx">sample</span><span class="o">/</span><span class="nx">web</span><span class="o">-</span><span class="nx">service</span><span class="o">-</span><span class="nx">review</span><span class="err">`</span>
<span class="mi">1</span><span class="p">.</span> <span class="err">`</span><span class="nx">sample</span><span class="o">/</span><span class="nx">swagger</span><span class="o">-</span><span class="nx">review</span><span class="err">`</span>

<span class="p">[</span><span class="o">!</span><span class="p">[</span><span class="nx">aws</span> <span class="nx">ecr</span> <span class="nx">repos</span><span class="p">](</span><span class="err">/images/blog/on-demand-environments/aws-ecr-repos.png)](/images/blog/on-demand-environments/aws-ecr-repos.png)</span>

<span class="err">####</span> <span class="nx">Tag</span> <span class="nx">and</span> <span class="nx">push</span> <span class="nx">images</span> <span class="nx">to</span> <span class="nx">ECR</span>

<span class="nx">Next</span><span class="p">,</span> <span class="nx">add</span> <span class="nx">the</span> <span class="nx">following</span> <span class="nx">functions</span> <span class="nx">to</span> <span class="o">*</span><span class="nx">deploy</span><span class="p">.</span><span class="nx">sh</span><span class="o">*:</span>
</pre></div>