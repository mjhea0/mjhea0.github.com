<div class="highlight"><pre><span class="c1">// @flow</span>

<span class="s1">&#39;use strict&#39;</span>

<span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">http</span> <span class="nx">from</span> <span class="s1">&#39;http&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">debug</span> <span class="nx">from</span> <span class="s1">&#39;debug&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">Api</span> <span class="nx">from</span> <span class="s1">&#39;./Api&#39;</span><span class="p">;</span>

<span class="c1">// Error interface for use in onError</span>
<span class="nx">declare</span> <span class="kr">interface</span> <span class="nx">ErrnoError</span> <span class="kr">extends</span> <span class="nb">Error</span> <span class="p">{</span>
  <span class="nx">errno</span><span class="o">?:</span> <span class="nx">number</span><span class="p">;</span>
  <span class="nx">code</span><span class="o">?:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">path</span><span class="o">?:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">syscall</span><span class="o">?:</span> <span class="nx">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;flow-api:startup&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">app</span><span class="o">:</span> <span class="nx">Api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Api</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">DEFAULT_PORT</span><span class="o">:</span> <span class="nx">number</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">port</span><span class="o">:</span> <span class="nx">string</span> <span class="o">|</span> <span class="nx">number</span> <span class="o">=</span> <span class="nx">normalizePort</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">server</span><span class="o">:</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">express</span><span class="p">);</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">);</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">onError</span><span class="p">);</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;listening&#39;</span><span class="p">,</span> <span class="nx">onListening</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">normalizePort</span><span class="p">(</span><span class="nx">val</span><span class="o">:</span> <span class="nx">any</span><span class="p">)</span><span class="o">:</span> <span class="nx">number</span> <span class="o">|</span> <span class="nx">string</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">port</span><span class="o">:</span> <span class="nx">number</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">val</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">:</span> <span class="nx">val</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">port</span> <span class="o">&amp;&amp;</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">port</span><span class="p">))</span> <span class="k">return</span> <span class="nx">port</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">port</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">port</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">return</span> <span class="nx">DEFAULT_PORT</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">onError</span><span class="p">(</span><span class="nx">error</span><span class="o">:</span> <span class="nx">ErrnoError</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">syscall</span> <span class="o">!==</span> <span class="s1">&#39;listen&#39;</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">bind</span><span class="o">:</span> <span class="nx">string</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">port</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="err">`</span><span class="nx">Pipe</span> <span class="nx">$</span><span class="p">{</span><span class="nx">port</span><span class="p">}</span><span class="err">`</span> <span class="o">:</span> <span class="err">`</span><span class="nx">Port</span> <span class="nx">$</span><span class="p">{</span><span class="nx">port</span><span class="p">.</span><span class="nx">toString</span><span class="p">()}</span><span class="err">`</span><span class="p">;</span>

  <span class="k">switch</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">&#39;EACCES&#39;</span><span class="o">:</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">bind</span><span class="p">}</span> <span class="nx">requires</span> <span class="nx">elevated</span> <span class="nx">privileges</span><span class="err">`</span><span class="p">);</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">&#39;EADDRINUSE&#39;</span><span class="o">:</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">bind</span><span class="p">}</span> <span class="nx">is</span> <span class="nx">already</span> <span class="k">in</span> <span class="nx">use</span><span class="err">`</span><span class="p">);</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">onListening</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">addr</span><span class="o">:</span> <span class="nx">string</span> <span class="o">=</span> <span class="nx">server</span><span class="p">.</span><span class="nx">address</span><span class="p">();</span>
  <span class="kd">let</span> <span class="nx">bind</span><span class="o">:</span> <span class="nx">string</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">addr</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="err">`</span><span class="nx">pipe</span> <span class="nx">$</span><span class="p">{</span><span class="nx">addr</span><span class="p">}</span><span class="err">`</span> <span class="o">:</span> <span class="err">`</span><span class="nx">port</span> <span class="nx">$</span><span class="p">{</span><span class="nx">addr</span><span class="p">.</span><span class="nx">port</span><span class="p">}</span><span class="err">`</span><span class="p">;</span>
  <span class="nx">logger</span><span class="p">(</span><span class="err">`</span><span class="nx">Listening</span> <span class="nx">on</span> <span class="nx">$</span><span class="p">{</span><span class="nx">bind</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>