<!DOCTYPE html>
<html lang="en">

  <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Authentication in Angular with NGRX</title>
  <meta name="description" content="This tutorial demonstrates how to add authentication to Angular using NGRX Store and Effects.">
  
    
    <meta name="keywords" content="angular, javascript, authentication, auth, ngrx, ngrx store, ngrx effects">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://mherman.org/blog/authentication-in-angular-with-ngrx/">
  
  
  <link rel="alternate" type="application/rss+xml" title="Michael Herman" href="https://mherman.org/feed.xml">

  <link rel="icon" type="image/png" href="/favicon.png">


  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Authentication in Angular with NGRX">
  <meta name="twitter:description" content="This tutorial demonstrates how to add authentication to Angular using NGRX Store and Effects.">
  
  

  <script type="text/javascript">
  WebFontConfig = {
    google: { families: [ 'Bitter:400,700,400italic:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  
    
  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-37074204-1', 'auto');
    ga('send', 'pageview');
  </script>


  
</head>


  <link rel="stylesheet" href="/assets/hello.css">
  <link rel="stylesheet" href="/assets/carbon.css">

  <body>

    <header class="site-header">

  <div class="color-bar">
    <div class="bar bar1"></div>
    <div class="bar bar2"></div>
    <div class="bar bar3"></div>
    <div class="bar bar4"></div>
    <div class="bar bar5"></div>
    <div class="bar bar6"></div>
  </div>

  <div class="wrapper">

    <a class="site-title" href="/">Michael Herman</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/">Blog</a>
      
        
        <a class="page-link" href="/about">About</a>
      
        
        <a class="page-link" href="/talks">Talks</a>
      
        
        <a class="page-link" href="/feed.xml">RSS</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CE7DT27Y&placement=mhermanorg" id="_carbonads_js"></script>
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Authentication in Angular with NGRX</h1>
    
    <p class="post-meta">
      Last update: <time datetime="2018-04-17T00:00:00-06:00" itemprop="datePublished">Apr 17, 2018</time>
       • 
  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/angular/">angular</a>,
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <a href="/categories/auth/">auth</a>
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  

</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>In this tutorial, we’ll add authentication to Angular using <a href="https://github.com/ngrx/platform">NGRX</a> Store and Effects.</p>

<blockquote>
  <p>This post assumes that you a have basic working knowledge of <a href="https://angular.io/">Angular</a> (2+), <a href="https://www.typescriptlang.org/">TypeScript</a>, <a href="http://reactivex.io/rxjs/">RxJS</a> and the <a href="https://redux.js.org/">Redux</a> design pattern. If you’re new to <a href="http://ngrx.github.io/">NGRX</a>, check out the awesome <a href="https://gist.github.com/btroncone/a6e4347326749f938510">Comprehensive Introduction to @ngrx/store</a> guide.</p>
</blockquote>

<p><em>Dependencies</em>:</p>

<ol>
  <li>Angular CLI v1.7.3 (Angular v5.2.0)</li>
  <li>Node v9.11.0</li>
  <li>NGRX Store v5.2.0</li>
  <li>NGRX Effects v5.2.0</li>
</ol>

<p><em>Final app</em>:</p>

<div style="text-align:left;padding-top:10px;padding-left:10px;padding-bottom:10px">
  <img src="/assets/img/blog/angular-auth-ngrx/final-app.gif" style="max-width: 70%;border:0;box-shadow:none;" alt="final app" />
</div>

<h2 class="no_toc" id="contents">Contents</h2>

<ul id="markdown-toc">
  <li><a href="#objectives" id="markdown-toc-objectives">Objectives</a></li>
  <li><a href="#token-based-authentication" id="markdown-toc-token-based-authentication">Token-based Authentication</a></li>
  <li><a href="#project-setup" id="markdown-toc-project-setup">Project Setup</a></li>
  <li><a href="#routing-and-components" id="markdown-toc-routing-and-components">Routing and Components</a></li>
  <li><a href="#workflow" id="markdown-toc-workflow">Workflow</a></li>
  <li><a href="#configure-forms-1" id="markdown-toc-configure-forms-1">Configure Forms</a></li>
  <li><a href="#ngrx-store-1" id="markdown-toc-ngrx-store-1">NGRX Store</a></li>
  <li><a href="#configure-auth-service-1" id="markdown-toc-configure-auth-service-1">Configure Auth Service</a></li>
  <li><a href="#ngrx-effects-1" id="markdown-toc-ngrx-effects-1">NGRX Effects</a></li>
  <li><a href="#configure-login-1" id="markdown-toc-configure-login-1">Configure Login</a></li>
  <li><a href="#configure-signup-1" id="markdown-toc-configure-signup-1">Configure Signup</a></li>
  <li><a href="#configure-logout-1" id="markdown-toc-configure-logout-1">Configure Logout</a></li>
  <li><a href="#update-the-templates-1" id="markdown-toc-update-the-templates-1">Update the Templates</a></li>
  <li><a href="#add-http-interceptor-1" id="markdown-toc-add-http-interceptor-1">Add HTTP Interceptor</a></li>
  <li><a href="#route-guard-1" id="markdown-toc-route-guard-1">Route Guard</a></li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ul>

<h2 id="objectives">Objectives</h2>

<p>By the end of this tutorial, you will be able to…</p>

<ol>
  <li>Develop a fully-functioning Angular app with authentication</li>
  <li>Discuss the benefits and drawbacks of using token-based authentication</li>
  <li>Implement user authentication with tokens</li>
  <li>Utilize NGRX Store for state management</li>
  <li>Isolate and manage side effects with NGRX Effects</li>
  <li>Set up an HTTP Interceptor to hijack outgoing requests and incoming responses</li>
  <li>Configure route-based authorization with route guards</li>
</ol>

<h2 id="token-based-authentication">Token-based Authentication</h2>

<p>With token-based Authentication, users send their credentials to an authentication server to obtain a signed token. The client then stores this token locally, usually in localStorage or in a cookie. Every subsequent call to the server, for a protected resource, includes that signed token that the server then verifies before granting access to the desired resource.</p>

<p><strong>Benefits:</strong></p>

<ol>
  <li><em>Stateless</em>: Since the token contains all information required for the server to verify a user’s identity, scaling is easier as we don’t need to worry about maintaining a session store on the server-side.</li>
  <li><em>Single Sign On</em>: After a token is generated, you can have your users access a number of different resources and services without having to prompt them for their login credentials.</li>
</ol>

<p><strong>Drawbacks:</strong></p>

<ol>
  <li><em>Cross-site Scripting (XSS) attacks</em>: Storing tokens in either local or session storage can lead to XSS attacks. Because of this, it’s a good idea to store tokens in a cookie with <code class="highlighter-rouge">httpOnly</code> and <code class="highlighter-rouge">secure</code> flags.</li>
</ol>

<blockquote>
  <p>Although we won’t be covering server-side token creation in this post, it’s worth noting that a <a href="https://jwt.io/">JSON Web Token</a> is a popular standard for creating tokens. Just keep in mind that since a JWT is <a href="https://stackoverflow.com/questions/454048/what-is-the-difference-between-encrypting-and-signing-in-asymmetric-encryption">signed rather than encrypted</a> it should never contain sensitive information like a user’s password.</p>
</blockquote>

<p>With that, here’s the full user auth process:</p>

<ol>
  <li>End user sends their credentials to the server</li>
  <li>Server verifies the credentials and, if correct, generates a token, which is then passed back to the client</li>
  <li>Client stores the token in localStorage or in a cookie</li>
  <li>Client sends the token alongside any subsequent requests to the server</li>
</ol>

<p>For more on token-based auth, along with the pros and cons of using it vs. session-based auth, please review the following articles:</p>

<ol>
  <li><a href="https://dzone.com/articles/cookies-vs-tokens-the-definitive-guide">Cookies vs Tokens: The Definitive Guide</a></li>
  <li><a href="https://stackoverflow.com/questions/17000835/token-authentication-vs-cookies">Token Authentication vs. Cookies</a></li>
</ol>

<h2 id="project-setup">Project Setup</h2>

<p>Begin by installing the Angular CLI globally, if you don’t already have it:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm install <span class="nt">-g</span> @angular/cli@1.7.3
</code></pre></div></div>

<p>Then, create a new Angular project:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ng new angular-auth-ngrx
<span class="nv">$ </span><span class="nb">cd </span>angular-auth-ngrx
</code></pre></div></div>

<p>Run the server:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ng serve
</code></pre></div></div>

<p>Then, in your browser of choice, navigate to <a href="http://localhost:4200">http://localhost:4200</a>. You should see the “Welcome to app!” message along with the Angular logo in the browser.</p>

<p>Kill the server. Then, install <a href="http://getbootstrap.com/">Bootstrap</a>:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm install bootstrap@4.1.0 <span class="nt">--save</span>
</code></pre></div></div>

<p>After installation, update the styles configuration in the <em>.angular-cli.json</em> file at the project root:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"styles"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
  </span><span class="s2">"../node_modules/bootstrap/dist/css/bootstrap.min.css"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"styles.css"</span><span class="w">
</span><span class="p">],</span><span class="w">
</span></code></pre></div></div>

<p>Add a <a href="https://getbootstrap.com/docs/4.0/layout/overview/#containers">container</a> to the <em>src/index.html</em> page:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>AngularAuthNgrx<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;base</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>

  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"icon"</span> <span class="na">type=</span><span class="s">"image/x-icon"</span> <span class="na">href=</span><span class="s">"favicon.ico"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;app-root&gt;&lt;/app-root&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>Run the server again to view the updated styles:</p>

<p><img src="/assets/img/blog/angular-auth-ngrx/bootstrap-welcome.png" alt="bootstrap welcome" /></p>

<h2 id="routing-and-components">Routing and Components</h2>

<p>Next, let’s add three components and configure some basic routes:</p>

<table>
  <thead>
    <tr>
      <th>Component</th>
      <th>Purpose</th>
      <th>Route</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">Landing</code></td>
      <td>Landing page</td>
      <td><code class="highlighter-rouge">/</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">LogIn</code></td>
      <td>Authenticating existing users</td>
      <td><code class="highlighter-rouge">/log-in</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">SignUp</code></td>
      <td>Registering new users</td>
      <td><code class="highlighter-rouge">/sign-up</code></td>
    </tr>
  </tbody>
</table>

<p>Start by generating the components:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ng generate component components/landing
<span class="nv">$ </span>ng generate component components/sign-up
<span class="nv">$ </span>ng generate component components/log-in
</code></pre></div></div>

<p>Next, add the <a href="https://angular.io/api/router/RouterModule">RouterModule</a> import to the <em>app.module.ts</em> file:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">RouterModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>
</code></pre></div></div>

<p>Add the following route configuration, to the <code class="highlighter-rouge">imports</code> array, to map each of the components we just created to a URL:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">RouterModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">([</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'log-in'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">LogInComponent</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'sign-up'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">SignUpComponent</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">LandingComponent</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'**'</span><span class="p">,</span> <span class="na">redirectTo</span><span class="p">:</span> <span class="s1">'/'</span> <span class="p">}</span>
<span class="p">])</span>
</code></pre></div></div>

<p>Your <em>app.module.ts</em> should now look like:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">BrowserModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/platform-browser'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">NgModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RouterModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">AppComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./app.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LandingComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./components/landing/landing.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">SignUpComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./components/sign-up/sign-up.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LogInComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./components/log-in/log-in.component'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">NgModule</span><span class="p">({</span>
  <span class="na">declarations</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">AppComponent</span><span class="p">,</span>
    <span class="nx">LandingComponent</span><span class="p">,</span>
    <span class="nx">SignUpComponent</span><span class="p">,</span>
    <span class="nx">LogInComponent</span>
  <span class="p">],</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">BrowserModule</span><span class="p">,</span>
    <span class="nx">RouterModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">([</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'log-in'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">LogInComponent</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'sign-up'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">SignUpComponent</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">LandingComponent</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'**'</span><span class="p">,</span> <span class="na">redirectTo</span><span class="p">:</span> <span class="s1">'/'</span> <span class="p">}</span>
    <span class="p">])</span>
  <span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[],</span>
  <span class="na">bootstrap</span><span class="p">:</span> <span class="p">[</span><span class="nx">AppComponent</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppModule</span> <span class="p">{</span> <span class="p">}</span>
</code></pre></div></div>

<p>Fire up the server and test each URL in the browser:</p>

<ol>
  <li><a href="http://localhost:4200">http://localhost:4200</a></li>
  <li><a href="http://localhost:4200/log-in">http://localhost:4200/log-in</a></li>
  <li><a href="http://localhost:4200/sign-up">http://localhost:4200/sign-up</a></li>
  <li><a href="http://localhost:4200/notreal">http://localhost:4200/notreal</a></li>
</ol>

<p>We know that the routes are configured correctly since <code class="highlighter-rouge">/notreal</code> redirects to <code class="highlighter-rouge">/</code> (and renders the <code class="highlighter-rouge">LandingComponent</code>) while <code class="highlighter-rouge">/log-in</code> and <code class="highlighter-rouge">/sign-up</code> work just fine. Now, we still need to use the <code class="highlighter-rouge">RouterOutlet</code> <a href="https://angular.io/api/router/RouterOutlet">directive</a> to tell Angular where to insert each of our HTML templates.</p>

<p>Replace the contents of the <em>app.component.html</em> file with the <code class="highlighter-rouge">&lt;router-outlet&gt;</code> tag:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;router-outlet&gt;&lt;/router-outlet&gt;</span>
</code></pre></div></div>

<p>Run the app again. Make sure you are shown the correct component when you visit each of the URLs in the browser.</p>

<p>Finally, update <em>src/app/components/landing/landing.component.html</em>:</p>

<pre><code class="language-ng2">&lt;div class="row"&gt;
  &lt;div class="col-md-4"&gt;
    &lt;h1&gt;Angular + NGRX&lt;/h1&gt;
    &lt;hr&gt;&lt;br&gt;
    &lt;a [routerLink]="['/log-in']" class="btn btn-primary"&gt;Log in&lt;/a&gt;
    &lt;a [routerLink]="['/sign-up']" class="btn btn-primary"&gt;Sign up&lt;/a&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>

<div style="text-align:left;padding-top:10px;padding-left:10px;">
  <img src="/assets/img/blog/angular-auth-ngrx/landing.png" style="max-width: 70%;border:0;box-shadow:none;" alt="landing component" />
</div>

<p>And, with that, we’re ready to start adding authentication!</p>

<h2 id="workflow">Workflow</h2>

<h3 id="configure-forms">Configure Forms</h3>

<ol>
  <li>Add form to the <code class="highlighter-rouge">SignUpComponent</code></li>
  <li>Define the <code class="highlighter-rouge">User</code> Model</li>
  <li>Add form to the <code class="highlighter-rouge">LogInComponent</code></li>
</ol>

<h3 id="ngrx-store">NGRX Store</h3>

<ol>
  <li>Install NGRX Store</li>
  <li>Add files and folders for the actions and reducers</li>
  <li>Define the state</li>
</ol>

<h3 id="configure-auth-service">Configure Auth Service</h3>

<ol>
  <li>Spin up the fake back-end server</li>
  <li>Add a service</li>
</ol>

<h3 id="ngrx-effects">NGRX Effects</h3>

<ol>
  <li>Install NGRX Effects</li>
  <li>Add effects file</li>
</ol>

<h3 id="configure-login">Configure Login</h3>

<ol>
  <li>Login
    <ul>
      <li>Dispatch <code class="highlighter-rouge">LogIn</code> action</li>
      <li>Add action</li>
      <li>Add effect (to dispatch either <code class="highlighter-rouge">LogInSuccess</code> or <code class="highlighter-rouge">LogInFailure</code>)</li>
    </ul>
  </li>
  <li>Login Success
    <ul>
      <li>Add action</li>
      <li>Add reducer (to create new state)</li>
      <li>Add effect (to add token to localStorage and redirect user)</li>
    </ul>
  </li>
  <li>Login Failure
    <ul>
      <li>Add action</li>
      <li>Add reducer (to create new state)</li>
      <li>Add effect</li>
    </ul>
  </li>
</ol>

<h3 id="configure-signup">Configure Signup</h3>

<ol>
  <li>Signup
    <ul>
      <li>Dispatch <code class="highlighter-rouge">SignUp</code> action</li>
      <li>Add action</li>
      <li>Add effect (to dispatch either <code class="highlighter-rouge">SignUpSuccess</code> or <code class="highlighter-rouge">SignUpFailure</code>)</li>
    </ul>
  </li>
  <li>Signup Success
    <ul>
      <li>Add action</li>
      <li>Add reducer (to create new state)</li>
      <li>Add effect (to add token to localStorage and redirect user)</li>
    </ul>
  </li>
  <li>Signup Failure
    <ul>
      <li>Add action</li>
      <li>Add reducer (to create new state)</li>
      <li>Add effect</li>
    </ul>
  </li>
</ol>

<h3 id="configure-logout">Configure Logout</h3>

<ol>
  <li>Logout
    <ul>
      <li>Dispatch <code class="highlighter-rouge">LogIn</code> action</li>
      <li>Add action</li>
      <li>Add reducer (to create new state)</li>
      <li>Add effect (to remove token from localStorage)</li>
    </ul>
  </li>
</ol>

<h3 id="update-the-templates">Update the Templates</h3>

<ol>
  <li>Add error messages to the forms
    <ul>
      <li>Update the components</li>
      <li>Add messages to the templates</li>
    </ul>
  </li>
  <li>Update the <code class="highlighter-rouge">LandingComponent</code></li>
</ol>

<h3 id="add-http-interceptor">Add HTTP Interceptor</h3>

<ol>
  <li>Configure the interceptor</li>
  <li>Handle unauthorized responses</li>
  <li>Add new route</li>
</ol>

<h3 id="route-guard">Route Guard</h3>

<ol>
  <li>Configure the interface</li>
  <li>Protect the route</li>
</ol>

<p>Let’s get to it!</p>

<h2 id="configure-forms-1">Configure Forms</h2>

<h3 id="add-form-to-the-signupcomponent">Add form to the <code class="highlighter-rouge">SignUpComponent</code></h3>

<p>Start with the template:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div class="row"&gt;
  &lt;div class="col-md-4"&gt;
    &lt;h1&gt;Sign up&lt;/h1&gt;
    &lt;hr&gt;&lt;br&gt;
    &lt;form (ngSubmit)="onSubmit()" ngNativeValidate&gt;
      &lt;div class="form-group"&gt;
        &lt;label for="email"&gt;Email&lt;/label&gt;
        &lt;input
          [(ngModel)]="user.email"
          name="email"
          type="email"
          required
          class="form-control"
          id="email"
          placeholder="enter your email"&gt;
      &lt;/div&gt;
      &lt;div class="form-group"&gt;
        &lt;label for="password"&gt;Password&lt;/label&gt;
        &lt;input
          [(ngModel)]="user.password"
          name="password"
          type="password"
          required
          class="form-control"
          id="password"
          placeholder="enter a password"&gt;
      &lt;/div&gt;
      &lt;button type="submit" class="btn btn-primary"&gt;Submit&lt;/button&gt;
      &lt;a [routerLink]="['/']" class="btn btn-success"&gt;Cancel&lt;/a&gt;
    &lt;/form&gt;
    &lt;p&gt;
      &lt;span&gt;Already have an account?&amp;nbsp;&lt;/span&gt;
      &lt;a [routerLink]="['/log-in']"&gt;Log in!&lt;/a&gt;
    &lt;/p&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre></div></div>

<p>Since Angular now automatically adds a <code class="highlighter-rouge">novalidate</code> attribute to forms, we used the <code class="highlighter-rouge">ngNativeValidate</code> <a href="https://github.com/angular/angular/blob/master/packages/forms/src/directives/ng_no_validate_directive.ts">directive</a> to turn the browser’s native form validation back on.</p>

<blockquote>
  <p>Feel free to use Angular’s <a href="https://angular.io/guide/form-validation">form validation</a>.</p>
</blockquote>

<p>Then, wire up the component itself:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">User</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../models/user'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-sign-up'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./sign-up.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./sign-up.component.css'</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">SignUpComponent</span> <span class="kr">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>

  <span class="nl">user</span><span class="p">:</span> <span class="nx">User</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>

  <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="nx">onSubmit</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>Add the <code class="highlighter-rouge">FormsModule</code> to <em>app.module.ts</em>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">BrowserModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/platform-browser'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">NgModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RouterModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">FormsModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/forms'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">AppComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./app.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LandingComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./components/landing/landing.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">SignUpComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./components/sign-up/sign-up.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LogInComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./components/log-in/log-in.component'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">NgModule</span><span class="p">({</span>
  <span class="na">declarations</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">AppComponent</span><span class="p">,</span>
    <span class="nx">LandingComponent</span><span class="p">,</span>
    <span class="nx">SignUpComponent</span><span class="p">,</span>
    <span class="nx">LogInComponent</span>
  <span class="p">],</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">BrowserModule</span><span class="p">,</span>
    <span class="nx">FormsModule</span><span class="p">,</span>
    <span class="nx">RouterModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">([</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'log-in'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">LogInComponent</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'sign-up'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">SignUpComponent</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">LandingComponent</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'**'</span><span class="p">,</span> <span class="na">redirectTo</span><span class="p">:</span> <span class="s1">'/'</span> <span class="p">}</span>
    <span class="p">])</span>
  <span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[],</span>
  <span class="na">bootstrap</span><span class="p">:</span> <span class="p">[</span><span class="nx">AppComponent</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppModule</span> <span class="p">{</span> <span class="p">}</span>
</code></pre></div></div>

<p>Run the application. The app should fail to build, and you should see the following error in the terminal since the <code class="highlighter-rouge">User</code> model does not exist:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ERROR <span class="k">in </span>src/app/components/sign-up/sign-up.component.ts<span class="o">(</span>3,22<span class="o">)</span>: error TS2307:
Cannot find module <span class="s1">'../../models/user'</span><span class="nb">.</span>
</code></pre></div></div>

<p>Kill the server.</p>

<h3 id="define-the-user-model">Define the <code class="highlighter-rouge">User</code> Model</h3>

<p>Moving along, let’s generate a new model class:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ng generate class models/user
</code></pre></div></div>

<p>Then update <em>src/app/models/user.ts</em>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">class</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="nx">id</span><span class="p">?:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">email</span><span class="p">?:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">password</span><span class="p">?:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">token</span><span class="p">?:</span> <span class="nx">string</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Run the server again. The app should compile just fine and the terminal should be error-free. Try submitting the form. You should see the user model logged to the JavaScript Console:</p>

<div style="text-align:left;padding-top:10px;padding-left:10px;">
  <img src="/assets/img/blog/angular-auth-ngrx/signup.png" style="max-width: 70%;border:0;box-shadow:none;" alt="signup component" />
</div>

<h3 id="add-form-to-the-logincomponent">Add form to the <code class="highlighter-rouge">LogInComponent</code></h3>

<p>Again, start with the template:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div class="row"&gt;
  &lt;div class="col-md-4"&gt;
    &lt;h1&gt;Log in&lt;/h1&gt;
    &lt;hr&gt;&lt;br&gt;
    &lt;form (ngSubmit)="onSubmit()" ngNativeValidate&gt;
      &lt;div class="form-group"&gt;
        &lt;label for="email"&gt;Email&lt;/label&gt;
        &lt;input
          [(ngModel)]="user.email"
          name="email"
          type="email"
          required
          class="form-control"
          id="email"
          placeholder="enter your email"&gt;
      &lt;/div&gt;
      &lt;div class="form-group"&gt;
        &lt;label for="password"&gt;Password&lt;/label&gt;
        &lt;input
          [(ngModel)]="user.password"
          name="password"
          type="password"
          required
          class="form-control"
          id="password"
          placeholder="enter a password"&gt;
      &lt;/div&gt;
      &lt;button type="submit" class="btn btn-primary"&gt;Submit&lt;/button&gt;
      &lt;a [routerLink]="['/']" class="btn btn-success"&gt;Cancel&lt;/a&gt;
    &lt;/form&gt;
    &lt;p&gt;
      &lt;span&gt;Don't have an account?&amp;nbsp;&lt;/span&gt;
      &lt;a [routerLink]="['/sign-up']"&gt;Sign up!&lt;/a&gt;
    &lt;/p&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre></div></div>

<p>Then, update the <code class="highlighter-rouge">LogInComponent</code> itself:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">User</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../models/user'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-log-in'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./log-in.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./log-in.component.css'</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogInComponent</span> <span class="kr">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>

  <span class="nl">user</span><span class="p">:</span> <span class="nx">User</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>

  <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="nx">onSubmit</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>Test it out! Like the sign up form, you should see the user model logged to the JavaScript Console.</p>

<p>With that, let’s move on to NGRX!</p>

<h2 id="ngrx-store-1">NGRX Store</h2>

<h3 id="install-ngrx-store">Install NGRX Store</h3>

<p>State management is difficult. As your application scales, state generally scatters across your application, tucked away in various nooks and crannies. Although it’s not an issue yet, it’s a good idea to set a solid foundation to help ensure that, going forward, state management is easier and more predictable. This is where <a href="https://github.com/ngrx/platform/blob/master/docs/effects/README.md">NGRX Store</a> comes into play. It helps to solve this problem by managing state in a single, immutable data store.</p>

<p><a href="https://github.com/ngrx/platform/blob/master/docs/store/README.md">Core tenets</a>:</p>

<ol>
  <li>State is a single immutable data structure</li>
  <li>Actions describe state changes</li>
  <li>Pure functions called reducers take the previous state and the next action to compute the new state</li>
  <li>State accessed with the Store, an observable of state and an observer of actions</li>
</ol>

<p>In a nutshell, NGRX Store builds on Redux’s core patterns by adding in RxJS. It’s specifically designed for Angular apps.</p>

<p>Building blocks:</p>

<ol>
  <li><em>Store</em> - single, immutable data structure</li>
  <li><em>Actions</em> - describe changes to state</li>
  <li><em>Reducers</em> - pure functions that create a new state</li>
</ol>

<p>Example:</p>

<div style="text-align:left;padding-top:10px;padding-left:10px;padding-bottom:20px;">
  <img src="/assets/img/blog/angular-auth-ngrx/angular-ngrx-store-flow.png" style="max-width:90%;border:0;box-shadow:none;" alt="angular ngrx store flow" />
</div>

<p>Install:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm install @ngrx/store@5.2.0 <span class="nt">--save</span>
</code></pre></div></div>

<h3 id="add-files-and-folders-for-the-actions-and-reducers">Add files and folders for the actions and reducers</h3>

<p>Next, we need to add a bit of structure for the actions and reducers. Within “src/app”, add a new folder called “store”. Then, add the following folders to “store”:</p>

<ol>
  <li>“actions”</li>
  <li>“reducers”</li>
</ol>

<p>Add a file called <em>app.states.ts</em> as well. Finally, add a single file to each folder:</p>

<ol>
  <li><em>auth.actions.ts</em></li>
  <li><em>auth.reducers.ts</em></li>
</ol>

<p>You should now have:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>└── store
    ├── actions
    │   └── auth.actions.ts
    ├── app.states.ts
    └── reducers
        └── auth.reducers.ts
</code></pre></div></div>

<blockquote>
  <p>You could also group actions and reducers by domain. Actions and reducers would live at the component level, in other words. If you decide to go that route, you should probably create a “common” folder for actions and reducers that are used across a number of components. Auth actions and reducers should then live in “common”.</p>
</blockquote>

<h3 id="define-the-state">Define the state</h3>

<p>Before creating any actions or reducers, let’s define structure of the store in <em>src/app/store/reducers/auth.reducers.ts</em>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">User</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../models/user'</span><span class="p">;</span>


<span class="k">export</span> <span class="kr">interface</span> <span class="nx">State</span> <span class="p">{</span>
  <span class="c1">// is a user authenticated?</span>
  <span class="nl">isAuthenticated</span><span class="p">:</span> <span class="kr">boolean</span><span class="p">;</span>
  <span class="c1">// if authenticated, there should be a user object</span>
  <span class="nl">user</span><span class="p">:</span> <span class="nx">User</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
  <span class="c1">// error message</span>
  <span class="nl">errorMessage</span><span class="p">:</span> <span class="nx">string</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>Remember: State is a single, immutable data structure.</p>
</blockquote>

<p>Also, add an <code class="highlighter-rouge">initialState</code> object:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">initialState</span><span class="p">:</span> <span class="nx">State</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">isAuthenticated</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="na">user</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="na">errorMessage</span><span class="p">:</span> <span class="kc">null</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Then, define the top-level state interface in <em>src/app/store/app.states.ts</em>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">auth</span> <span class="k">from</span> <span class="s1">'./reducers/auth.reducers'</span><span class="p">;</span>


<span class="k">export</span> <span class="kr">interface</span> <span class="nx">AppState</span> <span class="p">{</span>
  <span class="nl">authState</span><span class="p">:</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">State</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is a map of keys to the inner state types.</p>

<h2 id="configure-auth-service-1">Configure Auth Service</h2>

<h3 id="spin-up-the-fake-back-end-server">Spin up the fake back-end server</h3>

<p>In this section we’ll spin up a fake back-end that the client can communicate with. The app itself is a basic Node/Express application with the following routes:</p>

<table>
  <thead>
    <tr>
      <th>URL</th>
      <th>HTTP Verb</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>http://localhost:1337/ping</td>
      <td>GET</td>
      <td>Sanity Check</td>
    </tr>
    <tr>
      <td>http://localhost:1337/register</td>
      <td>POST</td>
      <td>Register a new user</td>
    </tr>
    <tr>
      <td>http://localhost:1337/login</td>
      <td>POST</td>
      <td>Log a user in</td>
    </tr>
    <tr>
      <td>http://localhost:1337/status</td>
      <td>GET</td>
      <td>Get user status</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>Just keep in mind that the back-end does <strong>not</strong> create a real <a href="https://en.wikipedia.org/wiki/JSON_Web_Token">JSON Web Token</a> (JWT). Feel free to swap it out for a working back-end or use the final application from the <a href="http://mherman.org/blog/2016/10/28/token-based-authentication-with-node">Token-Based Authentication with Node</a> blog post, if you’d like.</p>
</blockquote>

<p>Within a new terminal window, clone down the repo, install the dependencies, and spin up the app:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/testdrivenio/fake-token-api
<span class="nv">$ </span><span class="nb">cd </span>fake-token-api
<span class="nv">$ </span>npm install
<span class="nv">$ </span>npm start
</code></pre></div></div>

<p>In your browser, <a href="http://localhost:1337/ping">http://localhost:1337/ping</a> should return <code class="highlighter-rouge">"pong!"</code>.</p>

<h3 id="add-the-service">Add the service</h3>

<p>Back in Angular land, we need to wire up a service that’s responsible for making API calls to the fake back-end:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ng generate service services/auth
</code></pre></div></div>

<p>Add the service as a provider in the <code class="highlighter-rouge">@NgModule</code> definition and import the <code class="highlighter-rouge">HttpClientModule</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">BrowserModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/platform-browser'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">NgModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RouterModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">FormsModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/forms'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">HttpClientModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/common/http'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">AppComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./app.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LandingComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./components/landing/landing.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">SignUpComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./components/sign-up/sign-up.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LogInComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./components/log-in/log-in.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./services/auth.service'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">NgModule</span><span class="p">({</span>
  <span class="na">declarations</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">AppComponent</span><span class="p">,</span>
    <span class="nx">LandingComponent</span><span class="p">,</span>
    <span class="nx">SignUpComponent</span><span class="p">,</span>
    <span class="nx">LogInComponent</span>
  <span class="p">],</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">BrowserModule</span><span class="p">,</span>
    <span class="nx">FormsModule</span><span class="p">,</span>
    <span class="nx">HttpClientModule</span><span class="p">,</span>
    <span class="nx">RouterModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">([</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'log-in'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">LogInComponent</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'sign-up'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">SignUpComponent</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">LandingComponent</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'**'</span><span class="p">,</span> <span class="na">redirectTo</span><span class="p">:</span> <span class="s1">'/'</span> <span class="p">}</span>
    <span class="p">])</span>
  <span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">AuthService</span><span class="p">],</span>
  <span class="na">bootstrap</span><span class="p">:</span> <span class="p">[</span><span class="nx">AppComponent</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppModule</span> <span class="p">{</span> <span class="p">}</span>
</code></pre></div></div>

<p>Add the following methods to the service:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">HttpClient</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/common/http'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs/Observable'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">User</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../models/user'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AuthService</span> <span class="p">{</span>
  <span class="kr">private</span> <span class="nx">BASE_URL</span> <span class="o">=</span> <span class="s1">'http://localhost:1337'</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">http</span><span class="p">:</span> <span class="nx">HttpClient</span><span class="p">)</span> <span class="p">{}</span>

  <span class="nx">getToken</span><span class="p">():</span> <span class="nx">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">'token'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">logIn</span><span class="p">(</span><span class="nx">email</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">password</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">BASE_URL</span><span class="p">}</span><span class="s2">/login`</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">post</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span><span class="nx">email</span><span class="p">,</span> <span class="nx">password</span><span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">signUp</span><span class="p">(</span><span class="na">email</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="na">password</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">BASE_URL</span><span class="p">}</span><span class="s2">/register`</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">post</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span><span class="nx">email</span><span class="p">,</span> <span class="nx">password</span><span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Both the <code class="highlighter-rouge">logIn</code> and <code class="highlighter-rouge">signUp</code> methods return <code class="highlighter-rouge">Observable</code>s and create new <code class="highlighter-rouge">User</code>s. We’ll need to subscribe to <code class="highlighter-rouge">logIn</code> and <code class="highlighter-rouge">signUp</code>, after a successful form submission, to send the respective HTTP requests within the effects module.</p>

<h2 id="ngrx-effects-1">NGRX Effects</h2>

<h3 id="install-ngrx-effects">Install NGRX Effects</h3>

<p><a href="https://github.com/ngrx/platform/blob/master/docs/effects/README.md">NGRX Effects</a> listen for actions dispatched from the NGRX Store, perform some logic (e.g., a side effect), and then dispatch a new action.</p>

<div style="text-align:left;padding-top:10px;padding-left:10px;padding-bottom:20px;">
  <img src="/assets/img/blog/angular-auth-ngrx/angular-ngrx-store-effects-flow.png" style="max-width:90%;border:0;box-shadow:none;" alt="angular ngrx store + effects flow" />
</div>

<p>Install:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm install @ngrx/effects@5.2.0 <span class="nt">--save</span>
</code></pre></div></div>

<h3 id="add-effects-file">Add effects file</h3>

<p>Then, within the “store” folder, add a new folder called “effects”. And, within that folder, add a new file called <em>auth.effects.ts</em>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Action</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Router</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Actions</span><span class="p">,</span> <span class="nx">Effect</span><span class="p">,</span> <span class="nx">ofType</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/effects'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs/Observable'</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">'rxjs/add/observable/of'</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">'rxjs/add/operator/map'</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">'rxjs/add/operator/switchMap'</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">'rxjs/add/operator/catch'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">tap</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs/operators'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">AuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../services/auth.service'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AuthEffects</span> <span class="p">{</span>

  <span class="kd">constructor</span><span class="p">(</span>
    <span class="kr">private</span> <span class="nx">actions</span><span class="p">:</span> <span class="nx">Actions</span><span class="p">,</span>
    <span class="kr">private</span> <span class="nx">authService</span><span class="p">:</span> <span class="nx">AuthService</span><span class="p">,</span>
    <span class="kr">private</span> <span class="nx">router</span><span class="p">:</span> <span class="nx">Router</span><span class="p">,</span>
  <span class="p">)</span> <span class="p">{}</span>

  <span class="c1">// effects go here</span>

<span class="p">}</span>
</code></pre></div></div>

<p>Then, register the effects module in <code class="highlighter-rouge">@NgModule</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">BrowserModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/platform-browser'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">NgModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RouterModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">FormsModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/forms'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">HttpClientModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/common/http'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">EffectsModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/effects'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">AppComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./app.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LandingComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./components/landing/landing.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">SignUpComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./components/sign-up/sign-up.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LogInComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./components/log-in/log-in.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./services/auth.service'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AuthEffects</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./store/effects/auth.effects'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">NgModule</span><span class="p">({</span>
  <span class="na">declarations</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">AppComponent</span><span class="p">,</span>
    <span class="nx">LandingComponent</span><span class="p">,</span>
    <span class="nx">SignUpComponent</span><span class="p">,</span>
    <span class="nx">LogInComponent</span>
  <span class="p">],</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">BrowserModule</span><span class="p">,</span>
    <span class="nx">FormsModule</span><span class="p">,</span>
    <span class="nx">HttpClientModule</span><span class="p">,</span>
    <span class="nx">EffectsModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">([</span><span class="nx">AuthEffects</span><span class="p">]),</span>
    <span class="nx">RouterModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">([</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'log-in'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">LogInComponent</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'sign-up'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">SignUpComponent</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">LandingComponent</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'**'</span><span class="p">,</span> <span class="na">redirectTo</span><span class="p">:</span> <span class="s1">'/'</span> <span class="p">}</span>
    <span class="p">])</span>
  <span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">AuthService</span><span class="p">],</span>
  <span class="na">bootstrap</span><span class="p">:</span> <span class="p">[</span><span class="nx">AppComponent</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppModule</span> <span class="p">{</span> <span class="p">}</span>
</code></pre></div></div>

<h2 id="configure-login-1">Configure Login</h2>

<h3 id="login">Login</h3>

<h4 id="dispatch-login-action">Dispatch <code class="highlighter-rouge">LogIn</code> action</h4>

<p>First, after a successful form submission, we need to dispatch a <code class="highlighter-rouge">LogIn</code> action, which will send an action and a parameter to a reducer to eventually create a new state.</p>

<p><em>src/app/components/log-in/log-in.component.ts</em>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Store</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">User</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../models/user'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AppState</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../store/app.states'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LogIn</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../store/actions/auth.actions'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-log-in'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./log-in.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./log-in.component.css'</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogInComponent</span> <span class="kr">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>

  <span class="nl">user</span><span class="p">:</span> <span class="nx">User</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>

  <span class="kd">constructor</span><span class="p">(</span>
    <span class="kr">private</span> <span class="nx">store</span><span class="p">:</span> <span class="nx">Store</span><span class="o">&lt;</span><span class="nx">AppState</span><span class="o">&gt;</span>
  <span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="nx">onSubmit</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">email</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">LogIn</span><span class="p">(</span><span class="nx">payload</span><span class="p">));</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>With the Angular server running, you should see the following error since we still need to set up the module for the actions along with the <code class="highlighter-rouge">LogIn</code> action:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ERROR <span class="k">in </span>src/app/components/log-in/log-in.component.ts<span class="o">(</span>6,23<span class="o">)</span>: error TS2306:
File <span class="s1">'angular-auth-ngrx/src/app/store/actions/auth.actions.ts'</span> is not a module.
</code></pre></div></div>

<h4 id="add-action">Add action</h4>

<p>Actions describe changes to state. They are dispatched to a reducer, which will then create a new state.</p>

<p>Update <em>src/app/store/user.actions.ts</em> like so:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Action</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>


<span class="k">export</span> <span class="kr">enum</span> <span class="nx">AuthActionTypes</span> <span class="p">{</span>
  <span class="nx">LOGIN</span> <span class="o">=</span> <span class="s1">'[Auth] Login'</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Add the action class as well:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">class</span> <span class="nx">LogIn</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="nx">type</span> <span class="nx">All</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nx">LogIn</span><span class="p">;</span>
</code></pre></div></div>

<p>You should now have:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Action</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>


<span class="k">export</span> <span class="kr">enum</span> <span class="nx">AuthActionTypes</span> <span class="p">{</span>
  <span class="nx">LOGIN</span> <span class="o">=</span> <span class="s1">'[Auth] Login'</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogIn</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="nx">type</span> <span class="nx">All</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nx">LogIn</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="add-effect-to-dispatch-either-loginsuccess-or-loginfailure">Add effect (to dispatch either <code class="highlighter-rouge">LogInSuccess</code> or <code class="highlighter-rouge">LogInFailure</code>)</h4>

<p>Add the first effect to <em>src/app/store/effects/auth.effects.ts</em></p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Effect</span><span class="p">()</span>
<span class="nx">LogIn</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">actions</span>
  <span class="p">.</span><span class="nx">ofType</span><span class="p">(</span><span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">action</span><span class="p">:</span> <span class="nx">LogIn</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">action</span><span class="p">.</span><span class="nx">payload</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">switchMap</span><span class="p">(</span><span class="nx">payload</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">authService</span><span class="p">.</span><span class="nx">logIn</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">LogInSuccess</span><span class="p">({</span><span class="na">token</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">token</span><span class="p">,</span> <span class="na">email</span><span class="p">:</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">email</span><span class="p">});</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">Observable</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="k">new</span> <span class="nx">LogInFailure</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="nx">error</span> <span class="p">}));</span>
      <span class="p">});</span>
  <span class="p">});</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">ofType</code> operator filters the action by a type. It accepts multiple action types, so one effect can handle a number of actions. Then, with <code class="highlighter-rouge">map</code>, we “map” the action to its payload. This, essentially, returns an observable with <em>just</em> the payload. The <code class="highlighter-rouge">switchMap</code> is used to switch <em>back</em> to the response observable but still use the payload as an argument in the <code class="highlighter-rouge">switchMap</code> function.</p>

<p>Add the import:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span>
  <span class="nx">AuthActionTypes</span><span class="p">,</span>
  <span class="nx">LogIn</span><span class="p">,</span> <span class="nx">LogInSuccess</span><span class="p">,</span> <span class="nx">LogInFailure</span><span class="p">,</span>
<span class="p">}</span> <span class="k">from</span> <span class="s1">'../actions/auth.actions'</span><span class="p">;</span>
</code></pre></div></div>

<p>For AJAX requests, it’s a good practice to also dispatch a success or error action based on the result of the request.</p>

<h3 id="login-success">Login Success</h3>

<h4 id="add-action-1">Add action</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Action</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>


<span class="k">export</span> <span class="kr">enum</span> <span class="nx">AuthActionTypes</span> <span class="p">{</span>
  <span class="nx">LOGIN</span> <span class="o">=</span> <span class="s1">'[Auth] Login'</span><span class="p">,</span>
  <span class="nx">LOGIN_SUCCESS</span> <span class="o">=</span> <span class="s1">'[Auth] Login Success'</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogIn</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogInSuccess</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN_SUCCESS</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="nx">type</span> <span class="nx">All</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nx">LogIn</span>
  <span class="o">|</span> <span class="nx">LogInSuccess</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="add-reducer-to-create-new-state">Add reducer (to create new state)</h4>

<p>Reducers are pure functions that create a new state.</p>

<p>When the log in is successful, we need to set <code class="highlighter-rouge">isAuthenticated</code> to <code class="highlighter-rouge">true</code> and add the token and email to the <code class="highlighter-rouge">user</code> object.</p>

<p>Update <em>src/app/store/reducers/auth.reducers.ts</em>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">function</span> <span class="nx">reducer</span><span class="p">(</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">initialState</span><span class="p">,</span> <span class="nx">action</span><span class="p">:</span> <span class="nx">All</span><span class="p">):</span> <span class="nx">State</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN_SUCCESS</span><span class="p">:</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="p">...</span><span class="nx">state</span><span class="p">,</span>
        <span class="na">isAuthenticated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">user</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">token</span><span class="p">:</span> <span class="nx">action</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">token</span><span class="p">,</span>
          <span class="na">email</span><span class="p">:</span> <span class="nx">action</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">email</span>
        <span class="p">},</span>
        <span class="na">errorMessage</span><span class="p">:</span> <span class="kc">null</span>
      <span class="p">};</span>
    <span class="p">}</span>
    <span class="nl">default</span><span class="p">:</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Add the import:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">AuthActionTypes</span><span class="p">,</span> <span class="nx">All</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../actions/auth.actions'</span><span class="p">;</span>
</code></pre></div></div>

<p>Import the reducers into the Angular module:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">BrowserModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/platform-browser'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">NgModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RouterModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">FormsModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/forms'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">HttpClientModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/common/http'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">EffectsModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/effects'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">StoreModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">AppComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./app.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LandingComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./components/landing/landing.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">SignUpComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./components/sign-up/sign-up.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LogInComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./components/log-in/log-in.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./services/auth.service'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AuthEffects</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./store/effects/auth.effects'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">reducers</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./store/app.states'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">NgModule</span><span class="p">({</span>
  <span class="na">declarations</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">AppComponent</span><span class="p">,</span>
    <span class="nx">LandingComponent</span><span class="p">,</span>
    <span class="nx">SignUpComponent</span><span class="p">,</span>
    <span class="nx">LogInComponent</span>
  <span class="p">],</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">BrowserModule</span><span class="p">,</span>
    <span class="nx">FormsModule</span><span class="p">,</span>
    <span class="nx">HttpClientModule</span><span class="p">,</span>
    <span class="nx">StoreModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">(</span><span class="nx">reducers</span><span class="p">,</span> <span class="p">{}),</span>
    <span class="nx">EffectsModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">([</span><span class="nx">AuthEffects</span><span class="p">]),</span>
    <span class="nx">RouterModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">([</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'log-in'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">LogInComponent</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'sign-up'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">SignUpComponent</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">LandingComponent</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'**'</span><span class="p">,</span> <span class="na">redirectTo</span><span class="p">:</span> <span class="s1">'/'</span> <span class="p">}</span>
    <span class="p">])</span>
  <span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">AuthService</span><span class="p">],</span>
  <span class="na">bootstrap</span><span class="p">:</span> <span class="p">[</span><span class="nx">AppComponent</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppModule</span> <span class="p">{</span> <span class="p">}</span>
</code></pre></div></div>

<p>Then, update <em>app.states.ts</em>, adding in the reducers:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">auth</span> <span class="k">from</span> <span class="s1">'./reducers/auth.reducers'</span><span class="p">;</span>


<span class="k">export</span> <span class="kr">interface</span> <span class="nx">AppState</span> <span class="p">{</span>
  <span class="nl">authState</span><span class="p">:</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">State</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">reducers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">auth</span><span class="p">:</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">reducer</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="add-effect-to-add-token-to-localstorage-and-redirect-user">Add effect (to add token to localStorage and redirect user)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Effect</span><span class="p">({</span> <span class="na">dispatch</span><span class="p">:</span> <span class="kc">false</span> <span class="p">})</span>
<span class="nx">LogInSuccess</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
  <span class="nx">ofType</span><span class="p">(</span><span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN_SUCCESS</span><span class="p">),</span>
  <span class="nx">tap</span><span class="p">((</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">'token'</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">token</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">navigateByUrl</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
  <span class="p">})</span>
<span class="p">);</span>
</code></pre></div></div>

<p>Version 5.5 of RXJS introduced the <code class="highlighter-rouge">pipe</code> <a href="https://github.com/ReactiveX/rxjs/blob/master/doc/pipeable-operators.md">method</a>, which is used to compose a number of functions to act on the observable.  Again, <code class="highlighter-rouge">ofType</code> associates the effect with an action while <code class="highlighter-rouge">tap</code> performs a side effect transparently. In other words, it returns an observable identical to the source. In our case, we’re adding the token to localStorage and then redirecting the user to <code class="highlighter-rouge">/</code>.</p>

<blockquote>
  <p>Check out the comments for <a href="https://github.com/ReactiveX/rxjs/blob/5.5.5/src/Observable.ts#L305">pipe</a> and <a href="https://github.com/ReactiveX/rxjs/blob/5.5.5/src/operators/tap.ts#L14">tap</a>, respectively, from the source code.</p>
</blockquote>

<h3 id="login-failure">Login Failure</h3>

<h4 id="add-action-2">Add action</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Action</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>


<span class="k">export</span> <span class="kr">enum</span> <span class="nx">AuthActionTypes</span> <span class="p">{</span>
  <span class="nx">LOGIN</span> <span class="o">=</span> <span class="s1">'[Auth] Login'</span><span class="p">,</span>
  <span class="nx">LOGIN_SUCCESS</span> <span class="o">=</span> <span class="s1">'[Auth] Login Success'</span><span class="p">,</span>
  <span class="nx">LOGIN_FAILURE</span> <span class="o">=</span> <span class="s1">'[Auth] Login Failure'</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogIn</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogInSuccess</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN_SUCCESS</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogInFailure</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN_FAILURE</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="nx">type</span> <span class="nx">All</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nx">LogIn</span>
  <span class="o">|</span> <span class="nx">LogInSuccess</span>
  <span class="o">|</span> <span class="nx">LogInFailure</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="add-reducer-to-create-new-state-1">Add reducer (to create new state)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN_FAILURE</span><span class="p">:</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="p">...</span><span class="nx">state</span><span class="p">,</span>
    <span class="na">errorMessage</span><span class="p">:</span> <span class="s1">'Incorrect email and/or password.'</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="add-effect">Add effect</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Effect</span><span class="p">({</span> <span class="na">dispatch</span><span class="p">:</span> <span class="kc">false</span> <span class="p">})</span>
<span class="nx">LogInFailure</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
  <span class="nx">ofType</span><span class="p">(</span><span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN_FAILURE</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<p>Try it out. Make sure the token is added to localStorage and you are redirected after a successful log in:</p>

<ul>
  <li><em>email</em>: <code class="highlighter-rouge">test@test.com</code></li>
  <li><em>password</em>: <code class="highlighter-rouge">test</code></li>
</ul>

<div style="text-align:left;padding-top:10px;padding-left:10px;padding-bottom:20px">
  <img src="/assets/img/blog/angular-auth-ngrx/angular-ngrx-login.gif" style="max-width: 70%;border:0;box-shadow:none;" alt="log in" />
</div>

<p>The fake back-end will throw a <code class="highlighter-rouge">400</code> error if you use any email other than <code class="highlighter-rouge">test@test.com</code>. As of now, nothing happens on the UI, though. We’ll wire up error messaging shorty.</p>

<blockquote>
  <p>Looking for a quick challenge? Refactor the <code class="highlighter-rouge">LogIn</code> effect to use the <code class="highlighter-rouge">pipe</code> method. Clean up the code!</p>
</blockquote>

<h2 id="configure-signup-1">Configure Signup</h2>

<p>Your turn! Configuring the sign up functionality is nearly the same as the log in functionality. Try it on your own before reviewing the post.</p>

<h3 id="signup">Signup</h3>

<h4 id="dispatch-signup-action">Dispatch <code class="highlighter-rouge">SignUp</code> action</h4>

<p><em>src/app/components/sign-up/sign-up.component.ts</em>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Store</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">User</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../models/user'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AppState</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../store/app.states'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">SignUp</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../store/actions/auth.actions'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-sign-up'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./sign-up.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./sign-up.component.css'</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">SignUpComponent</span> <span class="kr">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>

  <span class="nl">user</span><span class="p">:</span> <span class="nx">User</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>

  <span class="kd">constructor</span><span class="p">(</span>
    <span class="kr">private</span> <span class="nx">store</span><span class="p">:</span> <span class="nx">Store</span><span class="o">&lt;</span><span class="nx">AppState</span><span class="o">&gt;</span>
  <span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="nx">onSubmit</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">email</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">SignUp</span><span class="p">(</span><span class="nx">payload</span><span class="p">));</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<h4 id="add-action-3">Add action</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Action</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>


<span class="k">export</span> <span class="kr">enum</span> <span class="nx">AuthActionTypes</span> <span class="p">{</span>
  <span class="nx">LOGIN</span> <span class="o">=</span> <span class="s1">'[Auth] Login'</span><span class="p">,</span>
  <span class="nx">LOGIN_SUCCESS</span> <span class="o">=</span> <span class="s1">'[Auth] Login Success'</span><span class="p">,</span>
  <span class="nx">LOGIN_FAILURE</span> <span class="o">=</span> <span class="s1">'[Auth] Login Failure'</span><span class="p">,</span>
  <span class="nx">SIGNUP</span> <span class="o">=</span> <span class="s1">'[Auth] Signup'</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogIn</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogInSuccess</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN_SUCCESS</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogInFailure</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN_FAILURE</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">SignUp</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">SIGNUP</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="nx">type</span> <span class="nx">All</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nx">LogIn</span>
  <span class="o">|</span> <span class="nx">LogInSuccess</span>
  <span class="o">|</span> <span class="nx">LogInFailure</span>
  <span class="o">|</span> <span class="nx">SignUp</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="add-effect-to-dispatch-either-signupsuccess-or-signupfailure">Add effect (to dispatch either <code class="highlighter-rouge">SignUpSuccess</code> or <code class="highlighter-rouge">SignUpFailure</code>)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Effect</span><span class="p">()</span>
<span class="nx">SignUp</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">actions</span>
  <span class="p">.</span><span class="nx">ofType</span><span class="p">(</span><span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">SIGNUP</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">action</span><span class="p">:</span> <span class="nx">SignUp</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">action</span><span class="p">.</span><span class="nx">payload</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">switchMap</span><span class="p">(</span><span class="nx">payload</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">authService</span><span class="p">.</span><span class="nx">signUp</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">SignUpSuccess</span><span class="p">({</span><span class="na">token</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">token</span><span class="p">,</span> <span class="na">email</span><span class="p">:</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">email</span><span class="p">});</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">Observable</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="k">new</span> <span class="nx">SignUpFailure</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="nx">error</span> <span class="p">}));</span>
      <span class="p">});</span>
  <span class="p">});</span>
</code></pre></div></div>

<p>Add the import:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span>
  <span class="nx">AuthActionTypes</span><span class="p">,</span>
  <span class="nx">LogIn</span><span class="p">,</span> <span class="nx">LogInSuccess</span><span class="p">,</span> <span class="nx">LogInFailure</span><span class="p">,</span>
  <span class="nx">SignUp</span><span class="p">,</span> <span class="nx">SignUpSuccess</span><span class="p">,</span> <span class="nx">SignUpFailure</span>
<span class="p">}</span> <span class="k">from</span> <span class="s1">'../actions/auth.actions'</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="signup-success">Signup Success</h3>

<h4 id="add-action-4">Add action</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Action</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>


<span class="k">export</span> <span class="kr">enum</span> <span class="nx">AuthActionTypes</span> <span class="p">{</span>
  <span class="nx">LOGIN</span> <span class="o">=</span> <span class="s1">'[Auth] Login'</span><span class="p">,</span>
  <span class="nx">LOGIN_SUCCESS</span> <span class="o">=</span> <span class="s1">'[Auth] Login Success'</span><span class="p">,</span>
  <span class="nx">LOGIN_FAILURE</span> <span class="o">=</span> <span class="s1">'[Auth] Login Failure'</span><span class="p">,</span>
  <span class="nx">SIGNUP</span> <span class="o">=</span> <span class="s1">'[Auth] Signup'</span><span class="p">,</span>
  <span class="nx">SIGNUP_SUCCESS</span> <span class="o">=</span> <span class="s1">'[Auth] Signup Success'</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogIn</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogInSuccess</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN_SUCCESS</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogInFailure</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN_FAILURE</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">SignUp</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">SIGNUP</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">SignUpSuccess</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">SIGNUP_SUCCESS</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="nx">type</span> <span class="nx">All</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nx">LogIn</span>
  <span class="o">|</span> <span class="nx">LogInSuccess</span>
  <span class="o">|</span> <span class="nx">LogInFailure</span>
  <span class="o">|</span> <span class="nx">SignUp</span>
  <span class="o">|</span> <span class="nx">SignUpSuccess</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="add-reducer-to-create-new-state-2">Add reducer (to create new state)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">SIGNUP_SUCCESS</span><span class="p">:</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="p">...</span><span class="nx">state</span><span class="p">,</span>
    <span class="na">isAuthenticated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">user</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">token</span><span class="p">:</span> <span class="nx">action</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">token</span><span class="p">,</span>
      <span class="na">email</span><span class="p">:</span> <span class="nx">action</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">email</span>
    <span class="p">},</span>
    <span class="na">errorMessage</span><span class="p">:</span> <span class="kc">null</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="add-effect-to-add-token-to-localstorage-and-redirect-user-1">Add effect (to add token to localStorage and redirect user)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Effect</span><span class="p">({</span> <span class="na">dispatch</span><span class="p">:</span> <span class="kc">false</span> <span class="p">})</span>
<span class="nx">SignUpSuccess</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
  <span class="nx">ofType</span><span class="p">(</span><span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">SIGNUP_SUCCESS</span><span class="p">),</span>
  <span class="nx">tap</span><span class="p">((</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">'token'</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">token</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">navigateByUrl</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
  <span class="p">})</span>
<span class="p">);</span>
</code></pre></div></div>

<h3 id="signup-failure">Signup Failure</h3>

<p>Again, try this on your own!</p>

<h4 id="add-action-5">Add action</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Action</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>


<span class="k">export</span> <span class="kr">enum</span> <span class="nx">AuthActionTypes</span> <span class="p">{</span>
  <span class="nx">LOGIN</span> <span class="o">=</span> <span class="s1">'[Auth] Login'</span><span class="p">,</span>
  <span class="nx">LOGIN_SUCCESS</span> <span class="o">=</span> <span class="s1">'[Auth] Login Success'</span><span class="p">,</span>
  <span class="nx">LOGIN_FAILURE</span> <span class="o">=</span> <span class="s1">'[Auth] Login Failure'</span><span class="p">,</span>
  <span class="nx">SIGNUP</span> <span class="o">=</span> <span class="s1">'[Auth] Signup'</span><span class="p">,</span>
  <span class="nx">SIGNUP_SUCCESS</span> <span class="o">=</span> <span class="s1">'[Auth] Signup Success'</span><span class="p">,</span>
  <span class="nx">SIGNUP_FAILURE</span> <span class="o">=</span> <span class="s1">'[Auth] Signup Failure'</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogIn</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogInSuccess</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN_SUCCESS</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogInFailure</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN_FAILURE</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">SignUp</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">SIGNUP</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">SignUpSuccess</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">SIGNUP_SUCCESS</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">SignUpFailure</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">SIGNUP_FAILURE</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="nx">type</span> <span class="nx">All</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nx">LogIn</span>
  <span class="o">|</span> <span class="nx">LogInSuccess</span>
  <span class="o">|</span> <span class="nx">LogInFailure</span>
  <span class="o">|</span> <span class="nx">SignUp</span>
  <span class="o">|</span> <span class="nx">SignUpSuccess</span>
  <span class="o">|</span> <span class="nx">SignUpFailure</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="add-reducer-to-create-new-state-3">Add reducer (to create new state)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">SIGNUP_FAILURE</span><span class="p">:</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="p">...</span><span class="nx">state</span><span class="p">,</span>
    <span class="na">errorMessage</span><span class="p">:</span> <span class="s1">'That email is already in use.'</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="add-effect-1">Add effect</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Effect</span><span class="p">({</span> <span class="na">dispatch</span><span class="p">:</span> <span class="kc">false</span> <span class="p">})</span>
<span class="nx">SignUpFailure</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
  <span class="nx">ofType</span><span class="p">(</span><span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">SIGNUP_FAILURE</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<blockquote>
  <p>You could combine <code class="highlighter-rouge">SignUpFailure</code> and <code class="highlighter-rouge">LogInFailure</code>, to make a single effect:</p>

  <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">AuthFailure</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
    <span class="nx">ofType</span><span class="p">(</span><span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">SIGNUP_FAILURE</span><span class="p">,</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN_FAILURE</span><span class="p">)</span>
  <span class="p">);</span>
</code></pre></div>  </div>

</blockquote>

<p>We’re now ready to test!</p>

<p>With the fake back-end running, try signing up with the following credentials:</p>

<ul>
  <li><em>email</em>: <code class="highlighter-rouge">test@test.com</code></li>
  <li><em>password</em>: <code class="highlighter-rouge">test</code></li>
</ul>

<p>Make sure that you are redirected after a successful attempt and that a token was added to localStorage. Also, ensure that nothing happens on an unsuccessful attempt (when you use an email other than <code class="highlighter-rouge">test@test.com</code>). We still need to wire up the handling of the error to the template.</p>

<h2 id="configure-logout-1">Configure Logout</h2>

<h3 id="logout">Logout</h3>

<h4 id="dispatch-logout-action">Dispatch <code class="highlighter-rouge">LogOut</code> action</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Store</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">AppState</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../store/app.states'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LogOut</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../store/actions/auth.actions'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-landing'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./landing.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./landing.component.css'</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">LandingComponent</span> <span class="kr">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>

  <span class="kd">constructor</span><span class="p">(</span>
    <span class="kr">private</span> <span class="nx">store</span><span class="p">:</span> <span class="nx">Store</span><span class="o">&lt;</span><span class="nx">AppState</span><span class="o">&gt;</span>
  <span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="nx">logOut</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">LogOut</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<h4 id="add-action-6">Add action</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Action</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>


<span class="k">export</span> <span class="kr">enum</span> <span class="nx">AuthActionTypes</span> <span class="p">{</span>
  <span class="nx">LOGIN</span> <span class="o">=</span> <span class="s1">'[Auth] Login'</span><span class="p">,</span>
  <span class="nx">LOGIN_SUCCESS</span> <span class="o">=</span> <span class="s1">'[Auth] Login Success'</span><span class="p">,</span>
  <span class="nx">LOGIN_FAILURE</span> <span class="o">=</span> <span class="s1">'[Auth] Login Failure'</span><span class="p">,</span>
  <span class="nx">SIGNUP</span> <span class="o">=</span> <span class="s1">'[Auth] Signup'</span><span class="p">,</span>
  <span class="nx">SIGNUP_SUCCESS</span> <span class="o">=</span> <span class="s1">'[Auth] Signup Success'</span><span class="p">,</span>
  <span class="nx">SIGNUP_FAILURE</span> <span class="o">=</span> <span class="s1">'[Auth] Signup Failure'</span><span class="p">,</span>
  <span class="nx">LOGOUT</span> <span class="o">=</span> <span class="s1">'[Auth] Logout'</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogIn</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogInSuccess</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN_SUCCESS</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogInFailure</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN_FAILURE</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">SignUp</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">SIGNUP</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">SignUpSuccess</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">SIGNUP_SUCCESS</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">SignUpFailure</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">SIGNUP_FAILURE</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogOut</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="nx">type</span> <span class="nx">All</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nx">LogIn</span>
  <span class="o">|</span> <span class="nx">LogInSuccess</span>
  <span class="o">|</span> <span class="nx">LogInFailure</span>
  <span class="o">|</span> <span class="nx">SignUp</span>
  <span class="o">|</span> <span class="nx">SignUpSuccess</span>
  <span class="o">|</span> <span class="nx">SignUpFailure</span>
  <span class="o">|</span> <span class="nx">LogOut</span><span class="p">;</span>
</code></pre></div></div>

<p>Did you notice we’re not sending any parameters with the dispatch? Because of that, we left off the payload in the constructor.</p>

<h4 id="add-reducer-to-create-new-state-4">Add reducer (to create new state)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGOUT</span><span class="p">:</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">initialState</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="add-effect-to-remove-token-from-localstorage">Add effect (to remove token from localStorage)</h4>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Effect</span><span class="p">({</span> <span class="na">dispatch</span><span class="p">:</span> <span class="kc">false</span> <span class="p">})</span>
<span class="kr">public</span> <span class="nx">LogOut</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
  <span class="nx">ofType</span><span class="p">(</span><span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGOUT</span><span class="p">),</span>
  <span class="nx">tap</span><span class="p">((</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s1">'token'</span><span class="p">);</span>
  <span class="p">})</span>
<span class="p">);</span>
</code></pre></div></div>

<p>Import:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span>
  <span class="nx">AuthActionTypes</span><span class="p">,</span>
  <span class="nx">LogIn</span><span class="p">,</span> <span class="nx">LogInSuccess</span><span class="p">,</span> <span class="nx">LogInFailure</span><span class="p">,</span>
  <span class="nx">SignUp</span><span class="p">,</span> <span class="nx">SignUpSuccess</span><span class="p">,</span> <span class="nx">SignUpFailure</span><span class="p">,</span>
  <span class="nx">LogOut</span><span class="p">,</span>
<span class="p">}</span> <span class="k">from</span> <span class="s1">'../actions/auth.actions'</span><span class="p">;</span>
</code></pre></div></div>

<p>We’ll test this functionality out shortly.</p>

<h2 id="update-the-templates-1">Update the Templates</h2>

<h3 id="add-error-messages-to-the-forms">Add error messages to the forms</h3>

<h4 id="update-the-components">Update the components</h4>

<p><code class="highlighter-rouge">LogInComponent</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Store</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs/Observable'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">User</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../models/user'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AppState</span><span class="p">,</span> <span class="nx">selectAuthState</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../store/app.states'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LogIn</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../store/actions/auth.actions'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-log-in'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./log-in.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./log-in.component.css'</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogInComponent</span> <span class="kr">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>

  <span class="nl">user</span><span class="p">:</span> <span class="nx">User</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
  <span class="nl">getState</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nl">errorMessage</span><span class="p">:</span> <span class="nx">string</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span>
    <span class="kr">private</span> <span class="nx">store</span><span class="p">:</span> <span class="nx">Store</span><span class="o">&lt;</span><span class="nx">AppState</span><span class="o">&gt;</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">getState</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">selectAuthState</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">getState</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">((</span><span class="nx">state</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">errorMessage</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">errorMessage</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">onSubmit</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">email</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">LogIn</span><span class="p">(</span><span class="nx">payload</span><span class="p">));</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>Here, we’re subscribing to the store and assigning the <code class="highlighter-rouge">errorMessage</code> to <code class="highlighter-rouge">this.errorMessage</code>, which we can reference in our template.</p>

<p>Update <em>app.states.ts</em>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">createFeatureSelector</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>

<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">auth</span> <span class="k">from</span> <span class="s1">'./reducers/auth.reducers'</span><span class="p">;</span>


<span class="k">export</span> <span class="kr">interface</span> <span class="nx">AppState</span> <span class="p">{</span>
  <span class="nl">authState</span><span class="p">:</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">State</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">reducers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">auth</span><span class="p">:</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">reducer</span>
<span class="p">};</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">selectAuthState</span> <span class="o">=</span> <span class="nx">createFeatureSelector</span><span class="o">&lt;</span><span class="nx">AppState</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">'auth'</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">createFeatureSelector</code> is a <a href="https://github.com/ngrx/platform/blob/master/docs/store/selectors.md">selector</a> used to query the state.</p>

<p><code class="highlighter-rouge">SignUpComponent</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Store</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs/Observable'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">User</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../models/user'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AppState</span><span class="p">,</span> <span class="nx">selectAuthState</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../store/app.states'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">SignUp</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../store/actions/auth.actions'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-sign-up'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./sign-up.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./sign-up.component.css'</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">SignUpComponent</span> <span class="kr">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>

  <span class="nl">user</span><span class="p">:</span> <span class="nx">User</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
  <span class="nl">getState</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nl">errorMessage</span><span class="p">:</span> <span class="nx">string</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span>
    <span class="kr">private</span> <span class="nx">store</span><span class="p">:</span> <span class="nx">Store</span><span class="o">&lt;</span><span class="nx">AppState</span><span class="o">&gt;</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">getState</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">selectAuthState</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">getState</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">((</span><span class="nx">state</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">errorMessage</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">errorMessage</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">onSubmit</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">email</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">SignUp</span><span class="p">(</span><span class="nx">payload</span><span class="p">));</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<h4 id="add-messages-to-the-templates">Add messages to the templates</h4>

<p>Login:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div class="row"&gt;
  &lt;div class="col-md-4"&gt;
    &lt;h1&gt;Log in&lt;/h1&gt;
    &lt;hr&gt;&lt;br&gt;
    &lt;div *ngIf="errorMessage"&gt;
      &lt;div class="alert alert-danger" role="alert"&gt;
        {{errorMessage}}
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;form (ngSubmit)="onSubmit()" ngNativeValidate&gt;
      &lt;div class="form-group"&gt;
        &lt;label for="email"&gt;Email&lt;/label&gt;
        &lt;input
          [(ngModel)]="user.email"
          name="email"
          type="email"
          required
          class="form-control"
          id="email"
          placeholder="enter your email"&gt;
      &lt;/div&gt;
      &lt;div class="form-group"&gt;
        &lt;label for="password"&gt;Password&lt;/label&gt;
        &lt;input
          [(ngModel)]="user.password"
          name="password"
          type="password"
          required
          class="form-control"
          id="password"
          placeholder="enter a password"&gt;
      &lt;/div&gt;
      &lt;button type="submit" class="btn btn-primary"&gt;Submit&lt;/button&gt;
      &lt;a [routerLink]="['/']" class="btn btn-success"&gt;Cancel&lt;/a&gt;
    &lt;/form&gt;
    &lt;p&gt;
      &lt;span&gt;Don't have an account?&amp;nbsp;&lt;/span&gt;
      &lt;a [routerLink]="['/sign-up']"&gt;Sign up!&lt;/a&gt;
    &lt;/p&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre></div></div>

<p>Signup:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div class="row"&gt;
  &lt;div class="col-md-4"&gt;
    &lt;h1&gt;Sign up&lt;/h1&gt;
    &lt;hr&gt;&lt;br&gt;
    &lt;div *ngIf="errorMessage"&gt;
      &lt;div class="alert alert-danger" role="alert"&gt;
        {{errorMessage}}
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;form (ngSubmit)="onSubmit()" ngNativeValidate&gt;
      &lt;div class="form-group"&gt;
        &lt;label for="email"&gt;Email&lt;/label&gt;
        &lt;input
          [(ngModel)]="user.email"
          name="email"
          type="email"
          required
          class="form-control"
          id="email"
          placeholder="enter your email"&gt;
      &lt;/div&gt;
      &lt;div class="form-group"&gt;
        &lt;label for="password"&gt;Password&lt;/label&gt;
        &lt;input
          [(ngModel)]="user.password"
          name="password"
          type="password"
          required
          class="form-control"
          id="password"
          placeholder="enter a password"&gt;
      &lt;/div&gt;
      &lt;button type="submit" class="btn btn-primary"&gt;Submit&lt;/button&gt;
      &lt;a [routerLink]="['/']" class="btn btn-success"&gt;Cancel&lt;/a&gt;
    &lt;/form&gt;
    &lt;p&gt;
      &lt;span&gt;Already have an account?&amp;nbsp;&lt;/span&gt;
      &lt;a [routerLink]="['/log-in']"&gt;Log in!&lt;/a&gt;
    &lt;/p&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre></div></div>

<p>Test this out!</p>

<div style="text-align:left;padding-top:10px;padding-left:10px;padding-bottom:20px">
  <img src="/assets/img/blog/angular-auth-ngrx/angular-ngrx-error-messages.gif" style="max-width: 70%;border:0;box-shadow:none;" alt="error messages" />
</div>

<h3 id="update-the-landingcomponent">Update the <code class="highlighter-rouge">LandingComponent</code></h3>

<p>Update the component:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Store</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs/Observable'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">AppState</span><span class="p">,</span> <span class="nx">selectAuthState</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../store/app.states'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LogOut</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../store/actions/auth.actions'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-landing'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./landing.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./landing.component.css'</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">LandingComponent</span> <span class="kr">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>

  <span class="nl">getState</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nl">isAuthenticated</span><span class="p">:</span> <span class="kc">false</span><span class="p">;</span>
  <span class="nx">user</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="nx">errorMessage</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span>
    <span class="kr">private</span> <span class="nx">store</span><span class="p">:</span> <span class="nx">Store</span><span class="o">&lt;</span><span class="nx">AppState</span><span class="o">&gt;</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">getState</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">selectAuthState</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">getState</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">((</span><span class="nx">state</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">isAuthenticated</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">errorMessage</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">errorMessage</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">logOut</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">LogOut</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>Next, update the Landing template so that the <em>Log in</em> and <em>Sign up</em> buttons are <em>only</em> visible when a user is not authenticated. Also, when the user is authenticated, a welcome message will be displayed along with a <em>Log out</em> button.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div class="row"&gt;
  &lt;div class="col-md-4"&gt;
    &lt;h1&gt;Angular + NGRX&lt;/h1&gt;
    &lt;hr&gt;&lt;br&gt;
    &lt;div *ngIf="isAuthenticated; then doSomething; else doSomethingElse;"&gt;&lt;/div&gt;
    &lt;ng-template #doSomething&gt;
      &lt;p&gt;You logged in &lt;em&gt;{{user.email}}!&lt;/em&gt;&lt;/p&gt;
      &lt;button class="btn btn-primary" (click)="logOut()"&gt;Log out&lt;/button&gt;
    &lt;/ng-template&gt;
    &lt;ng-template #doSomethingElse&gt;
      &lt;a [routerLink]="['/log-in']" class="btn btn-primary"&gt;Log in&lt;/a&gt;
      &lt;a [routerLink]="['/sign-up']" class="btn btn-primary"&gt;Sign up&lt;/a&gt;
    &lt;/ng-template&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre></div></div>

<p>Test it out! Make sure the token is removed when the user logs out.</p>

<div style="text-align:left;padding-top:10px;padding-left:10px;padding-bottom:20px;">
  <img src="/assets/img/blog/angular-auth-ngrx/landing-logged-in.png" style="max-width: 70%;border:0;box-shadow:none;" alt="landing component" />
</div>

<div style="text-align:left;padding-top:10px;padding-left:10px;padding-bottom:20px;">
  <img src="/assets/img/blog/angular-auth-ngrx/landing-logged-out.png" style="max-width: 70%;border:0;box-shadow:none;" alt="landing component" />
</div>

<p>Finally, update the template once again to show the current application state. This is just for reference while developing, so be sure to remove it before deploying to production.</p>

<p>Template:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div class="row"&gt;
  &lt;div class="col-md-4"&gt;

    &lt;h1&gt;Angular + NGRX&lt;/h1&gt;
    &lt;hr&gt;&lt;br&gt;

    &lt;div *ngIf="isAuthenticated; then doSomething; else doSomethingElse;"&gt;&lt;/div&gt;
    &lt;ng-template #doSomething&gt;
      &lt;p&gt;You logged in &lt;em&gt;{{user.email}}!&lt;/em&gt;&lt;/p&gt;
      &lt;button class="btn btn-primary" (click)="logOut()"&gt;Log out&lt;/button&gt;
    &lt;/ng-template&gt;
    &lt;ng-template #doSomethingElse&gt;
      &lt;a [routerLink]="['/log-in']" class="btn btn-primary"&gt;Log in&lt;/a&gt;
      &lt;a [routerLink]="['/sign-up']" class="btn btn-primary"&gt;Sign up&lt;/a&gt;
    &lt;/ng-template&gt;

    &lt;br&gt;&lt;br&gt;&lt;br&gt;

    &lt;div class="card" style="width: 18rem;"&gt;
      &lt;div class="card-body"&gt;
        &lt;h5 class="card-title"&gt;Current State&lt;/h5&gt;
        &lt;ul&gt;
          &lt;li&gt;&lt;strong&gt;isAuthenticated&lt;/strong&gt; - {{isAuthenticated}}&lt;/li&gt;
          &lt;li&gt;&lt;strong&gt;user.email&lt;/strong&gt; - {{ user?.email || 'null'}}&lt;/li&gt;
          &lt;li&gt;&lt;strong&gt;user.token&lt;/strong&gt; - {{ user?.token || 'null'}}&lt;/li&gt;
          &lt;li&gt;&lt;strong&gt;errorMessage&lt;/strong&gt; - {{ errorMessage || 'null'}}&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/div&gt;
    &lt;/div&gt;

  &lt;/div&gt;
&lt;/div&gt;
</code></pre></div></div>

<div style="text-align:left;padding-top:10px;padding-left:10px;padding-bottom:20px">
  <img src="/assets/img/blog/angular-auth-ngrx/angular-ngrx-landing-show-state.gif" style="max-width: 70%;border:0;box-shadow:none;" alt="state on landing page" />
</div>

<h2 id="add-http-interceptor-1">Add HTTP Interceptor</h2>

<h3 id="configure-the-interceptor">Configure the interceptor</h3>

<p>The <code class="highlighter-rouge">HttpInterceptor</code> <a href="https://angular.io/api/common/http/HttpInterceptor">interface</a> is used to intercept and modify HTTP requests globally. We’ll use it to add the authentication token and content type to the request headers.</p>

<p>Create the service:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ng generate service services/token
</code></pre></div></div>

<p>Rename <em>token.service.ts</em> to <em>token.interceptor.ts</em> and then remove  <em>token.service.spec.ts</em>.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span><span class="p">,</span> <span class="nx">Injector</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span>
  <span class="nx">HttpEvent</span><span class="p">,</span> <span class="nx">HttpInterceptor</span><span class="p">,</span> <span class="nx">HttpHandler</span><span class="p">,</span> <span class="nx">HttpRequest</span>
<span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/common/http'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs/Observable'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">AuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./auth.service'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">TokenInterceptor</span> <span class="kr">implements</span> <span class="nx">HttpInterceptor</span> <span class="p">{</span>
  <span class="kr">private</span> <span class="nx">authService</span><span class="p">:</span> <span class="nx">AuthService</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">injector</span><span class="p">:</span> <span class="nx">Injector</span><span class="p">)</span> <span class="p">{}</span>
  <span class="nx">intercept</span><span class="p">(</span><span class="nx">request</span><span class="p">:</span> <span class="nx">HttpRequest</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="nx">HttpHandler</span><span class="p">):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">HttpEvent</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">authService</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">injector</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">AuthService</span><span class="p">);</span>
    <span class="kd">const</span> <span class="na">token</span><span class="p">:</span> <span class="nx">string</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">authService</span><span class="p">.</span><span class="nx">getToken</span><span class="p">();</span>
    <span class="nx">request</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">clone</span><span class="p">({</span>
      <span class="na">setHeaders</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'Authorization'</span><span class="p">:</span> <span class="s2">`Bearer </span><span class="p">${</span><span class="nx">token</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
        <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/json'</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">next</span><span class="p">.</span><span class="nx">handle</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Import the <code class="highlighter-rouge">TokenInterceptor</code> and <code class="highlighter-rouge">HTTP_INTERCEPTORS</code> from <code class="highlighter-rouge">@angular/common/http</code> to <em>src/app/app.module.ts</em>, and then add the interceptor as a provider in the <code class="highlighter-rouge">@NgModule</code> definition:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">BrowserModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/platform-browser'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">NgModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RouterModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">FormsModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/forms'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">HttpClientModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/common/http'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">EffectsModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/effects'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">StoreModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">HTTP_INTERCEPTORS</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/common/http'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">AppComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./app.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LandingComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./components/landing/landing.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">SignUpComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./components/sign-up/sign-up.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LogInComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./components/log-in/log-in.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./services/auth.service'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AuthEffects</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./store/effects/auth.effects'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">reducers</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./store/app.states'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">TokenInterceptor</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./services/token.interceptor'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">NgModule</span><span class="p">({</span>
  <span class="na">declarations</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">AppComponent</span><span class="p">,</span>
    <span class="nx">LandingComponent</span><span class="p">,</span>
    <span class="nx">SignUpComponent</span><span class="p">,</span>
    <span class="nx">LogInComponent</span>
  <span class="p">],</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">BrowserModule</span><span class="p">,</span>
    <span class="nx">FormsModule</span><span class="p">,</span>
    <span class="nx">HttpClientModule</span><span class="p">,</span>
    <span class="nx">StoreModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">(</span><span class="nx">reducers</span><span class="p">,</span> <span class="p">{}),</span>
    <span class="nx">EffectsModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">([</span><span class="nx">AuthEffects</span><span class="p">]),</span>
    <span class="nx">RouterModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">([</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'log-in'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">LogInComponent</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'sign-up'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">SignUpComponent</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">LandingComponent</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'**'</span><span class="p">,</span> <span class="na">redirectTo</span><span class="p">:</span> <span class="s1">'/'</span> <span class="p">}</span>
    <span class="p">])</span>
  <span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">AuthService</span><span class="p">,</span>
    <span class="p">{</span>
      <span class="na">provide</span><span class="p">:</span> <span class="nx">HTTP_INTERCEPTORS</span><span class="p">,</span>
      <span class="na">useClass</span><span class="p">:</span> <span class="nx">TokenInterceptor</span><span class="p">,</span>
      <span class="na">multi</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">},</span>
  <span class="p">],</span>
  <span class="na">bootstrap</span><span class="p">:</span> <span class="p">[</span><span class="nx">AppComponent</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppModule</span> <span class="p">{</span> <span class="p">}</span>
</code></pre></div></div>

<p>Now, when an HTTP request is made, the token (if it exists in localStorage) will be added to the header.</p>

<h3 id="handle-unauthorized-responses">Handle unauthorized responses</h3>

<p>The interceptor can also be used to intercept incoming HTTP responses. We can use it here to check for any <code class="highlighter-rouge">401</code> codes and redirect the user to the log in route:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span><span class="p">,</span> <span class="nx">Injector</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span>
  <span class="nx">HttpEvent</span><span class="p">,</span> <span class="nx">HttpInterceptor</span><span class="p">,</span> <span class="nx">HttpHandler</span><span class="p">,</span> <span class="nx">HttpRequest</span><span class="p">,</span>
  <span class="nx">HttpResponse</span><span class="p">,</span> <span class="nx">HttpErrorResponse</span>
<span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/common/http'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs/Observable'</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">'rxjs/add/operator/do'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Router</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">AuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./auth.service'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">TokenInterceptor</span> <span class="kr">implements</span> <span class="nx">HttpInterceptor</span> <span class="p">{</span>
  <span class="kr">private</span> <span class="nx">authService</span><span class="p">:</span> <span class="nx">AuthService</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">injector</span><span class="p">:</span> <span class="nx">Injector</span><span class="p">)</span> <span class="p">{}</span>
  <span class="nx">intercept</span><span class="p">(</span><span class="nx">request</span><span class="p">:</span> <span class="nx">HttpRequest</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="nx">HttpHandler</span><span class="p">):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">HttpEvent</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">authService</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">injector</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">AuthService</span><span class="p">);</span>
    <span class="kd">const</span> <span class="na">token</span><span class="p">:</span> <span class="nx">string</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">authService</span><span class="p">.</span><span class="nx">getToken</span><span class="p">();</span>
    <span class="nx">request</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">clone</span><span class="p">({</span>
      <span class="na">setHeaders</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'Authorization'</span><span class="p">:</span> <span class="s2">`Bearer </span><span class="p">${</span><span class="nx">token</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
        <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/json'</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">next</span><span class="p">.</span><span class="nx">handle</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ErrorInterceptor</span> <span class="kr">implements</span> <span class="nx">HttpInterceptor</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="na">router</span><span class="p">:</span> <span class="nx">Router</span><span class="p">)</span> <span class="p">{}</span>
  <span class="nx">intercept</span><span class="p">(</span><span class="na">request</span><span class="p">:</span> <span class="nx">HttpRequest</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">,</span> <span class="na">next</span><span class="p">:</span> <span class="nx">HttpHandler</span><span class="p">):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">HttpEvent</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;&gt;</span> <span class="p">{</span>

    <span class="k">return</span> <span class="nx">next</span><span class="p">.</span><span class="nx">handle</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="na">response</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">response</span> <span class="k">instanceof</span> <span class="nx">HttpErrorResponse</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">401</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">Observable</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Add the <code class="highlighter-rouge">ErrorInterceptor</code> to the provider array:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">providers</span><span class="p">:</span> <span class="p">[</span>
  <span class="nx">AuthService</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="na">provide</span><span class="p">:</span> <span class="nx">HTTP_INTERCEPTORS</span><span class="p">,</span>
    <span class="na">useClass</span><span class="p">:</span> <span class="nx">TokenInterceptor</span><span class="p">,</span>
    <span class="na">multi</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">provide</span><span class="p">:</span> <span class="nx">HTTP_INTERCEPTORS</span><span class="p">,</span>
    <span class="na">useClass</span><span class="p">:</span> <span class="nx">ErrorInterceptor</span><span class="p">,</span>
    <span class="na">multi</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">],</span>
</code></pre></div></div>

<p>Make sure to import it:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span>
  <span class="nx">TokenInterceptor</span><span class="p">,</span> <span class="nx">ErrorInterceptor</span>
<span class="p">}</span> <span class="k">from</span> <span class="s1">'./services/token.interceptor'</span><span class="p">;</span>
</code></pre></div></div>

<p>We’ll test this out shortly.</p>

<h3 id="add-new-route">Add new route</h3>

<p>Generate the component:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ng generate component components/status
</code></pre></div></div>

<p>Update the router:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">RouterModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">([</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'log-in'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">LogInComponent</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'sign-up'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">SignUpComponent</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'status'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">StatusComponent</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">LandingComponent</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'**'</span><span class="p">,</span> <span class="na">redirectTo</span><span class="p">:</span> <span class="s1">'/'</span> <span class="p">}</span>
<span class="p">])</span>
</code></pre></div></div>

<p>Dispatch a new action in the component:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Store</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">AppState</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../store/app.states'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">GetStatus</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../../store/actions/auth.actions'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-status'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./status.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./status.component.css'</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">StatusComponent</span> <span class="kr">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">store</span><span class="p">:</span> <span class="nx">Store</span><span class="o">&lt;</span><span class="nx">AppState</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">GetStatus</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>Add the action:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Action</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@ngrx/store'</span><span class="p">;</span>


<span class="k">export</span> <span class="kr">enum</span> <span class="nx">AuthActionTypes</span> <span class="p">{</span>
  <span class="nx">LOGIN</span> <span class="o">=</span> <span class="s1">'[Auth] Login'</span><span class="p">,</span>
  <span class="nx">LOGIN_SUCCESS</span> <span class="o">=</span> <span class="s1">'[Auth] Login Success'</span><span class="p">,</span>
  <span class="nx">LOGIN_FAILURE</span> <span class="o">=</span> <span class="s1">'[Auth] Login Failure'</span><span class="p">,</span>
  <span class="nx">SIGNUP</span> <span class="o">=</span> <span class="s1">'[Auth] Signup'</span><span class="p">,</span>
  <span class="nx">SIGNUP_SUCCESS</span> <span class="o">=</span> <span class="s1">'[Auth] Signup Success'</span><span class="p">,</span>
  <span class="nx">SIGNUP_FAILURE</span> <span class="o">=</span> <span class="s1">'[Auth] Signup Failure'</span><span class="p">,</span>
  <span class="nx">LOGOUT</span> <span class="o">=</span> <span class="s1">'[Auth] Logout'</span><span class="p">,</span>
  <span class="nx">GET_STATUS</span> <span class="o">=</span> <span class="s1">'[Auth] GetStatus'</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogIn</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogInSuccess</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN_SUCCESS</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogInFailure</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGIN_FAILURE</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">SignUp</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">SIGNUP</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">SignUpSuccess</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">SIGNUP_SUCCESS</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">SignUpFailure</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">SIGNUP_FAILURE</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">public</span> <span class="nx">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">LogOut</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">LOGOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">GetStatus</span> <span class="kr">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nx">readonly</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">GET_STATUS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="nx">type</span> <span class="nx">All</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nx">LogIn</span>
  <span class="o">|</span> <span class="nx">LogInSuccess</span>
  <span class="o">|</span> <span class="nx">LogInFailure</span>
  <span class="o">|</span> <span class="nx">SignUp</span>
  <span class="o">|</span> <span class="nx">SignUpSuccess</span>
  <span class="o">|</span> <span class="nx">SignUpFailure</span>
  <span class="o">|</span> <span class="nx">LogOut</span>
  <span class="o">|</span> <span class="nx">GetStatus</span><span class="p">;</span>
</code></pre></div></div>

<p>Effect:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Effect</span><span class="p">({</span> <span class="na">dispatch</span><span class="p">:</span> <span class="kc">false</span> <span class="p">})</span>
<span class="nx">GetStatus</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">actions</span>
  <span class="p">.</span><span class="nx">ofType</span><span class="p">(</span><span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">GET_STATUS</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">action</span><span class="p">:</span> <span class="nx">GetStatus</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">action</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">switchMap</span><span class="p">(</span><span class="nx">payload</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">authService</span><span class="p">.</span><span class="nx">getStatus</span><span class="p">();</span>
  <span class="p">});</span>

<span class="p">@</span><span class="nd">Effect</span><span class="p">({</span> <span class="na">dispatch</span><span class="p">:</span> <span class="kc">false</span> <span class="p">})</span>
<span class="na">GetStatus</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">actions</span>
  <span class="p">.</span><span class="nx">ofType</span><span class="p">(</span><span class="nx">AuthActionTypes</span><span class="p">.</span><span class="nx">GET_STATUS</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">switchMap</span><span class="p">(</span><span class="nx">payload</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">authService</span><span class="p">.</span><span class="nx">getStatus</span><span class="p">();</span>
  <span class="p">});</span>
</code></pre></div></div>

<p>Add the <code class="highlighter-rouge">getStatus</code> method to <code class="highlighter-rouge">AuthService</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">getStatus</span><span class="p">():</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">BASE_URL</span><span class="p">}</span><span class="s2">/status`</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Remove the token from localStorage (if it exists), since it’s invalid, and redirect the user:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ErrorInterceptor</span> <span class="kr">implements</span> <span class="nx">HttpInterceptor</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">router</span><span class="p">:</span> <span class="nx">Router</span><span class="p">)</span> <span class="p">{}</span>
  <span class="nx">intercept</span><span class="p">(</span><span class="nx">request</span><span class="p">:</span> <span class="nx">HttpRequest</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="nx">HttpHandler</span><span class="p">):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">HttpEvent</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;&gt;</span> <span class="p">{</span>

    <span class="k">return</span> <span class="nx">next</span><span class="p">.</span><span class="nx">handle</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="na">response</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">response</span> <span class="k">instanceof</span> <span class="nx">HttpErrorResponse</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">401</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s1">'token'</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">navigateByUrl</span><span class="p">(</span><span class="s1">'/log-in'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">Observable</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Add a <code class="highlighter-rouge">/status</code> link to the Landing template:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div class="row"&gt;
  &lt;div class="col-md-4"&gt;

    &lt;h1&gt;Angular + NGRX&lt;/h1&gt;
    &lt;hr&gt;&lt;br&gt;

    &lt;div *ngIf="isAuthenticated; then doSomething; else doSomethingElse;"&gt;&lt;/div&gt;
    &lt;ng-template #doSomething&gt;
      &lt;p&gt;You logged in &lt;em&gt;{{user.email}}!&lt;/em&gt;&lt;/p&gt;
      &lt;button class="btn btn-primary" (click)="logOut()"&gt;Log out&lt;/button&gt;
    &lt;/ng-template&gt;
    &lt;ng-template #doSomethingElse&gt;
      &lt;a [routerLink]="['/log-in']" class="btn btn-primary"&gt;Log in&lt;/a&gt;
      &lt;a [routerLink]="['/sign-up']" class="btn btn-primary"&gt;Sign up&lt;/a&gt;
    &lt;/ng-template&gt;

    &lt;a [routerLink]="['/status']" class="btn btn-primary"&gt;Status&lt;/a&gt;

    &lt;br&gt;&lt;br&gt;&lt;br&gt;

    &lt;div class="card" style="width: 18rem;"&gt;
      &lt;div class="card-body"&gt;
        &lt;h5 class="card-title"&gt;Current State&lt;/h5&gt;
        &lt;ul&gt;
          &lt;li&gt;&lt;strong&gt;isAuthenticated&lt;/strong&gt; - {{isAuthenticated}}&lt;/li&gt;
          &lt;li&gt;&lt;strong&gt;user.email&lt;/strong&gt; - {{ user?.email || 'null'}}&lt;/li&gt;
          &lt;li&gt;&lt;strong&gt;user.token&lt;/strong&gt; - {{ user?.token || 'null'}}&lt;/li&gt;
          &lt;li&gt;&lt;strong&gt;errorMessage&lt;/strong&gt; - {{ errorMessage || 'null'}}&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/div&gt;
    &lt;/div&gt;

  &lt;/div&gt;
&lt;/div&gt;
</code></pre></div></div>

<p>Status template:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div class="row"&gt;
  &lt;div class="col-md-4"&gt;
    &lt;h1&gt;Status Works!&lt;/h1&gt;
    &lt;hr&gt;&lt;br&gt;
    &lt;a [routerLink]="['/']" class="btn btn-primary"&gt;Home&lt;/a&gt;
&lt;/div&gt;
</code></pre></div></div>

<p>Now, if you try to access <code class="highlighter-rouge">/status</code> and are <em>not</em> logged in, you will be redirected to the <code class="highlighter-rouge">/log-in</code> route:</p>

<div style="text-align:left;padding-top:10px;padding-left:10px;">
  <img src="/assets/img/blog/angular-auth-ngrx/angular-ngrx-http-interceptor.gif" style="max-width: 70%;border:0;box-shadow:none;" alt="http interceptor" />
</div>

<p>You should also see the token added to the header when you hit the <code class="highlighter-rouge">/status</code> route:</p>

<div style="text-align:left;padding-top:10px;padding-left:10px;padding-bottom:20px;">
  <img src="/assets/img/blog/angular-auth-ngrx/status.png" style="max-width: 70%;border:0;box-shadow:none;" alt="status component" />
</div>

<h2 id="route-guard-1">Route Guard</h2>

<p>Try going to <a href="http://localhost:4200/status">http://localhost:4200/status</a> in the browser. Did you notice that the component will render for a second before re-directing? That’s because <code class="highlighter-rouge">ngOnInit()</code> is fired <em>after</em> the component is created. We can use a route guard to prevent access to the route altogether so the redirect will happen <em>before</em> the component gets created.</p>

<h3 id="configure-the-interface">Configure the interface</h3>

<p>Create the service:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ng generate service services/auth-guard
</code></pre></div></div>

<p>Update:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Router</span><span class="p">,</span> <span class="nx">CanActivate</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">AuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./auth.service'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AuthGuardService</span> <span class="kr">implements</span> <span class="nx">CanActivate</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span>
    <span class="kr">public</span> <span class="nx">auth</span><span class="p">:</span> <span class="nx">AuthService</span><span class="p">,</span>
    <span class="kr">public</span> <span class="nx">router</span><span class="p">:</span> <span class="nx">Router</span>
  <span class="p">)</span> <span class="p">{}</span>
  <span class="nx">canActivate</span><span class="p">():</span> <span class="kr">boolean</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">getToken</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">navigateByUrl</span><span class="p">(</span><span class="s1">'/log-in'</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So, we are using the <code class="highlighter-rouge">CanActivate</code> route guard <a href="https://angular.io/api/router/CanActivate">interface</a> to implement the guard itself. In the <code class="highlighter-rouge">canActivate</code> method, we check to see if a token is in localStorage, return the appropriate boolean, and (if necessary) redirect the user.</p>

<blockquote>
  <p>It’s probably worth looking at state as well, to get the value of <code class="highlighter-rouge">isAuthenticated</code>. Make this change on your own.</p>
</blockquote>

<h3 id="protect-the-route">Protect the route</h3>

<p>Update the route in <em>app.module.ts</em>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span> <span class="nl">path</span><span class="p">:</span> <span class="s1">'status'</span><span class="p">,</span> <span class="nx">component</span><span class="p">:</span> <span class="nx">StatusComponent</span><span class="p">,</span> <span class="nx">canActivate</span><span class="p">:</span> <span class="p">[</span><span class="nx">AuthGuard</span><span class="p">]</span> <span class="p">},</span>
</code></pre></div></div>

<p>Add the provider:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">providers</span><span class="p">:</span> <span class="p">[</span>
  <span class="nx">AuthService</span><span class="p">,</span>
  <span class="nx">AuthGuard</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="na">provide</span><span class="p">:</span> <span class="nx">HTTP_INTERCEPTORS</span><span class="p">,</span>
    <span class="na">useClass</span><span class="p">:</span> <span class="nx">TokenInterceptor</span><span class="p">,</span>
    <span class="na">multi</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">provide</span><span class="p">:</span> <span class="nx">HTTP_INTERCEPTORS</span><span class="p">,</span>
    <span class="na">useClass</span><span class="p">:</span> <span class="nx">ErrorInterceptor</span><span class="p">,</span>
    <span class="na">multi</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">],</span>
</code></pre></div></div>

<p>Import <code class="highlighter-rouge">canActivate</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">RouterModule</span><span class="p">,</span> <span class="nx">CanActivate</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>
</code></pre></div></div>

<p>Import the service:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">AuthGuardService</span> <span class="k">as</span> <span class="nx">AuthGuard</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./services/auth-guard.service'</span><span class="p">;</span>
</code></pre></div></div>

<p>You should no longer see the template flicker before being redirected.</p>

<h2 id="conclusion">Conclusion</h2>

<p>This article took a look at how to add authentication to an Angular app using NGRX Store (to manage state) and Effects (to manage side-effects). The full code can be found in the <a href="https://github.com/mjhea0/angular-auth-ngrx">angular-auth-ngrx</a> repository.</p>

<blockquote>
  <p>Want to learn how to test this app? Check out the <a href="https://testdriven.io/testing-angular-with-cypress-and-docker">Testing Angular with Cypress and Docker</a> blog post!</p>
</blockquote>

<p>Looking for some challenges?</p>

<ol>
  <li>Add some additional actions and effects: <code class="highlighter-rouge">[Auth] Signup Redirect</code> and <code class="highlighter-rouge">[Auth] Login Redirect</code></li>
  <li>Refactor out native form validation (<code class="highlighter-rouge">ngNativeValidate</code>) and add in reactive Angular form validation</li>
  <li>Add unit and end-to-end tests</li>
  <li>Configure NGRX <a href="https://github.com/ngrx/platform/blob/master/docs/router-store/README.md">Router Store</a> so that the Angular Router has access to state</li>
  <li>Add Docker to simplify the development workflow (see <a href="http://mherman.org/blog/2018/02/26/dockerizing-an-angular-app">Dockerizing an Angular App
</a> for more info)</li>
  <li>Remove all <code class="highlighter-rouge">console.log</code> statements</li>
  <li>Use a <a href="https://stackoverflow.com/questions/43466159/how-to-set-a-cookie-for-jwt-token-in-angular-2/43475915">cookie instead of localStorage</a></li>
</ol>

  </div>

  <!-- addthis -->
  
    <div class="sharing">
  <br>
  <!-- AddThis Button BEGIN -->
  <div class="addthis_toolbox addthis_default_style addthis_32x32_style">
    <a class="addthis_button_preferred_1"></a>
    <a class="addthis_button_preferred_2"></a>
    <a class="addthis_button_preferred_3"></a>
    <a class="addthis_button_preferred_4"></a>
    <a class="addthis_button_compact"></a>
    <a class="addthis_counter addthis_bubble_style"></a>
  </div>
  <script type="text/javascript">var addthis_config = {"data_track_addressbar":false};</script>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-50e5f1cc35ad077d"></script>
  <!-- AddThis Button END -->
  <br>
</div>

  

  <!-- disqus -->
  
    <div id="disqus_thread"></div>

<script>
  var disqus_config = function () {
    this.page.url = 'https://mherman.org/blog/authentication-in-angular-with-ngrx/';
    this.page.identifier = 'https://mherman.org/blog/authentication-in-angular-with-ngrx/';
  };

  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//' + 'michaelherman' + '.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  


</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      




<div>
  <hr>
  <p>
    <span>Copyright &copy; 2019 - Michael Herman</span>
    <br>
    <small>Questions? michael at mherman dot org</small><br>
    <small><a href="#">Back to top</a></small>
    <br>
    <span>
      <a href="https://github.com/mjhea0"><i class="fa fa-github-square" style="font-size:2em" aria-hidden="true"></i></a>
      <a href="https://twitter.com/mikeherman"><i class="fa fa-twitter-square" style="font-size:2em" aria-hidden="true"></i></a>
      <a href="https://www.linkedin.com/in/mjhea0/"><i class="fa fa-linkedin-square" style="font-size:2em" aria-hidden="true"></i></a>
      <a href="https://www.youtube.com/hermanmu"><i class="fa fa-youtube-square" style="font-size:2em" aria-hidden="true"></i></a>
    </span>
  </p>
</div>

    </p>

  </div>

</footer>


  </body>

  <script type="text/javascript" src="/assets/hello.js"></script>
</html>
