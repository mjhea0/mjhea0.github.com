<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Node | Michael Herman]]></title>
  <link href="http://mherman.org/blog/categories/node/atom.xml" rel="self"/>
  <link href="http://mherman.org/"/>
  <updated>2016-04-06T20:04:14-06:00</updated>
  <id>http://mherman.org/</id>
  <author>
    <name><![CDATA[Michael Herman]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Designing a RESTful API With Node and Postgres]]></title>
    <link href="http://mherman.org/blog/2016/03/13/designing-a-restful-api-with-node-and-postgres/"/>
    <updated>2016-03-13T07:56:00-06:00</updated>
    <id>http://mherman.org/blog/2016/03/13/designing-a-restful-api-with-node-and-postgres</id>
    <content type="html"><![CDATA[<p><strong>In this tutorial we&rsquo;ll create a RESTful web service with JavaScript, Node, Express, Postgres, and pg-promise.</strong></p>

<div style="text-align:center;">
  <img src="http://mherman.org/images/node-restful-api.png" style="max-width: 100%; border:0; box-shadow: none;" alt="node restful api">
</div>


<p><br><hr></p>

<p>Our app will include the following endpoints:</p>

<table style="font-size:18px;border-spacing:12px 0px;border-collapse:separate;border:1px solid black;">
<thead>
<tr>
<th style="text-align:center"><strong>URL</strong></th>
<th style="text-align:center"><strong>HTTP Verb</strong></th>
<th style="text-align:center"><strong>Action</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>/api/puppies</td>
<td>GET</td>
<td>Return ALL puppies</td>
</tr>
<tr>
<td>/api/puppies/:id</td>
<td>GET</td>
<td>Return a SINGLE puppy</td>
</tr>
<tr>
<td>/api/puppies</td>
<td>POST</td>
<td>Add a puppy</td>
</tr>
<tr>
<td>/api/puppies/:id</td>
<td>PUT</td>
<td>Update a puppy</td>
</tr>
<tr>
<td>/api/puppies/:id</td>
<td>DELETE</td>
<td>Delete a puppy</td>
</tr>
</tbody>
</table>


<p><br></p>

<blockquote><p>This tutorial uses the following tools and technologies - Node.js v<a href="https://nodejs.org/en/blog/release/v4.3.1/">4.3.1</a>, express-generator v<a href="https://github.com/expressjs/generator/releases/tag/v4.13.1">4.13.1</a>, pg-promise v<a href="https://github.com/vitaly-t/pg-promise/releases/tag/v.3.2.3">3.2.3</a>, PostgreSQL v<a href="http://www.postgresql.org/docs/9.4/static/release.html">9.4</a>, and Bluebird v<a href="http://bluebirdjs.com">3.3.4</a></p></blockquote>

<h2>Project setup</h2>

<p>Install the Express Generator (if necessary):</p>

<pre><code class="sh">$ npm install express-generator@4.13.1 -g
</code></pre>

<p>Create a new project and install the required dependencies:</p>

<pre><code class="sh">$ express node-postgres-promises
$ cd node-postgres-promises
$ npm install
</code></pre>

<p>Test!</p>

<pre><code class="sh">$ npm start
</code></pre>

<p>Navigate to <a href="http://localhost:3000">http://localhost:3000</a> in your browser, and you should see the familiar &ldquo;Welcome to Express&rdquo; text. Kill the server when done. Now let&rsquo;s set up the Postgres bindings via <a href="https://www.npmjs.com/package/pg-promise">pg-promise</a>&hellip;</p>

<p>Install <code>pg-promise</code></p>

<pre><code class="sh">$ npm install pg-promise@3.2.3 --save
</code></pre>

<p>Why <code>pg-promise</code> instead of <code>pg</code>? Put simply, pg-promise abstracts away much of the difficult, low-level connection management, allowing you to focus on the business logic. Further, the library includes a powerful <a href="https://www.npmjs.com/package/pg-promise#queries-and-parameters">query formatting engine</a> and support for <a href="https://www.npmjs.com/package/pg-promise#transactions">automated transactions</a>.</p>

<p>Finally, create a new file in the project root called <em>queries.js</em>:</p>

<pre><code class="javascript">var promise = require('bluebird');

var options = {
  // Initialization Options
  promiseLib: promise
};

var pgp = require('pg-promise')(options);
var connectionString = 'postgres://localhost:5432/puppies';
var db = pgp(connectionString);

// add query functions

module.exports = {
  getAllPuppies: getAllPuppies,
  getSinglePuppy: getSinglePuppy,
  createPuppy: createPuppy,
  updatePuppy: updatePuppy,
  removePuppy: removePuppy
};
</code></pre>

<p>Here, we created an instance of <code>pg-promise</code> and assigned it to a variable, <code>pgp</code>.</p>

<p>Did you notice that we passed an object, <code>options</code>, during the initialization process? This is required, even if you do not pass any properties/<a href="https://www.npmjs.com/package/pg-promise#initialization-options">initialization options</a> to the object. In this case, we <a href="https://www.npmjs.com/package/pg-promise#promiselib">overrode</a> pg-promise&rsquo;s default promise library - ES6 Promises - with <a href="http://bluebirdjs.com">Bluebird</a> by setting the <code>promiseLib</code> property in the <code>options</code> object.</p>

<blockquote><p>Why Bluebird? It&rsquo;s loaded with features and reputed to be <a href="http://programmers.stackexchange.com/questions/278778/why-are-native-es6-promises-slower-and-more-memory-intensive-than-bluebird">faster</a> than ES6 Promises.</p></blockquote>

<p>Don&rsquo;t forget to install Bluebird:</p>

<pre><code class="sh">$ npm install bluebird@3.3.4 --save
</code></pre>

<p>Next, we defined a connection string, and then passed it to the pg-promise instance to create a global connection instance.</p>

<p>Done!</p>

<h2>Postgres setup</h2>

<p>Create a new file also in the root called <em>puppies.sql</em> and then add the following code:</p>

<pre><code class="sql">DROP DATABASE IF EXISTS puppies;
CREATE DATABASE puppies;

\c puppies;

CREATE TABLE pups (
  ID SERIAL PRIMARY KEY,
  name VARCHAR,
  breed VARCHAR,
  age INTEGER,
  sex VARCHAR
);

INSERT INTO pups (name, breed, age, sex)
  VALUES ('Tyler', 'Retrieved', 3, 'M');
</code></pre>

<p>Run the file to create the database, apply the schema, and add one row to the newly created database:</p>

<pre><code class="sh">$ psql -f puppies.sql

DROP DATABASE
CREATE DATABASE
CREATE TABLE
INSERT 0 1
</code></pre>

<h2>Routes</h2>

<p>Now we can set up the route handlers in <em>index.js</em>:</p>

<pre><code class="javascript">var express = require('express');
var router = express.Router();

var db = require('../queries');


router.get('/api/puppies', db.getAllPuppies);
router.get('/api/puppies/:id', db.getSinglePuppy);
router.post('/api/puppies', db.createPuppy);
router.put('/api/puppies/:id', db.updatePuppy);
router.delete('/api/puppies/:id', db.removePuppy);


module.exports = router;
</code></pre>

<h2>Queries</h2>

<p>Next, let&rsquo;s add the SQL queries to the <em>queries.js</em> file&hellip;</p>

<h3>GET All Puppies</h3>

<pre><code class="javascript">function getAllPuppies(req, res, next) {
  db.any('select * from pups')
    .then(function (data) {
      res.status(200)
        .json({
          status: 'success',
          data: data,
          message: 'Retrieved ALL puppies'
        });
    })
    .catch(function (err) {
      return next(err);
    });
}
</code></pre>

<p>In the above code, we utilized the <code>any</code> <a href="https://www.npmjs.com/package/pg-promise#query-result-mask">Query Result Mask</a> to query the database, which returns a promise object. This method is used to indicate that we are expecting any number of results back. Success and failures are then handled by <code>.then()</code> and <code>.catch()</code>.</p>

<p>Besides, <code>any</code>, you can use the following <a href="https://www.npmjs.com/package/pg-promise#query-result-mask">Query Result Masks</a> (just to name a few):</p>

<ul>
<li><code>one</code> - a single row is expected</li>
<li><code>many</code> - one or more rows are expected</li>
<li><code>none</code> - no rows are expected</li>
<li><code>result</code> - passes the original object when resolved (we&rsquo;ll look at an example of this shortly)</li>
</ul>


<p>Test the request out in the browser - <a href="http://localhost:3000/api/puppies">http://localhost:3000/api/puppies</a>:</p>

<pre><code class="json">{
  status: "success",
  data: [
    {
      id: 1,
      name: "Tyler",
      breed: "Shih-tzu",
      age: 3,
      sex: "M"
    }
  ],
  message: "Retrieved ALL puppies"
}
</code></pre>

<h3>GET Single Puppy</h3>

<pre><code class="javascript">function getSinglePuppy(req, res, next) {
  var pupID = parseInt(req.params.id);
  db.one('select * from pups where id = $1', pupID)
    .then(function (data) {
      res.status(200)
        .json({
          status: 'success',
          data: data,
          message: 'Retrieved ONE puppy'
        });
    })
    .catch(function (err) {
      return next(err);
    });
}
</code></pre>

<p>Again, test in the browser: <a href="http://localhost:3000/api/puppies/1">http://localhost:3000/api/puppies/1</a></p>

<pre><code class="json">{
  status: "success",
  data: {
    id: 1,
    name: "Tyler",
    breed: "Shih-tzu",
    age: 3,
    sex: "M"
  },
  message: "Retrieved ONE puppy"
}
</code></pre>

<h3>POST</h3>

<pre><code class="javascript">function createPuppy(req, res, next) {
  req.body.age = parseInt(req.body.age);
  db.none('insert into pups(name, breed, age, sex)' +
      'values(${name}, ${breed}, ${age}, ${sex})',
    req.body)
    .then(function () {
      res.status(200)
        .json({
          status: 'success',
          message: 'Inserted one puppy'
        });
    })
    .catch(function (err) {
      return next(err);
    });
}
</code></pre>

<p>Test with curl in a new terminal window:</p>

<pre><code class="sh">$ curl --data "name=Whisky&amp;breed=annoying&amp;age=3&amp;sex=f" \
http://127.0.0.1:3000/api/puppies
</code></pre>

<p>You should see:</p>

<pre><code class="sh">{
  "status": "success",
  "message": "Inserted one puppy"
}
</code></pre>

<p>Double check the GET ALL route in your browser to ensure that the new puppy is now part of the collection.</p>

<h3>PUT</h3>

<pre><code class="javascript">function updatePuppy(req, res, next) {
  db.none('update pups set name=$1, breed=$2, age=$3, sex=$4 where id=$5',
    [req.body.name, req.body.breed, parseInt(req.body.age),
      req.body.sex, parseInt(req.params.id)])
    .then(function () {
      res.status(200)
        .json({
          status: 'success',
          message: 'Updated puppy'
        });
    })
    .catch(function (err) {
      return next(err);
    });
}
</code></pre>

<p>Test!</p>

<pre><code class="sh">$ curl -X PUT --data "name=Hunter&amp;breed=annoying&amp;age=33&amp;sex=m" \
http://127.0.0.1:3000/api/puppies/1
</code></pre>

<h3>Delete</h3>

<pre><code class="javascript">function removePuppy(req, res, next) {
  var pupID = parseInt(req.params.id);
  db.result('delete from pups where id = $1', pupID)
    .then(function (result) {
      /* jshint ignore:start */
      res.status(200)
        .json({
          status: 'success',
          message: `Removed ${result.rowCount} puppy`
        });
      /* jshint ignore:end */
    })
    .catch(function (err) {
      return next(err);
    });
}
</code></pre>

<p>So, we used the <code>result</code> <a href="https://www.npmjs.com/package/pg-promise#query-result-mask">Query Result Mask</a>, in order to get the number of records affected by the query.</p>

<pre><code class="sh">$ curl -X DELETE http://127.0.0.1:3000/api/puppies/1
</code></pre>

<p>Result:</p>

<pre><code class="sh">{
  "status": "success",
  "message": "Removed 1 puppy"
}
</code></pre>

<h2>Error Handling</h2>

<p>Update the error handlers in <em>app.js</em> to serve up JSON:</p>

<pre><code class="javascript">// development error handler
// will print stacktrace
if (app.get('env') === 'development') {
  app.use(function(err, req, res, next) {
    res.status( err.code || 500 )
    .json({
      status: 'error',
      message: err
    });
  });
}

// production error handler
// no stacktraces leaked to user
app.use(function(err, req, res, next) {
  res.status(err.status || 500)
  .json({
    status: 'error',
    message: err.message
  });
});
</code></pre>

<h2>Conclusion</h2>

<p>We now have a basic RESTful API built with Node, Express, and pg-promise. Be sure to comment below if you have any questions.</p>

<p>Grab the code from the <a href="https://github.com/mjhea0/node-postgres-promises">repo</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Node, Postgres, and Sequelize]]></title>
    <link href="http://mherman.org/blog/2015/10/22/node-postgres-sequelize/"/>
    <updated>2015-10-22T10:52:00-06:00</updated>
    <id>http://mherman.org/blog/2015/10/22/node-postgres-sequelize</id>
    <content type="html"><![CDATA[<p><strong>Let&rsquo;s build a CRUD app with Node (v4.1.1), Express (v4.13.1), Sequelize (v3.12.2), and PostgreSQL (9.4.4).</strong></p>

<div style="text-align:center;">
  <img src="http://mherman.org/images/node-sequelize.png" style="max-width: 100%; border:0;" alt="node sequelize">
</div>


<p><strong>Updates</strong>:
  - <em>November 1st, 2015</em> - Added Database Migrations</p>

<blockquote><p>This a follow-up to <a href="http://mherman.org/blog/2015/02/12/postgresql-and-nodejs/#.ViVUDxNViko">PostgreSQL and NodeJS</a>.</p></blockquote>

<h2>Getting Started</h2>

<p>Grab the initial boilerplate and install the dependencies:</p>

<pre><code class="sh">$ git clone git@github.com:mjhea0/node-postgres-sequelize.git
$ git checkout tags/v1
$ npm install
</code></pre>

<p>Now run a quick sanity check:</p>

<pre><code class="sh">$ gulp
</code></pre>

<p>If all went well, a new browser window should have opened to <a href="http://localhost:5000/">http://localhost:5000/</a> and you should see the &ldquo;Welcome to Express.&rdquo; text.</p>

<h2>Sequelize</h2>

<p>With Postgres listening on port 5432, we can make a connection to it using the <a href="http://docs.sequelizejs.com/en/latest/">Sequelize</a> library, <em>an Object Relational Mapper (ORM), written in JavaScript, which supports MySQL, PostgreSQL, SQLite, and MariaDB</em>.</p>

<blockquote><p>Need to set up Postgres? On a Mac? Check out <a href="http://postgresapp.com/">Postgres.app</a>.</p></blockquote>

<p>Install Sequelize, <a href="https://www.npmjs.com/package/pg">pg</a> (for making the database connection), and <a href="https://www.npmjs.com/package/pg-hstore">pg-hstore</a> (for serializing and deserializing JSON into the <a href="http://www.postgresql.org/docs/9.0/static/hstore.html">Postgres hstore key/value pair format</a>):</p>

<pre><code class="sh">$ npm install sequelize@3.12.2 pg@4.4.3 pg-hstore@2.3.2 --save
</code></pre>

<h2>Migrations</h2>

<p>The <a href="https://github.com/sequelize/cli">Sequelize CLI</a> is used to bootstrap a new project and handle <a href="https://en.wikipedia.org/wiki/Schema_migration">database migrations</a> directly from the terminal.</p>

<blockquote><p>Read more about the Sequelize CLI from the official <a href="http://docs.sequelizejs.com/en/latest/docs/migrations/">documentation</a>.</p></blockquote>

<h3>Init</h3>

<p>Start by installing the package:</p>

<pre><code class="sh">$ npm install sequelize-cli@2.1.0 --save
</code></pre>

<p>Next, create a config file called <em>.sequelizerc</em> in your project root to specify the paths to specific files required by Sequelize:</p>

<pre><code class="javascript">var path = require('path');

module.exports = {
  'config': path.resolve('./server', 'config.json'),
  'migrations-path': path.resolve('./server', 'migrations'),
  'models-path': path.resolve('./server', 'models'),
  'seeders-path': path.resolve('./server', 'seeders')
}
</code></pre>

<p>Now, run the init command to create the files (<em>config.json</em>) and folders (&ldquo;migrations&rdquo;, &ldquo;models&rdquo;, and &ldquo;seeders&rdquo;):</p>

<pre><code class="sh">$ node_modules/.bin/sequelize init
</code></pre>

<p>Take a look at the <em>index.js</em> file within the &ldquo;models&rdquo; directory:</p>

<pre><code class="javascript">'use strict';

var fs        = require('fs');
var path      = require('path');
var Sequelize = require('sequelize');
var basename  = path.basename(module.filename);
var env       = process.env.NODE_ENV || 'development';
var config    = require(__dirname + '/../config.json')[env];
var db        = {};

if (config.use_env_variable) {
  var sequelize = new Sequelize(process.env[config.use_env_variable]);
} else {
  var sequelize = new Sequelize(config.database, config.username, config.password, config);
}

fs
  .readdirSync(__dirname)
  .filter(function(file) {
    return (file.indexOf('.') !== 0) &amp;&amp; (file !== basename);
  })
  .forEach(function(file) {
    if (file.slice(-3) !== '.js') return;
    var model = sequelize['import'](path.join(__dirname, file));
    db[model.name] = model;
  });

Object.keys(db).forEach(function(modelName) {
  if (db[modelName].associate) {
    db[modelName].associate(db);
  }
});

db.sequelize = sequelize;
db.Sequelize = Sequelize;

module.exports = db;
</code></pre>

<p>Here, we establish a connection to the database, grab all the model files from the current directory, add them to the <code>db</code> object, and apply any relations between each model (if any).</p>

<h3>Config</h3>

<p>Be sure to also update the <em>config.js</em> file for your development, test, and production databases:</p>

<pre><code class="javascript">{
  "development": {
    "username": "update me",
    "password": "update me",
    "database": "todos",
    "host": "127.0.0.1",
    "port": "5432",
    "dialect": "postgres"
  },
  "test": {
    "username": "update me",
    "password": "update me",
    "database": "update_me",
    "host": "update me",
    "dialect": "update me"
  },
  "production": {
    "username": "update me",
    "password": "update me",
    "database": "update me",
    "host": "update me",
    "dialect": "update me"
  }
}
</code></pre>

<blockquote><p>If you are just running this locally, using the basic development server, then just update the <code>development</code> config.</p></blockquote>

<p>Go ahead and create a database named &ldquo;todos&rdquo;.</p>

<h3>Create Migration</h3>

<p>Now let&rsquo;s create a model along with a migration. Since we&rsquo;re working with todos, run the following command:</p>

<pre><code class="sh">$ node_modules/.bin/sequelize model:create --name Todo --attributes "title:string, complete:boolean,UserId:integer"
</code></pre>

<p>Take a look a the newly created model file, <em>todo.js</em> in the models directory:</p>

<pre><code class="javascript">'use strict';
module.exports = function(sequelize, DataTypes) {
  var Todo = sequelize.define('Todo', {
    title: DataTypes.STRING,
    complete: DataTypes.BOOLEAN
  }, {
    classMethods: {
      associate: function(models) {
        // associations can be defined here
      }
    }
  });
  return Todo;
};
</code></pre>

<p>The corresponding migration file can be found in the &ldquo;migrations&rdquo; folder. Take a look. Next, let&rsquo;s associate a user to a todo. First, we need to define a new migration:</p>

<pre><code class="sh">$ node_modules/.bin/sequelize model:create --name User --attributes "email:string"
</code></pre>

<p>Now we need to set up the relationship between the two models&hellip;</p>

<h3>Associations</h3>

<p>To associate the models (one user can have many todos), make the following updates&hellip;</p>

<p><strong>todo.js</strong>:</p>

<pre><code class="javascript">'use strict';
module.exports = function(sequelize, DataTypes) {
  var Todo = sequelize.define('Todo', {
    title: DataTypes.STRING,
    complete: DataTypes.BOOLEAN
  }, {
    classMethods: {
      associate: function(models) {
        Todo.belongsTo(models.User);
      }
    }
  });
  return Todo;
};
</code></pre>

<p><strong>user.js</strong>:</p>

<pre><code class="javascript">'use strict';
module.exports = function(sequelize, DataTypes) {
  var User = sequelize.define('User', {
    email: DataTypes.STRING
  }, {
    classMethods: {
      associate: function(models) {
        User.hasMany(models.Todo);
      }
    }
  });
  return User;
};
</code></pre>

<h3>Sync</h3>

<p>Finally, before we sync, let&rsquo;s add an additional attribute to the <code>complete</code> filed in the <em>todo.js</em> file:</p>

<pre><code class="javascript">'use strict';
module.exports = function(sequelize, DataTypes) {
  var Todo = sequelize.define('Todo', {
    title: DataTypes.STRING,
    complete: {
      type: DataTypes.BOOLEAN,
      defaultValue: false
    }
  }, {
    classMethods: {
      associate: function(models) {
        Todo.belongsTo(models.User);
      }
    }
  });
  return Todo;
};
</code></pre>

<p>Run the migration to create the tables:</p>

<pre><code class="sh">$ node_modules/.bin/sequelize db:migrate

Sequelize [Node: 4.1.1, CLI: 2.1.0, ORM: 3.12.2]

Loaded configuration file "server/config.json".
Using environment "development".
Using gulpfile ~/node_modules/sequelize-cli/lib/gulpfile.js
Starting 'db:migrate'...
== 20151101052127-create-todo: migrating =======
== 20151101052127-create-todo: migrated (0.049s)

== 20151101052148-create-user: migrating =======
== 20151101052148-create-user: migrated (0.042s)
</code></pre>

<h2>CRUD</h2>

<p>With Sequelize set up and the models defined, we can now set up our RESTful routing structure for the todo resource. First, within <em>index.js</em> in the &ldquo;routes&rdquo; folder add the following requirement:</p>

<pre><code class="javascript">var models = require('../models/index');
</code></pre>

<p>Then add a route for creating a new user:</p>

<pre><code class="javascript">router.post('/users', function(req, res) {
  models.User.create({
    email: req.body.email
  }).then(function(user) {
    res.json(user);
  });
});
</code></pre>

<p>To add a new user, run the server - <code>gulp</code> - and then run the following in a new terminal window:</p>

<pre><code class="sh">$ curl --data "email=michael@mherman.org" http://127.0.0.1:3000/users
</code></pre>

<p>You should see:</p>

<pre><code class="json">{
  "id":1,
  "email":"michael@mherman.org",
  "updatedAt":"2015-11-01T12:24:20.375Z",
  "createdAt":"2015-11-01T12:24:20.375Z"
}
</code></pre>

<p>Now we can add the todo routes&hellip;</p>

<h3>GET all todos</h3>

<pre><code class="javascript">// get all todos
router.get('/todos', function(req, res) {
  models.Todo.findAll({}).then(function(todos) {
    res.json(todos);
  });
});
</code></pre>

<p>When you hit that route you should see an empty array since we have not added any todos. Let&rsquo;s do that now.</p>

<h3>POST</h3>

<pre><code class="javascript">// add new todo
router.post('/todos', function(req, res) {
  models.Todo.create({
    title: req.body.title,
    UserId: req.body.user_id
  }).then(function(todo) {
    res.json(todo);
  });
});
</code></pre>

<p>Now let&rsquo;s test:</p>

<pre><code class="sh">$ curl --data "title=test&amp;user_id=1" http://127.0.0.1:3000/todos
$ curl --data "title=test2&amp;user_id=1" http://127.0.0.1:3000/todos
</code></pre>

<p>Then if you go back and hit <a href="http://127.0.0.1:3000/todos">http://127.0.0.1:3000/todos</a> in our browser, you should see:</p>

<pre><code class="json">[
  {
    id: 1,
    title: "test",
    complete: false,
    createdAt: "2015-11-01T12:31:56.451Z",
    updatedAt: "2015-11-01T12:31:56.451Z",
    UserId: 1
  },
  {
    id: 2,
    title: "test2",
    complete: false,
    createdAt: "2015-11-01T12:32:09.000Z",
    updatedAt: "2015-11-01T12:32:09.000Z",
    UserId: 1
  }
]
</code></pre>

<h3>GET single todo</h3>

<p>How about getting a single todo?</p>

<pre><code class="javascript">// get single todo
router.get('/todo/:id', function(req, res) {
  models.Todo.find({
    where: {
      id: req.params.id
    }
  }).then(function(todo) {
    res.json(todo);
  });
});
</code></pre>

<p>Navigate to <a href="http://localhost:3000/todo/1">http://localhost:3000/todo/1</a> in your browser. You should the single todo.</p>

<h3>PUT</h3>

<p>Need to update a todo?</p>

<pre><code class="javascript">// update single todo
router.put('/todo/:id', function(req, res) {
  models.Todo.find({
    where: {
      id: req.params.id
    }
  }).then(function(todo) {
    if(todo){
      todo.updateAttributes({
        title: req.body.title,
        complete: req.body.complete
      }).then(function(todo) {
        res.send(todo);
      });
    }
  });
});
</code></pre>

<p>And now for a test, of course:</p>

<pre><code class="sh">$ curl -X PUT --data "complete=true" http://127.0.0.1:3000/todo/2
</code></pre>

<h3>DELETE</h3>

<p>Want to delete a todo?</p>

<pre><code class="javascript">// delete a single todo
router.delete('/todo/:id', function(req, res) {
  models.Todo.destroy({
    where: {
      id: req.params.id
    }
  }).then(function(todo) {
    res.json(todo);
  });
});
</code></pre>

<p>Test:</p>

<pre><code class="sh">$ curl -X DELETE http://127.0.0.1:3000/todo/1
</code></pre>

<p>Again, navigate to <a href="http://localhost:3000/todos">http://localhost:3000/todos</a> in your browser. You should now only see one todo.</p>

<h2>Conclusion</h2>

<p>That&rsquo;s it for the basic server-side code. You now have a database, models, and migrations set up. Whenever you want to update the state of your database, just add additional migrations and then run them as necessary.</p>

<p>Grab the code from the <a href="https://github.com/mjhea0/node-postgres-sequelize">Github repo</a>. Comment below with questions. Cheers!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Social Authentication in Node.js With Passport]]></title>
    <link href="http://mherman.org/blog/2015/09/26/social-authentication-in-node-dot-js-with-passport/"/>
    <updated>2015-09-26T13:37:00-06:00</updated>
    <id>http://mherman.org/blog/2015/09/26/social-authentication-in-node-dot-js-with-passport</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/jaredhanson/passport">Passport</a> is a library that provides a mechanism for easily setting up an authentication/registration system with support for <a href="https://github.com/jaredhanson/passport#strategies">several frameworks and auth providers</a>. <strong>In this tutorial, we’ll demonstrate in detail how to integrate this library into a Node.JS/Express 4 application to provide user authentication through LinkedIn, Github, and Twitter using OAuth 2.0.</strong></p>

<div style="text-align:center;">
  <img src="http://mherman.org/images/passport-social-auth.png" style="max-width: 100%; border:0;" alt="passport social auth">
</div>


<p>We will be using:</p>

<ul>
<li>NodeJS v<a href="https://nodejs.org/docs/v4.1.1/api/all.html">4.1.1</a></li>
<li>ExpressJS v<a href="http://expressjs.com/4x/api.html">4.13.1</a></li>
<li>Mongoose v<a href="http://mongoosejs.com/docs/guide.html">4.1.8</a></li>
<li>Passport Strategies:

<ul>
<li>passport: v<a href="https://github.com/jaredhanson/passport">0.3.0</a></li>
<li>passport-linkedin: v<a href="https://github.com/jaredhanson/passport-linkedin">1.0.0</a></li>
<li>passport-github2: v<a href="https://github.com/cfsghost/passport-github">0.1.9</a></li>
<li>passport-twitter: v<a href="https://github.com/jaredhanson/passport-twitter">1.0.3</a></li>
</ul>
</li>
</ul>


<blockquote><p>For all dependencies, please view the <em>package.json</em> file in the <a href="https://github.com/mjhea0/passport-social-auth">repo</a>.</p></blockquote>

<h2>OAuth 2.0?</h2>

<p><a href="http://oauth.net/2/">OAuth 2.0</a> is the successor of the OAuth protocol (<a href="https://en.wikipedia.org/wiki/OAuth">open standard for authorization</a>), which enables third-party applications, such as the one we&rsquo;ll be building, access to an HTTP service without having to share secure credentials.</p>

<h2>Project Setup</h2>

<p>Let&rsquo;s get started!</p>

<h3>Boilerplate</h3>

<p>Start by downloading the project structure from the <a href="https://github.com/mjhea0/passport-social-auth/releases/tag/v1">Github repo</a>.</p>

<p>You should have:</p>

<pre><code class="sh">├── client
│   └── public
│       ├── css
│       │   └── main.css
│       └── js
│           └── main.js
├── package.json
└── server
    ├── app.js
    ├── bin
    │   └── www
    ├── routes
    │   └── index.js
    └── views
        ├── error.html
        ├── index.html
        └── layout.html
</code></pre>

<h2>Passport</h2>

<p>Install Passport as well as the specific <a href="https://github.com/jaredhanson/passport#search-all-strategies">Passport Strategies</a>:</p>

<pre><code class="sh">$ npm install passport@0.3.0 --save
$ npm install passport-github2@0.1.9 passport-linkedin@1.0.0 passport-twitter@1.0.3 --save
</code></pre>

<p>Create an &ldquo;auth&rdquo; directory in the &ldquo;server&rdquo; and add the following files:</p>

<pre><code class="sh">└── auth
  ├── github.js
  ├── linkedin.js
  └── twitter.js
</code></pre>

<p>Add the Passport dependency to <em>app.js</em>:</p>

<pre><code class="javascript">var passport = require('passport');
</code></pre>

<p>Install the <a href="https://github.com/expressjs/session">express session</a> middleware:</p>

<pre><code class="sh">$ npm install express-session@1.11.3 --save
</code></pre>

<p>And add it as a dependency:</p>

<pre><code class="javascript">var session = require('express-session');
</code></pre>

<p>Then add the required middleware:</p>

<pre><code class="javascript">app.use(session({
  secret: 'keyboard cat',
  resave: true,
  saveUninitialized: true
}));
app.use(passport.initialize());
app.use(passport.session());
</code></pre>

<h3>Configuration</h3>

<p>Add a <em>_config.js</em> file to the &ldquo;server&rdquo; and add the following:</p>

<pre><code class="javascript">var ids = {
  github: {
    clientID: 'get_your_own',
    clientSecret: 'get_your_own',
    callbackURL: "http://127.0.0.1:3000/auth/github/callback"
  },
  linkedin: {
    clientID: 'get_your_own',
    clientSecret: 'get_your_own',
    callbackURL: "http://127.0.0.1:3000/auth/linkedin/callback"
  },
  twitter: {
    consumerKey: 'get_your_own',
    consumerSecret: 'get_your_own',
    callbackURL: "http://127.0.0.1:3000/auth/twitter/callback"
  }
};

module.exports = ids;
</code></pre>

<p>Make sure to add this file to your <em>.gitignore</em> since this will contain sensitive info.</p>

<h3>MongoDB and Mongoose</h3>

<p>Install <a href="http://mongoosejs.com/">Mongoose</a>:</p>

<pre><code class="sh">$ npm install mongoose@4.1.8 --save
</code></pre>

<p>Require the dependency in <em>app.js</em>:</p>

<pre><code class="javascript">var mongoose = require('mongoose');
</code></pre>

<p>Then establish the connection to MongoDB within <em>app.js</em>:</p>

<pre><code class="javascript">// *** mongoose *** //
mongoose.connect('mongodb://localhost/passport-social-auth');
</code></pre>

<p>Add a Mongoose Schema to a new file called <em>user.js</em> in a new folder, within &ldquo;server&rdquo;, called &ldquo;models&rdquo;:</p>

<pre><code class="javascript">var mongoose = require('mongoose');
var Schema = mongoose.Schema;


// create User Schema
var User = new Schema({
  name: String,
  someID: String
});


module.exports = mongoose.model('users', User);
</code></pre>

<h3>Serialize and Deserialize</h3>

<p>Passport needs to serialize and deserialize user instances from a session store to support login sessions. To add this funcionality, create an <em>init.js</em> file within the &ldquo;auth&rdquo; directory, and then add the following code:</p>

<pre><code class="javascript">var passport = require('passport');
var User = require('../models/user');


module.exports = function() {

  passport.serializeUser(function(user, done) {
    done(null, user.id);
  });

  passport.deserializeUser(function(id, done) {
    User.findById(id, function (err, user) {
      done(err, user);
    });
  });

};
</code></pre>

<h3>Routes and Views</h3>

<p>Before we test, add the following route-</p>

<pre><code class="javascript">router.get('/login', function(req, res, next) {
  res.send('Go back and register!');
});
</code></pre>

<p>-and update the <em>index.html</em> file:</p>

<p>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>{% extends <span class="ni">&amp;lsquo;</span>layout.html<span class="ni">&amp;rsquo;</span> %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% block title %}{% endblock %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% block content %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;pre&gt;&lt;code&gt;</span><span class="ni">&amp;lt;</span>h1<span class="ni">&amp;gt;</span>{{ title }}<span class="ni">&amp;lt;</span>/h1<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>p<span class="ni">&amp;gt;</span>Welcome! Please Login.<span class="ni">&amp;lt;</span>/p<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>hr<span class="ni">&amp;gt;&amp;lt;</span>br<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>a href=&quot;http://mherman.org/auth/linkedin&quot; class=&quot;btn btn-default&quot;<span class="ni">&amp;gt;</span>LinkedIn<span class="ni">&amp;lt;</span>/a<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>a href=&quot;http://mherman.org/auth/github&quot; class=&quot;btn btn-default&quot;<span class="ni">&amp;gt;</span>Github<span class="ni">&amp;lt;</span>/a<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>a href=&quot;http://mherman.org/auth/twitter&quot; class=&quot;btn btn-default&quot;<span class="ni">&amp;gt;</span>Twitter<span class="ni">&amp;lt;</span>/a<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="nt">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;/div&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% endblock %}
</span></code></pre></td></tr></table></div></figure>
</p>

<h3>Sanity Check</h3>

<p>Test this code to make sure all is well:</p>

<pre><code class="sh">$ npm start
</code></pre>

<p>Once done, kill the server, and then commit your code and push to Github.</p>

<blockquote><p>Need the updated code? Grab it <a href="https://github.com/mjhea0/passport-social-auth/releases/tag/v2">here</a>.</p></blockquote>

<h2>LinkedIn Auth</h2>

<blockquote><p><a href="https://github.com/jaredhanson/passport-linkedin">https://github.com/jaredhanson/passport-linkedin</a></p></blockquote>

<p>For almost all of the strategies, you will need to-</p>

<ol>
<li>Create an app through the auth provider</li>
<li>Update the config file with the required IDs and keys as well as a callback URL</li>
<li>Configure the Passport strategy</li>
<li>Add the required routes</li>
<li>Update the view</li>
</ol>


<h3>Create an App</h3>

<p>Navigate to <a href="https://www.linkedin.com/developer/apps/">LinkedIn Developers</a> to register a new application. Just enter dummy info, make sure to add the callback - <a href="http://127.0.0.1:3000/auth/linkedin/callback">http://127.0.0.1:3000/auth/linkedin/callback</a> - and update the config within the app:</p>

<pre><code class="javascript">linkedin: {
 clientID: 'ADD YOUR ID HERE',
 clientSecret: 'ADD YOUR SECRET HERE',
 callbackURL: "http://127.0.0.1:3000/auth/linkedin/callback"
},
</code></pre>

<h3>Configure Strategy</h3>

<blockquote><p><a href="https://github.com/jaredhanson/passport-linkedin#usage">https://github.com/jaredhanson/passport-linkedin#usage</a></p></blockquote>

<p>Add the following code to <em>linkedin.js</em>:</p>

<pre><code class="javascript">var passport = require('passport');
var LinkedInStrategy = require('passport-linkedin');

var User = require('../models/user');
var config = require('../_config');
var init = require('./init');

passport.use(new LinkedInStrategy({
    consumerKey: config.linkedin.clientID,
    consumerSecret: config.linkedin.clientSecret,
    callbackURL: config.linkedin.callbackURL
  },
  // linkedin sends back the tokens and progile info
  function(token, tokenSecret, profile, done) {

    var searchQuery = {
      name: profile.displayName
    };

    var updates = {
      name: profile.displayName,
      someID: profile.id
    };

    var options = {
      upsert: true
    };

    // update the user if s/he exists or add a new user
    User.findOneAndUpdate(searchQuery, updates, options, function(err, user) {
      if(err) {
        return done(err);
      } else {
        return done(null, user);
      }
    });
  }

));

// serialize user into the session
init();


module.exports = passport;
</code></pre>

<p>Aside for the Passport magic, you can see that we&rsquo;re either updating the user, if the user is found, or creating a new user, if a user is not found.</p>

<h3>Add Routes</h3>

<blockquote><p><a href="https://github.com/jaredhanson/passport-linkedin#authenticate-requests">https://github.com/jaredhanson/passport-linkedin#authenticate-requests</a></p></blockquote>

<p>Update the routes with:</p>

<pre><code class="javascript">router.get('/auth/linkedin', passportLinkedIn.authenticate('linkedin'));

router.get('/auth/linkedin/callback',
  passportLinkedIn.authenticate('linkedin', { failureRedirect: '/login' }),
  function(req, res) {
    // Successful authentication
    res.json(req.user);
  });
</code></pre>

<p>Add in the dependency as well:</p>

<pre><code class="javascript">var passportLinkedIn = require('../auth/linkedin');
</code></pre>

<h3>Sanity Check</h3>

<p>Test this out. <em>Be sure to use <a href="http://127.0.0.1:3000/">http://127.0.0.1:3000/</a> rather than <a href="http://localhost:3000/">http://localhost:3000/</a>.</em></p>

<p>Now, let&rsquo;s just duplicate that workflow for the remaining providers&hellip;</p>

<h2>Github Auth</h2>

<blockquote><p><a href="https://github.com/cfsghost/passport-github">https://github.com/cfsghost/passport-github</a></p></blockquote>

<h3>Create an App</h3>

<p>Again, create an app, adding in the correct callback URL, and add the given client ID and Secret Key to the <em>_config.js</em> file.</p>

<h3>Configure Strategy</h3>

<blockquote><p><a href="https://github.com/cfsghost/passport-github#configure-strategy">https://github.com/cfsghost/passport-github#configure-strategy</a></p></blockquote>

<pre><code class="javascript">var passport = require('passport');
var GitHubStrategy = require('passport-github2').Strategy;

var User = require('../models/user');
var config = require('../_config');
var init = require('./init');


passport.use(new GitHubStrategy({
  clientID: config.github.clientID,
  clientSecret: config.github.clientSecret,
  callbackURL: config.github.callbackURL
  },
  function(accessToken, refreshToken, profile, done) {

    var searchQuery = {
      name: profile.displayName
    };

    var updates = {
      name: profile.displayName,
      someID: profile.id
    };

    var options = {
      upsert: true
    };

    // update the user if s/he exists or add a new user
    User.findOneAndUpdate(searchQuery, updates, options, function(err, user) {
      if(err) {
        return done(err);
      } else {
        return done(null, user);
      }
    });
  }

));

// serialize user into the session
init();


module.exports = passport;
</code></pre>

<h3>Add Routes</h3>

<blockquote><p><a href="https://github.com/cfsghost/passport-github#authenticate-requests">https://github.com/cfsghost/passport-github#authenticate-requests</a></p></blockquote>

<pre><code class="javascript">var passportGithub = require('../auth/github');

router.get('/auth/github', passportGithub.authenticate('github', { scope: [ 'user:email' ] }));

router.get('/auth/github/callback',
  passportGithub.authenticate('github', { failureRedirect: '/login' }),
  function(req, res) {
    // Successful authentication
    res.json(req.user);
  });
</code></pre>

<h2>Twitter Auth</h2>

<blockquote><p><a href="https://github.com/jaredhanson/passport-twitter">https://github.com/jaredhanson/passport-twitter</a></p></blockquote>

<h3>Create an App</h3>

<p>Create an app on the <a href="https://apps.twitter.com/">Twitter Developer page</a>, and grab the Consumer Key and Secret.</p>

<h3>Configure Strategy</h3>

<blockquote><p><a href="https://github.com/jaredhanson/passport-twitter#configure-strategy">https://github.com/jaredhanson/passport-twitter#configure-strategy</a></p></blockquote>

<pre><code class="javascript">var passport = require('passport');
var TwitterStrategy = require('passport-twitter').Strategy;

var User = require('../models/user');
var config = require('../_config');
var init = require('./init');

passport.use(new TwitterStrategy({
    consumerKey: config.twitter.consumerKey,
    consumerSecret: config.twitter.consumerSecret,
    callbackURL: config.twitter.callbackURL
  },
  function(accessToken, refreshToken, profile, done) {

    var searchQuery = {
      name: profile.displayName
    };

    var updates = {
      name: profile.displayName,
      someID: profile.id
    };

    var options = {
      upsert: true
    };

    // update the user if s/he exists or add a new user
    User.findOneAndUpdate(searchQuery, updates, options, function(err, user) {
      if(err) {
        return done(err);
      } else {
        return done(null, user);
      }
    });
  }

));

// serialize user into the session
init();


module.exports = passport;
</code></pre>

<h3>Add Routes</h3>

<blockquote><p><a href="https://github.com/jaredhanson/passport-twitter#authenticate-requests">https://github.com/jaredhanson/passport-twitter#authenticate-requests</a></p></blockquote>

<pre><code class="javascript">var passportTwitter = require('../auth/twitter');

router.get('/auth/twitter', passportTwitter.authenticate('twitter'));

router.get('/auth/twitter/callback',
  passportTwitter.authenticate('twitter', { failureRedirect: '/login' }),
  function(req, res) {
    // Successful authentication
    res.json(req.user);
  });
</code></pre>

<h2>Conclusion</h2>

<p>Try adding some additional <a href="https://github.com/jaredhanson/passport#strategies">strategies</a>, comment below if you have questions, and grab the final code from the <a href="https://github.com/mjhea0/passport-social-auth">repo</a>.</p>

<p>Thanks for reading!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Testing Node.js With Mocha and Chai]]></title>
    <link href="http://mherman.org/blog/2015/09/10/testing-node-js-with-mocha-and-chai/"/>
    <updated>2015-09-10T10:52:00-06:00</updated>
    <id>http://mherman.org/blog/2015/09/10/testing-node-js-with-mocha-and-chai</id>
    <content type="html"><![CDATA[<p><strong>This post serves as an introduction to testing a Node.js RESTful API with <a href="http://mochajs.org/">Mocha</a> (v2.3.1). a JavaScript testing framework.</strong></p>

<div style="text-align:center;">
  <img src="http://mherman.org/images/mocha-chaijs.png" style="max-width: 100%; border:0;" alt="mocha and chai.js">
</div>


<h2>Why Test?</h2>

<p>Before diving in it&rsquo;s important that you understand <em>why</em> tests are necessary.</p>

<p>Grab the Node/Express sample CRUD application from the <a href="https://github.com/mjhea0/node-mocha-chai-tutorial">repository</a>:</p>

<pre><code class="sh">$ git clone https://github.com/mjhea0/node-mocha-chai-tutorial.git
$ git checkout tags/v1
</code></pre>

<p>Once you have <em>v1</em> of the app, manually go through it and test each of the CRUD functions via cURL (or <a href="http://httpie.org/">HTTPie</a> or <a href="https://www.getpostman.com/">Postman</a>):</p>

<ol>
<li>Add new blobs</li>
<li>View all blobs</li>
<li>View a single blob</li>
<li>Update a single blob</li>
<li>Delete a single blob</li>
</ol>


<p>This is a tedious process. What if you had to go through this same manual process <em>every</em> single time a new feature got added to the application? That would not only be a massive misuse of time - but unreliable as well. Hence the need for setting up a testing framework for automating the testing of the application, so you can run hundreds of tests in a matter of seconds.</p>

<p>With that, install Mocha:</p>

<pre><code class="sh">$ npm install -g mocha@2.3.1
</code></pre>

<blockquote><p>We installed this globally so we&rsquo;ll be able to run <code>mocha</code> from the terminal.</p></blockquote>

<h2>Structure</h2>

<p>To set up the basic tests, create a new folder called &ldquo;test&rdquo; in the project root, then within that folder add a file called <em>test-server.js</em>. Your file/folder structure should now look like:</p>

<pre><code class="sh">├── package.json
├── server
│   ├── app.js
│   ├── models
│   │   └── blob.js
│   └── routes
│       └── index.js
└── test
    └── test-server.js
</code></pre>

<p>Now add the following code to the new file:</p>

<pre><code class="javascript">describe('Blobs', function() {
  it('should list ALL blobs on /blobs GET');
  it('should list a SINGLE blob on /blob/&lt;id&gt; GET');
  it('should add a SINGLE blob on /blobs POST');
  it('should update a SINGLE blob on /blob/&lt;id&gt; PUT');
  it('should delete a SINGLE blob on /blob/&lt;id&gt; DELETE');
});
</code></pre>

<p>Although this is just boilerplate, pay attention to the <code>describe()</code> block and <code>it()</code> statements. <code>describe()</code> is used for grouping tests in a logical manner. Meanwhile, the <code>it()</code> statements contain each individual test case, which generally (err, <em>should</em>) test a single feature or edge case.</p>

<h2>Logic</h2>

<p>To add the necessary logic, we&rsquo;ll utilize <a href="http://chaijs.com/">Chai</a> (v3.2.0), an assertion library, and <a href="http://chaijs.com/plugins/chai-http">chai-http</a> (v 1.0.0), for making the actual HTTP requests and then testing the responses.</p>

<p>Install them both now:</p>

<pre><code class="sh">$ npm install chai@3.2.0 chai-http@1.0.0 --save-dev
</code></pre>

<p>Then update <em>test-server.js</em>, like so:</p>

<pre><code class="javascript">var chai = require('chai');
var chaiHttp = require('chai-http');
var server = require('../server/app');
var should = chai.should();

chai.use(chaiHttp);


describe('Blobs', function() {
  it('should list ALL blobs on /blobs GET');
  it('should list a SINGLE blob on /blob/&lt;id&gt; GET');
  it('should add a SINGLE blob on /blobs POST');
  it('should update a SINGLE blob on /blob/&lt;id&gt; PUT');
  it('should delete a SINGLE blob on /blob/&lt;id&gt; DELETE');
});
</code></pre>

<p>Here, we required the new packages, <code>chai</code> and <code>chai-http</code>, and our <em>app.js</em> file in order to make requests to the app. We also used the <code>should</code> assertion library so we can utilize <a href="http://chaijs.com/api/bdd/">BDD-style assertions</a>.</p>

<blockquote><p>One of the powerful aspects of Chai is that it allows you to choose the type of assertion style you&rsquo;d like to use. Check out the <a href="http://chaijs.com/guide/styles/">Assertion Style Guide</a> for more info. Also, aside for the assertion libraries included with Chai, there are a number of other libraries available via <a href="https://github.com/mochajs/mocha/wiki#assertion-libraries">NPM</a> and <a href="https://github.com/search?utf8=%E2%9C%93&amp;q=chai+assertion&amp;type=Repositories&amp;ref=searchresults">Github</a>.</p></blockquote>

<p>Now we can write our tests&hellip;</p>

<h2>Test - GET (all)</h2>

<p>Update the first <code>it()</code> statement:</p>

<pre><code class="javascript">it('should list ALL blobs on /blobs GET', function(done) {
  chai.request(server)
    .get('/blobs')
    .end(function(err, res){
      res.should.have.status(200);
      done();
    });
});
</code></pre>

<p>So, we passed an anonymous function with a single argument of <code>done</code> (a function) to the <code>it()</code> statement. This argument ends the test case when called - e.g., <code>done()</code>. The test itself is simple: We made a GET request to the <code>/blobs</code> endpoint and then asserted that the response contained a 200 HTTP status code.</p>

<p>Simple, right?</p>

<p>To test, simply run <code>mocha</code>; and if all went well, you should see:</p>

<pre><code class="sh">$ mocha


  Blobs
Connected to Database!
GET /blobs 200 19.621 ms - 2
    ✓ should list ALL blobs on /blobs GET (43ms)
    - should list a SINGLE blob on /blob/&lt;id&gt; GET
    - should add a SINGLE blob on /blobs POST
    - should update a SINGLE blob on /blob/&lt;id&gt; PUT
    - should delete a SINGLE blob on /blob/&lt;id&gt; DELETE


  1 passing (72ms)
  4 pending
</code></pre>

<p>Since testing the status code alone isn&rsquo;t very significant, let&rsquo;s add some more assertions:</p>

<pre><code class="javascript">it('should list ALL blobs on /blobs GET', function(done) {
  chai.request(server)
    .get('/blobs')
    .end(function(err, res){
      res.should.have.status(200);
      res.should.be.json;
      res.body.should.be.a('array');
      done();
    });
});
</code></pre>

<p>This should be straightforward, since these assertions read like plain English. Run the test suite again. It passes, right? This test still isn&rsquo;t complete, since we&rsquo;re not testing any of the <em>actual</em> data being returned. We&rsquo;ll get to that shortly.</p>

<p>How about testing a POST request&hellip;</p>

<h2>Test - POST</h2>

<p>Based on the code within <em>index.js</em>, when a new &ldquo;blob&rdquo; is successfully added, we should see the following response:</p>

<pre><code class="sh">{
  "SUCCESS": {
    "__v": 0,
    "name": "name",
    "lastName": "lastname",
    "_id": "some-unique-id"
  }
}
</code></pre>

<blockquote><p>Need proof? Test this out by logging <code>{'SUCCESS': newBlob}</code> to the console, and then run a manual test to see what gets logged.</p></blockquote>

<p>With that, think about how you would write/structure your assertions to test this&hellip;</p>

<pre><code class="javascript">it('should add a SINGLE blob on /blobs POST', function(done) {
  chai.request(server)
    .post('/blobs')
    .send({'name': 'Java', 'lastName': 'Script'})
    .end(function(err, res){
      res.should.have.status(200);
      res.should.be.json;
      res.body.should.be.a('object');
      res.body.should.have.property('SUCCESS');
      res.body.SUCCESS.should.be.a('object');
      res.body.SUCCESS.should.have.property('name');
      res.body.SUCCESS.should.have.property('lastName');
      res.body.SUCCESS.should.have.property('_id');
      res.body.SUCCESS.name.should.equal('Java');
      res.body.SUCCESS.lastName.should.equal('Script');
      done();
    });
});
</code></pre>

<p>Need help understanding what&rsquo;s happening here? Add <code>console.log(res.body)</code> just before the first assert. Run the test to see the data contained within the response body. The test we wrote tests the actual structure and data from the response body, broken down by each individual key/value pair.</p>

<h2>Hooks</h2>

<p>Up to this point we have been using the main database for testing purposes, which is not ideal since we&rsquo;re polluting the database with test data. Instead, let&rsquo;s utilize a test database and add a dummy blob to it to assert against. To do this, we can use the <code>beforeEach()</code> and <code>afterEach()</code> <a href="http://mochajs.org/#hooks">hooks</a> - which, as the names suggest, add and remove a dummy document to the database before and after each test case is ran.</p>

<p>This sounds a bit difficult, but with Mocha it&rsquo;s super easy!</p>

<p>Start by adding a configuration file called <em>_config.js</em> to the &ldquo;server&rdquo; folder in order to specify a different database URI for testing purposes:</p>

<pre><code class="javascript">var config = {};

config.mongoURI = {
  development: 'mongodb://localhost/node-testing',
  test: 'mongodb://localhost/node-test'
};

module.exports = config;
</code></pre>

<p>Next, update <em>app.js</em> to utilize the test database when the environment variable <code>app.settings.env</code> evaluates to <code>test</code>. (The default is <code>development</code>.)</p>

<pre><code class="javascript">// *** config file *** //
var config = require('./_config');

// *** mongoose *** ///
mongoose.connect(config.mongoURI[app.settings.env], function(err, res) {
  if(err) {
    console.log('Error connecting to the database. ' + err);
  } else {
    console.log('Connected to Database: ' + config.mongoURI[app.settings.env]);
  }
});
</code></pre>

<p>Finally, update the requirements and add the hooks to the testing script:</p>

<pre><code class="javascript">process.env.NODE_ENV = 'test';

var chai = require('chai');
var chaiHttp = require('chai-http');
var mongoose = require("mongoose");

var server = require('../server/app');
var Blob = require("../server/models/blob");

var should = chai.should();
chai.use(chaiHttp);


describe('Blobs', function() {

  Blob.collection.drop();

  beforeEach(function(done){
    var newBlob = new Blob({
      name: 'Bat',
      lastName: 'man'
    });
    newBlob.save(function(err) {
      done();
    });
  });
  afterEach(function(done){
    Blob.collection.drop();
    done();
  });

...snip...
</code></pre>

<p>Now, before each test case, the database is cleared and a new blob is added; then, after each test, the database is cleared before the next test case is ran.</p>

<p>Run the tests again to ensure they still pass.</p>

<h2>Test - GET (all)</h2>

<p>With the hooks set up, let&rsquo;s refactor the first test to assert that the blob from the <code>beforeEach()</code> is part of the collection:</p>

<pre><code class="javascript">it('should list ALL blobs on /blobs GET', function(done) {
  chai.request(server)
    .get('/blobs')
    .end(function(err, res){
      res.should.have.status(200);
      res.should.be.json;
      res.body.should.be.a('array');
      res.body[0].should.have.property('_id');
      res.body[0].should.have.property('name');
      res.body[0].should.have.property('lastName');
      res.body[0].name.should.equal('Bat');
      res.body[0].lastName.should.equal('man');
      done();
    });
});
</code></pre>

<p>Let&rsquo;s look at the final three tests&hellip;</p>

<h2>Test - GET (single)</h2>

<pre><code class="javascript">it('should list a SINGLE blob on /blob/&lt;id&gt; GET', function(done) {
    var newBlob = new Blob({
      name: 'Super',
      lastName: 'man'
    });
    newBlob.save(function(err, data) {
      chai.request(server)
        .get('/blob/'+data.id)
        .end(function(err, res){
          res.should.have.status(200);
          res.should.be.json;
          res.body.should.be.a('object');
          res.body.should.have.property('_id');
          res.body.should.have.property('name');
          res.body.should.have.property('lastName');
          res.body.name.should.equal('Super');
          res.body.lastName.should.equal('man');
          res.body._id.should.equal(data.id);
          done();
        });
    });
});
</code></pre>

<p>In this test case, we first added a new blob, and then used the newly created <code>_id</code> to make the request and then test the subsequent response.</p>

<h2>Test - PUT</h2>

<pre><code class="javascript">it('should update a SINGLE blob on /blob/&lt;id&gt; PUT', function(done) {
  chai.request(server)
    .get('/blobs')
    .end(function(err, res){
      chai.request(server)
        .put('/blob/'+res.body[0]._id)
        .send({'name': 'Spider'})
        .end(function(error, response){
          response.should.have.status(200);
          response.should.be.json;
          response.body.should.be.a('object');
          response.body.should.have.property('UPDATED');
          response.body.UPDATED.should.be.a('object');
          response.body.UPDATED.should.have.property('name');
          response.body.UPDATED.should.have.property('_id');
          response.body.UPDATED.name.should.equal('Spider');
          done();
      });
    });
});
</code></pre>

<p>Here, we hit the <code>/blobs</code> endpoint with a GET request to grab the blob added from the <code>beforeEach()</code> hook, then we simply added the <code>_id</code> to the URL for the PUT request and updated the name to <code>Spider</code>.</p>

<h2>Test - DELETE</h2>

<p>Finally&hellip;</p>

<pre><code class="javascript">it('should delete a SINGLE blob on /blob/&lt;id&gt; DELETE', function(done) {
  chai.request(server)
    .get('/blobs')
    .end(function(err, res){
      chai.request(server)
        .delete('/blob/'+res.body[0]._id)
        .end(function(error, response){
          response.should.have.status(200);
          response.should.be.json;
          response.body.should.be.a('object');
          response.body.should.have.property('REMOVED');
          response.body.REMOVED.should.be.a('object');
          response.body.REMOVED.should.have.property('name');
          response.body.REMOVED.should.have.property('_id');
          response.body.REMOVED.name.should.equal('Bat');
          done();
      });
    });
});
</code></pre>

<h2>Conclusion</h2>

<p>Hopefully you can now see just how easy it is to test your code with Mocha and Chai. Keep practicing on your own, incorporating a true <a href="https://mochajs.org/#bdd">BDD</a> approach into your workflow. Grab the final code for this tutorial from the <a href="https://github.com/mjhea0/node-mocha-chai-tutorial">repository</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Node, Express, Swig, and MongoDB - Getting Started With CRUD]]></title>
    <link href="http://mherman.org/blog/2015/08/24/node-express-swig-mongo-primer/"/>
    <updated>2015-08-24T08:11:00-06:00</updated>
    <id>http://mherman.org/blog/2015/08/24/node-express-swig-mongo-primer</id>
    <content type="html"><![CDATA[<p><strong>Let&rsquo;s create a basic CRUD app using Node, Express, Swig, and MongoDB.</strong></p>

<div style="text-align:center;">
  <img src="http://mherman.org/images/node-express.png" style="max-width: 100%; border:0;" alt="mean stack authentication">
</div>


<p><br></p>

<blockquote><p>This tutorial utilizes <a href="http://nodejs.org/">Node</a> v0.12.5, <a href="http://expressjs.com/">Express</a> v4.13.1, <a href="http://paularmstrong.github.io/swig/">Swig</a> and <a href="http://mongoosejs.com/">Mongoose</a> v4.1.3.</p></blockquote>

<h2>Getting started</h2>

<p>Start by downloading the <a href="http://expressjs.com/starter/generator.html">Express application generator</a> (if you don&rsquo;t already have it) to create a basic Express project:</p>

<pre><code class="sh">$ npm install express-generator -g
</code></pre>

<blockquote><p>The <code>-g</code> flag indicates that you want to install the package globally, on your entire system.</p></blockquote>

<p>Navigate to a convenient directory, like your &ldquo;Desktop&rdquo; or &ldquo;Documents&rdquo;, then create the boilerplate:</p>

<pre><code class="sh">$ express node-express-swig-mongo
$ cd node-express-swig-mongo
</code></pre>

<p>Check out the project structure:</p>

<pre><code class="sh">├── app.js
├── bin
│   └── www
├── package.json
├── public
│   ├── images
│   ├── javascripts
│   └── stylesheets
│       └── style.css
├── routes
│   ├── index.js
│   └── users.js
└── views
    ├── error.jade
    ├── index.jade
    └── layout.jade
</code></pre>

<p>Don&rsquo;t worry about the files and folders for now. Just know that we have created a boilerplate that can be used for a number of Node/Express applications. This took care of the heavy lifting, adding common files, folders, and scripts generally associated with all apps.</p>

<p>Notice the <em>package.json</em> file. This stores your project&rsquo;s dependencies, which we still need to install:</p>

<pre><code class="sh">$ npm install
</code></pre>

<p>Now let&rsquo;s install Mongoose and Swig:</p>

<pre><code class="sh">$ npm install mongoose swig --save
</code></pre>

<blockquote><p>The <code>--save</code> flag adds the dependencies and their versions to the <em>package.json</em> file. Take a look.</p></blockquote>

<h2>Sanity check</h2>

<p>Let&rsquo;s test our setup by running the app:</p>

<pre><code class="sh">$ npm start
</code></pre>

<p>Navigate to <a href="http://localhost:3000/">http://localhost:3000/</a> in your browser and you should see the &ldquo;Welcome to Express&rdquo; text. Once done, kill the server by pressing CTRL-C.</p>

<h2>Nodemon</h2>

<p>Before moving on, let&rsquo;s setup <a href="http://nodemon.io/">Nodemon</a> so that you can run your app and watch for code changes without having to manually restart the server. Check out the link above to learn more.</p>

<pre><code class="sh">$ npm install nodemon -g
</code></pre>

<p>Let&rsquo;s test again:</p>

<pre><code class="sh">$ nodemon
</code></pre>

<p>In your terminal you should see:</p>

<pre><code class="sh">23 Aug 16:31:02 - [nodemon] v1.4.1
23 Aug 16:31:02 - [nodemon] to restart at any time, enter `rs`
23 Aug 16:31:02 - [nodemon] watching: *.*
23 Aug 16:31:02 - [nodemon] starting `node ./bin/www`
</code></pre>

<p>Essentially, Nodemon is watching for code changes, and if they do occur, then it will refresh the local server for you so you don&rsquo;t have to constantly kill the server then start it back up. It saves a lot of time and keystrokes.</p>

<p>Awesome. With the setup done, let&rsquo;s build something!</p>

<h2>Routes</h2>

<p>Grab your favorite text editor (such as <a href="http://www.sublimetext.com/">Sublime</a> or <a href="https://atom.io/">Atom</a>), and then open the main file, <em>app.js</em>, which houses much of the business logic. Take a look at the routes:</p>

<pre><code class="javascript">app.use('/', routes);
app.use('/users', users);
</code></pre>

<p>Understanding how routes work as well as how to trace all the files associated with an individual route is an important skill to learn. You&rsquo;ll be able to approach most applications and understand how they work just by starting with the routes.</p>

<p>Let&rsquo;s look at this route:</p>

<pre><code class="javascript">app.use('/users', users)
</code></pre>

<p>Here, we know that this route is associated with the <code>/users</code> endpoint. What&rsquo;s an endpoint? Simply navigate to <a href="http://localhost:3000/users">http://localhost:3000/users</a>.</p>

<p>The end user navigates to that endpoint and expects <em>something</em> to happen. That could mean some HTML is rendered or perhaps JSON is returned. That&rsquo;s not important at this point. For now, let&rsquo;s look at how Node handles the logic for &ldquo;handling routes&rdquo;.</p>

<p>Also, within that route, you can see the variable <code>users</code>. Where is in this file? It&rsquo;s at the top, and it loads in another file within our app:</p>

<pre><code class="javascript">var users = require('./routes/users');
</code></pre>

<p>Open that file:</p>

<pre><code class="javascript">var express = require('express');
var router = express.Router();

/* GET users listing. */
router.get('/', function(req, res) {
  res.send('respond with a resource');
});

module.exports = router;
</code></pre>

<p><strong>What&rsquo;s happening here?</strong> Essentially when that endpoint is hit, it responds by sending text in the form of a response to the end user - &ldquo;respond with a resource&rdquo;. Now, of course you don&rsquo;t always have to send text. You could respond with a template or view like a Jade or Swig template file that gets rendered into HTML. We&rsquo;ll look at how this works in just a minute when we add our own routes.</p>

<p><strong>Make sure you understand everything in this section before moving on.</strong></p>

<h3>Add a new route</h3>

<p>Let&rsquo;s now add a new route that renders a HTML form to the end user.</p>

<p>Start by adding the route handler in the <em>app.js</em> file:</p>

<pre><code class="javascript">app.use('/api', api);
</code></pre>

<blockquote><p>Remember this simply means <code>app.use('/ENDPOINT', VARIABLE_NAME);</code>,</p></blockquote>

<p>Use the <code>api</code> variable to require a JS file within our routes folder.</p>

<pre><code class="javascript">var api = require('./routes/api');
</code></pre>

<p>Take a look in the terminal. You should see an error, indicating Node can&rsquo;t find the <code>./routes/api</code> module. We need to create it!</p>

<p>Create a new file called <em>api.js</em> in the &ldquo;routes&rdquo; directory. Add the following code:</p>

<pre><code class="javascript">var express = require('express');
var router = express.Router();


router.get('/superheros', function(req, res) {
  res.send('Just a test');
});

module.exports = router;
</code></pre>

<blockquote><p>Do you remember what this code <code>res.send('Just a test');</code> will do? If not, review the previous section.</p></blockquote>

<p>Navigate to <a href="http://localhost:3000/api/superheros">http://localhost:3000/api/superheros</a>. You should see the text &ldquo;Just a test&rdquo; on the page.</p>

<h2>Swig</h2>

<p>Swig is a templating language, which compiles down to HTML, making it easy to separate logic from markup. For more on Swig, check out the <a href="http://mherman.org/blog/2015/08/23/primer-on-swig-templating/#.VdpL_VNViko">Primer on Swig Templating</a>.</p>

<p>Take a quick look at the <em>layout.jade</em>, <em>index.jade</em>, and <em>error.jade</em> files within the &ldquo;views&rdquo; folder. Right now these files are using <a href="http://jade-lang.com/">Jade</a> templating. Let&rsquo;s update these files to remove Jade and add Swig. First, remove the <em>.jade</em> extension from each file and add a <em>.html</em> extension. Now we can update the actual syntax&hellip;</p>

<p><strong><em>layout.html</em></strong></p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="ni">&amp;lt;</span>!DOCTYPE html&gt;
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'>  <span class="nt">&lt;head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;title&gt;</span>{{ title }}<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;//netdna.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;http://mherman.org/css/main.css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;body&gt;</span>
</span><span class='line'>    {% block content %}
</span><span class='line'>    {% endblock %}
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;//code.jquery.com/jquery-2.1.4.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;http://mherman.org/js/main.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span><span class='line'>{% endr
</span><span class='line'>{% endcodeblock %}aw %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;&lt;strong&gt;&lt;em&gt;</span>index.html<span class="nt">&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% codeblock lang:html %}
</span><span class='line'>{% raw %}
</span><span class='line'>{% extends <span class="ni">&amp;lsquo;</span>layout.html<span class="ni">&amp;rsquo;</span> %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% block title %}{% endblock %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% block content %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;pre&gt;&lt;code&gt;</span><span class="ni">&amp;lt;</span>h1<span class="ni">&amp;gt;</span>{{ title }}<span class="ni">&amp;lt;</span>/h1<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>p<span class="ni">&amp;gt;</span>Welcome to {{ title }}<span class="ni">&amp;lt;</span>/p<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="nt">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;/div&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% endblock %}
</span></code></pre></td></tr></table></div></figure></p>

<p><strong><em>error.html</em></strong></p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>{% extends <span class="ni">&amp;lsquo;</span>layout.html<span class="ni">&amp;rsquo;</span> %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% block title %}{% endblock %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% block content %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;pre&gt;&lt;code&gt;</span><span class="ni">&amp;lt;</span>h1<span class="ni">&amp;gt;</span>{{ message }}<span class="ni">&amp;lt;</span>/h1<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>h2<span class="ni">&amp;gt;</span>{{ error.status }}<span class="ni">&amp;lt;</span>/h2<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>pre<span class="ni">&amp;gt;</span>{{ error.stack }}<span class="ni">&amp;lt;</span>/pre<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="nt">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;/div&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% endblock %}
</span></code></pre></td></tr></table></div></figure></p>

<p>Finally, update <em>app.js</em> by requiring the following dependency at the top of the file:</p>

<pre><code class="javascript">var swig = require('swig');
</code></pre>

<p>Then set Swig as the template engine by replacing <code>app.set('view engine', 'jade');</code> with-</p>

<pre><code class="javascript">var swig = new swig.Swig();
app.engine('html', swig.renderFile);
app.set('view engine', 'html');
</code></pre>

<p>Jump back to the &ldquo;views&rdquo;, and take a look at <em>layout.html</em> and <em>index.html</em>. There&rsquo;s a relationship between those two files. We define the base structure in the <em>layout</em> file, which contains common structure that can be reused in multiple places.</p>

<p>Do you see the <code>block</code> keyword?</p>

<p>What really happens when the <em>index</em> file is rendered is that it first renders the base template because of the <code>extends</code> keyword. So, the <em>layout</em> template then gets rendered, which eventually pulls in the child template, overwriting the <code>block</code> keyword with:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;h1&gt;</span>{{ title }}<span class="nt">&lt;/h1&gt;</span>
</span><span class='line'>  <span class="nt">&lt;p&gt;</span>Welcome to {{ title }}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% end
</span><span class='line'>{% endcodeblock %}raw %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>Hope that makes sense. If not, check out <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://mherman.org/blog/2015/08/23/primer-on-swig-templating/#template-inheritence&quot;</span><span class="nt">&gt;</span>this<span class="nt">&lt;/a&gt;</span> resource for more info on template inheritance.<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;h3&gt;</span>Setup <span class="nt">&lt;em&gt;</span>api.html<span class="nt">&lt;/em&gt;&lt;/h3&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>Create a new file called <span class="nt">&lt;em&gt;</span>api.html<span class="nt">&lt;/em&gt;</span> in the <span class="ni">&amp;ldquo;</span>views<span class="ni">&amp;rdquo;</span> directory, and then add the following code:<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% codeblock lang:html %}
</span><span class='line'>{% raw %}
</span><span class='line'>{% extends <span class="ni">&amp;lsquo;</span>layout.html<span class="ni">&amp;rsquo;</span> %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% block title %}{% endblock %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% block content %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;pre&gt;&lt;code&gt;</span><span class="ni">&amp;lt;</span>h1<span class="ni">&amp;gt;</span>{{ title }}<span class="ni">&amp;lt;</span>/h1<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>p<span class="ni">&amp;gt;</span>Welcome to {{ title }}<span class="ni">&amp;lt;</span>/p<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="nt">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;/div&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% endblock %}
</span></code></pre></td></tr></table></div></figure></p>

<p>The same thing is happening here with inheritance. If you&rsquo;re unfamiliar with Swig syntax, <code>{{ title }}</code> is essentially a variable, which we can pass in from <code>./routes/api.js</code>.</p>

<p>Update <code>./routes/api.js</code> by changing-</p>

<pre><code class="javascript">res.send('Just a test');
</code></pre>

<p>-to-</p>

<pre><code class="javascript">res.render('api', { title: 'Superhero API' });
</code></pre>

<p>This just says, &ldquo;When a user hits the <code>/api/superheros</code> endpoint, render the <em>api.html</em> file and pass in <code>Superhero API</code> as the title.&rdquo;</p>

<blockquote><p>Keep in mind that all Swig files are converted to HTML since browsers can&rsquo;t read the Swig templating syntax.</p></blockquote>

<p>Ready to test? Simple refresh <a href="http://localhost:3000/api/superheros">http://localhost:3000/api/superheros</a>.</p>

<p>Did it work? If yes, move on. If not, go back through this section and review.</p>

<h3>Update <em>api.html</em></h3>

<p>So, let&rsquo;s update the template to display a form:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>{% extends <span class="ni">&amp;lsquo;</span>layout.html<span class="ni">&amp;rsquo;</span> %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% block title %}{% endblock %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% block content %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;pre&gt;&lt;code&gt;</span><span class="ni">&amp;lt;</span>h1<span class="ni">&amp;gt;</span>{{ title }}<span class="ni">&amp;lt;</span>/h1<span class="ni">&amp;gt;</span>
</span><span class='line'>
</span><span class='line'><span class="ni">&amp;lt;</span>br<span class="ni">&amp;gt;</span>
</span><span class='line'>
</span><span class='line'><span class="ni">&amp;lt;</span>form method=&quot;post&quot; action=&quot;/api/superheros&quot; class=&quot;form-inline&quot;<span class="ni">&amp;gt;</span>
</span><span class='line'>  <span class="ni">&amp;lt;</span>div class=&quot;form-group&quot;<span class="ni">&amp;gt;</span>
</span><span class='line'>    <span class="ni">&amp;lt;</span>label<span class="ni">&amp;gt;</span>Superhero name<span class="ni">&amp;lt;</span>/label<span class="ni">&amp;gt;</span>
</span><span class='line'>    <span class="ni">&amp;lt;</span>input type=&quot;text&quot; name=&quot;name&quot; class=&quot;form-control&quot; required<span class="ni">&amp;gt;</span>
</span><span class='line'>  <span class="ni">&amp;lt;</span>/div<span class="ni">&amp;gt;</span>
</span><span class='line'>  <span class="ni">&amp;lt;</span>button type=&quot;submit&quot; class=&quot;btn btn-default&quot;<span class="ni">&amp;gt;</span>Save<span class="ni">&amp;lt;</span>/button<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>/form<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="nt">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;/div&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% endblock %}
</span></code></pre></td></tr></table></div></figure></p>

<p>Refresh your browser. Do you see the form? Try clicking save. What happens? Well, you just tried to send a POST request to the <code>/api/superheros</code> endpoint, which does not exist - so you should see a 404 error. Let&rsquo;s set up the route handler.</p>

<h2>POST requests (part 1)</h2>

<p>Open <em>api.js</em> to add the logic for this new route:</p>

<pre><code class="javascript">var express = require('express');
var router = express.Router();


router.get('/superheros', function(req, res) {
  res.render('api', { title: 'Superhero API' });
});

router.post('/superheros', function(req, res) {
  console.log(req.body.name);
  res.redirect('/api/superheros');
});

module.exports = router;
</code></pre>

<p>Test this out again. Now, when you submit the form, we have the <code>/api/superheros</code> endpoint setup, which then grabs the text from the input box via <code>req.body.name</code>. Make sure the text is consoled in your terminal.</p>

<p>Okay. So, we are handling the routes and rendering the right template, but we still need to setup Mongoose to save the data from our form before we can finish with the POST request.</p>

<h2>Mongoose</h2>

<p><a href="http://mongoosejs.com/">Mongoose</a> is used for interacting with MongoDB. Start with defining the Schema, which then maps to a collection in Mongo.</p>

<p>Create a file called <em>database.js</em> in your app&rsquo;s root directory, then add the following code:</p>

<pre><code class="javascript">var mongoose = require('mongoose');
var Schema   = mongoose.Schema;

var Superhero = new Schema(
  {name : String}
);

mongoose.model('superheros', Superhero);

mongoose.connect('mongodb://localhost/node-superhero');
</code></pre>

<p>Here, we required/included the Mongoose library along with a reference to the <code>Schema()</code> method. As said, you always start with defining the schema, then we linked it to collection called &ldquo;superheros&rdquo;. Finally, we opened a connection to an instance of our local MongoDB.</p>

<blockquote><p>If you don&rsquo;t have the MongoDB server running. Do so now. Open a new terminal window, and run the command <code>sudo mongod</code>. If you need to set up MongoDB, follow the Installation steps <a href="http://docs.mongodb.org/manual/tutorial/install-mongodb-on-os-x/">here</a>.</p></blockquote>

<p>Next, open <em>app.js</em> and require the Mongoose config at the very top of the file:</p>

<pre><code class="javascript">// mongoose config
require('./database');
</code></pre>

<p>With Mongoose setup, we need to update <em>api.js</em> to create (via POST) and read (via GET) data from the Mongo collection.</p>

<h2>GET requests (all resources)</h2>

<p>Open <em>api.js</em>. Require Mongoose as well as the <code>superheros</code> model, which we already created:</p>

<pre><code class="javascript">var mongoose = require('mongoose');
var Superhero = mongoose.model('superheros');
</code></pre>

<p>Now, update the function handling GET requests:</p>

<pre><code class="javascript">router.get('/superheros', function(req, res) {
  Superhero.find(function(err, superheros){
    console.log(superheros)
    res.render(
      'api',
      {title : 'Superhero API', superheros : superheros}
    );
  });
});
</code></pre>

<p><code>Superhero.find()</code> grabs all superheros from the Mongo collection, which we assign to the variable <code>superheros</code>. We can now use that variable in the Swig template.</p>

<h3>Update <em>api.html</em> to display superheros</h3>

<p>Let&rsquo;s add a loop to iterate through the superheros and then display the <code>name</code> key from the collection.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>{% extends <span class="ni">&amp;lsquo;</span>layout.html<span class="ni">&amp;rsquo;</span> %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% block title %}{% endblock %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% block content %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;pre&gt;&lt;code&gt;</span><span class="ni">&amp;lt;</span>h1<span class="ni">&amp;gt;</span>{{ title }}<span class="ni">&amp;lt;</span>/h1<span class="ni">&amp;gt;</span>
</span><span class='line'>
</span><span class='line'><span class="ni">&amp;lt;</span>br<span class="ni">&amp;gt;</span>
</span><span class='line'>
</span><span class='line'><span class="ni">&amp;lt;</span>form method=&quot;post&quot; action=&quot;/api/superheros&quot; class=&quot;form-inline&quot;<span class="ni">&amp;gt;</span>
</span><span class='line'>  <span class="ni">&amp;lt;</span>div class=&quot;form-group&quot;<span class="ni">&amp;gt;</span>
</span><span class='line'>    <span class="ni">&amp;lt;</span>label<span class="ni">&amp;gt;</span>Superhero name<span class="ni">&amp;lt;</span>/label<span class="ni">&amp;gt;</span>
</span><span class='line'>    <span class="ni">&amp;lt;</span>input type=&quot;text&quot; name=&quot;name&quot; class=&quot;form-control&quot; required<span class="ni">&amp;gt;</span>
</span><span class='line'>  <span class="ni">&amp;lt;</span>/div<span class="ni">&amp;gt;</span>
</span><span class='line'>  <span class="ni">&amp;lt;</span>button type=&quot;submit&quot; class=&quot;btn btn-default&quot;<span class="ni">&amp;gt;</span>Save<span class="ni">&amp;lt;</span>/button<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>/form<span class="ni">&amp;gt;</span>
</span><span class='line'>
</span><span class='line'><span class="ni">&amp;lt;</span>hr<span class="ni">&amp;gt;&amp;lt;</span>br<span class="ni">&amp;gt;</span>
</span><span class='line'>
</span><span class='line'><span class="ni">&amp;lt;</span>h2<span class="ni">&amp;gt;</span>All Superheros<span class="ni">&amp;lt;</span>/h2<span class="ni">&amp;gt;</span>
</span><span class='line'>
</span><span class='line'><span class="ni">&amp;lt;</span>ul<span class="ni">&amp;gt;</span>
</span><span class='line'>{% for superhero in superheros %}
</span><span class='line'>  <span class="ni">&amp;lt;</span>li<span class="ni">&amp;gt;</span>{{superhero.name}}<span class="ni">&amp;lt;</span>/li<span class="ni">&amp;gt;</span>
</span><span class='line'>{% endfor %}
</span><span class='line'><span class="ni">&amp;lt;</span>/ul<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="nt">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;/div&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% endblock %}
</span></code></pre></td></tr></table></div></figure></p>

<blockquote><p>Do you remember where we set the <code>name</code> key? Check out the database schema in <em>database.js</em>.</p></blockquote>

<p>Before this will actually work - e.g., display superheros - we first need to add the logic to insert data into the Mongo collection.</p>

<h2>POST requests (part 2)</h2>

<p>Back in <em>api.js</em>, update the function for handling POST requests:</p>

<pre><code class="javascript">router.post('/superheros', function(req, res) {
  new Superhero({name : req.body.name})
  .save(function(err, superhero) {
    console.log(superhero)
    res.redirect('/api/superheros');
  });
});
</code></pre>

<p>This simply saves a new superhero, which again is grabbed from the form via <code>req.body.name</code>.</p>

<h2>Sanity Check</h2>

<p>Refresh you app. Add some superheros. If you&rsquo;ve done everything correctly, the superheros should be displayed beneath the form.</p>

<p>What about updates? And deletions? First, let&rsquo;s display a single superhero.</p>

<h2>GET requests (single resource)</h2>

<p>Update the list item in the HTML file like so to give each item a unique URL.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;superhero/{{superhero.id}}&quot;</span><span class="nt">&gt;</span>{{superhero.name}}<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Now, let&rsquo;s add a new route handler to <em>api.js</em> to display a single superhero:</p>

<pre><code class="javascript">router.get('/superhero/:id', function(req, res) {
  var query = {"_id": req.params.id};
  Superhero.findOne(query, function(err, superhero){
    console.log(superhero)
    res.render(
      'superhero',
      {title : 'Superhero API - ' + superhero.name, superhero : superhero}
    );
  });
});
</code></pre>

<p>What&rsquo;s next? A new template. <em>superhero.html</em>:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>{% extends <span class="ni">&amp;lsquo;</span>layout.html<span class="ni">&amp;rsquo;</span> %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% block title %}{% endblock %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% block content %}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;pre&gt;&lt;code&gt;</span><span class="ni">&amp;lt;</span>h1<span class="ni">&amp;gt;</span>{{ title }}<span class="ni">&amp;lt;</span>/h1<span class="ni">&amp;gt;</span>
</span><span class='line'>
</span><span class='line'><span class="ni">&amp;lt;</span>br<span class="ni">&amp;gt;</span>
</span><span class='line'>
</span><span class='line'><span class="ni">&amp;lt;</span>form method=&quot;post&quot; action=&quot;/api/superhero/{{superhero.id}}?_method=PUT&quot;<span class="ni">&amp;gt;</span>
</span><span class='line'>  <span class="ni">&amp;lt;</span>div class=&quot;form-group&quot;<span class="ni">&amp;gt;</span>
</span><span class='line'>    <span class="ni">&amp;lt;</span>label<span class="ni">&amp;gt;</span>Superhero name<span class="ni">&amp;lt;</span>/label<span class="ni">&amp;gt;</span>
</span><span class='line'>    <span class="ni">&amp;lt;</span>input type=&quot;text&quot; name=&quot;name&quot; class=&quot;form-control&quot; value=&quot;{{superhero.name}}&quot; required<span class="ni">&amp;gt;</span>
</span><span class='line'>  <span class="ni">&amp;lt;</span>/div<span class="ni">&amp;gt;</span>
</span><span class='line'>  <span class="ni">&amp;lt;</span>button type=&quot;submit&quot; class=&quot;btn btn-default&quot;<span class="ni">&amp;gt;</span>Update<span class="ni">&amp;lt;</span>/button<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>/form<span class="ni">&amp;gt;</span>
</span><span class='line'>
</span><span class='line'><span class="ni">&amp;lt;</span>br<span class="ni">&amp;gt;</span>
</span><span class='line'>
</span><span class='line'><span class="ni">&amp;lt;</span>form method=&quot;post&quot; action=&quot;/api/superhero/{{superhero.id}}?_method=DELETE&quot; class=&quot;form-inline&quot;<span class="ni">&amp;gt;</span>
</span><span class='line'>  <span class="ni">&amp;lt;</span>button type=&quot;submit&quot; class=&quot;btn btn-default&quot;<span class="ni">&amp;gt;</span>Delete<span class="ni">&amp;lt;</span>/button<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>/form<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="nt">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;/div&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>{% endblock %}
</span></code></pre></td></tr></table></div></figure></p>

<p>Test this out.</p>

<h2>PUT requests</h2>

<p>Since most browsers do not handle PUT or DELETE requests, we need to use the <a href="https://github.com/expressjs/method-override">method-override</a> middleware to handle such requests.</p>

<p>Install via NPM:</p>

<pre><code class="sh">$ npm install method-override --save
</code></pre>

<p>Add the requirement to <em>app.js</em>:</p>

<pre><code class="javascript">var methodOverride = require('method-override');
</code></pre>

<p>Then define the middleware just below the view engine setup in <em>app.js</em>:</p>

<pre><code class="javascript">app.use(methodOverride('_method'))
</code></pre>

<p>Finally, add the route handler to <em>api.js</em>:</p>

<pre><code class="javascript">router.put('/superhero/:id', function(req, res) {
  var query = {"_id": req.params.id};
  var update = {name : req.body.name};
  var options = {new: true};
  Superhero.findOneAndUpdate(query, update, options, function(err, superhero){
    console.log(superhero)
    res.render(
      'superhero',
      {title : 'Superhero API - ' + superhero.name, superhero : superhero}
    );
  });
});
</code></pre>

<p>Here, we are simply searching Mongo for the correct superhero via the Mongo ID and then updating the superhero name, which comes from the form, <code>req.body.name</code>. By setting <code>new</code> to <code>true</code>, we&rsquo;re able to grab the updated superhero information after the changes are made in Mongo. Try removing this option. What happens?</p>

<h2>DELETE requests</h2>

<p>With the button already set up in the template, we just need to add the route handler to <em>api.js</em>:</p>

<pre><code class="javascript">router.delete('/superhero/:id', function(req, res) {
  var query = {"_id": req.params.id};
  Superhero.findOneAndRemove(query, function(err, superhero){
    console.log(superhero)
    res.redirect('/api/superheros');
  });
});
</code></pre>

<p>Again, we&rsquo;re querying the database by the Mongo ID and then removing it. Simple, right?</p>

<h2>Conclusion</h2>

<p>That&rsquo;s it. Post your questions below. Grab the code from the <a href="https://github.com/mjhea0/node-express-swig-mongo">repository</a>. Cheers!</p>
]]></content>
  </entry>
  
</feed>
