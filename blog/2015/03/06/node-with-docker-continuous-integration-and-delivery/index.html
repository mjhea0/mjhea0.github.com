
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Node With Docker - Continuous Integration and Delivery - Michael Herman</title>
  <meta name="author" content="Michael Herman">

  
  <meta name="description" content="This article details how to set up your local development environment with Docker as well as continuous integration and delivery, step by step.">
  <meta name="keywords" content="node, docker, web development, express, continuous integration, tutum, docker compose, continuous delivery">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mherman.org/blog/2015/03/06/node-with-docker-continuous-integration-and-delivery">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Michael Herman" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Fjalla+One" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
<!--- MathJax Configuration -->
<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-37074204-1', 'auto');
    ga('send', 'pageview');

  </script>



</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Michael Herman</a></h1>
  
    <h2>Software Developer</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscribe" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 13.310204,73.332654 C 5.967347,73.332654 0,79.322448 0,86.621428 c 0,7.338776 5.967347,13.262246 13.310204,13.262246 7.370408,0 13.328572,-5.92245 13.328572,-13.262246 0,-7.29898 -5.958164,-13.288774 -13.328572,-13.288774 z M 0.01530612,33.978572 V 53.143878 C 12.493878,53.143878 24.229592,58.02347 33.068368,66.865306 41.894898,75.685714 46.767346,87.47449 46.767346,100 h 19.25 C 66.017346,63.592858 36.4,33.979592 0.01530612,33.978572 l 0,0 z M 0.03877552,0 V 19.17449 C 44.54796,19.17551 80.77551,55.437756 80.77551,100 H 100 C 100,44.87653 55.15102,0 0.03877552,0 z"></path></svg></a></li>
  
</ul>
  
  
  
  
  
  
  
  
  
  
    
      <form action="http://google.com/search" method="get">
        <fieldset role="search">
          <input type="hidden" name="sitesearch" value="mherman.org" />
    
          <input class="search" type="text" name="q" results="0" placeholder="Search"/>
        </fieldset>
      </form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Node With Docker - Continuous Integration and Delivery</h1>
      
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-06T08:05:00-07:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:05 am</span></time>
        
        
      </p>
    
  </header>


<div class="entry-content"><p>Welcome.</p>

<p><strong>This is a quick start guide for spinning up Docker containers that run NodeJS and Redis. We’ll look at a basic development workflow to manage the local development of an app, on Mac OS X, as well as continuous integration and delivery, step by step.</strong></p>

<div style="text-align:center;">
  <img src="https://raw.githubusercontent.com/mjhea0/node-docker-workflow/master/_presentation/images/logo.png" style="max-width: 100%; border:0;" alt="logo">
</div>


<p><br></p>

<p><strong>Updates</strong>:
  - <em>October 18th, 2015</em> - Upgraded to the latest versions of Docker (1.8.3), Docker Compose (1.4.2), and NodeJS (4.1.1). Added Docker Machine (0.4.1).
  - <em>May 13th, 2015</em> - Upgraded to the latest versions of Docker (1.6.1), boot2docker (1.6.1), and Docker Compose (1.2.0)</p>

<blockquote><p>This tutorial is ported from <a href="https://realpython.com/blog/python/docker-in-action-fitter-happier-more-productive/">Docker in Action - Fitter, Happier, More Productive</a>.</p></blockquote>

<p>We&rsquo;ll be using the following tools, technologies, and services in this post:</p>

<ol>
<li><a href="http://nodejs.org/">NodeJS</a> v4.1.1</li>
<li><a href="http://expressjs.com/">Express</a> v4.13.3</li>
<li><a href="http://redis.io/">Redis</a> v2.2.5</li>
<li><a href="https://www.docker.com/">Docker</a> v1.8.3</li>
<li><a href="https://docs.docker.com/compose/">Docker Compose</a> v1.4.2</li>
<li><a href="https://docs.docker.com/machine/">Docker Machine</a> v0.4.1</li>
<li><a href="https://hub.docker.com/">Docker Hub</a></li>
<li><a href="https://circleci.com/">CircleCI</a></li>
<li><a href="https://www.digitalocean.com/">Digital Ocean</a></li>
<li><a href="https://www.tutum.co/">Tutum</a></li>
</ol>


<blockquote><p>There&rsquo;s slides too! Check them out <a href="http://realpython.github.io/fitter-happier-docker/node.html#/">here</a>, if interested.</p></blockquote>

<h2>Docker?</h2>

<p>Be sure you understand the Docker basics before diving into this tutorial. Check out the official <a href="https://www.docker.com/whatisdocker/">&ldquo;What is Docker?&rdquo;</a> guide for an excellent intro.</p>

<p>In short, with Docker, you can truly mimic your production environment on your local machine. No more having to debug environment specific bugs or worrying that your app will perform differently in production.</p>

<ol>
<li>Version control for infrastructure</li>
<li>Easily distribute/recreate your entire development environment</li>
<li>Build once, run anywhere – aka The Holy Grail!</li>
</ol>


<h3>Docker-specific terms</h3>

<ul>
<li>A <em>Dockerfile is a file that contains a set of instructions used to create an </em>image*.</li>
<li>An <em>image</em> is used to build and save snapshots (the state) of an environment.</li>
<li>A <em>container</em> is an instantiated, live <em>image</em> that runs a collection of processes.</li>
</ul>


<blockquote><p>Be sure to check out the Docker <a href="https://docs.docker.com/">documentation</a> for more info on <a href="https://docs.docker.com/reference/builder/">Dockerfiles</a>, <a href="https://docs.docker.com/terms/image/">images</a>, and <a href="https://docs.docker.com/terms/container/">containers</a>.</p></blockquote>

<h2>Local Setup</h2>

<p>Let&rsquo;s get your local development environment set up!</p>

<h3>Get Docker</h3>

<p>Follow the download instructions from the guide <a href="https://docs.docker.com/installation/mac/">Installing Docker on Mac OS X</a> to install the Docker client along with-
  - <a href="https://docs.docker.com/machine/">Docker Machine</a> for creating Docker hosts both locally and in the cloud
  - <a href="https://docs.docker.com/compose/">Docker Compose</a> for orchestrating a multi-container application into a single app</p>

<p>Once installed, let&rsquo;s run a quick sanity check to ensure Docker is installed correctly. Start by creating a Docker VM by running the &ldquo;Docker Quickstart Terminal&rdquo; application. If all went well, you should see something similar to in your terminal:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>bash --login <span class="s1">&#39;/Applications/Docker/Docker Quickstart Terminal.app/Contents/Resources/Scripts/start.sh&#39;</span>
</span><span class='line'>➜  ~  bash --login <span class="s1">&#39;/Applications/Docker/Docker Quickstart Terminal.app/Contents/Resources/Scripts/start.sh&#39;</span>
</span><span class='line'>Creating Machine default...
</span><span class='line'>Creating CA: /Users/michaelherman/.docker/machine/certs/ca.pem
</span><span class='line'>Creating client certificate: /Users/michaelherman/.docker/machine/certs/cert.pem
</span><span class='line'>Creating VirtualBox VM...
</span><span class='line'>Creating SSH key...
</span><span class='line'>Starting VirtualBox VM...
</span><span class='line'>Starting VM...
</span><span class='line'>To see how to connect Docker to this machine, run: docker-machine env default
</span><span class='line'>Starting machine default...
</span><span class='line'>Started machines may have new IP addresses. You may need to re-run the <span class="sb">`</span>docker-machine env<span class="sb">`</span> command.
</span><span class='line'>Setting environment variables <span class="k">for</span> machine default...
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>                        <span class="c">##         .</span>
</span><span class='line'>                  <span class="c">## ## ##        ==</span>
</span><span class='line'>               <span class="c">## ## ## ## ##    ===</span>
</span><span class='line'>           /<span class="s2">&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;</span><span class="err">&quot;</span><span class="se">\_</span>__/ <span class="o">===</span>
</span><span class='line'>      ~~~ <span class="o">{</span>~~ ~~~~ ~~~ ~~~~ ~~~ ~ /  <span class="o">===</span>- ~~~
</span><span class='line'>           <span class="se">\_</span>_____ o           __/
</span><span class='line'>             <span class="se">\ </span>   <span class="se">\ </span>        __/
</span><span class='line'>              <span class="se">\_</span>___<span class="se">\_</span>______/
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>docker is configured to use the default machine with IP 192.168.99.100
</span><span class='line'>For <span class="nb">help </span>getting started, check out the docs at https://docs.docker.com
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s create a new container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker run hello-world
</span></code></pre></td></tr></table></div></figure>


<p>You should see:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>Unable to find image <span class="s1">&#39;hello-world:latest&#39;</span> locally
</span><span class='line'>latest: Pulling from library/hello-world
</span><span class='line'>b901d36b6f2f: Pull <span class="nb">complete</span>
</span><span class='line'>0a6ba66e537a: Pull <span class="nb">complete</span>
</span><span class='line'>Digest: sha256:517f03be3f8169d84711c9ffb2b3235a4d27c1eb4ad147f6248c8040adb93113
</span><span class='line'>Status: Downloaded newer image <span class="k">for</span> hello-world:latest
</span><span class='line'>
</span><span class='line'>Hello from Docker.
</span><span class='line'>This message shows that your installation appears to be working correctly.
</span><span class='line'>
</span><span class='line'>To generate this message, Docker took the following steps:
</span><span class='line'> 1. The Docker client contacted the Docker daemon.
</span><span class='line'> 2. The Docker daemon pulled the <span class="s2">&quot;hello-world&quot;</span> image from the Docker Hub.
</span><span class='line'> 3. The Docker daemon created a new container from that image which runs the
</span><span class='line'>    executable that produces the output you are currently reading.
</span><span class='line'> 4. The Docker daemon streamed that output to the Docker client, which sent it
</span><span class='line'>    to your terminal.
</span><span class='line'>
</span><span class='line'>To try something more ambitious, you can run an Ubuntu container with:
</span><span class='line'> <span class="nv">$ </span>docker run -it ubuntu bash
</span><span class='line'>
</span><span class='line'>Share images, automate workflows, and more with a free Docker Hub account:
</span><span class='line'> https://hub.docker.com
</span><span class='line'>
</span><span class='line'>For more examples and ideas, visit:
</span><span class='line'> https://docs.docker.com/userguide/
</span></code></pre></td></tr></table></div></figure>


<p>With that, let&rsquo;s create our Node Project&hellip;</p>

<h3>Get the Project</h3>

<p>Grab the base code from the <a href="https://github.com/mjhea0/node-docker-workflow/releases/tag/v2">repo</a>, and add it to your project directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>└── app
</span><span class='line'>    ├── Dockerfile
</span><span class='line'>    ├── index.js
</span><span class='line'>    ├── package.json
</span><span class='line'>    └── <span class="nb">test</span>
</span><span class='line'>        └── test.js
</span></code></pre></td></tr></table></div></figure>


<h3>Docker Machine</h3>

<p>Within your project directory, start Docker Machine:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker-machine create -d virtualbox dev<span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This command, <code>create</code>, setup a new &ldquo;Machine&rdquo; (called <code>dev</code>) for local Docker development. Now we just need to point Docker at this specific Machine:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">eval</span> <span class="s2">&quot;$(docker-machine env dev)&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>You now should have two Machines running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker-machine  ls
</span><span class='line'>NAME      ACTIVE   DRIVER       STATE     URL                         SWARM
</span><span class='line'>default            virtualbox   Running   tcp://192.168.99.100:2376
</span><span class='line'>dev       *        virtualbox   Running   tcp://192.168.99.102:2376
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Make sure the <code>dev</code> is the active Machine.</p></blockquote>

<h3>Compose Up!</h3>

<p><a href="https://github.com/docker/compose">Docker Compose</a> (Previously known as fig) is an orchestration framework that handles the building and running of multiple services, making it easy to link multiple services together running in different containers.</p>

<p>Make sure Compose is set up correctly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>docker-compose -v
</span><span class='line'>docker-compose version: 1.4.2
</span></code></pre></td></tr></table></div></figure>


<p>Now we just need to define the services - web (NodeJS) and persistence (Redis) in a configuration file called  <em>docker-compose.yml</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">web</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">build</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">./app</span>
</span><span class='line'>  <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="s">&quot;./app:/src/app&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="s">&quot;80:3000&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">links</span><span class="p-Indicator">:</span>
</span><span class='line'>   <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">redis</span>
</span><span class='line'><span class="l-Scalar-Plain">redis</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">redis:latest</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;6379:6379&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we add the services that make up our basic stack:</p>

<ol>
<li><strong>web</strong>: First, we build the image based on the instructions in the <em>app/Dockerfile</em> - where we setup our Node environment, create a volume, install the required dependencies, and fire up the app running on port 3000. Then we forward that port in the container to port 80 on the host environment - e.g., the Docker VM.</li>
<li><strong>redis</strong>: Next, the Redis service is built from the <a href="https://registry.hub.docker.com/_/redis/">image</a> on Docker Hub. Port 6379 is exposed and forwarded.</li>
</ol>


<h3>Profit</h3>

<p>Run <code>docker-compose up</code> to build new images for the NodeJS/Express app and Redis services and then run both processes in new containers. Grab a cup of coffee. Or go for a long walk. This will take a while the first time you run it. Subsequent builds run much quicker since Docker <a href="https://docs.docker.com/articles/dockerfile_best-practices/#build-cache">caches</a> the results from the first build.</p>

<p>Open your browser and navigate to the IP address associated with the Docker VM (<code>docker-machine ip dev</code>). You should see the text, &ldquo;You have viewed this page 1 times!&rdquo; in your browser. Refresh. The page counter should increment.</p>

<p>Once done, kill the processes (Ctrl-C). Commit your changes locally, and then push to Github.</p>

<h3>Next Steps</h3>

<p>So, what did we accomplish?</p>

<p>We set up our local environment, detailing the basic process of building an <em>image</em> from a <em>Dockerfile</em> and then creating an instance of the image called a <em>container</em>. We then tied everything together with Docker Compose to build and connect different containers for both the NodeJS/Express app and Redis process.</p>

<p>Need the updated code? Grab it from the <a href="https://github.com/mjhea0/node-docker-workflow/releases/tag/v2b">repo</a>.</p>

<p>Next, let’s talk about Continuous Integration&hellip;</p>

<h2>Continuous Integration</h2>

<p>We&rsquo;ll start with Docker Hub.</p>

<h3>Docker Hub</h3>

<p><a href="https://hub.docker.com/">Docker Hub</a> &ldquo;manages the lifecycle of distributed apps with cloud services for building and sharing containers and automating workflows&rdquo;. It&rsquo;s the Github for Docker images.</p>

<ol>
<li><a href="https://hub.docker.com/account/signup/">Signup</a> using your Github credentials.</li>
<li><a href="http://docs.docker.com/docker-hub/builds/#about-automated-builds">Set up</a> a new automated build. And add your Github repo that you created and pushed to earlier. Just accept all the default options, expect for the &ldquo;Dockerfile Location&rdquo; - change that to &ldquo;/app&rdquo;.</li>
</ol>


<p>Each time you push to Github, Docker Hub will generate a new build from scratch.</p>

<p>Docker Hub acts much like a continuous integration server since it ensures you do not cause a regression that completely breaks the build process when the code base is updated. That said, Docker Hub should be the last test before deployment to either staging or production so let&rsquo;s use a <em>true</em> continuous integration server to fully test our code before it hits Docker Hub.</p>

<h3>CircleCI</h3>

<p><a href="https://circleci.com/">CircleCI</a> is a CI platform that supports Docker.</p>

<p>Given a Dockerfile, CircleCI builds an image, starts a new container (or containers), and then runs tests inside that container.</p>

<ol>
<li><a href="https://circleci.com/">Sign up</a> with your Github account.</li>
<li>Create a new project using the Github repo you created.</li>
</ol>


<p>Next we need to add a configuration file, called <em>circle.yml</em>, to the root folder of the project so that CircleCI can properly create the build.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">machine</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docker</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">dependencies</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">override</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sudo pip install --upgrade docker-compose==1.3.3</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">override</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docker-compose run -d --no-deps web</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">cd app; mocha</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, we install Docker Compose, create a new image, and run the container along with our unit tests.</p>

<blockquote><p>Notice how we’re using the command <code>docker-compose run -d --no-deps web</code>, to run the web process, instead of <code>docker-compose up</code>. This is because CircleCI already has Redis <a href="https://circleci.com/docs/environment#databases">running</a> and available to us for our tests. So, we just need to run the web process.</p></blockquote>

<p>Before we test this out, we need to change some settings on Docker Hub.</p>

<h3>Docker Hub (redux)</h3>

<p>Right now, each push to Github will create a new build. That&rsquo;s not what we want. Instead, we want CircleCI to run tests against the master branch then <em>after</em> they pass (and only after they pass), a new build should trigger on Docker Hub.</p>

<p>Open your repository on Docker Hub, and make the following updates:</p>

<ol>
<li>Click <em>Build Settings</em>.</li>
<li>Uncheck the <em>Activate Auto-build</em> box: &ldquo;When activated, your image will build automatically when your source code repo is pushed.&rdquo;. Save the changes.</li>
<li>Then once again under <em>Build Settings</em> scroll down to <em>Build Triggers</em>.</li>
<li>Active the <em>Trigger Status</em>.</li>
<li>Copy the curl command that &ldquo;Trigger all tags/branches for this automated build&rdquo; – i.e., <code>curl -H "Content-Type: application/json" --data '{"build": true}' -X POST https://registry.hub.docker.com/u/mjhea0/node-docker-workflow/trigger/e80163ce-9f98-40ba-8498-c84538917fbc/</code>.</li>
</ol>


<h3>CircleCI (redux)</h3>

<p>Back on CircleCI, let&rsquo;s add that curl command as an environment variable:</p>

<ol>
<li>Within the <em>Project Settings</em>, select <em>Environment variables</em>.</li>
<li>Add a new variable with the name &ldquo;DEPLOY&rdquo; and paste the curl command as the value.</li>
</ol>


<p>Then add the following code to the bottom of the <em>circle.yml</em> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">deployment</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">hub</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">branch</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">master</span>
</span><span class='line'>    <span class="l-Scalar-Plain">commands</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">$DEPLOY</span>
</span></code></pre></td></tr></table></div></figure>


<p>This simply fires the <code>$DEPLOY</code> variable after our tests pass on the master branch.</p>

<p>Now, let&rsquo;s test!</p>

<h3>Profit!</h3>

<p>Follow these steps&hellip;</p>

<ol>
<li>Create a new branch</li>
<li>Make changes locally</li>
<li>Push changes to Github</li>
<li>Issue a pull request</li>
<li>Manually merge into Master once the tests pass</li>
<li>Once the second round passes, a new build is triggered on Docker Hub</li>
</ol>


<p>What&rsquo;s left? Deployment! Grab the updated <a href="https://github.com/mjhea0/node-docker-workflow/releases/tag/v2c">code</a>, if necessary.</p>

<h2>Deployment</h2>

<p>Let&rsquo;s get our app running on <a href="https://www.digitalocean.com/">Digital Ocean</a>.</p>

<p>After you&rsquo;ve signed up and <a href="https://www.digitalocean.com/community/tutorials/how-to-use-ssh-keys-with-digitalocean-droplets">set up an SSH key</a>, create a new $5 Droplet, choose &ldquo;Applications&rdquo; and then select the Docker Application.</p>

<p>Once setup, SSH into the server as the &lsquo;root&rsquo; user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>ssh root@&lt;some_ip_address&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Now you just need to clone the repo, install Docker compose, and then you can run your app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>git clone https://github.com/mjhea0/node-docker-workflow.git
</span><span class='line'><span class="nv">$ </span>curl -L https://github.com/docker/compose/releases/download/1.4.2/docker-compose-<span class="sb">`</span>uname -s<span class="sb">`</span>-<span class="sb">`</span>uname -m<span class="sb">`</span> &gt; /usr/local/bin/docker-compose
</span><span class='line'><span class="nv">$ </span>chmod +x /usr/local/bin/docker-compose
</span><span class='line'><span class="nv">$ </span>docker-compose up -d
</span></code></pre></td></tr></table></div></figure>


<p>Sanity check. Navigate to your Droplet’s IP address in the browser. You should see your app.</p>

<p>Nice!</p>

<p>But what about continuous delivery? Instead of having to SSH into the server and clone the new code, the process should be part of our workflow so that once a new build is generated on Docker Hub, the code is updated on Digital Ocean automatically.</p>

<p>Enter <a href="https://www.tutum.co/">Tutum</a>.</p>

<h2>Continuous Delivery</h2>

<p><a href="https://www.tutum.co/">Tutum</a> manages the orchestration and deployment of Docker images and containers. Setup is simple. After you&rsquo;ve signed up (with Github), you need to add a <a href="https://support.tutum.co/support/solutions/articles/5000523221-your-first-node">Node</a>, which is just a Linux host. We&rsquo;ll use Digital Ocean.</p>

<p>Start by linking your Digital Ocean account within the &ldquo;Account Info&rdquo; area.</p>

<p>Now you can add a new Node. The process is straightforward, but if you need help, please refer to the <a href="https://support.tutum.co/support/solutions/articles/5000523221-your-first-node">official documentation</a>. Just add a name, select a region, and then you&rsquo;re good to go.</p>

<p>With a Node setup, we can now add a <a href="https://support.tutum.co/support/solutions/articles/5000569899-stacks">Stack</a> of services - <em>web</em> and <em>Redis</em>, in our case - that make up our tech stack. Next, create a new file called <em>tutum.yml</em>, and add the following code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">web</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mjhea0/node-docker-workflow</span>
</span><span class='line'>  <span class="l-Scalar-Plain">autorestart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">always</span>
</span><span class='line'>  <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="s">&quot;80:3000&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">links</span><span class="p-Indicator">:</span>
</span><span class='line'>   <span class="p-Indicator">-</span> <span class="s">&quot;redis:redis&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">redis</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">redis</span>
</span><span class='line'>    <span class="l-Scalar-Plain">autorestart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">always</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;6379:6379&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, we are pulling the images from Docker Hub and building them just like we did with Docker Compose. Notice the difference here, between this file and the <em>docker-compose.yml</em> file. Here, we are not creating images, we&rsquo;re pulling them in from Docker Hub. It&rsquo;s essentially the same thing since the most updated build is on Docker Hub.</p>

<p>Now just create a new Stack, adding a name and uploading the <em>tutum.yml</em> file, and click &ldquo;Create and deploy&rdquo; to pull in the new images on the Node and then build and run the containers.</p>

<p>Once done, you can view your live app!</p>

<blockquote><p>Note: You lose the &ldquo;magic&rdquo; of Tutum when running things in a single host, as we&rsquo;re currently doing. In a real world scenario you&rsquo;d want to deploy multiple web containers, load balance across them and have them live on different hosts, sharing a single REDIS cache. We may look at this in a future post, focusing solely on delivery.</p></blockquote>

<p>Before we call it quits, we need to sync Docker Hub with Tutum so that when a new build is created on Docker Hub, the services are rebuilt and redeployed on Tutum - automatically!</p>

<p>Tutum makes this simple.</p>

<p>Under the <em>Services</em> tab, click the <em>web</em> service, and, finally, click the <em>Webhooks tab</em>. To create a new hook, simply add a name and then click <em>Add</em>. Copy the URL, and then navigate back to Docker Hub. Once there, click the <em>Webhook</em> link and add a new hook, pasting in the URL.</p>

<p>Now after a build is created on Docker Hub, a POST request is sent to that URL, which, in turn, triggers a redeploy on Tutum. Boom!</p>

<h2>Conclusion</h2>

<p>As always comment below if you have questions. If you manage a different workflow for continuous integration and delivery, please post the details below. Grab the final code from the <a href="https://github.com/mjhea0/node-docker-workflow">repo</a>.</p>

<p>See you next time!</p>
</div>


  <footer>
    <p class="meta">
      
  



  <span class="byline author vcard">Authored by <span class="fn">
  
    Michael Herman
  
  </span></span>


      




<time class='entry-date' datetime='2015-03-06T08:05:00-07:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:05 am</span></time>
      
      

<span class="categories">
  
    <a class='category' href='/blog/categories/docker/'>docker</a>
  
</span>


    </p>
    
      <div class="sharing">
<!--   
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://mherman.org/blog/2015/03/06/node-with-docker-continuous-integration-and-delivery/" data-via="" data-counturl="http://mherman.org/blog/2015/03/06/node-with-docker-continuous-integration-and-delivery/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
   -->
  <br>
  <!-- AddThis Button BEGIN -->
  <div class="addthis_toolbox addthis_default_style addthis_32x32_style">
  <a class="addthis_button_preferred_1"></a>
  <a class="addthis_button_preferred_2"></a>
  <a class="addthis_button_preferred_3"></a>
  <a class="addthis_button_preferred_4"></a>
  <a class="addthis_button_compact"></a>
  <a class="addthis_counter addthis_bubble_style"></a>
  </div>
  <script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-50e5f1cc35ad077d"></script>
  <!-- AddThis Button END -->
  <br>
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/02/12/postgresql-and-nodejs/" title="Previous Post: PostgreSQL and NodeJS">&laquo; PostgreSQL and NodeJS</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/04/09/testing-angularjs-with-protractor-and-karma-part-1/" title="Next Post: Testing AngularJS with Protractor and Karma - part 1">Testing AngularJS with Protractor and Karma - part 1 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>


</div>

    </div>
  </div>
  <footer role="contentinfo"><div>
  <span>Copyright &copy; 2016 - Michael Herman</span><br>
  <a href="https://github.com/mjhea0"><i class="fa fa-github-square" style="font-size:2em" aria-hidden="true"></i></a>
  <a href="https://twitter.com/mikeherman"><i class="fa fa-twitter-square" style="font-size:2em" aria-hidden="true"></i></a>
  <a href="http://www.linkedin.com/pub/michael-herman/3b/a94/4"><i class="fa fa-linkedin-square" style="font-size:2em" aria-hidden="true"></i></a>
  <a href="http://www.youtube.com/hermanmu"><i class="fa fa-youtube-square" style="font-size:2em" aria-hidden="true"></i></a>
</div>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'michaelherman';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://mherman.org/blog/2015/03/06/node-with-docker-continuous-integration-and-delivery/';
        var disqus_url = 'http://mherman.org/blog/2015/03/06/node-with-docker-continuous-integration-and-delivery/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>






<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
